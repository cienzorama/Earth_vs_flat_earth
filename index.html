<!DOCTYPE html>
<html>
    <head>
        <link rel="icon" type="image/vnd.microsoft.icon" href="favicon.ico">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

        <title>Earth vs. flat earth</title>

        <!-- Babylon.js -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.2/dat.gui.min.js"></script>
        <script src="https://assets.babylonjs.com/generated/Assets.js"></script>
        <script src="https://cdn.babylonjs.com/recast.js"></script>
        <script src="https://cdn.babylonjs.com/ammo.js"></script>
        <script src="https://cdn.babylonjs.com/havok/HavokPhysics_umd.js"></script>
        <script src="https://cdn.babylonjs.com/cannon.js"></script>
        <script src="https://cdn.babylonjs.com/Oimo.js"></script>
        <script src="https://cdn.babylonjs.com/earcut.min.js"></script>
        <script src="https://cdn.babylonjs.com/babylon.js"></script>
        <script src="https://cdn.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
        <script src="https://cdn.babylonjs.com/proceduralTexturesLibrary/babylonjs.proceduralTextures.min.js"></script>
        <script src="https://cdn.babylonjs.com/postProcessesLibrary/babylonjs.postProcess.min.js"></script>
        <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.js"></script>
        <script src="https://cdn.babylonjs.com/serializers/babylonjs.serializers.min.js"></script>
        <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
        <script src="https://cdn.babylonjs.com/inspector/babylon.inspector.bundle.js"></script>

        <!--Open Street Maps-->
        <script src="https://openlayers.org/en/v4.6.5/build/ol.js"></script>
        <!--<script src="https://openlayers.org/en/v4.6.5/css/ol.css"></script> -->

        <!--- Base de datos de figura de las constelaciones --->
		<script src="/js/stars_db.js"></script>


        <style>
            html, body {
                overflow: hidden;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }

            #renderCanvas {
                width: 100%;
                height: 100%;
                touch-action: none;
            }
            
            #map {
                width: 100%;
                height: 100%;
                touch-action: none;
            }

            .anybutton {
                top:90%;
                left:90%;
                width:100px;
                height:40px;
                position: absolute;
                z-index: 2;
                background: white; 
            }

            #canvasZone {
                width: 100%;
                height: 100%;
            }
        </style>
    </head>
<body>
    <div id="canvasZone">
        <canvas id="renderCanvas" style="z-index:1;"></canvas>
        <div tabindex="700" id="map" class="map"></div>
        <input type="button" class="anybutton" id="done_button" value="DONE!" />
    </div>

    <script>

        var canvas = document.getElementById("renderCanvas");
        var done_button=document.getElementById("done_button");

        var startRenderLoop = function (engine, canvas) {
            engine.runRenderLoop(function () {
                if (sceneToRender && sceneToRender.activeCamera) {
                    sceneToRender.render();
                }
            });
        }

        var engine = null;
        var scene = null;
        var sceneToRender = null;
        var createDefaultEngine = function() { return new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true,  disableWebGL2Support: false}); };
    
        done_button.setAttribute("hidden", "hidden");

        //Configuración del servidor de tiles de mapa
        var myTileServer = new ol.layer.Tile({
            source: new ol.source.OSM({
                crossOrigin: null,
                url: 'https://{a-c}.tile.openstreetmap.org/{z}/{x}/{y}.png'
            })
        });

        //Creacíon del mapa y transformación
        //de coordenadas
        var map = new ol.Map({
            layers: [ myTileServer ],
            target: 'map',
            view: new ol.View({
                center: ol.proj.transform([10, 45], 'EPSG:4326', 'EPSG:3857'),
                zoom: 2
            })
        });

        //Configuración de las capas 
        // de marcadores
        marker_type=1;
        markers=null;
        markers = new ol.layer.Vector();
        map.addLayer(markers);
        marker_lat=null;
        marker_lon=null;
        map_latlon=[];

        //Al pulsar sobre el mapa:
        //Borra el marcador existente y crea uno nuevo
        map.on('click', (event)=> {

            //Borra la capa de marcadores existente
            map.removeLayer(markers);

            //Crea una nueva capa de marcadores
            markers = new ol.layer.Vector({source: new ol.source.Vector()});
            map.addLayer(markers);
            
            //Obtiene las coordenadas de la ubicación seleccionada
            map_latlon=ol.proj.toLonLat(map.getCoordinateFromPixel(event.pixel));
            marker_lat=map_latlon[0];
            marker_lon=map_latlon[1];
            
            //Añade un marcador al mapa
            var marker = new ol.Feature(new ol.geom.Point(ol.proj.fromLonLat(map_latlon)));
            
            //Selección del símbolo de ubicación
            if (marker_type==1) {
                marker_icon_source='http://maps.google.com/mapfiles/kml/paddle/red-circle.png';
            }
            if (marker_type==2) {
                marker_icon_source='http://maps.google.com/mapfiles/kml/paddle/blu-circle.png';
            }

            //Consfiguración del estilo de marcador
            marker.setStyle(
                new ol.style.Style({
                    image: new ol.style.Icon({
                    src: marker_icon_source,
                    anchor: [0.5, 1],
                    scale: 0.5
                    })
                })
            );

            //Añade el marcador a la capa de marcadores
            markers.getSource().addFeature(marker);
            
        })

//|-----------------------------------------------|
//|  Representación de interactiva de fenómenos   |
//|            para dos observadores              |
//|      sobre La Tierra y la "tierra plana"      |
//|                                               |
//|                                               |
//| - Rutas ortodrómicas, loxodrómicas,           |
//|    flatodrómicas y equiangulares.             |
//| - Posición y orientación del Sol y La Luna    |
//| - Trayectoria diaria del Sol y La Luna        |
//| - Selección de fecha y hora (1900-2100)       |
//| - Ubicación precisa de los observadores       |
//| - Animacines                                  |
//| - Cálculos de distancias                      |
//| - Cálculo y representación de Eclipses        |
//| - Iluminación La Tierra y fases de La Luna    |
//| - Representación del analema solar y lunar    |
//|                                               |
//| Advertencia: Todo fenómeno representado       |
//|              sobre la "tierra plana" en este  |
//|              programa no es más que una       |
//|              proyección sobre el disco de     |
//|              cálculos préviamente realizados  |
//|              sobre la esfera.                 |
//|                                               |
//|                                               |
//| v0.55sb   20/10/2023                          |
//|                                               |
//|            cienzorama@gmail.com               |
//|-----------------------------------------------|


//Datos de las líneas sobre
//la esfera y la tierra plana
//Ortodrómicas
line_data=[];
line_data_fe=[];
//Loxodrímicas
line_data_lox=[];
line_data_lox_fe=[];
//Flatodrómicas
line_data_flat_sp=[];
line_data_flat_fe=[];
//Equiangular
line_data_eqac_sp=[];
line_data_eqac_fe=[];

//Posición de los controles
pos1=[];
pos2=[];
pos3=[];
pos4=[];

//Numero de divisiones de cada línea
ndiv=200;

//Radio de la esfera
r=10;

//Visibilidad de la tierra plana
fe_is_visible=0;

//Factores de escala mínimos y máximos 
//para el tamaño del disco.
//En el mínimo (=1), el radio del disco
//es igual a 2 radios terrestres, manteniendo
//el tamaño del ecuador.
//En el máximo (=pi/2), el radio del disco
//es igual al tamaño del meridiano de polo a polo
//de la esfera
sfe_min=1.0;
sfe_max=0.5*Math.PI;

//Factor de escala y tamaño del
//disco seleccionado
sfe=sfe_max*1.0;
rfe=sfe*r;
//Copia del factor de escala inicial
sfe0=sfe*1.0;

//Tamaño de las esferas
//roja y azul
handler_radius=r/8.0;

//Altura de las líneas 
//sobre la tierra plana
height_fe=rfe/400;
fe_h=rfe/200.0;

//Radio visual de las líneas
//sobre la esfera
deltar=1.002*0+1.002;
rdeltar=r*deltar;

//Radio (medio) de la La Tierra
earth_radius=6371.0;

//Factores de escala
factor_de_escala_sp=earth_radius/(rdeltar);
factor_de_escala_fe=sfe*earth_radius/rfe;
//Máxima latitud permitida respecto a +-pi/2
max_lat=0.99999;

//Factor de conversión
//de grados a radianes
dtor=Math.PI/180.0;

//Coordenadas de los controles
lat1=0;lat2=0;
lon1=0;lon2=0;
h1=0;h2=0;

//Color de las líneas
line_color_orto=new BABYLON.Color3(0,1,0);
line_color_loxo=new BABYLON.Color3(1,0,0);
line_color_flat=new BABYLON.Color3(1,1,0);
line_color_eqac=new BABYLON.Color3(0,1,1);

line_color_moon=new BABYLON.Color3(0.5,0.5,0.5);
line_color_sun=new BABYLON.Color3(1,1,0);

//Posición del centro de la esfera y el disco
zero=new BABYLON.Vector3(0,0,0);
nan=new BABYLON.Vector3(NaN,NaN,NaN);
fe_angle=0;
//fe_pos=new BABYLON.Vector3(0,-fe_h,-4*rfe);
fe_pos=new BABYLON.Vector3(4*rfe*Math.sin(fe_angle),-fe_h,-4*rfe*Math.cos(fe_angle));

//Distancias
distancia_sp=0;
distancia_sp_suma=0;
distancia_fe_suma=0;
distancia_sp_lox=0;
distancia_sp_lox_suma=0;
distancia_fe_lox_suma=0;
distancia_sp_flat_suma=0;
distancia_fe_flat_suma=0;
distancia_sp_eqac_suma=0;
distancia_fe_eqac_suma=0;

dist_orto=[];
dist_loxo=[];
dist_flat=[];
dist_eqac=[];
dist_orto_fe=[];
dist_loxo_fe=[];
dist_flat_fe=[];
dist_eqac_fe=[];

//Visibilidad de las líneas
orto_es_visible=0;
loxo_es_visible=0;
flato_es_visible=0;
eqac_es_visible=0;

//Línea seleccionada para información
info_orto=0;
info_loxo=0;
info_flat=0;
info_eqac=0;

//Opción para mantener
//la distancia ortodrómica constante
keep_orto_dist=0;

//Selección de modelo
sp_sel=1;
fe_sel=0;

//Cambio de posición
change_pos=0;

//Sensibilidad del ratón
mouse_sense=1.0;

//Ángulo entre las posiciones
//sobre la esfera
orthodromic_angle=0;

//Dia juliano
JD=2451545.0;
FECHA=[];
TIME_STEP=1;
GMT_OFFSET_RED=2;
GMT_OFFSET_BLUE=-3;

//Visibilidad del fondo de estrellas
// y las figuras de las constelaciones
stars_visible=1;

//Líneas entre las ubicaciones, el centro
// de La Tierra y la posición de La Luna
moon_line_data_1=[];
moon_line_data_2=[];
moon_line_data_c=[];

//Líneas entre las ubicaciones, el centro
// de La Tierra y la posición del Sol
sun_line_data_1=[];
sun_line_data_2=[];
sun_line_data_c=[];

//Lineas de dirección de La Luna y el Sol para
//cada ubicación sobre la TP
fe_moon_line_data_1=[];
fe_moon_line_data_2=[];
fe_sun_line_data_1=[];
fe_sun_line_data_2=[];

//Tamaño de las líneas de dirección sobre la TP
fe_line_size=r*Math.PI;

//Ubicación en la que La Luna es cenital
moon_sphere_pos=new BABYLON.Vector3(0,0,0);
moon_fe_pos=new BABYLON.Vector3(0,0,0);

//Ubicación en la que El Sol es cenital
sun_sphere_pos=new BABYLON.Vector3(0,0,0);
sun_fe_pos=new BABYLON.Vector3(0,0,0);

//Trayectoria del Sol cenital sobre la esfera y el disco
sun_tr_line_data=[ nan,nan];
sun_tr_line_data_fe=[ nan,nan];
sun_tr_np=2;
sun_tr_a=0;

//Trayectoria de La Luna cenital sobre la esfera y el disco
moon_tr_line_data=[ nan,nan];
moon_tr_line_data_fe=[ nan,nan];
moon_tr_np=2;
moon_tr_a=0;

//Ángulos de elevación y azimut de La Luna y El Sol
//para cada ubicación
moon_alt1=0;moon_az1=0;
moon_alt2=0;moon_az2=0;
sun_alt1=0;sun_az1=0;
sun_alt2=0;sun_az2=0;

//Opción de corrección de altura por elevación
horizon_correction=0;

//Alturas corregidas por la altura del observador
moon_alt1_co=0;
moon_alt2_co=0;
sun_alt1_co=0;
sun_alt2_co=0;

//Ángulo de caida del horizonte con la altura
h1_alt_co=0;
h2_alt_co=0;

//Distancia del Sol y La Luna al centro de La Tierra
moon_earth_distance=0;
sun_earth_distance=0;

//Línea base, paralaje lunar y solar y
// rumbos de la ortodroma que pasa
//por la ubicaciones
moon_bl=0;
moon_paralax=0;
sun_paralax=0;
moon_bear1=0;moon_bear2=0;

//Visibilidad de las líneas de orientación/posición
//del Sol y La Luna
sun_tg_visible=0;
sun_tp_visible=1;
moon_tg_visible=0;
moon_tp_visible=0;

//Visibilidad de punto de disstancia mínima entre
//líneas de dirección hacia el Sol o La Luna sobre
//la tierra plana
sun_tp_cut_visible=1;
moon_tp_cut_visible=1;

//Altura y azimut de observación de usuario
user_alt_1=90;user_az_1=0;
user_alt_2=90;user_az_2=0;

//datos de usuario -test-
user_alt_1=56;user_az_1=218;
user_alt_2=29;user_az_2=43.87;

user_alt_1_co=56;
user_alt_2_co=29;

user_ra=0;
user_dec=0;
usuario_mira_estrella=0;

//Datos de las líneas de dirección de la
//observación de usuario en la esfera
// y la tierra plana
user_data_line_1=[];
user_data_line_2=[];
fe_user_data_line_1=[];
fe_user_data_line_2=[];

//Visibilidad de las líneas de dirección
// usuario sobre la esfera y la tierra plana
user_tg_lines_visible=0;
user_tp_lines_visible=0;

//Longitud de las lineas de direción
//de la observación de usuario
user_line_size=1000;

//Numero de texturas para La Tierra y
//textura actual
number_earth_texture=4;
current_earth_texture=1;

//Orientación local de La Luna
//1 - Orientación Altazimutal
//0 - Orientación NAT (North at top)
local_orientation=1;

//Control de animación
animation_control=0;

//Control de visualización de las
//cámaras que apuntan a La Luna
moon_cameras_option=0;

//Aputado de las cámaras secundarias
moon_cameras_point_moon=0;

//Control de visualización de
//información adicional sobre el modelo
additional_model_info=0;

//Datos de iluminación
//ilu_data_fe=[];
//ilu_data_sp=[];
ilu_data_fe=[nan,nan];
ilu_data_sp=[nan,nan];
ilu_is_visible=0;
ilu_alpha=0.5;
ilu_color=new BABYLON.Color3(0.75,0.75,0.25);
ilu_ts=128;
ilu_texture_data=new Uint8Array(ilu_ts*ilu_ts*3);

//Datos del calculo de eclipses
calcula_elcipse=0;
eclipse_data_umbra=[];
eclipse_data_umbra_fe=[];
eclipse_data_penumbra=[];
eclipse_data_penumbra_fe=[];
eclipse_test=0;

//Carga la base de datos de estrellas y figuras
star_data=[];
star_pos=[];
read_star_data();

//Permuta las componetes z e y
// de un vector
function change_yz(vector) {

    var cx=vector.x;
    var cy=vector.y;
    var cz=vector.z;

    return new BABYLON.Vector3(cx,cz,cy);
}

//Obteción de la fecha actual en UTC
//desde el sistema.
//Por defecto carga la fechay la hora actual.
function obtiene_fecha_actual() {

    var d=new Date();
    var fecha = new Array(6);

    fecha[0]=d.getUTCDate();
    fecha[1]=d.getUTCMonth()+1;
    fecha[2]=d.getUTCFullYear();
    fecha[3]=d.getUTCHours();
    fecha[4]=d.getUTCMinutes();
    fecha[5]=d.getUTCSeconds();

    //Fecha y hora de prueba
    /*
    fecha[0]=28;
    fecha[1]=10;
    fecha[2]=2023;
    fecha[3]=20;
    fecha[4]=35;
    */
    
    return fecha;
}

//Calcula el tiempo dinámico en función del año
//entre 1900 y 2150 (~72 segundos en 2022)
//Error ~ +- 1 segundo.
 function calc_dynamic_time(year) {

    var t,u,y,DT;

    y=year;

    if (y>=1900 && y<=1920) {
        t = y - 1900;
        DT = -2.79 + 1.494119 * t - 0.0598939 * t*t + 0.0061966 * t*t*t - 0.000197 * t*t*t*t;
    }

    if (y>=1920 && y<=1941) {
        t = y - 1920;
        DT = 21.20 + 0.84493*t - 0.076100 * t*t + 0.0020936 * t*t*t;
    }

    if (y>=1941 && y<=1961) {
        t = y - 1950;
        DT = 29.07 + 0.407*t - t*t/233.0 + t*t*t / 2547.0;
    }

    if (y>=1961 && y<=1986) {
        t = y - 1975;
        DT = 45.45 + 1.067*t - t*t/260.0 - t*t*t / 718.0;
    }

    if (y>=1986 && y<=2005) {
        t = y - 2000;
        DT = 63.86 + 0.3345 * t - 0.060374 * t*t + 0.0017275 * t*t*t + 0.000651814 * t*t*t*t;
            + 0.00002373599 * t*t*t*t*t;
    }

    if (y>=2005 && y<=2050) {
        t = y - 2000;
        DT = 62.92 + 0.32217 * t + 0.005589 * t*t;
    }

    if (y>=2050 && y<=2150) {
        DT = -20 + 32 * ((y-1820.0)/100.0)*((y-1820.0)/100.0) - 0.5628 * (2150 - y);
    }

    //DT=0; 

    return -DT;

}

//Obtiene el dia juliano (de efemerides)
//a partir de la fecha y la hora		
function calc_jd(fecha) {

    var dia=fecha[0];
    var mes=fecha[1];
    var ano=fecha[2];
    var hora=fecha[3];
    var minuto=fecha[4];
    var segundo=fecha[5];

    var ano1=ano;
    if (mes==1 || mes==2) {
        mes=mes+12;
        ano=ano-1;
    }
    
    var a=Math.floor(ano1/100.0);
    var b=2-a+Math.floor(a/4.0);
    var dia1=dia+hora/24.0+(minuto + segundo/60.0)/1440.0;
    var jd=Math.floor(365.25*(ano+4716))+Math.floor(30.6001*(mes+1))+dia1+b-1524.5;

    //Corrige el tiempo dinámico
    var DT=calc_dynamic_time(ano);
    jd+=DT/86400.0;

    return jd;
}

//Cálculo de la fecha y la hora
//a partir del día juliano (de efemérides)
function calc_fecha(jd) {

    var jd1=0.5+jd;
    var z=Math.floor(jd1);
    var f=jd1-z;
    var alfa=Math.floor((z-1867216.25)/36524.25);
    var a=z+1+alfa-Math.floor(alfa/4.0);
    var b=a+1524;
    var c=Math.floor((b-122.1)/365.25);
    var d=Math.floor(365.25*c);
    var e=Math.floor((b-d)/30.6001);

    var dia=b-d-Math.floor(30.6001*e)+f;
    var mes=0;
    var ano=0;

    if (e<14) {mes=e-1;} else {mes=e-13;}
    if (mes>2) {ano=c-4716;} else {ano=c-4715;}

    //---
    //Repite el cálculo considerando 
    // el tiempo dinámico
    var DT=calc_dynamic_time(ano);

    jd1=0.5+jd-DT/86400.0;
    z=Math.floor(jd1);
    f=jd1-z;
    alfa=Math.floor((z-1867216.25)/36524.25);
    a=z+1+alfa-Math.floor(alfa/4.0);
    b=a+1524;
    c=Math.floor((b-122.1)/365.25);
    d=Math.floor(365.25*c);
    e=Math.floor((b-d)/30.6001);

    var dia=b-d-Math.floor(30.6001*e)+f;
    var mes=0;
    var ano=0;

    if (e<14) {mes=e-1;} else {mes=e-13;}
    if (mes>2) {ano=c-4716;} else {ano=c-4715;}
    //----

    /*
    var hora=(dia-Math.floor(dia))*24;
    var minuto=(hora-Math.floor(hora))*60;
    var segundo=(minuto-Math.floor(minuto))*60;
    */

    var hora=(dia*24) % 24;
    var minuto=(dia*24*60) % 60;
    var segundo=(dia*24*60*60) % 60; 

    dia=Math.floor(dia);
    hora=Math.floor(hora);
    minuto=Math.floor(minuto);
    segundo=Math.floor(segundo);

    var fecha1=[];

    fecha1[0]=dia;
    fecha1[1]=mes;
    fecha1[2]=ano;
    fecha1[3]=hora;
    fecha1[4]=minuto;
    fecha1[5]=segundo;

    return fecha1;
}

//Cálculo del tiempo sidéreo de Greenwich
//(orientación espacial del primer meridiano)
//Astronomical Algorithms - Jean Meeus - Cap. 12
function calc_gmst() {

    var j1=JD*1.0;
    var t1 = (j1 -2451545.0)/36525.0; 

    var fecha1=calc_fecha(JD);
    var hh=fecha1[3]*1.0;
    var mm=fecha1[4]*1.0;
    var ss=fecha1[5]*1.0;
    fecha1[3]=0;fecha1[4]=0;fecha1[5]=0;

    var j0=calc_jd(fecha1);
    var j = (j0 - 2451545)/36525.0;
    var g0=100.46061837 + 36000.770053608*j + 0.000387933*j*j - j*j*j/38710000.0;     

    if (g0>360) {
        g0=g0-Math.floor(g0/360.0)*360.0;     
    } else {
        g0 = g0 - (Math.floor(g0/360.0) - 1.0)*360.0;
    }
    
    var ut=hh+mm/60.0+ss/3600.0;
    var gst = g0 + 360.98564724*ut/24.0;

    gst=gst*dtor;

    return gst;
}

//Cálculo de la posición geocéntrica del Sol
// respecto al primer meridiano y al plano 
//del ecuador terrestre
//
// Esta función contiene tres métodos
//
//Método de baja precisión
//Aproximación al DE200 - Astronomical Almanac 1984
//Error <1' de longitud y latitud eclíptica 1900<fecha<2100

//Método de precisión media
//Parámetros orbitales aproximados por ajuste al VSOP87
//Error <30'' de longitud

//Método de alta precisión
//Aproximación basada en el cálculo de la longitud, anomalía
//y excentricidad media del Sol, con correciones para calcular
//el centro y el equinoccio verdadero.
function calc_sun_pos() {

    //Aproximación para calcular el
    //Tiempo-Luz al sol
    //-----------------------------------
    var d2k=(JD-2451543.5);

    //Elementos oscultantes de la órbita
    //de La Tierra
    var a_p=1.0;
    var e_p=0.016709 - 1.151E-9 * d2k;
    var M_p= 356.0470 + 0.9856002585 * d2k;

    var M_p=M_p*dtor;

    //Ecuación de Kepler
    var E_p = M_p + e_p*Math.sin(M_p)*(1.0 + e_p *Math.cos(M_p));

    //Posición sobre el plano de la órbita
    var xv_p=a_p*(Math.cos(E_p)-e_p);
    var yv_p=a_p*(Math.sqrt(1.0-e_p*e_p)*Math.sin(E_p));

    //distancia desde el foco
    var sun_lighttime=+149597870.7*Math.sqrt(xv_p*xv_p+yv_p*yv_p)/299792.458/86400.0;

    //------------------------------------

    var d2k=(JD-2451543.5)+sun_lighttime;

    var t = (JD - 2451545+sun_lighttime)/36525.0;
    var t2=t*t;
    var t3=t2*t;

	var ecl = 23.4393 - 3.563E-7 * d2k;

    ecl=ecl*dtor;

    //Elementos oscultantes de la órbita
    //de La Tierra
    var N_p=0;
    var i_p=0;
    var w_p=282.9404 + 4.70935E-5 * d2k;
    var a_p=1.0;
    var e_p=0.016709 - 1.151E-9 * d2k;
    var M_p= 356.0470 + 0.9856002585 * d2k;

    //Parámetros de la órbita de La Tierra
    //para el equinoccio medio de la época
    //Astronomical Algorithms - Jean Meeus, pág. 212
    if (0) {
        var L_p=100.466457+36000.7698278*t+0.00030322*t2+0.000000020*t3;
        var a_p=1.000001018;
        var e_p=0.016070863-0.000042037*t-0.0000001267*t2+0.00000000014*t3;
        var i_p=0;
        var N_p=0;
        var pi_p=102.937348+1.17195366*t+0.00045688*t2-0.000000018*t3;
        
        var M_p=L_p-pi_p;
        var w_p=pi_p-N_p+180;
    }

    var N_p=N_p*dtor;
    var i_p=i_p*dtor;
    var w_p=w_p*dtor;
    var M_p=M_p*dtor;

    //Ecuación de Kepler
    var E_p = M_p + e_p*Math.sin(M_p)*(1.0 + e_p *Math.cos(M_p));

    //Posición sobre el plano de la órbita
    var xv_p=a_p*(Math.cos(E_p)-e_p);
    var yv_p=a_p*(Math.sqrt(1.0-e_p*e_p)*Math.sin(E_p));

    //Anomalía verdadera y distancia desde el foco
    var v_p=Math.atan2(yv_p,xv_p);
    var r_p=Math.sqrt(xv_p*xv_p+yv_p*yv_p);

    var cos_N_pe=Math.cos(N_p);
    var sin_N_pe=Math.sin(N_p);
    var cos_v_w_pe=Math.cos(v_p+w_p);
    var sin_v_w_pe=Math.sin(v_p+w_p);
    var cos_i_pe=Math.cos(i_p);
    var sin_i_pe=Math.sin(i_p);

    //Escala de la distancia al Sol
    rp=149597870.7/earth_radius*10;

    //Transformaciones de rotación en función de los
    //ángulos de orientación de la órbita
    var xh_p = rp*r_p * ( cos_N_pe * cos_v_w_pe - sin_N_pe * sin_v_w_pe * cos_i_pe );
    var yh_p = rp*r_p * ( sin_N_pe * cos_v_w_pe + cos_N_pe * sin_v_w_pe * cos_i_pe );
    var zh_p = rp*r_p * ( sin_v_w_pe * sin_i_pe );

    //Cálculo de precisión la posición del Sol
    //Posición media corregida con ecuación del centro
    // y modificación a posición verdadera
    //Astronomical Algorithms - Jean Meeus, Pág. 163
    if (1) {
        var beta=0;
        var Lo=280.46646+36000.76983*t+0.0003032*t2;
        var Mo=357.52911+35999.05029*t-0.0001537*t2;
        var e0=0.016708634-0.000042037*t-0.0000001267*t2;
        var Co=(1.914602-0.004817*t-0.000014*t2)*Math.sin(Mo*dtor)+
            (0.019993-0.000101*t)*Math.sin(2*Mo*dtor)+
            0.000289*Math.sin(3*Mo*dtor);
        var cc=Lo+Co;
        var nu=Mo+Co;

        var Oo=125.04-1934.136*t
        cc=cc-0.00509-0.00478*Math.sin(Oo*dtor);

        cc=cc*dtor;
        nu=nu*dtor;

        var r_p=1.000001018*(1-e0*e0)/(1+e0*Math.cos(nu));

        var xh_p=rp*r_p*Math.cos(beta)*Math.cos(cc);
        var yh_p=rp*r_p*Math.cos(beta)*Math.sin(cc);
        var zh_p=rp*r_p*Math.sin(beta);
    }

    //Cálculo del tiempo sidéreo medio de Greenwich
    GMST=-calc_gmst();
    
    //Transformación del plano de la eclíptica
    //al ecuador terrestre
    var cos_ecl=Math.cos(ecl);
    var sin_ecl=Math.sin(ecl);
    var xg_p = xh_p
    var yg_p = yh_p * cos_ecl - zh_p * sin_ecl;
    var zg_p = yh_p * sin_ecl + zh_p * cos_ecl;

    //Rotación respecto del primer meridiano
    var cos_GMST=Math.cos(GMST);
    var sin_GMST=Math.sin(GMST);
    var xe_p=xg_p*cos_GMST-yg_p*sin_GMST;
    var ye_p=xg_p*sin_GMST+yg_p*cos_GMST;
    var ze_p=zg_p;

    sun_xyz=new BABYLON.Vector3(xe_p,ze_p,ye_p);
    
    return sun_xyz;
}


//Cálculo de la orientación del Polo Norte de La Luna
//Report of the IAU Working Group on Cartographic
//Coordinates and Rotational Elements: 2009, Page 4, Table 2.
//Celestial Mechanics & Dynamical Astronomy
function calc_moon_ori() {

    var j1=JD;
    var t1 = (j1 -2451545.0)/36525.0; 
    var d=(j1-2451545.0);

    var E1,E2,E3,E4,E5,E6,E7,E8,E9,E10;
    var E11,E12,E13;

    var dn=d;
    E1 = 125.045- 0.0529921*dn;E1=E1*dtor;
    E2 = 250.089- 0.1059842*dn;E2=E2*dtor;
    E3 = 260.008+ 13.0120009*dn;E3=E3*dtor;
    E4 = 176.625+ 13.3407154*dn;E4=E4*dtor;
    E5 = 357.529+ 0.9856003*dn;E5=E5*dtor;
    E6 = 311.589+ 26.4057084*dn;E6=E6*dtor;
    E7 = 134.963+ 13.0649930*dn;E7=E7*dtor;
    E8 = 276.617+ 0.3287146*dn;E8=E8*dtor;
    E9 = 34.226+ 1.7484877*dn;E9=E9*dtor;
    E10= 15.134- 0.1589763*dn;E10=E10*dtor;
    E11= 119.743+ 0.0036096*dn;E11=E11*dtor;
    E12= 239.961+ 0.1643573*dn;E12=E12*dtor;
    E13= 25.053+ 12.9590088*dn;E13=E13*dtor;

    var sin_E1=Math.sin(E1);
    var sin_E2=Math.sin(E2);
    var sin_E3=Math.sin(E3);
    var sin_E4=Math.sin(E4);
    var sin_E6=Math.sin(E6);
    var sin_E10=Math.sin(E10);
    var sin_E13=Math.sin(E13);

    var ra0 = 269.9949+0.0031*t1-3.8787*sin_E1 -0.1204*sin_E2
    +0.0700*sin_E3 -0.0172*sin_E4 +0.0072*sin_E6
    -0.0052*sin_E10+0.0043*sin_E13;

    var dec0 = 66.5392+0.0130*t1+1.5419*Math.cos(E1) +0.0239*Math.cos(E2)
    -0.0278*Math.cos(E3) +0.0068*Math.cos(E4) -0.0029*Math.cos(E6)
    +0.0009*Math.cos(E7) +0.0008*Math.cos(E10)-0.0009*Math.cos(E13);

    var w0= 38.3213+13.17635815*d -1.4e-12*d*d +1*(3.5610*sin_E1
    +0.1208*sin_E2 -0.0642*sin_E3 +0.0158*sin_E4
    +0.0252*Math.sin(E5) -0.0066*sin_E6 -0.0047*Math.sin(E7)
    -0.0046*Math.sin(E8) +0.0028*Math.sin(E9) +0.0052*sin_E10
    +0.0040*Math.sin(E11)+0.0019*Math.sin(E12)-0.0044*sin_E13)-125.1228*0;

    //Corrección respecto a la posición del
    //primer meridiano y al sistema 
    //de referencia de webGL
    moon_ori1=(90-dec0)*dtor;
	moon_ori2=-(ra0+270)*dtor+calc_gmst();
	moon_w=-(w0)*dtor;

}

//Cálculo de la posición geocéntrica de La Luna
//respecto al primer meridiano y al plano 
//del ecuador terrestre
//Método de alta precisión
//Astronomical Algorithms - Jean Meeus - Cap. 47
//Error 10'' en longitud y 4'' en latitud eclípticas
function calc_moon_pos() {

    var d2k=(JD-2451543.5);
	var ecl = 23.4393 - 3.563E-7 * d2k;

    ecl=ecl*dtor;

    var nvals2=60;
    var t = (JD - 2451545.0)/36525.0;
    var t2=t*t;
    var t3=t2*t;
    var t4=t3*t;

    var d_lng = [0,2,2,0,0,0,2,2,2,2,0,1,0,2,0,0,4,0,4,2,2,1,1,2,2,4,2,0,2,2,1,2,0,0,2,2,2,4,0,3,2,4,0,2,2,2,4,0,4,1,2,0,1,3,4,2,0,1,2,2];
    var m_lng = [0,0,0,0,1,0,0,-1,0,-1,1,0,1,0,0,0,0,0,0,1,1,0,1,-1,0,0,0,1,0,-1,0,-2,1,2,-2,0,0,-1,0,0,1,-1,2,2,1,-1,0,0,-1,0,1,0,1,0,0,-1,2,1,0,0];
    var mp_lng = [1,-1,0,2,0,0,-2,-1,1,0,-1,0,1,0,1,1,-1,3,-2,-1,0,-1,0,1,2,0,-3,-2,-1,-2,1,0,2,0,-1,1,0,-1,2,-1,1,-2,-1,-1,-2,0,1,4,0,-2,0,2,1,-2,-3,2,1,-1,3,-1];
    var f_lng = [0,0,0,0,0,2,0,0,0,0,0,0,0,-2,2,-2,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,-2,2,0,2,0,0,0,0,0,0,-2,0,0,0,0,-2,-2,0,0,0,0,0,0,0,-2];


    var sin_lng = [6288774,1274027,658314,213618,-185116,-114332,58793,57066,53322,
    45758,-40923,-34720,-30383,15327,-12528,10980,10675,10034,8548,-7888,-6766,
    -5163,4987,4036,3994,3861,3665,-2689,-2602,2390,-2348,2236,-2120,-2069,2048,
    -1773,-1595,1215,-1110,-892,-810,759,-713,-700,691,596,549,537,520,-487,
    -399,-381,351,-340,330,327,-323,299,294,0.0];

    var cos_lng = [-20905355,-3699111,-2955968,-569925,48888,-3149,246158,-152138,
    -170733,-204586,-129620,108743,104755,10321,0,79661,-34782,-23210,-21636,
    24208,30824,-8379,-16675,-12831,-10445,-11650,14403,-7003,0,10056,6322,
    -9884,5751,0,-4950,4130,0,-3958,0,3258,2616,-1897,-2117,2354,0,0,-1423,
    -1117,-1571,-1739,0,-4421,0,0,0,0,1165,0,0,8752.0];


    var d_lat = [0,0,0,2,2,2,2,0,2,0,2,2,2,2,2,2,2,0,4,0,0,0,1,0,0,0,1,0,4,4,0,4,2,2,2,2,0,2,2,2,2,4,2,2,0,2,1,1,0,2,1,2,0,4,4,1,4,1,4,2];
    var m_lat = [0,0,0,0,0,0,0,0,0,0,-1,0,0,1,-1,-1,-1,1,0,1,0,1,0,1,1,1,0,0,0,0,0,0,0,0,-1,0,0,0,0,1,1,0,-1,-2,0,1,1,1,1,1,0,-1,1,0,-1,0,0,0,-1,-2];
    var mp_lat =[0,1,1,0,-1,-1,0,2,1,2,0,-2,1,0,-1,0,-1,-1,-1,0,0,-1,0,1,1,0,0,3,0,-1,1, -2,0,2,1,-2,3,2,-3,-1,0,0,1,0,1,1,0,0,-2,-1,1,-2,2,-2,-1,1,1,-1,0,0];
    var f_lat = [1,1,-1,-1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,-1,-1,1,3,1,1,1,-1,-1,-1,1,-1,1,-3,1,-3,-1,-1,1,-1,1,-1,1,1,1,1,-1,3,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1];

    var sin_lat = [5128122,280602,277693,173237,55413,46271,32573,17198,9266,8822,
    8216,4324,4200,-3359,2463,2211,2065,-1870,1828,-1794,-1749,-1565,-1491,
    -1475,-1410,-1344,-1335,1107,1021,833,777,671,607,596,491,-451,439,422,
    421,-366,-351,331,315,302,-283,-229,223,223,-220,-220,-185,181,-177,176,
    166,-164,132,-119,115,107.0];


    var Lprime =218.3164477 + t*481267.88123421 - t2*0.0015786 + t3*1.0/538841.0 - t4*1.0/(6.5194e7);Lprime=Lprime*dtor;
    var D= 297.8501921 + t*445267.1114034 - t2*0.0018819 + t3*1.0/545868.0 - t4*1.0/(1.13065e8);D=D*dtor;
    var M = 357.5291092 + t*35999.0502909 - t2*0.0001536 + t3*1.0/(2.449e7);M = M*dtor;
    var Mprime = 134.9633964 + t*477198.8675055 + t*t*0.0087414 + t*t*t*1.0/(6.9699e4) - t4*1.0/(1.4712e7);Mprime = Mprime*dtor;
    var F = 93.2720950 + t*483202.0175233 - t2*0.0036539 - t3*1.0/(3.526e7*0+3526000) + t4*1.0/(8.6331e8);F = F*dtor;
    
    var E = 1.0 - 0.002516*t - 7.4e-6*t2;
    var E2 = E*E;

    var A1 = (119.75 + 131.849*t) * dtor;
    var A2 = (53.09 + 479264.290*t) * dtor;
    var A3 = (313.45 + 481266.484*t) * dtor;
    var suml_add = 3958*Math.sin(A1) + 1962*Math.sin(Lprime - F) + 318*Math.sin(A2);
    var sumb_add =  -2235*Math.sin(Lprime) + 382*Math.sin(A3) + 175*Math.sin(A1-F) + 175*Math.sin(A1 + F) + 127*Math.sin(Lprime - Mprime) -115*Math.sin(Lprime + Mprime);

    var dlon=0;
    var drad=0;
    var dlat=0;
    var argumento;
    var corr;

    for (var i=0;i<nvals2;i++) {

        corr=1;
        if (m_lng[i]==1 || m_lng[i]==-1) corr=E;
        if (m_lng[i]==2 || m_lng[i]==-2) corr=E2;

        argumento=D*d_lng[i]+M*m_lng[i]+Mprime*mp_lng[i]+F*f_lng[i];
        dlon+=corr*sin_lng[i]*Math.sin(argumento);
        drad+=corr*cos_lng[i]*Math.cos(argumento);

        corr=1;
        if (m_lat[i]==1 || m_lat[i]==-1) corr=E;
        if (m_lat[i]==2 || m_lat[i]==-2) corr=E2;

        argumento=D*d_lat[i]+M*m_lat[i]+Mprime*mp_lat[i]+F*f_lat[i];
        dlat+=corr*sin_lat[i]*Math.sin(argumento);

    }


    dlon+=suml_add;
    dlat+=sumb_add;

    lonecl_p=Lprime+(dlon/(1e6))*dtor;
    latecl_p=(dlat/(1e6))*dtor;
    r_p=(385000.56+drad/(1e3))/earth_radius;

    var ss=10;

    var cos_lonecl_p=Math.cos(lonecl_p);
    var sin_lonecl_p=Math.sin(lonecl_p);
    var cos_latecl_p=Math.cos(latecl_p);
    var sin_latecl_p=Math.sin(latecl_p);

    //Transformación a coordenadas cartesianas eclípticas
    xh_p = r_p * cos_lonecl_p * cos_latecl_p * ss;
    yh_p = r_p * sin_lonecl_p * cos_latecl_p * ss;
    zh_p = r_p * sin_latecl_p * ss;

    //Cálculo del tiempo sidéreo medio de Greenwich
    GMST=-calc_gmst();
    
    //Transformación al plano del ecuador terrestre
    var cos_ecl=Math.cos(ecl);
    var sin_ecl=Math.sin(ecl);
    var xg_p = xh_p
    var yg_p = yh_p * cos_ecl - zh_p * sin_ecl;
    var zg_p = yh_p * sin_ecl + zh_p * cos_ecl;

    //Rotación respecto al primer meridiano
    var cos_GMST=Math.cos(GMST);
    var sin_GMST=Math.sin(GMST);
    var xe_p=xg_p*cos_GMST-yg_p*sin_GMST;
    var ye_p=xg_p*sin_GMST+yg_p*cos_GMST;
    var ze_p=zg_p;

    moon_xyz=new BABYLON.Vector3(xe_p,ze_p,ye_p);
    
    return moon_xyz;

}


//Cálculo de la posición geocéntrica de La Luna
//respecto al primer meridiano y al plano 
//del ecuador terrestre
//Método de baja precisión
//Aproximación al DE200 Astronomical Almanac 1984
//Error 2' de longitud y latitud eclíptica 1900<fecha<2100
function calc_moon_pos_old() {

    //Días desde el 2000.0
    var d2k=(JD-2451543.5);
    //Oblicuidad de la eclíptica
	var ecl= 23.4393 - 3.563E-7 * d2k;

    ecl=ecl*dtor;

    //Elementos oscultantes de la órbita de La Tierra
    var N_s=0;
    var i_s=0;
    var w_s=180+282.9404 + 4.70935E-5 * d2k;
    var a_s=1.0;
    var e_s=0.016709 - 1.151E-9 * d2k;
    var M_s= 356.0470 + 0.9856002585 * d2k;

    var N_s=N_s*dtor;
    var i_s=i_s*dtor;
    var w_s=w_s*dtor;
    var M_s=M_s*dtor;

    //Elementos oscultatnes de la órbita de La Luna
    var N_p=125.1228 - 0.0529538083 * d2k;
    var i_p=5.1454;
    var w_p=318.0634 + 0.1643573223 * d2k;
    var a_p=60.2666;
    var e_p=0.054900;
    var M_p=115.3654 + 13.0649929509 * d2k;

    N_p=N_p*dtor;
    i_p=i_p*dtor;
    w_p=w_p*dtor;
    M_p=M_p*dtor;

    //Solución iterativa de la ecuación de Kepler
    //Condición inicial (método de iteración de un punto)
    var E_p=M_p+e_p*Math.sin(M_p)*(1+e_p*Math.cos(M_p));

    //Itera hasta que la diferencia sea menor de 1e-6 Radianes
    //Si la excentricidad<0.5 basta con 10 iteraciones
    for (var k=1;k<10;k++) {
        E_p=E_p-(E_p-e_p*Math.sin(E_p)-M_p)/(1-e_p*Math.cos(E_p));
    }

    //Posición de La Luna en el plano de la órbita
    var xv_p=a_p*(Math.cos(E_p)-e_p);
    var yv_p=a_p*(Math.sqrt(1.0-e_p*e_p)*Math.sin(E_p));

    //Anomalía verdadera y distancia a La Tierra
    var v_p=Math.atan2(yv_p,xv_p);
    var r_p=Math.sqrt(xv_p*xv_p+yv_p*yv_p);

    var cos_N_pe=Math.cos(N_p);
    var sin_N_pe=Math.sin(N_p);
    var cos_v_w_pe=Math.cos(v_p+w_p);
    var sin_v_w_pe=Math.sin(v_p+w_p);
    var cos_i_pe=Math.cos(i_p);
    var sin_i_pe=Math.sin(i_p);

    //Transformaciones de rotación en función de los
    //ángulos de orientación de la órbita
    var xh_p = r_p * ( cos_N_pe * cos_v_w_pe - sin_N_pe * sin_v_w_pe * cos_i_pe );
    var yh_p = r_p * ( sin_N_pe * cos_v_w_pe + cos_N_pe * sin_v_w_pe * cos_i_pe );
    var zh_p = r_p * ( sin_v_w_pe * sin_i_pe );

    //Transformación a coordenadas eclípticas geocénctricas
    var lonecl_p=Math.atan2(yh_p,xh_p);
    var latecl_p=Math.atan2(zh_p,Math.sqrt(xh_p*xh_p+yh_p*yh_p));

    var Mm=M_p;
    var Ms=M_s;
    var ws=w_s;
    var wm=w_p;
    var Nm=N_p;

    var Ls=Ms+ws;
    var Lm=Mm+wm+Nm;
    var D=Lm-Ls;
    var D2=2*D;
    var F=Lm-Nm;

    //Correciones en longitud eclíptica para La Luna
    var lon_m_corr=0;
    lon_m_corr=lon_m_corr-1.274 * Math.sin(Mm - D2);
    lon_m_corr=lon_m_corr+0.658 * Math.sin(D2);
    lon_m_corr=lon_m_corr-0.186 * Math.sin(Ms);
    lon_m_corr=lon_m_corr-0.059 * Math.sin(2*Mm - D2);
    lon_m_corr=lon_m_corr-0.057 * Math.sin(Mm - D2 + Ms);
    lon_m_corr=lon_m_corr+0.053 * Math.sin(Mm + D2);
    lon_m_corr=lon_m_corr+0.046 * Math.sin(D2 - Ms);
    lon_m_corr=lon_m_corr+0.041 * Math.sin(Mm - Ms);
    lon_m_corr=lon_m_corr-0.035 * Math.sin(D);
    lon_m_corr=lon_m_corr-0.031 * Math.sin(Mm + Ms);
    lon_m_corr=lon_m_corr-0.015 * Math.sin(2*F - D2);
    lon_m_corr=lon_m_corr+0.011 * Math.sin(Mm - 4*D);

    //Correciones en latitud eclíptica para La Luna
    var lat_m_corr=0;
    lat_m_corr=lat_m_corr-0.173 * Math.sin(F - D2);
    lat_m_corr=lat_m_corr-0.055 * Math.sin(Mm - F - D2);
    lat_m_corr=lat_m_corr-0.046 * Math.sin(Mm + F - D2);
    lat_m_corr=lat_m_corr+0.033 * Math.sin(F + D2);
    lat_m_corr=lat_m_corr+0.017 * Math.sin(2*Mm + F);

    //Correciones en la distancia geocéntrica para La Luna
    var r_m_corr=0;
    r_m_corr=r_m_corr-0.58 * Math.cos(Mm - D2);
    r_m_corr=r_m_corr-0.46 * Math.cos(D2);

    lonecl_p=lonecl_p+lon_m_corr*dtor;
    latecl_p=latecl_p+lat_m_corr*dtor;
    r_p=r_p+r_m_corr;

    //Factor de escala
    var ss=10;

    var cos_lonecl_p=Math.cos(lonecl_p);
    var sin_lonecl_p=Math.sin(lonecl_p);
    var cos_latecl_p=Math.cos(latecl_p);
    var sin_latecl_p=Math.sin(latecl_p);

    //Transformación a coordenadas cartesianas eclípticas
    xh_p = r_p * cos_lonecl_p * cos_latecl_p * ss;
    yh_p = r_p * sin_lonecl_p * cos_latecl_p * ss;
    zh_p = r_p * sin_latecl_p * ss;

    //Cálculo del tiempo sidéreo medio de Greenwich
    GMST=-calc_gmst();
    
    //Transformación al plano del ecuador terrestre
    var cos_ecl=Math.cos(ecl);
    var sin_ecl=Math.sin(ecl);
    var xg_p = xh_p
    var yg_p = yh_p * cos_ecl - zh_p * sin_ecl;
    var zg_p = yh_p * sin_ecl + zh_p * cos_ecl;

    //Rotación respecto al primer meridiano
    var cos_GMST=Math.cos(GMST);
    var sin_GMST=Math.sin(GMST);
    var xe_p=xg_p*cos_GMST-yg_p*sin_GMST;
    var ye_p=xg_p*sin_GMST+yg_p*cos_GMST;
    var ze_p=zg_p;

    moon_xyz=new BABYLON.Vector3(xe_p,ze_p,ye_p);
    
    return moon_xyz;
}

//Cálculo de la posición y tamaño de la
//sombra de La Tierra
function calc_earth_shadow() {

    var sun_pos1=sun_pos.subtract(zero);
    var moon_pos1=moon_pos.subtract(zero);

    var sun_distance=BABYLON.Vector3.Distance(sun_pos1,zero);
    var moon_distance=BABYLON.Vector3.Distance(moon_pos1,zero);

    var Rs=r*109.30;
    var Rt=r;

    var alpha=Math.atan((Rs-Rt)/sun_distance);
    umbra_size=Rt-moon_distance*Math.tan(alpha);

    var sev=sun_pos1.normalize();
    sev=sev.scale(-1*moon_distance);

    var umbra_start_pos=sev.scale(0.985);
    var umbra_end_pos=sev.scale(0.99);

    umbra_pos=[umbra_start_pos,umbra_end_pos];

    var beta=Math.atan((Rs+Rt)/sun_distance);
    penumbra_size=Rt+moon_distance*Math.tan(beta);

}


//Función de Gudermann
var gdf=function(xx) {
    return Math.atan(Math.sinh(xx));
}

//Función de Gudermann inversa
var agdf=function(xx) {
    return Math.atanh(Math.sin(xx));
}

//Transformación a coordenadas cartersianas
//sobre la esfera
var rlatlon_to_xyz=function(fun_r,fun_lat,fun_lon,fun_h) {

	fun_r=fun_r+fun_h/1000.0/factor_de_escala_sp;
    var cos_fun_lat=Math.cos(fun_lat);
    var fun_x=fun_r*Math.cos(fun_lon)*cos_fun_lat;
    var fun_z=fun_r*Math.sin(fun_lon)*cos_fun_lat;
    var fun_y=fun_r*Math.sin(fun_lat);

    var fun_v=new BABYLON.Vector3(fun_x,fun_y,fun_z);
    return fun_v;
}

//Transformación a coordenadas cartersianas
//sobre la tierra plana
var rlatlon_to_xyz_fe=function(fun_r,fun_lat,fun_lon,fun_h) {

    fun_h=fun_h/1000.0/factor_de_escala_sp;
    var fun_arg=2*fun_r*(-fun_lat+Math.PI/2)/Math.PI;
    var fun_v1x=fe_pos.x+Math.cos(fun_lon)*fun_arg;
    var fun_v1y=fe_pos.y+height_fe+fun_h;
    var fun_v1z=fe_pos.z+Math.sin(fun_lon)*fun_arg;

    fun_v1fe=new BABYLON.Vector3(fun_v1x,fun_v1y,fun_v1z);
    return fun_v1fe;
}

//Cálculo del vector local norte
function local_north_vector(latf,lonf,par,inv_yz) {

    var dhyp_lat=-1/Math.PI*(1-par)-par*Math.sin(latf);
    //var hyp=(-(latf-Math.PI/2)/Math.PI)*(1-par)+par*Math.cos(latf);

    var unx=dhyp_lat*Math.cos(lonf);
    var uny=dhyp_lat*Math.sin(lonf);
    var unz=par*Math.cos(latf*par);
    
    if (inv_yz==1) {
        return new BABYLON.Vector3(unx,unz,uny);
    } else {
        return new BABYLON.Vector3(unx,uny,unz);
    }
}

//Cálculo del vector local este
function local_east_vector(latf,lonf,par,inv_yz) {

    //var dhyp_lat=-1/Math.PI*(1-par)-par*Math.sin(latf);
    var hyp=(-(latf-Math.PI/2)/Math.PI)*(1-par)+par*Math.cos(latf);
    
    var uex=-hyp*Math.sin(lonf);
    var uey=hyp*Math.cos(lonf);
    var uez=0;

    if (inv_yz==1) {
        return new BABYLON.Vector3(uex,uez,uey);
    } else {
        return new BABYLON.Vector3(uex,uey,uez);
    }

}

//Cálculo de una dirección usando la base del sistema
//de referencia local, la altura y el azimuth
//Opcionalmente permuta los valores de z e y
function local_altaz_to_xyz(un,ue,ur,alt,az,inv_yz) {

    var cos_alt=Math.cos(alt*dtor);
    var sin_alt=Math.sin(alt*dtor);
    var cos_az=Math.cos(az*dtor);
    var sin_az=Math.sin(az*dtor);

    //Vector de orientación de La Luna respecto de la posición 1 sobre la TP
    var x1=un.x*cos_alt*cos_az+ue.x*cos_alt*sin_az+ur.x*sin_alt;
    var y1=un.y*cos_alt*cos_az+ue.y*cos_alt*sin_az+ur.y*sin_alt;
    var z1=un.z*cos_alt*cos_az+ue.z*cos_alt*sin_az+ur.z*sin_alt;
    
    if (inv_yz==0) {
        var result=new BABYLON.Vector3(x1,y1,z1);
    } else {
        var result=new BABYLON.Vector3(x1,z1,y1);
    }

    return result;
}

//Rotación de un vector respecto de un eje
//Grupo de simetría SO(3)
function so3_rotation(axis,angle,v) {

    var axis1=axis.subtract(zero);
    axis1.normalize();

    var x=axis1.x;
    var y=axis1.y;
    var z=axis1.z;

    var c=Math.cos(angle);
    var s=Math.sin(angle);
    var ic=1-c;

    var m11=x*x*ic+c;   var m12=x*y*ic-z*s; var m13=x*z*ic+y*s;
    var m21=x*y*ic+z*s; var m22=y*y*ic+c;   var m23=y*z*ic-x*s;
    var m31=z*x*ic-y*s; var m32=z*y*ic+x*s; var m33=z*z*ic+c;

    var rx=m11*v.x+m12*v.y+m13*v.z;
    var ry=m21*v.x+m22*v.y+m23*v.z;
    var rz=m31*v.x+m32*v.y+m33*v.z;

    return new BABYLON.Vector3(rx,ry,rz);

}

//Cálculo de la ortodrómica, loxodrómica,
//flatodrómica y equiangular y proyección
//sobre la esfera y la tierra plana
var calculate_lines=function() {

    //Vectores de posición sobre la esfera
    var v1=pos1.subtract(zero);
    var v2=pos2.subtract(zero);

    base_line=BABYLON.Vector3.Distance(v1,v2)/r*earth_radius;

    v1.normalize();
    v2.normalize();

    var v1v2=v1.x*v2.x+v1.y*v2.y+v1.z*v2.z;

    //Cálculos ortodrómicos
    //Ángulo entre ambas posiciones
    var angulo=Math.acos(v1v2);
    var angulo_o=angulo*1.0;
    distancia_sp=angulo*earth_radius;
    orthodromic_angle=angulo/dtor;
    
    //Cálculo del plano que contiene
    //Las posiciones y el centro
    var h=v1.cross(v2);
    h.normalize();

    //Eje accesorio
    var v2p=h.cross(v1);
    v2p.normalize();

    //Cálculos de loxodrómicos
    var lat01=Math.asin(v1.y);
    var lon01=Math.atan2(v1.z,v1.x);
    var lat02=Math.asin(v2.y);
    var lon02=Math.atan2(v2.z,v2.x);

    //Diferencia de latitud y longitud
    //entre las posiciones inicial y final
    delta_lat=lat02-lat01;
    delta_lon=lon02-lon01;

    //Acotación  y corrección 
    //de la diferencia en longitud
    dl=delta_lon;
    if (delta_lon>Math.PI) dl=-(2*Math.PI-delta_lon);
    if (delta_lon<-Math.PI) dl=2*Math.PI+delta_lon;    
    delta_lon=dl;

    //Cálculo del rumbo loxodrómico
    //basado en la función de Gundermann
    var bear=Math.atan2(delta_lon,(agdf(lat02)-agdf(lat01)));

    //Cálculos flatodrómicos
    //Vectore de posición de los puntos
    v1fe=rlatlon_to_xyz_fe(rfe,lat01,lon01,h1);
    v2fe=rlatlon_to_xyz_fe(rfe,lat02,lon02,h2);

    //Distancia mínima entre los puntos
    //en la tierra plana
    dist_fe=BABYLON.Vector3.Distance(v1fe,v2fe);
    dv=v2fe.subtract(v1fe);
    dv.normalize();

    //Cálculos equiangulares
    //Transformación de los puntos sobre la tierra
    //plana a coordenadas polares
    pr1=2*rfe*(-lat01+Math.PI/2)/Math.PI;
    pt1=lon01;

    pr2=2*rfe*(-lat02+Math.PI/2)/Math.PI;
    pt2=lon02;

    //Constantes de la espiral equiangular
    p_especial=0;
    p_beta=Math.log(pr2/pr1)/(delta_lon);
    p_alpha=pr1/Math.exp(p_beta*pt1);
    if (pr1==pr2) p_beta=0;
    if (pt1==pt2) p_especial=1;

    //Borra los cálculos anteriores de distancia
    //usando segmentos
    distancia_sp_suma=0;
    distancia_fe_suma=0;
    distancia_sp_lox_suma=0;
    distancia_fe_lox_suma=0;
    distancia_fe_flat_suma=0;
    distancia_sp_flat_suma=0;
    distancia_sp_eqac_suma=0;
    distancia_fe_eqac_suma=0;

    es_posible_calc_dist_fe=1;
    for (var i=0;i<ndiv+1;i++) {

        var inc=i/(ndiv*1.0);

        //Línea ortodrómica sobre la esfera
        ang1=angulo*inc;

        cos_ang1=Math.cos(ang1);
        sin_ang1=Math.sin(ang1);

        dx=rdeltar*(v1.x*cos_ang1+v2p.x*sin_ang1);
        dy=rdeltar*(v1.y*cos_ang1+v2p.y*sin_ang1);
        dz=rdeltar*(v1.z*cos_ang1+v2p.z*sin_ang1);

        line_data[i]=new BABYLON.Vector3(dx,dy,dz);

        //Línea ortodrómica sobre la tierra plana        
        var lat_sp=Math.asin(dy/(rdeltar));
        var lon_sp=Math.atan2(dz,dx);

        //Si la línea pasa cerca de la latitud -90º
        //se indica que el cálculo de la distancia
        //en la tierra plana carece de sentido
        if (lat_sp<-Math.PI/2*0.98) es_posible_calc_dist_fe=0;

        line_data_fe[i]=rlatlon_to_xyz_fe(rfe,lat_sp,lon_sp,1e4);
        
        if (lat_sp<-Math.PI/2*0.98 && i>0 && i<ndiv)  line_data_fe[i]=nan.subtract(zero);
        
        //Línea loxodrómica sobre la esfera
        var lon_sp2=lon01+delta_lon*inc;
        var lat_sp2=gdf(agdf(lat01)+(1/Math.tan(bear))*delta_lon*inc);

        line_data_lox[i]=rlatlon_to_xyz(rdeltar,lat_sp2,lon_sp2,0);
        line_data_lox_fe[i]=rlatlon_to_xyz_fe(rfe,lat_sp2,lon_sp2,1e4);

        //Línea flatodrómica sobre la tierra plana
        dx4=v1fe.x+dv.x*dist_fe*inc;  
        dy4=v1fe.y+dv.y*dist_fe*inc+fe_h/3;
        dz4=v1fe.z+dv.z*dist_fe*inc;
        
        line_data_flat_fe[i]=new BABYLON.Vector3(dx4,dy4,dz4);

        //Línea flatodrómica sobre la esfera
        dc=BABYLON.Vector3.Distance(fe_pos,new BABYLON.Vector3(dx4,0,dz4));
        lat_sp3=Math.PI*(0.5-dc/(2*rfe));
        dx5=dx4-fe_pos.x;
        dz5=dz4-fe_pos.z;
        lon_sp3=Math.atan2(dz5,dx5);

        line_data_flat_sp[i]=rlatlon_to_xyz(rdeltar,lat_sp3,lon_sp3,0);

        //Línea equiangular sobre la tierra plana
        pt3=pt1+delta_lon*inc;
        pr3=p_alpha*Math.exp(p_beta*pt3);
        if (p_especial==1) pr3=pr1+(pr2-pr1)*inc;

        var dx7=fe_pos.x+pr3*Math.cos(pt3);
        var dy7=fe_pos.y+fe_pos.y+fe_h*2;
        var dz7=fe_pos.z+pr3*Math.sin(pt3);

        line_data_eqac_fe[i]=new BABYLON.Vector3(dx7,dy7,dz7);

        //Línea equiangular sobre la esfera
        dc2=BABYLON.Vector3.Distance(fe_pos,new BABYLON.Vector3(dx7,0,dz7));
        lat_sp4=Math.PI*(0.5-dc2/(2*rfe));
        dx8=dx7-fe_pos.x;
        dz8=dz7-fe_pos.z;
        lon_sp4=Math.atan2(dz8,dx8);

        line_data_eqac_sp[i]=rlatlon_to_xyz(rdeltar,lat_sp4,lon_sp4,0);

        //Distancias calculadas mediante suma de segmentos
        if (i>0) {

            distancia_sp_suma+=BABYLON.Vector3.Distance(line_data[i-1],line_data[i])
            distancia_fe_suma+=BABYLON.Vector3.Distance(line_data_fe[i-1],line_data_fe[i]);
            distancia_sp_lox_suma+=BABYLON.Vector3.Distance(line_data_lox[i-1],line_data_lox[i])
            distancia_fe_lox_suma+=BABYLON.Vector3.Distance(line_data_lox_fe[i-1],line_data_lox_fe[i]);
            distancia_fe_flat_suma+=BABYLON.Vector3.Distance(line_data_flat_fe[i-1],line_data_flat_fe[i]);
            distancia_sp_flat_suma+=BABYLON.Vector3.Distance(line_data_flat_sp[i-1],line_data_flat_sp[i]);
            distancia_fe_eqac_suma+=BABYLON.Vector3.Distance(line_data_eqac_fe[i-1],line_data_eqac_fe[i]);
            distancia_sp_eqac_suma+=BABYLON.Vector3.Distance(line_data_eqac_sp[i-1],line_data_eqac_sp[i]);

            dist_orto[i]=distancia_sp_suma*factor_de_escala_sp;
            dist_loxo[i]=distancia_sp_lox_suma*factor_de_escala_sp;
            dist_flat[i]=distancia_sp_flat_suma*factor_de_escala_sp;
            dist_eqac[i]=distancia_sp_eqac_suma*factor_de_escala_sp;

            dist_orto_fe[i]=distancia_fe_suma*factor_de_escala_fe;
            dist_loxo_fe[i]=distancia_fe_lox_suma*factor_de_escala_fe;
            dist_flat_fe[i]=distancia_fe_flat_suma*factor_de_escala_fe;
            dist_eqac_fe[i]=distancia_fe_eqac_suma*factor_de_escala_fe;

        }
    }

    dist_orto[0]=0;
    dist_loxo[0]=0;
    dist_flat[0]=0;
    dist_eqac[0]=0;
    dist_orto_fe[0]=0;
    dist_loxo_fe[0]=0;
    dist_flat_fe[0]=0;
    dist_eqac_fe[0]=0;
    
    //Escalado de las distancias
    distancia_sp_suma*=factor_de_escala_sp;
    distancia_fe_suma*=factor_de_escala_fe;
    distancia_sp_lox_suma*=factor_de_escala_sp;
    distancia_fe_lox_suma*=factor_de_escala_fe;
    distancia_sp_flat_suma*=factor_de_escala_sp;
    distancia_fe_flat_suma*=factor_de_escala_fe;
    distancia_fe_eqac_suma*=factor_de_escala_fe;
    distancia_sp_eqac_suma*=factor_de_escala_sp;

    //Correción de distancias para el método
    //basado en suma de segmentos
    //(innecesario si ndiv>1000)
    distancia_sp_suma=distancia_sp;
    if (lat01!=lat02) {
        var distancia_loxo_real=earth_radius*(lat02-lat01)/Math.cos(bear);
    } else {
        var distancia_loxo_real=suma=earth_radius*(delta_lon)*Math.cos(lat1);
    }

    var distancia_orto_real=distancia_sp;
    var corrige_loxo=0;
    if (distancia_sp>distancia_sp_lox_suma) corrige_loxo=1;

    for (var i=0;i<ndiv+1;i++) {

        dist_orto[i]=dist_orto[i]/distancia_sp_suma*distancia_orto_real;
        
        if (corrige_loxo==1) {
            dist_loxo[i]=dist_loxo[i]/distancia_sp_lox_suma*distancia_orto_real;
            dist_eqac[i]=dist_eqac[i]/distancia_sp_eqac_suma*distancia_orto_real;
        }

    }

    if (corrige_loxo==1) {
        distancia_sp_lox_suma=distancia_orto_real;
        distancia_sp_eqac_suma=distancia_orto_real;
    }

    //Si el cálculo de distancia sobre la tierra plana carece de sentido
    if (es_posible_calc_dist_fe==0) {
        distancia_fe_suma=0;
        //distancia_fe_lox_suma=0;
    }
    //Si el cálculo de distancia sobre la tierra plana
    //tiene algún otro error
    if (isNaN(distancia_fe_suma)) distancia_fe_suma=0;
    if (isNaN(distancia_fe_lox_suma)) distancia_fe_lox_suma=0;

    //Posición del Sol y ubicación donde es cenital
    sun_pos=calc_sun_pos();
    sun_sphere_pos.copyFrom(sun_pos);
    sun_sphere_pos.normalize();
    sun_latc=Math.asin(sun_sphere_pos.y);
    sun_lonc=Math.atan2(sun_sphere_pos.z,sun_sphere_pos.x);
    sun_fe_pos=rlatlon_to_xyz_fe(rfe,sun_latc,sun_lonc,0);

    sun_sphere_pos.scaleInPlace(r);

    //Distancia Tierra-Sol
    sun_earth_distance=BABYLON.Vector3.Distance(sun_pos,zero)*earth_radius/10.0;

    //Líneas de cada ubicación y el centro
    //hasta El Sol
    sun_line_data_1=[pos1,sun_pos];
    sun_line_data_2=[pos2,sun_pos];
    sun_line_data_c=[zero,sun_pos];

    //Posición de La Luna
    moon_pos=calc_moon_pos();

    //Distancia Tierra-Luna
    moon_earth_distance=BABYLON.Vector3.Distance(moon_pos,zero)*earth_radius/10.0;

    //Líneas de cada ubicación y el centro
    //hasta La Luna
    moon_line_data_1=[pos1,moon_pos];
    moon_line_data_2=[pos2,moon_pos];
    moon_line_data_c=[zero,moon_pos];

    //Ubicación donde la Luna es cenital
    moon_sphere_pos.copyFrom(moon_pos);
    moon_sphere_pos.normalize();

    //Latitud y longitud de la ubicación
    //donde La Luna es cnital
    moon_latc=Math.asin(moon_sphere_pos.y);
    moon_lonc=Math.atan2(moon_sphere_pos.z,moon_sphere_pos.x);

    //Ubicación sobre la TP donde La Luna es cenital
    moon_fe_pos=rlatlon_to_xyz_fe(rfe,moon_latc,moon_lonc,0);
    
    moon_sphere_pos.scaleInPlace(r);

    //Línea de dirección entre el las posiciones
    //en las que El Sol y La Luna son cenitales
    // y proyección sobre la esfera
    var sumovec_sp=moon_sphere_pos.subtract(sun_sphere_pos);
    sumovec_sp.normalize();
    sumopos_sp=[sun_sphere_pos,sun_sphere_pos.add(sumovec_sp.scale(20))];

    var sumovec_fe=moon_fe_pos.subtract(sun_fe_pos);
    sumovec_fe.normalize();
    sumopos_fe=[sun_fe_pos,sun_fe_pos.add(sumovec_fe.scale(20))];

    var sumonor_sp=sun_sphere_pos.cross(moon_sphere_pos);
    sumonor_sp.normalize();
    var sumoaux=sumonor_sp.cross(sun_sphere_pos);
    sumoaux.normalize();
    var sumox=sun_sphere_pos.subtract(zero);
    sumox.normalize();

    sumopro_sp=[];
    for (var i=0;i<10;i++) {

        var sumoang=i/10*Math.PI/2.0;

        var cos_sumoang=Math.cos(sumoang);
        var sin_sumoang=Math.sin(sumoang);

        sumopro_sp[i]=new BABYLON.Vector3(

            1.01*rdeltar*(sumox.x*cos_sumoang+sumoaux.x*sin_sumoang),
            1.01*rdeltar*(sumox.y*cos_sumoang+sumoaux.y*sin_sumoang),
            1.01*rdeltar*(sumox.z*cos_sumoang+sumoaux.z*sin_sumoang),
        );

    }
    //

    //Fase lunar - !!!!!!DEPRECATED!!!!!!
    var mf_sp=new BABYLON.Vector3(0,0,0);
    var mf_mp=new BABYLON.Vector3(0,0,0);
    mf_sp.copyFrom(sun_pos);
    mf_mp.copyFrom(moon_pos);
    mf_sp.normalize();
    mf_mp.normalize();
    mf_ang=Math.acos(BABYLON.Vector3.Dot(mf_sp,mf_mp))/dtor;
    var mf_cp=BABYLON.Vector3.Cross(mf_sp,mf_mp);
    mf_sgn=1;
    if (mf_cp.y>0) mf_sgn=-1;

    //par=1 -> TG
    //par0  -> TP
    var par=1;

    //Sistema de refenrencia local sobre la TG de la Ubicación 2
    //-----------------------------------------------------------

    //Componente norte del sistema de referencia local
    var ori_un2=local_north_vector(lat02,lon02,1,1);
    ori_un2.normalize();
    
    //Componente este del sistema de referencia local
    var ori_ue2=local_east_vector(lat02,lon02,1,1);
    ori_ue2.normalize();
    
    //Componente radial del sistema de referencia local    
    ori_ur2=ori_un2.cross(ori_ue2);

    //Sistema de referencia local sobre la TG de la Ubicación 1
    //----------------------------------------------------------

    //Componente norte del sistema de referencia local
    var ori_un1=local_north_vector(lat01,lon01,1,1);
    ori_un1.normalize();
    
    //Componente este del sistema de referencia local
    var ori_ue1=local_east_vector(lat01,lon01,1,1);
    ori_ue1.normalize();

    //Componente radial del sistema de referencia local    
    ori_ur1=ori_un1.cross(ori_ue1);

    //Vectores desde cada ubicación a La Luna
    var moon_pos1=moon_pos.subtract(zero);
    var moon_pos2=moon_pos.subtract(zero);
    
    moon_pos1=moon_pos1.subtract(pos1);
    moon_pos2=moon_pos2.subtract(pos2);
    moon_pos1.normalize();
    moon_pos2.normalize();

    //Vectores desde cada ubicación al Sol
    var sun_pos1=sun_pos.subtract(zero);
    var sun_pos2=sun_pos.subtract(zero);
    
    sun_pos1=sun_pos1.subtract(pos1);
    sun_pos2=sun_pos2.subtract(pos2);
    sun_pos1.normalize();
    sun_pos2.normalize();

    //Paralaje de La Luna respecto a las ubicaciones
    moon_paralax=Math.acos(BABYLON.Vector3.Dot(moon_pos1,moon_pos2))/dtor;    

    //Paralaje del Sol respecto a las ubicaciones
    sun_paralax=Math.acos(BABYLON.Vector3.Dot(sun_pos1,sun_pos2))/dtor;    
    
    //Proyección de la posición de los vectores
    //de posición sobre los sistemas de referencia
    //local de las ubicaciones
    var moon_un1=BABYLON.Vector3.Dot(moon_pos1,ori_un1);
    var moon_ue1=BABYLON.Vector3.Dot(moon_pos1,ori_ue1);
    var moon_ur1=BABYLON.Vector3.Dot(moon_pos1,ori_ur1);

    var moon_un2=BABYLON.Vector3.Dot(moon_pos2,ori_un2);
    var moon_ue2=BABYLON.Vector3.Dot(moon_pos2,ori_ue2);
    var moon_ur2=BABYLON.Vector3.Dot(moon_pos2,ori_ur2);

    var sun_un1=BABYLON.Vector3.Dot(sun_pos1,ori_un1);
    var sun_ue1=BABYLON.Vector3.Dot(sun_pos1,ori_ue1);
    var sun_ur1=BABYLON.Vector3.Dot(sun_pos1,ori_ur1);

    var sun_un2=BABYLON.Vector3.Dot(sun_pos2,ori_un2);
    var sun_ue2=BABYLON.Vector3.Dot(sun_pos2,ori_ue2);
    var sun_ur2=BABYLON.Vector3.Dot(sun_pos2,ori_ur2);
    
    //Control del error en vectores puramente radiales
    if (sun_ur1>1) sun_ur1=1;
    if (sun_ur2>1) sun_ur2=1;
    if (moon_ur1>1) moon_ur1=1;
    if (moon_ur2>1) moon_ur2=1;

    //Elevación y azimut de La Luna desde las ubicaciones
    moon_alt1=Math.asin(moon_ur1);
    moon_az1=Math.atan2(moon_ue1,moon_un1);
    moon_alt2=Math.asin(moon_ur2);
    moon_az2=Math.atan2(moon_ue2,moon_un2);

    sun_alt1=Math.asin(sun_ur1);
    sun_az1=Math.atan2(sun_ue1,sun_un1);
    sun_alt2=Math.asin(sun_ur2);
    sun_az2=Math.atan2(sun_ue2,sun_un2);

    //Corrección de la altura del Sol y La Luna
    //En función de la altura del observador
    moon_alt1_co=moon_alt1+h1_alt_co;
    moon_alt2_co=moon_alt2+h2_alt_co;
    sun_alt1_co=sun_alt1+h1_alt_co;
    sun_alt2_co=sun_alt2+h2_alt_co;

    //Correción de azimut (siempre >0 y <360)
    if (moon_az1<0) moon_az1=moon_az1+2*Math.PI;
    if (moon_az2<0) moon_az2=moon_az2+2*Math.PI;

    if (sun_az1<0) sun_az1=sun_az1+2*Math.PI;
    if (sun_az2<0) sun_az2=sun_az2+2*Math.PI;

    //Distancia de la línea base de las ubicaciones
    moon_bl=BABYLON.Vector3.Distance(pos1,pos2)/(rdeltar)*earth_radius;

    //Rumbo de la ortodroma entre las ubicaciones cuando pasa por la 1
    var qy = Math.sin(lon02-lon01) * Math.cos(lat02);
    var qx = Math.cos(lat01)*Math.sin(lat02) -
          Math.sin(lat01)*Math.cos(lat02)*Math.cos(lon02-lon01);
    var qtheta = Math.atan2(qy, qx);
    moon_bear1 = (qtheta*180/Math.PI + 360) % 360;

    //Rumbo de la ortodroma entre las ubicaciones cuando pasa por la 2
    qy = Math.sin(lon01-lon02) * Math.cos(lat01);
    qx = Math.cos(lat02)*Math.sin(lat01) -
          Math.sin(lat02)*Math.cos(lat01)*Math.cos(lon01-lon02);
    qtheta = Math.atan2(qy, qx);
    moon_bear2 = (qtheta*180/Math.PI + 360) % 360;

    //Los usuarios oservan la misma estrella 
    if (usuario_mira_estrella==1) {

        var GMST_0=calc_gmst();
        var LST_1=GMST_0+lon1;
        var LST_2=GMST_0+lon2;
        var HA_1=LST_1-user_ra/24*2*Math.PI;
        var HA_2=LST_2-user_ra/24*2*Math.PI;

        var xus1=Math.cos(HA_1)*Math.cos(user_dec*dtor);
        var yus1=Math.sin(HA_1)*Math.cos(user_dec*dtor);
        var zus1=Math.sin(user_dec*dtor);

        var xhor1=xus1*Math.sin(lat1)-zus1*Math.cos(lat1);
        var yhor1=yus1;
        var zhor1=xus1*Math.cos(lat1)+zus1*Math.sin(lat1);

        user_az_1=(Math.atan2(yhor1,xhor1)+Math.PI)/dtor;
        user_alt_1=Math.asin(zhor1)/dtor;
        user_alt_1_co=user_alt_1*1.0;

        var xus2=Math.cos(HA_2)*Math.cos(user_dec*dtor);
        var yus2=Math.sin(HA_2)*Math.cos(user_dec*dtor);
        var zus2=Math.sin(user_dec*dtor);

        var xhor2=xus2*Math.sin(lat2)-zus2*Math.cos(lat2);
        var yhor2=yus2;
        var zhor2=xus2*Math.cos(lat2)+zus2*Math.sin(lat2);

        user_az_2=(Math.atan2(yhor2,xhor2)+Math.PI)/dtor;
        user_alt_2=Math.asin(zhor2)/dtor;
        user_alt_2_co=user_alt_2*1.0;

        //console.log(user_alt_1,user_az_1);
        //console.log(user_alt_2,user_az_2);

    }


    //Cálculo de las líneas de observación de usuario
    //sobre la esfera
    //-------------------------------------------------
    var user1=local_altaz_to_xyz(ori_un1,ori_ue1,ori_ur1,user_alt_1,user_az_1,0);
    user1.normalize();
    user1.scaleInPlace(user_line_size);
    user_data_line_1=[pos1,pos1.add(user1)];

    var user2=local_altaz_to_xyz(ori_un2,ori_ue2,ori_ur2,user_alt_2,user_az_2,0);
    user2.normalize();
    user2.scaleInPlace(user_line_size);
    user_data_line_2=[pos2,pos2.add(user2)];

    //--------------------------------------------------

    //Cálculo de los sistemas de referencia
    //local sobre la tierra plana
    //-------------------------------------

    //Opción de tierra plana
    var par=0;

    //Sistema de refencia local sobre la TP de la ubicación 2
    //-------------------------------------------------------

    //Componente norte del sistema de referencia local
    var fe_un2=local_north_vector(lat02,lon02,0,0);
    fe_un2.normalize();
    
    //Componente este del sistema de referencia local
    var fe_ue2=local_east_vector(lat02,lon02,0,0);
    fe_ue2.normalize();
    
    //Componente radial del sistema de referencia local TP   
    fe_ur2=fe_ue2.cross(fe_un2);
    fe_ur2.normalize();

    //Sistema de referencia local sobre la TP de la ubicación 1
    //--------------------------------------------------------------
    
    //Componente norte del sistema de referencia local
    var fe_un1=local_north_vector(lat01,lon01,0,0);
    fe_un1.normalize();
    
    //Componente este del sistema de referencia local
    var fe_ue1=local_east_vector(lat01,lon01,0,0);
    fe_ue1.normalize();

    //Componente radial del sistema de referencia local    
    fe_ur1=fe_ue1.cross(fe_un1);
    fe_ur1.normalize();

    //Direcciones de observación de La Luna sobre la TP
    var fe_moon1=local_altaz_to_xyz(fe_un1,fe_ue1,fe_ur1,moon_alt1/dtor,moon_az1/dtor,1);
    var fe_moon2=local_altaz_to_xyz(fe_un2,fe_ue2,fe_ur2,moon_alt2/dtor,moon_az2/dtor,1);

    //Direcciones de observación del Sol sobre la TP
    var fe_sun1=local_altaz_to_xyz(fe_un1,fe_ue1,fe_ur1,sun_alt1/dtor,sun_az1/dtor,1);
    var fe_sun2=local_altaz_to_xyz(fe_un2,fe_ue2,fe_ur2,sun_alt2/dtor,sun_az2/dtor,1);

    //Normalización de los vectores de dirección
    fe_moon1.normalize();
    fe_moon2.normalize();

    fe_sun1.normalize();
    fe_sun2.normalize();

    //Cálculo de las líneas de observación de usuario
    //sobre el disco
    //-------------------------------------------------

    //Dirección de observación del usuario 1 sobre el disco
    var fe_user1=local_altaz_to_xyz(fe_un1,fe_ue1,fe_ur1,user_alt_1,user_az_1,1);
    fe_user1.normalize();
    fe_user1.scaleInPlace(user_line_size);
    fe_user_data_line_1=[pos3,pos3.add(fe_user1)];

    //Dirección de observación del usuario 1 sobre el disco
    var fe_user2=local_altaz_to_xyz(fe_un2,fe_ue2,fe_ur2,user_alt_2,user_az_2,1);
    fe_user2.normalize();
    fe_user2.scaleInPlace(user_line_size);
    fe_user_data_line_2=[pos4,pos4.add(fe_user2)];

    //------------------------------------------------------

    //Punto más cercano entre las líneas de dirección
    //hacia La Luna y el Sol.
    var fe_moon1_vn=fe_moon1.subtract(zero);
    var fe_moon2_vn=fe_moon2.subtract(zero);

    var n_v1v2=BABYLON.Vector3.Cross(fe_moon1_vn,fe_moon2_vn);
    var n1_v1v2=BABYLON.Vector3.Cross(fe_moon1_vn,n_v1v2);
    var n2_v1v2=BABYLON.Vector3.Cross(fe_moon2_vn,n_v1v2);

    var dot_v1n2=BABYLON.Vector3.Dot(fe_moon1_vn,n2_v1v2);
    var dot_v2n1=BABYLON.Vector3.Dot(fe_moon2_vn,n1_v1v2);

    var dot_p2p1_n2=BABYLON.Vector3.Dot(pos4.subtract(pos3),n2_v1v2);
    var dot_p1p2_n1=BABYLON.Vector3.Dot(pos3.subtract(pos4),n1_v1v2);
    
    var coci1=dot_p2p1_n2/dot_v1n2;
    var coci2=dot_p1p2_n1/dot_v2n1;

    var moon_cut1=pos3.add(fe_moon1_vn.scale(coci1));
    var moon_cut2=pos4.add(fe_moon2_vn.scale(coci2));

    var moon_cut_v=moon_cut1.subtract(moon_cut2);
    moon_cut_v.scaleInPlace(0.5);
    moon_cut_p=moon_cut2.add(moon_cut_v);
    moon_cut_h=moon_cut_p.y*1.0;

    if (moon_cut_h<=0 || fe_moon1.y<=0 || fe_moon2.y<=0) {
        moon_cut_p=nan.subtract(zero);
        moon_cut_h=NaN;
    }

    moon_cut_line_data=[
        new BABYLON.Vector3(moon_cut_p.x,0,moon_cut_p.z),moon_cut_p
    ];

    moon_cut_d=earth_radius/r*BABYLON.Vector3.Distance(moon_cut_line_data[0],moon_cut_line_data[1]);

    //--//

    var fe_sun1_vn=fe_sun1.subtract(zero);
    var fe_sun2_vn=fe_sun2.subtract(zero);

    var n_v1v2=BABYLON.Vector3.Cross(fe_sun1_vn,fe_sun2_vn);
    var n1_v1v2=BABYLON.Vector3.Cross(fe_sun1_vn,n_v1v2);
    var n2_v1v2=BABYLON.Vector3.Cross(fe_sun2_vn,n_v1v2);

    var dot_v1n2=BABYLON.Vector3.Dot(fe_sun1_vn,n2_v1v2);
    var dot_v2n1=BABYLON.Vector3.Dot(fe_sun2_vn,n1_v1v2);

    var dot_p2p1_n2=BABYLON.Vector3.Dot(pos4.subtract(pos3),n2_v1v2);
    var dot_p1p2_n1=BABYLON.Vector3.Dot(pos3.subtract(pos4),n1_v1v2);
    
    var coci1=dot_p2p1_n2/dot_v1n2;
    var coci2=dot_p1p2_n1/dot_v2n1;

    var sun_cut1=pos3.add(fe_sun1_vn.scale(coci1));
    var sun_cut2=pos4.add(fe_sun2_vn.scale(coci2));

    var sun_cut_v=sun_cut1.subtract(sun_cut2);
    sun_cut_v.scaleInPlace(0.5);
    sun_cut_p=sun_cut2.add(sun_cut_v);
    sun_cut_h=sun_cut_p.y*1.0;

    if (sun_cut_h<=0 || fe_sun1.y<=0 || fe_sun2.y<=0) {
        sun_cut_p=nan.subtract(zero);
        sun_cut_h=NaN;
    }

    sun_cut_line_data=[
        new BABYLON.Vector3(sun_cut_p.x,0,sun_cut_p.z),sun_cut_p
    ];

    sun_cut_d=earth_radius/r*BABYLON.Vector3.Distance(sun_cut_line_data[0],sun_cut_line_data[1]);
    
    //Datos de usuario sobre la esfera
    var sp_user1_vn=user1.subtract(zero);
    sp_user1_vn.normalize();

    var sp_user2_vn=user2.subtract(zero);
    sp_user2_vn.normalize();

    var n_v1v2=BABYLON.Vector3.Cross(sp_user1_vn,sp_user2_vn);
    var n1_v1v2=BABYLON.Vector3.Cross(sp_user1_vn,n_v1v2);
    var n2_v1v2=BABYLON.Vector3.Cross(sp_user2_vn,n_v1v2);

    var dot_v1n2=BABYLON.Vector3.Dot(sp_user1_vn,n2_v1v2);
    var dot_v2n1=BABYLON.Vector3.Dot(sp_user2_vn,n1_v1v2);

    var dot_p2p1_n2=BABYLON.Vector3.Dot(pos1.subtract(pos2),n2_v1v2);
    var dot_p1p2_n1=BABYLON.Vector3.Dot(pos2.subtract(pos1),n1_v1v2);
    
    var coci1=-1*dot_p2p1_n2/dot_v1n2;
    var coci2=-1*dot_p1p2_n1/dot_v2n1;

    var sp_user_cut1=pos1.add(sp_user1_vn.scale(coci1));
    var sp_user_cut2=pos2.add(sp_user2_vn.scale(coci2));

    var sp_user_cut_v=sp_user_cut1.subtract(sp_user_cut2);
    sp_user_cut_v.scaleInPlace(0.5);
    sp_user_cut_p=sp_user_cut2.add(sp_user_cut_v);

    sp_user_cut_h=BABYLON.Vector3.Distance(zero,sp_user_cut_p);

    sp_user_cut_line_data=[
        new BABYLON.Vector3(0,0,0),sp_user_cut_p
    ];

    //Distancia mínima entre las líneas
    sp_user_cut_dl=earth_radius/r*BABYLON.Vector3.Distance(sp_user_cut1,sp_user_cut2);
    //Distancia al observador 1
    sp_user_cut_d1=earth_radius/r*coci1;
    //Distancia al observador 2
    sp_user_cut_d2=earth_radius/r*coci2;
    //Distancia al centro de La Tierra
    sp_user_cut_d=earth_radius/r*sp_user_cut_h;


    //Datos de usuario sobre la tierra plana
    var fe_user1_vn=fe_user1.subtract(zero);
    fe_user1_vn.normalize();

    var fe_user2_vn=fe_user2.subtract(zero);
    fe_user2_vn.normalize();

    var n_v1v2=BABYLON.Vector3.Cross(fe_user1_vn,fe_user2_vn);
    var n1_v1v2=BABYLON.Vector3.Cross(fe_user1_vn,n_v1v2);
    var n2_v1v2=BABYLON.Vector3.Cross(fe_user2_vn,n_v1v2);

    var dot_v1n2=BABYLON.Vector3.Dot(fe_user1_vn,n2_v1v2);
    var dot_v2n1=BABYLON.Vector3.Dot(fe_user2_vn,n1_v1v2);

    var dot_p2p1_n2=BABYLON.Vector3.Dot(pos3.subtract(pos4),n2_v1v2);
    var dot_p1p2_n1=BABYLON.Vector3.Dot(pos4.subtract(pos3),n1_v1v2);
    
    var coci1=-1*dot_p2p1_n2/dot_v1n2;
    var coci2=-1*dot_p1p2_n1/dot_v2n1;

    var fe_user_cut1=pos3.add(fe_user1_vn.scale(coci1));
    var fe_user_cut2=pos4.add(fe_user2_vn.scale(coci2));

    var fe_user_cut_v=fe_user_cut1.subtract(fe_user_cut2);
    fe_user_cut_v.scaleInPlace(0.5);
    fe_user_cut_p=fe_user_cut2.add(fe_user_cut_v);

    fe_user_cut_h=BABYLON.Vector3.Distance(
        new BABYLON.Vector3(fe_user_cut_p.x,0,fe_user_cut_p.z),
        fe_user_cut_p);
    //fe_user_cut_h=fe_user_cut_p.y*1.0;

    fe_user_cut_line_data=[
        new BABYLON.Vector3(fe_user_cut_p.x,0,fe_user_cut_p.z),
        fe_user_cut_p
    ];

    //Distancia mínima entre las líneas
    fe_user_cut_dl=earth_radius/r*BABYLON.Vector3.Distance(fe_user_cut1,fe_user_cut2);
    //Distancia al observador 1
    fe_user_cut_d1=earth_radius/r*coci1;
    fe_user_cut_d1=earth_radius/r*BABYLON.Vector3.Distance(fe_user_cut_p,
                          new BABYLON.Vector3(pos3.x,0,pos3.z));
    //Distancia al observador 2
    fe_user_cut_d2=earth_radius/r*coci2;
    fe_user_cut_d2=earth_radius/r*BABYLON.Vector3.Distance(fe_user_cut_p,
                          new BABYLON.Vector3(pos4.x,0,pos4.z));
    //Altura respecto del plano
    fe_user_cut_d=earth_radius/r*fe_user_cut_h;

    //
    //Posición y dirección de las puntas de flecha
    //de dirección sobre la TP
    var head_arrow_size=1.5;

    var fe_sun1_v=fe_sun1.subtract(zero);
    fe_sun1_v.scaleInPlace(-head_arrow_size);

    var fe_sun2_v=fe_sun2.subtract(zero);
    fe_sun2_v.scaleInPlace(-head_arrow_size);
    
    var fe_moon1_v=fe_moon1.subtract(zero);
    fe_moon1_v.scaleInPlace(-head_arrow_size);

    var fe_moon2_v=fe_moon2.subtract(zero);
    fe_moon2_v.scaleInPlace(-head_arrow_size);
    //
    
    //Escalado de las líneas de dirección
    fe_moon1.scaleInPlace(fe_line_size);
    fe_moon2.scaleInPlace(fe_line_size);
    fe_sun1.scaleInPlace(fe_line_size);
    fe_sun2.scaleInPlace(fe_line_size);

    fe_moon_line_data_1=[pos3,pos3.add(fe_moon1)];
    fe_moon_line_data_2=[pos4,pos4.add(fe_moon2)];

    fe_sun_line_data_1=[pos3,pos3.add(fe_sun1)];
    fe_sun_line_data_2=[pos4,pos4.add(fe_sun2)];

    //Datos de punta de flecha para las direcciones del Sol y La Luna sobre la tierra plana
    fe_sun_data_arrow_1=[(pos3.add(fe_sun1)).subtract(fe_sun1_v),pos3.add(fe_sun1)];
    fe_sun_data_arrow_2=[(pos4.add(fe_sun2)).subtract(fe_sun2_v),pos4.add(fe_sun2)];

    fe_moon_data_arrow_1=[(pos3.add(fe_moon1)).subtract(fe_moon1_v),pos3.add(fe_moon1)];
    fe_moon_data_arrow_2=[(pos4.add(fe_moon2)).subtract(fe_moon2_v),pos4.add(fe_moon2)];


    //Inicialización de las puntas de flecha para las direcciones
    //del Sol y la Luna en el plano de información local
    rose_arrow_sun_b=[];rose_arrow_sun_e=[];
    rose_arrow_moon_b=[];rose_arrow_moon_e=[];
    rose_arrow_n_b=[];rose_arrow_n_e=[];
    rose_arrow_s_b=[];rose_arrow_s_e=[];
    for (var k=0;k<4;k++) {
        rose_arrow_sun_b[k]=nan.subtract(zero);
        rose_arrow_sun_e[k]=nan.subtract(zero);
        rose_arrow_moon_b[k]=nan.subtract(zero);
        rose_arrow_moon_e[k]=nan.subtract(zero);
        rose_arrow_n_e[k]=nan.subtract(zero);
        rose_arrow_n_b[k]=nan.subtract(zero);
        rose_arrow_s_e[k]=nan.subtract(zero);
        rose_arrow_s_b[k]=nan.subtract(zero);
    }

    //---Fase lunar----
    var v_sun_moon=sun_pos.subtract(zero);
    v_sun_moon=v_sun_moon.subtract(moon_pos);
    v_sun_moon.normalize();

    var v_moon_pos_c=moon_pos.subtract(zero);
    var v_sun_pos_c=sun_pos.subtract(zero);
    
    v_moon_pos_c=v_moon_pos_c.subtract(zero);
    v_sun_pos_c=v_sun_pos_c.subtract(zero);
    
    v_moon_pos_c.normalize();
    v_sun_pos_c.normalize();
    
    mfc=Math.acos(BABYLON.Vector3.Dot(v_moon_pos_c,v_sun_moon));
    mfc=0.5*(1-Math.cos(mfc))*100;
    if (mfc>99.99) mfc=99.99;
    meloc=Math.acos(BABYLON.Vector3.Dot(v_moon_pos_c,v_sun_pos_c))/dtor;

    var v_moon_pos_1=moon_pos.subtract(zero);
    var v_sun_pos_1=sun_pos.subtract(zero);
    
    v_moon_pos_1=v_moon_pos_1.subtract(pos1);
    v_sun_pos_1=v_sun_pos_1.subtract(pos1);

    v_moon_pos_1.normalize();
    v_sun_pos_1.normalize();
    
    mf1=Math.acos(BABYLON.Vector3.Dot(v_moon_pos_1,v_sun_moon));
    mf1=0.5*(1-Math.cos(mf1))*100;
    if (mf1>99.99) mf1=99.99;
    melo1=Math.acos(BABYLON.Vector3.Dot(v_moon_pos_1,v_sun_pos_1))/dtor;

    var v_moon_pos_2=moon_pos.subtract(zero);
    var v_sun_pos_2=sun_pos.subtract(zero);
    
    v_moon_pos_2=v_moon_pos_2.subtract(pos2);
    v_sun_pos_2=v_sun_pos_2.subtract(pos2);

    v_moon_pos_2.normalize();
    v_sun_pos_2.normalize();
    
    mf2=Math.acos(BABYLON.Vector3.Dot(v_moon_pos_2,v_sun_moon));
    mf2=0.5*(1-Math.cos(mf2))*100;
    if (mf2>99.99) mf2=99.99;
    melo2=Math.acos(BABYLON.Vector3.Dot(v_moon_pos_2,v_sun_pos_2))/dtor;

    //----------------------------


    //Posición y orientación de las
    //cámaras que apuntan hacia La Luna
    //-----------------------------------
    pos1_cam=pos1.subtract(zero);
    pos2_cam=pos2.subtract(zero);

    pos1_upv=pos1.subtract(zero);
    pos2_upv=pos2.subtract(zero);
    pos1_upv.normalize();
    pos2_upv.normalize();

    if (local_orientation==0) {
        pos1_upv=new BABYLON.Vector3(0,1,0);
        pos2_upv=new BABYLON.Vector3(0,1,0);
    }
    //-----------------------------------

    //Cálculo de la orientación
    //del Polo Norte de La Luna
    calc_moon_ori();

    //Sombra fake de La Tierra 
    //a la distancia de La Luna
    calc_earth_shadow();

    
    //Rosa de rumbos para los observadores
    //sobre la esfera y la tierra plana
    rose_lines_data=[nan,nan];
    rose_lines_color_data=[nan,nan];
    n_rose_lines_data=0;

    hc_lines_data=[nan,nan];
    hc_lines_color_data=[nan,nan];
    n_hc_lines_data=0;

    var temp_moon_pos=[];

    if (additional_model_info==1) {

        //Posiciones de La Luna +-12h
        var temp_moon_pos=[];
        var jd0=JD*1.0;
        for (var i=0;i<27;i++) {
            JD=jd0+(i-12)/24.0;
            temp_moon_pos[i]=calc_moon_pos_old();
        }
        JD=jd0*1.0;
        //
        
        var r_escala=0.5;
        for (var k=0;k<4;k++) {

            if (fe_is_visible==0 && k>1) continue;

            if (k==0) {

                var rpos=pos1.subtract(zero);
                var rvn=ori_un1.subtract(zero);
                var rve=ori_ue1.subtract(zero);
                var sun__az=sun_az1*1.0;
                var moon__az=moon_az1*1.0;
            }

            if (k==1) {

                var rpos=pos2.subtract(zero);
                var rvn=ori_un2.subtract(zero);
                var rve=ori_ue2.subtract(zero);
                var sun__az=sun_az2*1.0;
                var moon__az=moon_az2*1.0;
            }

            if (k==2) {

                var rpos=pos3.subtract(zero);
                var rvn=fe_un1.subtract(zero);
                var rve=fe_ue1.subtract(zero);
                rvn=change_yz(rvn);
                rve=change_yz(rve);
                var sun__az=sun_az1*1.0;
                var moon__az=moon_az1*1.0;
            }

            if (k==3) {

                var rpos=pos4.subtract(zero);
                var rvn=fe_un2.subtract(zero);
                var rve=fe_ue2.subtract(zero);
                rvn=change_yz(rvn);
                rve=change_yz(rve);
                var sun__az=sun_az2*1.0;
                var moon__az=moon_az2*1.0;
            }

            for (var j=0;j<11;j++) {
                for (var i=0;i<4;i++) {

                    var rose_ang=i*2*Math.PI/4+j/9.0*Math.PI/2.0;

                    var rcolor=new BABYLON.Color4(1,1,1,1);
                
                    if (j==0) {
                        var rd1=2.0*r_escala;
                        var rd2=3.0*r_escala;
                    } else if (j==3 || j==6) {
                        var rd1=2.5*r_escala;
                        var rd2=3.0*r_escala;
                    } else if (j==9 || j==10) {
                        var rd1=0;
                        var rd2=3.0*r_escala;
                        if (j==9) {
                            rose_ang=sun__az;
                            rcolor=new BABYLON.Color4(1,1,0,1);
                        }
                        if (j==10) {
                            rose_ang=moon__az;
                            rcolor=new BABYLON.Color4(0.5,0.5,0.5,1);
                        }
                    } else {
                        var rd1=2.75*r_escala;
                        var rd2=3.0*r_escala;
                    }

                    var rcos=Math.cos(rose_ang);
                    var rsin=Math.sin(rose_ang);

                    rose_p1=new BABYLON.Vector3(rpos.x+rd1*(rvn.x*rcos+rve.x*rsin),
                                                rpos.y+rd1*(rvn.y*rcos+rve.y*rsin),
                                                rpos.z+rd1*(rvn.z*rcos+rve.z*rsin));
                    rose_lines_data[n_rose_lines_data]=rose_p1;
                    rose_lines_color_data[n_rose_lines_data]=rcolor;
                    n_rose_lines_data++;                                    

                    rose_p2=new BABYLON.Vector3(rpos.x+rd2*(rvn.x*rcos+rve.x*rsin),
                                                rpos.y+rd2*(rvn.y*rcos+rve.y*rsin),
                                                rpos.z+rd2*(rvn.z*rcos+rve.z*rsin));
                    rose_lines_data[n_rose_lines_data]=rose_p2;
                    rose_lines_color_data[n_rose_lines_data]=rcolor;
                    n_rose_lines_data++;                                    

                    //Añade un punto nulo a la lista
                    //Fin de la cadena de líneas
                    rose_p3=nan.subtract(zero);
                    rose_lines_data[n_rose_lines_data]=rose_p3;
                    rose_lines_color_data[n_rose_lines_data]=rcolor;
                    n_rose_lines_data++;                                    

                }
            }


            // Horizonte astronomico

            // Añade punto nulo
            rose_p3=nan.subtract(zero);
            rose_lines_data[n_rose_lines_data]=rose_p3;
            rose_lines_color_data[n_rose_lines_data]=rcolor;
            n_rose_lines_data++;

            for (var j=0;j<30;j++) {

                var rose_ang=j*2*Math.PI/29;

                var rcolor=new BABYLON.Color4(1,1,1,1);

                rd1=3.0*r_escala;
            
                var rcos=Math.cos(rose_ang);
                var rsin=Math.sin(rose_ang);

                rose_p1=new BABYLON.Vector3(rpos.x+rd1*(rvn.x*rcos+rve.x*rsin),
                                            rpos.y+rd1*(rvn.y*rcos+rve.y*rsin),
                                            rpos.z+rd1*(rvn.z*rcos+rve.z*rsin));
                rose_lines_data[n_rose_lines_data]=rose_p1;
                rose_lines_color_data[n_rose_lines_data]=rcolor;
                n_rose_lines_data++;                                    
                
            }

            //Añade un punto nulo
            rose_p3=nan.subtract(zero);
            rose_lines_data[n_rose_lines_data]=rose_p3;
            rose_lines_color_data[n_rose_lines_data]=rcolor;
            n_rose_lines_data++; 

            //

            //Cálculo del horizonte geométrico
            //
            //Añade un punto nulo
            rose_p3=nan.subtract(zero);
            hc_lines_data[n_hc_lines_data]=rose_p3;
            hc_lines_color_data[n_hc_lines_data]=rcolor;
            n_hc_lines_data++; 

            var hobs=0;
            if (k<2) {

                if (k==0) hobs=h1/earth_radius*r/1000.0;
                if (k==1) hobs=h2/earth_radius*r/1000.0;

                var ach=Math.acos(r/(r+hobs));
                var ch_l=r*Math.tan(ach);
                var ch_s=ch_l*Math.cos(ach);
                var ch_p=ch_l*Math.sin(ach);

                var ch_pos=rpos.subtract(zero);
                var ch_posn=rpos.subtract(zero);
                ch_posn.normalize();
                ch_posn.scaleInPlace((r+hobs-ch_p)*1.0000);

                var ch_aux=new BABYLON.Vector3(0,1,0);
                if (BABYLON.Vector3.Dot(ch_aux,ch_posn)==1) ch_aux=new BABYLON.Vector3(1,0,0);

                var ch_x=BABYLON.Vector3.Cross(ch_aux,ch_pos);
                ch_x.normalize();
                var ch_y=BABYLON.Vector3.Cross(ch_x,ch_pos);
                ch_y.normalize();

                for (var j=0;j<30;j++) {

                    var rose_ang=j*2*Math.PI/29;
                    var rcolor=new BABYLON.Color4(1,0,1,1);
            
                    var rcos=Math.cos(rose_ang);
                    var rsin=Math.sin(rose_ang);

                    rose_p1=new BABYLON.Vector3(ch_posn.x+ch_s*(ch_x.x*rcos+ch_y.x*rsin),
                                                ch_posn.y+ch_s*(ch_x.y*rcos+ch_y.y*rsin),
                                                ch_posn.z+ch_s*(ch_x.z*rcos+ch_y.z*rsin));
                    hc_lines_data[n_hc_lines_data]=rose_p1;
                    hc_lines_color_data[n_hc_lines_data]=rcolor;
                    n_hc_lines_data++;

                }
            }

            //Añade un punto nulo
            rose_p3=nan.subtract(zero);
            hc_lines_data[n_hc_lines_data]=rose_p3;
            hc_lines_color_data[n_hc_lines_data]=rcolor;
            n_hc_lines_data++; 
            //

            //
            var rcolor=new BABYLON.Color4(1,1,0,1);
            rose_p1=rpos.subtract(zero);
            if (k==0) {
                rose_p2=local_altaz_to_xyz(ori_un1,ori_ue1,ori_ur1,sun_alt1/dtor,sun_az1/dtor,0);
            }
            if (k==1) {
                rose_p2=local_altaz_to_xyz(ori_un2,ori_ue2,ori_ur2,sun_alt2/dtor,sun_az2/dtor,0);
            }
            if (k==2) {
                rose_p2=local_altaz_to_xyz(fe_un1,fe_ue1,fe_ur1,sun_alt1/dtor,sun_az1/dtor,1);
            }
            if (k==3) {
                rose_p2=local_altaz_to_xyz(fe_un2,fe_ue2,fe_ur2,sun_alt2/dtor,sun_az2/dtor,1);
            }

            rose_p2.normalize();
            rose_p2=rose_p2.scale(1.5);
            rose_p2=rose_p2.add(rpos);

            //Extremos de las flechas de dirección al Sol
            rose_arrow_sun_e[k]=((rose_p2.subtract(rpos)).scale(0.85)).add(rpos);
            rose_arrow_sun_b[k]=rose_p2.subtract(zero);

            rose_lines_data[n_rose_lines_data]=rose_p1.subtract(zero);
            rose_lines_color_data[n_rose_lines_data]=rcolor;
            n_rose_lines_data++;
            rose_lines_data[n_rose_lines_data]=rose_p2.subtract(zero);
            rose_lines_color_data[n_rose_lines_data]=rcolor;
            n_rose_lines_data++;

            var rcolor=new BABYLON.Color4(0.5,0.5,0.5,1);
            rose_p1=rpos.subtract(zero);
            if (k==0) {
                rose_p2=local_altaz_to_xyz(ori_un1,ori_ue1,ori_ur1,moon_alt1/dtor,moon_az1/dtor,0);
            }
            if (k==1) {
                rose_p2=local_altaz_to_xyz(ori_un2,ori_ue2,ori_ur2,moon_alt2/dtor,moon_az2/dtor,0);
            }
            if (k==2) {
                rose_p2=local_altaz_to_xyz(fe_un1,fe_ue1,fe_ur1,moon_alt1/dtor,moon_az1/dtor,1);
            }
            if (k==3) {
                rose_p2=local_altaz_to_xyz(fe_un2,fe_ue2,fe_ur2,moon_alt2/dtor,moon_az2/dtor,1);
            }

            rose_p2.normalize();
            rose_p2=rose_p2.scale(1.5);
            rose_p2=rose_p2.add(rpos);

            //Extremos de las flechas de dirección a La Luna
            rose_arrow_moon_e[k]=((rose_p2.subtract(rpos)).scale(0.85)).add(rpos);
            rose_arrow_moon_b[k]=rose_p2.subtract(zero);

            rose_lines_data[n_rose_lines_data]=rose_p1.subtract(zero);
            rose_lines_color_data[n_rose_lines_data]=rcolor;
            n_rose_lines_data++;
            rose_lines_data[n_rose_lines_data]=rose_p2.subtract(zero);
            rose_lines_color_data[n_rose_lines_data]=rcolor;
            n_rose_lines_data++;

            //Añade un punto nulo a la lista
            //Fin de la cadena de líneas
            rose_p3=nan.subtract(zero);
            rose_lines_data[n_rose_lines_data]=rose_p3;
            rose_lines_color_data[n_rose_lines_data]=rcolor;
            n_rose_lines_data++;

            var rcolor=new BABYLON.Color4(1,0.0,1,1);
            rose_p1=rpos.subtract(zero);
            if (k==0) {
                rose_p2=local_altaz_to_xyz(ori_un1,ori_ue1,ori_ur1,lat01/dtor,0,0);
            }
            if (k==1) {
                rose_p2=local_altaz_to_xyz(ori_un2,ori_ue2,ori_ur2,lat02/dtor,0,0);
            }
            if (k==2) {
                rose_p2=local_altaz_to_xyz(fe_un1,fe_ue1,fe_ur1,lat01/dtor,0,1);
            }
            if (k==3) {
                rose_p2=local_altaz_to_xyz(fe_un2,fe_ue2,fe_ur2,lat02/dtor,0,1);
            }

            rose_p2.normalize();
            rose_p2=rose_p2.scale(1.5);
            rose_p1=rose_p2.scale(-1);
            rose_p2=rose_p2.add(rpos);
            rose_p1=rose_p1.add(rpos);
         
            //Extremos de las flechas de dirección al polo norte y sur celeste
            rose_arrow_n_e[k]=((rose_p2.subtract(rpos)).scale(0.85)).add(rpos);
            rose_arrow_n_b[k]=rose_p2.subtract(zero);
            rose_arrow_s_e[k]=((rose_p1.subtract(rpos)).scale(0.85)).add(rpos);
            rose_arrow_s_b[k]=rose_p1.subtract(zero);

            rose_lines_data[n_rose_lines_data]=rose_p1.subtract(zero);
            rose_lines_color_data[n_rose_lines_data]=rcolor;
            n_rose_lines_data++;
            rose_lines_data[n_rose_lines_data]=rose_p2.subtract(zero);
            rose_lines_color_data[n_rose_lines_data]=rcolor;
            n_rose_lines_data++;

            //Añade un punto nulo a la lista
            //Fin de la cadena de líneas
            rose_p3=nan.subtract(zero);
            rose_lines_data[n_rose_lines_data]=rose_p3;
            rose_lines_color_data[n_rose_lines_data]=rcolor;
            n_rose_lines_data++;            
            //

            var rd1=3.0*r_escala;
            var rcolor=new BABYLON.Color4(1,1,0,1);
            for (var i=0;i<30;i++) {

                var rose_ang=i*2*Math.PI/29.0;
                
                var rvn=new BABYLON.Vector3(1,0,0);
                var rve=new BABYLON.Vector3(0,0,1);
                var rvr=new BABYLON.Vector3(0,1,0);
                
                if (k==2) {
                    var rvn=so3_rotation(change_yz(fe_ue1),-lat01+Math.PI/2,change_yz(fe_un1));  
                    var rve=change_yz(fe_ue1);
                    var rvr=so3_rotation(change_yz(fe_ue1),-lat01+Math.PI/2,change_yz(fe_ur1));            
                }
                if (k==3) {
                    var rvn=so3_rotation(change_yz(fe_ue2),-lat02+Math.PI/2,change_yz(fe_un2));  
                    var rve=change_yz(fe_ue2);
                    var rvr=so3_rotation(change_yz(fe_ue2),-lat02+Math.PI/2,change_yz(fe_ur2));            
                }
                
                var rcos=Math.cos(rose_ang);
                var rsin=Math.sin(rose_ang);
                var dcos=Math.cos(sun_latc);
                var dsin=Math.sin(sun_latc);

                rose_p1=new BABYLON.Vector3(rpos.x+rd1*(rvn.x*rcos*dcos+rve.x*rsin*dcos+rvr.x*dsin),
                                            rpos.y+rd1*(rvn.y*rcos*dcos+rve.y*rsin*dcos+rvr.y*dsin),
                                            rpos.z+rd1*(rvn.z*rcos*dcos+rve.z*rsin*dcos+rvr.z*dsin));
                rose_lines_data[n_rose_lines_data]=rose_p1;

                //
                var rose_p1n=rose_p1.subtract(rpos);
                rose_p1n.normalize();
                var vector_r=[];
                if (k==0) vector_r=rpos.subtract(zero);
                if (k==1) vector_r=rpos.subtract(zero);
                if (k==2) vector_r=new BABYLON.Vector3(0,1,0);
                if (k==3) vector_r=new BABYLON.Vector3(0,1,0);
                vector_r.normalize();

                var angle_bo=Math.acos(BABYLON.Vector3.Dot(vector_r,rose_p1n));
                rcolor=new BABYLON.Color4(1,1,0,1);
                if (angle_bo>Math.PI/2.0) {
                    rcolor=new BABYLON.Color4(1,1,0,0);
                }
                //

                rose_lines_color_data[n_rose_lines_data]=rcolor;
                n_rose_lines_data++; 
                                    
            }

            //Añade un punto nulo a la lista
            //Fin de la cadena de líneas
            rose_p3=nan.subtract(zero);
            rose_lines_data[n_rose_lines_data]=rose_p3;
            rose_lines_color_data[n_rose_lines_data]=rcolor;
            n_rose_lines_data++;

            var rcolor=new BABYLON.Color4(0.5,0.5,0.5,1);
            for (var i=0;i<27;i++) {

                var tmp1=temp_moon_pos[i].subtract(zero);
                if (k==0 || k==1) {
                    
                    var tmp1_o=tmp1.subtract(rpos);
                    tmp1_o.normalize();
                    rose_p1=new BABYLON.Vector3(rpos.x+rd1*tmp1_o.x,
                                                rpos.y+rd1*tmp1_o.y,
                                                rpos.z+rd1*tmp1_o.z);
                    rose_lines_data[n_rose_lines_data]=rose_p1;

                    //
                    var rose_p1n=rose_p1.subtract(rpos);
                    rose_p1n.normalize();
                    var vector_r=rpos.subtract(zero);
                    vector_r.normalize();

                    var angle_bo=Math.acos(BABYLON.Vector3.Dot(vector_r,rose_p1n));
                    rcolor=new BABYLON.Color4(0.5,0.5,0.5,1);
                    if (angle_bo>Math.PI/2.0) {
                        rcolor=new BABYLON.Color4(0.5,0.5,0.5,0);
                    }
                    //

                    rose_lines_color_data[n_rose_lines_data]=rcolor;
                    n_rose_lines_data++; 
                }
                if (k==2) {
                    
                    var tmp1_o=tmp1.subtract(pos1);
                    tmp1_o.normalize();

                    var tmp_un1=BABYLON.Vector3.Dot(tmp1_o,ori_un1);
                    var tmp_ue1=BABYLON.Vector3.Dot(tmp1_o,ori_ue1);
                    var tmp_ur1=BABYLON.Vector3.Dot(tmp1_o,ori_ur1);
            
                    var tmp_alt1=Math.asin(tmp_ur1);
                    var tmp_az1=Math.atan2(tmp_ue1,tmp_un1);
                    if (tmp_az1<0) tmp_az1=tmp_az1+2*Math.PI;

                    var tmp_moon_fe1=local_altaz_to_xyz(fe_un1,fe_ue1,fe_ur1,tmp_alt1/dtor,tmp_az1/dtor,1);
                    tmp_moon_fe1.normalize();
                    tmp_moon_fe1.scaleInPlace(rd1);

                    rose_lines_data[n_rose_lines_data]=pos3.add(tmp_moon_fe1);
                    rose_lines_color_data[n_rose_lines_data]=rcolor;
                    n_rose_lines_data++; 

                }
                if (k==3) {
                    
                    var tmp1_o=tmp1.subtract(pos2);
                    tmp1_o.normalize();

                    var tmp_un2=BABYLON.Vector3.Dot(tmp1_o,ori_un2);
                    var tmp_ue2=BABYLON.Vector3.Dot(tmp1_o,ori_ue2);
                    var tmp_ur2=BABYLON.Vector3.Dot(tmp1_o,ori_ur2);
            
                    var tmp_alt2=Math.asin(tmp_ur2);
                    var tmp_az2=Math.atan2(tmp_ue2,tmp_un2);
                    if (tmp_az2<0) tmp_az2=tmp_az2+2*Math.PI;

                    var tmp_moon_fe2=local_altaz_to_xyz(fe_un2,fe_ue2,fe_ur2,tmp_alt2/dtor,tmp_az2/dtor,1);
                    tmp_moon_fe2.normalize();
                    tmp_moon_fe2.scaleInPlace(rd1);

                    rose_lines_data[n_rose_lines_data]=pos4.add(tmp_moon_fe2);
                    rose_lines_color_data[n_rose_lines_data]=rcolor;
                    n_rose_lines_data++; 

                }

            }

            //Añade un punto nulo a la lista
            //Fin de la cadena de líneas
            rose_p3=nan.subtract(zero);
            rose_lines_data[n_rose_lines_data]=rose_p3;
            rose_lines_color_data[n_rose_lines_data]=rcolor;
            n_rose_lines_data++;

        }

    }


    //Iluminación del Sol sobre el plano
    //línea borde de la iluminación sobre la esfera
    //transofrmada al plano (referencia para el mapa de sombra)
    if (1) {

        if (ilu_is_visible==1) {

            //Vector de dirección entre el Sol y centro
            // de La Tierra
            var ilu_vector=zero.subtract(sun_pos);
            var ilu_aux=new BABYLON.Vector3(0,1,0);

            var ilu_vector=sun_pos.subtract(zero);
            angulo_o=Math.PI/2.0-sun_alt1_co*1.0;
            ilu_vector.normalize();
            ilu_vector.scaleInPlace(Math.cos(angulo_o));
            var ilu_r=Math.sin(angulo_o);

            //Vectores en el plano perpendicular al
            //vector de dirección entre el Sol y La Tierra
            var ilu_vector_a=ilu_vector.cross(ilu_aux);
            var ilu_vector_b=ilu_vector.cross(ilu_vector_a);

            ilu_vector_a.normalize();
            ilu_vector_b.normalize();

            var iluc=0;

            var ilu_n=100;
            for (var i=0;i<ilu_n;i++) {

                //Ángulo que recorre el plano perpendicular
                //al vector de dirección entre el Sol y La tierra
                //desde el punto que pasa por el centro de La Tierra
                var ilu_ang=2*Math.PI*i/(ilu_n-1);

                var ilu_cos=Math.cos(ilu_ang);
                var ilu_sin=Math.sin(ilu_ang);

                //Vectores de posición de la línea que define el
                //límite entre la parte iluminada y la que no 
                //de la esfera de La Tierra.
                var ilu_x=ilu_vector.x+ilu_r*(ilu_vector_a.x*ilu_cos+ilu_vector_b.x*ilu_sin);
                var ilu_y=ilu_vector.y+ilu_r*(ilu_vector_a.y*ilu_cos+ilu_vector_b.y*ilu_sin);
                var ilu_z=ilu_vector.z+ilu_r*(ilu_vector_a.z*ilu_cos+ilu_vector_b.z*ilu_sin);

                //Conversión de la posición de línea del límite
                // de iluminación a latitud y longitud
                var ilu_lat=Math.asin(ilu_y);
                var ilu_lon=Math.atan2(ilu_z,ilu_x);

                //Datos de la línea de iluminación sobre la esfera
                ilu_data_sp[iluc]=rlatlon_to_xyz(rdeltar*0+r*1.0005,ilu_lat,ilu_lon,0);

                //Transformación de la línea límite de iluminación
                //de la esfera al disco
                ilu_data_fe[iluc]=rlatlon_to_xyz_fe(rfe,ilu_lat,ilu_lon,0);

                iluc++;
            }

            //Añade un punto nulo
            ilu_data_sp[iluc]=nan.subtract(zero);
            ilu_data_fe[iluc]=nan.subtract(zero);
            iluc++

            var ilu_vector=moon_pos.subtract(zero);
            angulo_o=Math.PI/2.0-moon_alt2_co*1.0;
            ilu_vector.normalize();
            ilu_vector.scaleInPlace(Math.cos(angulo_o));
            var ilu_r=Math.sin(angulo_o);

            //Vectores en el plano perpendicular al
            //vector de dirección entre el Sol y La Tierra
            var ilu_vector_a=ilu_vector.cross(ilu_aux);
            var ilu_vector_b=ilu_vector.cross(ilu_vector_a);

            ilu_vector_a.normalize();
            ilu_vector_b.normalize();

            var ilu_n=100;
            for (var i=0;i<ilu_n;i++) {

                //Ángulo que recorre el plano perpendicular
                //al vector de dirección entre el Sol y La tierra
                //desde el punto que pasa por el centro de La Tierra
                var ilu_ang=2*Math.PI*i/(ilu_n-1);

                var ilu_cos=Math.cos(ilu_ang);
                var ilu_sin=Math.sin(ilu_ang);

                //Vectores de posición de la línea que define el
                //límite entre la parte iluminada y la que no 
                //de la esfera de La Tierra.
                var ilu_x=ilu_vector.x+ilu_r*(ilu_vector_a.x*ilu_cos+ilu_vector_b.x*ilu_sin);
                var ilu_y=ilu_vector.y+ilu_r*(ilu_vector_a.y*ilu_cos+ilu_vector_b.y*ilu_sin);
                var ilu_z=ilu_vector.z+ilu_r*(ilu_vector_a.z*ilu_cos+ilu_vector_b.z*ilu_sin);

                //Conversión de la posición de línea del límite
                // de iluminación a latitud y longitud
                var ilu_lat=Math.asin(ilu_y);
                var ilu_lon=Math.atan2(ilu_z,ilu_x);

                //Datos de la línea de iluminación sobre la esfera
                ilu_data_sp[iluc]=rlatlon_to_xyz(rdeltar*0+r*1.0005,ilu_lat,ilu_lon,0);

                //Transformación de la línea límite de iluminación
                //de la esfera al disco
                ilu_data_fe[iluc]=rlatlon_to_xyz_fe(rfe,ilu_lat,ilu_lon,0);

                iluc++;
            }

        }

        //Iluminación sobre el plano
        //Generación del mapa de sobras para 
        //aplicarlo a la textura del plano como ambient
        var fila=0;
        var columna=0;
        var ilu_val,ilx,ily,ild,ila;
        var illat,illon,ile;

        //Vector de dirección desde el Sol hasta el
        //centro de La Tierra
        var spn=zero.subtract(sun_pos);
        var spn=sun_pos.subtract(zero);
        spn.normalize();

        for (var i=0;i<ilu_texture_data.length;i+=3) {

            ilu_val=120;

            //Coordenadas x e y del mapa de sombra
            //con el (0,0) en la mitad
            ilx=2*(columna/(ilu_ts-1)-0.5);
            ily=2*(fila/(ilu_ts-1)-0.5);

            //Distancia al centro del mapa y
            // ángulo respecto a la referencia x
            ild=Math.sqrt(ilx*ilx+ily*ily);
            ila=Math.atan2(ily,ilx);

            //Latitud y longitud sobre el plano
            illat=-2*(ild-0.5)*Math.PI/2.0;
            illon=ila+Math.PI/2;

            //Generación de vector de posición sobre
            // esfera en función de la latitud y la longitud
            ile=rlatlon_to_xyz(r,illat,illon,0);
            ile.normalize();

            //Se puede considerar en primera aproximación que
            //la dirección al Sol depende muy poco de la ubicación
            //y se puede asumir dicha constante.
            //Si no estás deacuerdo, descomenta las dos líneas siguientes.
            //var spn=sun_pos.subtract(ile);
            //spn.normalize();

            //Ángulo que forma la dirección al Sol y
            //el vector al cenit para cada ubicación
            //(Ángulo cenital del Sol)
            ilp=Math.acos(BABYLON.Vector3.Dot(ile,spn))/dtor;

            //Efecto crepúsculo en la iluminación del disco
            if (ilp<=90) {
                ilu_val=255;
            } else {

                if (ilp>90 && ilp<96) {

                    ilu_val=160;

                    if (ilp<94) ilu_val=190;
                    if (ilp<92) ilu_val=205;

                } else {
                    ilu_val=120;
                }
            }

            //Color de la textura
            ilu_texture_data[i]=ilu_val;
            ilu_texture_data[i+1]=ilu_val;
            ilu_texture_data[i+2]=ilu_val;

            //Actualización de los índices
            //para recorrer el mapa sombras
            columna++;
            if (columna==ilu_ts) {
                columna=0;
                fila++;
            }

        }
    
    }


    //Cálculo de eclipses solares
    //Líneas de umbra y penumbra
    //El cálculo sólo se realia si la elongación
    //de La Luna es inferior a 4 grados
    if (Math.abs(meloc)>4.0) {

        eclipse_data_umbra=[nan,nan];
        eclipse_data_umbra_fe=[nan,nan];
        eclipse_data_penumbra=[nan,nan];
        eclipse_data_penumbra_fe=[nan,nan];

    } else  {

        var eclipse_np=200;

        var Rs=r*109.30;
        var Rm=r*0.2726416575105949;
        var Rt=r;

        var ecl_vector=moon_pos.subtract(sun_pos);
        ecl_vector.normalize();

        var ecl_aux=new BABYLON.Vector3(0,1,0);

        var ecl_va=ecl_vector.cross(ecl_aux);
        ecl_va.normalize();
        var ecl_vb=ecl_vector.cross(ecl_va);
        ecl_vb.normalize();

        for (var i=0;i<eclipse_np;i++) {
            for (var j=0;j<2;j++) {

                var ecl_ang=i/(eclipse_np-1)*2*Math.PI;

                var cos_ecl_ang=Math.cos(ecl_ang);
                var sin_ecl_ang=Math.sin(ecl_ang);

                var ecl_vs=new BABYLON.Vector3(
                                    
                    sun_pos.x+Rs*(ecl_va.x*cos_ecl_ang+ecl_vb.x*sin_ecl_ang),
                    sun_pos.y+Rs*(ecl_va.y*cos_ecl_ang+ecl_vb.y*sin_ecl_ang),
                    sun_pos.z+Rs*(ecl_va.z*cos_ecl_ang+ecl_vb.z*sin_ecl_ang)

                );

                if (j==1) {
                    var ecl_ang=i/(eclipse_np-1)*2*Math.PI+Math.PI;

                    var cos_ecl_ang=Math.cos(ecl_ang);
                    var sin_ecl_ang=Math.sin(ecl_ang);
                }

                var ecl_vm=new BABYLON.Vector3(
                                    
                    moon_pos.x+Rm*(ecl_va.x*cos_ecl_ang+ecl_vb.x*sin_ecl_ang),
                    moon_pos.y+Rm*(ecl_va.y*cos_ecl_ang+ecl_vb.y*sin_ecl_ang),
                    moon_pos.z+Rm*(ecl_va.z*cos_ecl_ang+ecl_vb.z*sin_ecl_ang)

                );

                var ecl_vsvm=ecl_vm.subtract(ecl_vs);

                var uu=ecl_vsvm.subtract(zero);
                uu.normalize();
                var oo=ecl_vm.subtract(zero);
                var cc=zero.subtract(zero);
                var rr=rdeltar*1.005;

                var oo_cc=oo.subtract(cc);
                var uu_oo_cc=-1.0*BABYLON.Vector3.Dot(oo_cc,uu);

                var uu_oo_cc2=uu_oo_cc*uu_oo_cc;

                var oo_cc2_rr=BABYLON.Vector3.Dot(oo_cc,oo_cc)-rr*rr;

                var insqrt=uu_oo_cc2-oo_cc2_rr;

                if (insqrt>0) {

                    var ecl_d1=uu_oo_cc+Math.sqrt(insqrt);
                    var ecl_d2=uu_oo_cc-Math.sqrt(insqrt);
                    var ecl_d=0;

                    if (ecl_d1<ecl_d2) {ecl_d=ecl_d1;} else {ecl_d=ecl_d2;}

                    if (j==0) {
                        eclipse_data_umbra[i]=ecl_vm.add(uu.scale(ecl_d));
                        var ecl_lat=Math.asin(eclipse_data_umbra[i].y/rr);
                        var ecl_lon=Math.atan2(eclipse_data_umbra[i].z,eclipse_data_umbra[i].x);
                        eclipse_data_umbra_fe[i]=rlatlon_to_xyz_fe(rfe,ecl_lat,ecl_lon,0);
                        eclipse_data_umbra_fe[i].y+=0.15;
                    } else {
                        eclipse_data_penumbra[i]=ecl_vm.add(uu.scale(ecl_d));
                        var ecl_lat=Math.asin(eclipse_data_penumbra[i].y/rr);
                        var ecl_lon=Math.atan2(eclipse_data_penumbra[i].z,eclipse_data_penumbra[i].x);
                        eclipse_data_penumbra_fe[i]=rlatlon_to_xyz_fe(rfe,ecl_lat,ecl_lon,0);
                        eclipse_data_penumbra_fe[i].y+=0.15;
                    }

                } else {

                    if (j==0) {
                        eclipse_data_umbra[i]=nan.subtract(zero);
                        eclipse_data_umbra_fe[i]=nan.subtract(zero);
                    } else {
                        eclipse_data_penumbra[i]=nan.subtract(zero);
                        eclipse_data_penumbra_fe[i]=nan.subtract(zero);
                    }

                }

            }
        }

    }

    update_star_data(JD);

}


var createScene =  function () {

    var scene = new BABYLON.Scene(engine);
    scene.clearColor = new BABYLON.Color3(0.0, 0.0, 0.0);

    scene.setRenderingAutoClearDepthStencil(2, false, false)

    //Cámara
    var camera = new BABYLON.ArcRotateCamera("Camera main", 0, 0, 10, zero, scene);
    camera.setPosition(new BABYLON.Vector3(4*r, 0, 0));
    camera.attachControl(canvas, true);
    camera.radius=4*r;
    camera.lowerRadiusLimit=2*r;
    camera.upperRadiusLimit=8*r;
    camera.maxZ=3e7;
    camera.minZ=0.01;

    //Solo se permite el uso del botón izquierdo 
    //del ratón
    camera.inputs.attached.pointers.buttons = [0];

    //Desactiva algunas funciones en pantallas táctiles
    const input = camera.inputs.attached.pointers;
	input.multiTouchPanAndZoom = false;
	input.multiTouchPanning = false;

    //Cámaras apuntando a La Luna
    var camera_moon_1=new BABYLON.TargetCamera("Camera moon 1", 0, 0, 10, zero, scene);
    var camera_moon_2=new BABYLON.TargetCamera("Camera moon 2", 0, 0, 10, zero, scene);

    scene.activeCameras.push(camera);

    camera.viewport = new BABYLON.Viewport(0.0, 0.0, 1.0, 1.0);
    camera_moon_1.viewport = new BABYLON.Viewport(0.0, 0.0, 1.0, 1.0);
    camera_moon_2.viewport = new BABYLON.Viewport(0.0, 0.0, 1.0, 1.0);    
    
    //Máscaras de cámara para
    //evitar que el GUI se represente
    //en los viewports de las cámaras 
    //adicionales
    camera.layerMask =        0x00000001;
    camera_moon_1.layerMask = 0x00000110;
    camera_moon_2.layerMask = 0x00000110;
    
    //Campo visual de las cámaras adicionales
    //Típicamente el doble del tamaño de La Luna (~1º)
    camera_moon_1.fov=1*dtor;
    camera_moon_2.fov=1*dtor;

    //Se limita la representación de los
    //elementos en las cámaras adicionales
    //para evitar que muestre la TP y sus
    //elementos
    camera_moon_1.minZ=0.001;
    camera_moon_2.minZ=0.001;
    camera_moon_1.maxZ=2000000;
    camera_moon_2.maxZ=2000000;

    // Iluminación global
    var light = new BABYLON.PointLight("omni", new BABYLON.Vector3(0, 2000, 0), scene);
    light.intensity=3;

    //Material de la esfera roja
    redMat = new BABYLON.StandardMaterial("rsph", scene);
    redMat.specularColor = new BABYLON.Color3(0, 0, 0);
    redMat.diffuseColor=BABYLON.Color3.Red();
    redMat.emissiveColor = BABYLON.Color3.Red();
    redMat.alpha=0.35;
    redMat.useLogarithmicDepth = true;

    //Material de la esfera azul
    blueMat = new BABYLON.StandardMaterial("bsph", scene);
    blueMat.specularColor = new BABYLON.Color3(0,0,0);
    blueMat.diffuseColor = BABYLON.Color3.Blue();
    blueMat.emissiveColor = BABYLON.Color3.Blue();
    blueMat.alpha=0.35;
    blueMat.useLogarithmicDepth = true;

    //Material de la esfera roja
    redMat2 = new BABYLON.StandardMaterial("rsph", scene);
    redMat2.specularColor = new BABYLON.Color3(0, 0, 0);
    redMat2.diffuseColor=BABYLON.Color3.Red();
    redMat2.emissiveColor = BABYLON.Color3.Red();
    redMat2.alpha=0.35;
    redMat2.useLogarithmicDepth = true;

    //Material de la esfera azul
    blueMat2 = new BABYLON.StandardMaterial("bsph", scene);
    blueMat2.specularColor = new BABYLON.Color3(0,0,0);
    blueMat2.diffuseColor = BABYLON.Color3.Blue();
    blueMat2.emissiveColor = BABYLON.Color3.Blue();
    blueMat2.alpha=0.35;
    blueMat2.useLogarithmicDepth = true;

    //Material de la esfera auxiliar
    var auxMat = new BABYLON.StandardMaterial("asph", scene);
    auxMat.diffuseColor = new BABYLON.Color3(1, 1, 1);
    auxMat.specularColor = new BABYLON.Color3(0, 0, 0);
    auxMat.ambientColor = new BABYLON.Color3(0,0,0);
    auxMat.emissiveColor = BABYLON.Color3.Green();
    auxMat.alpha=0.5;
    auxMat.useLogarithmicDepth = true;

    //Material de la esfera auxiliar 2
    var auxMat2 = new BABYLON.StandardMaterial("asph", scene);
    auxMat2.diffuseColor = new BABYLON.Color3(1,1,1);
    auxMat2.specularColor = new BABYLON.Color3(0,0,0);
    auxMat2.emissiveColor = new BABYLON.Color3(1,1,1);
    auxMat2.useLogarithmicDepth = true;

    //Material de la esfera posición de corte para La Luna
    mooncutMat = new BABYLON.StandardMaterial("asph", scene);
    mooncutMat.diffuseColor = new BABYLON.Color3(0.7,0.7,0.7);
    mooncutMat.specularColor = new BABYLON.Color3(0,0,0);
    mooncutMat.ambientColor= new BABYLON.Color3(1,1,1);
    mooncutMat.emissiveColor = new BABYLON.Color3(0.7,0.7,0.7);
    mooncutMat.useLogarithmicDepth=true;

    //Material de la esfera posición de corte para El Sol
    suncutMat = new BABYLON.StandardMaterial("asph", scene);
    suncutMat.diffuseColor = new BABYLON.Color3(1,1,0);
    suncutMat.specularColor = new BABYLON.Color3(0,0,0);
    suncutMat.ambientColor= new BABYLON.Color3(1,1,1);
    suncutMat.emissiveColor = new BABYLON.Color3(1,1,0);
    suncutMat.useLogarithmicDepth=true;

    //Material de la esfera posición de corte para La Luna
    mooncutMat2 = new BABYLON.StandardMaterial("asph", scene);
    mooncutMat2.diffuseColor = new BABYLON.Color3(0.7,0.7,0.7);
    mooncutMat2.specularColor = new BABYLON.Color3(0,0,0);
    mooncutMat2.ambientColor= new BABYLON.Color3(1,1,1);
    mooncutMat2.emissiveColor = new BABYLON.Color3(0.7,0.7,0.7);
    mooncutMat2.useLogarithmicDepth=true;

    //Material de la esfera posición de corte para El Sol
    suncutMat2 = new BABYLON.StandardMaterial("asph", scene);
    suncutMat2.diffuseColor = new BABYLON.Color3(1,1,0);
    suncutMat2.specularColor = new BABYLON.Color3(0,0,0);
    suncutMat2.ambientColor= new BABYLON.Color3(1,1,1);
    suncutMat2.emissiveColor = new BABYLON.Color3(1,1,0);
    suncutMat2.useLogarithmicDepth=true;

    //Textura y material de La Tierra
    //Baja resolución
    //var url_em="images/1024px-Whole_world_-_land_and_oceans.jpg";
    //Media resolución
    var url_em="images/2560px-Whole_world_-_land_and_oceans.jpg";
    
    var EarthMat = new BABYLON.StandardMaterial("earth", scene);
    EarthMat.diffuseColor = new BABYLON.Color3(1, 1, 1);
    //EarthMat.emissiveColor = BABYLON.Color3.White();
    EarthMat.emissiveColor = new BABYLON.Color3(0.45,0.45,0.45);
    EarthMat.backFaceCulling = true;
    EarthMat.diffuseTexture = new BABYLON.Texture(url_em, scene);
    EarthMat.diffuseTexture.uScale=-1;
    EarthMat.diffuseTexture.vScale=-1;
    EarthMat.specularColor = new BABYLON.Color3(0,0,0);
    EarthMat.useLogarithmicDepth = true;
    
    //Textura y material de la tierra plana
    var url_fem="images/Flat_earth.jpg";
    FlatEarthMat=new BABYLON.StandardMaterial("Flatearth", scene);
    FlatEarthMat.diffuseTexture = new BABYLON.Texture(url_fem, scene);
    FlatEarthMat.specularColor = new BABYLON.Color3(0,0,0);
    FlatEarthMat.useLogarithmicDepth = true;
    //FlatEarthMat.emissiveColor= ilu_text;

    //Esfera de La Tierra
    var EarthSphere = BABYLON.MeshBuilder.CreateSphere("Earth", {segments:400, diameter:2*r}, scene);
    //var EarthSphere = BABYLON.MeshBuilder.CreateIcoSphere("Earth", {subdivisions: 5, radius: r}, scene);
    EarthSphere.material = EarthMat;
    EarthSphere.position.y = 0;
    EarthSphere.position.x = 0;
    EarthSphere.isBlocker=true;
					
    //Rotación sobre el eje Y (arriba) de La Tierra                   
    EarthSphere.rotation=new BABYLON.Vector3(0, 0, 0);
    EarthSphere.rotate(BABYLON.Axis.Y, Math.PI, BABYLON.Space.WORLD);
    EarthSphere.rotate(BABYLON.Axis.X, 0.0, BABYLON.Space.WORLD);
    EarthSphere.rotate(BABYLON.Axis.Z, 0.0, BABYLON.Space.WORLD);

    //Esfera de La Luna
    var MoonMat = new BABYLON.StandardMaterial("Moon", scene);
    MoonMat.diffuseColor = new BABYLON.Color3(1, 1, 1);
    //EarthMat.emissiveColor = BABYLON.Color3.White();
    //EarthMat.emissiveColor = new BABYLON.Color3(0.5,0.5,0.5);
    MoonMat.backFaceCulling = true;
    var url_moon_map="images/1024px-Moon_texture.jpg";
    MoonMat.diffuseTexture = new BABYLON.Texture(url_moon_map, scene);
    MoonMat.diffuseTexture.uScale=-1;
    MoonMat.diffuseTexture.vScale=-1;
    MoonMat.specularColor = new BABYLON.Color3(0,0,0);
    MoonMat.useLogarithmicDepth = true;

    var MoonSphere = BABYLON.MeshBuilder.CreateSphere("Moon", {segments:20, diameter:2*0.27262*r}, scene);
    MoonSphere.material = MoonMat;
    //MoonSphere.position.y = 0;
    //MoonSphere.position.x = 0;
    //MoonSphere.isBlocker=true;

    //Esfera de El Sol
    var SunMat = new BABYLON.StandardMaterial("Sun", scene);
    SunMat.diffuseColor = new BABYLON.Color3(1,1,0);
    SunMat.emissiveColor = new BABYLON.Color3(1,1,0);
    SunMat.specularColor = new BABYLON.Color3(0,0,0);
    SunMat.backFaceCulling = true;
    SunMat.useLogarithmicDepth = true;

    var SunSphere = BABYLON.MeshBuilder.CreateSphere("Sun", {segments:20, diameter:2*109.30*r}, scene);
    SunSphere.material = SunMat;

    //Disco de La Tierra Plana como cilindro

    //Coordenadas de textura (solo de la parte superior)
    const faceUV = [];
	faceUV[0] =	new BABYLON.Vector4(0, 0, 0, 0); //bottom
    faceUV[1] =	new BABYLON.Vector4(0, 0, 0, 0); //side
    faceUV[2] = new BABYLON.Vector4(0, 0, 1, 1); //top
	
    //Color del cilindro
    const faceColors = [ ];
    faceColors[0] = new BABYLON.Color4(0.5, 0.5, 0.5, 1)
	
    //Cilindro muy achatado (disco) para la tierra plana
	EarthDisk = BABYLON.MeshBuilder.CreateCylinder("FlatEarth", {height:fe_h, tessellation: 60, diameter: 4*rfe,faceUV: faceUV, faceColors: faceColors});
	EarthDisk.material = FlatEarthMat;
    EarthDisk.isVisible=fe_is_visible;

    //Correción de rotación de la tierra plana
    EarthDisk.rotation=new BABYLON.Vector3(0, 0, 0);
    EarthDisk.rotate(BABYLON.Axis.Y, Math.PI*1.5, BABYLON.Space.WORLD);
    EarthDisk.rotate(BABYLON.Axis.X, 0.0, BABYLON.Space.WORLD);
    EarthDisk.rotate(BABYLON.Axis.Z, 0.0, BABYLON.Space.WORLD);

    EarthDisk.position= fe_pos;

    //Posiciones iniciales
    lat1=40.0*dtor;
    lon1=-4.0*dtor;

    lat2=-34.0*dtor;
    lon2=-61.1*dtor;

    //Posiciones iniciales 
    //de la plantilla de Guillermo M.
    if (0) {

        lat1=(33+32/60.0+24.98/3600.0)*dtor;
        lon1=-(41+5/60.0+53.77/3600.0)*dtor;

        lat2=(21+4/60.0+7.35/3600.0)*dtor;
        lon2=-(146+38/60.0+34.77/3600.0)*dtor;
    }

    //Marcador de posicion de La Luna
    var moonMat1 = new BABYLON.StandardMaterial("moonMat", scene);
    moonMat1.diffuseColor = new BABYLON.Color3(0.4, 0.4, 0.4);
    moonMat1.specularColor = new BABYLON.Color3(0.4, 0.4, 0.4);
    moonMat1.emissiveColor = new BABYLON.Color3(1,1,1);
    moonMat1.alpha=0.9;
    moonMat1.useLogarithmicDepth = true;

    var moonSphere = BABYLON.MeshBuilder.CreateSphere("sun", {diameter:0.3}, scene);
    moonSphere.material = moonMat1;
    moonSphere.position=moon_sphere_pos;

    //Marcador de posicion de La Luna sobre la tierra plana
    var moonFe = BABYLON.MeshBuilder.CreateSphere("moon", {diameter:0.5}, scene);
    moonFe.material = moonMat1;
    moonFe.position=moon_fe_pos;
    moonFe.isVisible=fe_is_visible;

     //Marcador de posicion del Sol sobre La Tierra
    var sunMat1 = new BABYLON.StandardMaterial("moonMat", scene);
    sunMat1.diffuseColor = new BABYLON.Color3(0.4, 0.4, 0.4);
    sunMat1.specularColor = new BABYLON.Color3(0.4, 0.4, 0.4);
    sunMat1.emissiveColor = new BABYLON.Color3(1,1,0);
    sunMat1.alpha=0.9;
    sunMat1.useLogarithmicDepth = true;

    var sunSphere = BABYLON.MeshBuilder.CreateSphere("sun", {diameter:0.3}, scene);
    sunSphere.material = sunMat1;
    sunSphere.position=sun_sphere_pos;

    //Marcador de posicion del Sol sobre la tierra plana
    var sunFe = BABYLON.MeshBuilder.CreateSphere("sun", {diameter:0.5}, scene);
    sunFe.material = sunMat1;
    sunFe.position = sun_fe_pos;
    sunFe.isVisible=fe_is_visible;
    
    //Esfera roja
    pos1=rlatlon_to_xyz(r,lat1,lon1,h1);

    redSphere = BABYLON.MeshBuilder.CreateSphere("red", {diameter:handler_radius}, scene);
    redSphere.material = redMat;
    redSphere.position=pos1;

    //Esfera azul
    pos2=rlatlon_to_xyz(r,lat2,lon2,h2);

    blueSphere = BABYLON.MeshBuilder.CreateSphere("blue", {diameter: handler_radius}, scene);
    blueSphere.material = blueMat;
    blueSphere.position=pos2;
    
    //Esfera roja sobre la tierra plana
    pos3=rlatlon_to_xyz_fe(rfe,lat1,lon1,h1);
    redSphere_fe = BABYLON.MeshBuilder.CreateSphere("red_fe", {diameter:handler_radius}, scene);
    redSphere_fe.material = redMat;
    redSphere_fe.position=pos3;
    redSphere_fe.isVisible=fe_is_visible;

    //Esfera azul sobre la tierra plana
    pos4=rlatlon_to_xyz_fe(rfe,lat2,lon2,h2);
    blueSphere_fe = BABYLON.MeshBuilder.CreateSphere("blue_fe", {diameter:handler_radius}, scene);
    blueSphere_fe.material = blueMat;
    blueSphere_fe.position=pos4;
    blueSphere_fe.isVisible=fe_is_visible;

    //Esfera auxiliar
    var auxSphere = BABYLON.MeshBuilder.CreateSphere("aux ", {diameter:handler_radius*0.5}, scene);
    auxSphere.material = auxMat;
    auxSphere.position=zero;
    
    FECHA=obtiene_fecha_actual();
    JD=calc_jd(FECHA);

    //Cálculo de las líneas
    calculate_lines();
    moonFe.position=moon_fe_pos;
    sunFe.position=sun_fe_pos;

    ilu_text=new BABYLON.RawTexture.CreateRGBTexture(ilu_texture_data, ilu_ts, ilu_ts, scene);
    FlatEarthMat.ambientTexture=ilu_text;
    
    //Posición, orientación y apuntados
    //de las cámaras hacia La Luna
    camera_moon_1.position=pos1_cam;
    camera_moon_2.position=pos2_cam;
    camera_moon_1.upVector=pos1_upv;
    camera_moon_2.upVector=pos2_upv;
    if (moon_cameras_point_moon==1) {
        camera_moon_1.target=moon_pos.subtract(zero);
        camera_moon_2.target=moon_pos.subtract(zero);
    } else {
        camera_moon_1.target=(user_data_line_1[1]).subtract(zero);
        camera_moon_2.target=(user_data_line_2[1]).subtract(zero);
    }
    
    //Posición de las esferas
    //de La Luna y El Sol
    MoonSphere.position=moon_pos;
    SunSphere.position=sun_pos;

    //Rotación de la texura de La Luna
    MoonSphere.rotation=new BABYLON.Vector3(0, 0, 0);

    //Diurnal motion
    MoonSphere.rotate(BABYLON.Axis.Y, moon_w, BABYLON.Space.WORLD);
    MoonSphere.rotate(BABYLON.Axis.X, 0.0, BABYLON.Space.WORLD);
    MoonSphere.rotate(BABYLON.Axis.Z, 0.0, BABYLON.Space.WORLD);
    //Axial Tilt
    MoonSphere.rotate(BABYLON.Axis.X, moon_ori1, BABYLON.Space.WORLD);
    MoonSphere.rotate(BABYLON.Axis.Y, moon_ori2, BABYLON.Space.WORLD);
    MoonSphere.rotate(BABYLON.Axis.Z, 0.0, BABYLON.Space.WORLD);

    //Material de la línea ortodrómica
    ol_mat = new BABYLON.StandardMaterial("asph", scene);
    ol_mat.diffuseColor = line_color_orto;
    ol_mat.specularColor = new BABYLON.Color3(0,0,0);
    ol_mat.emissiveColor = line_color_orto;
    ol_mat.useLogarithmicDepth=true;

    //Línea otrodrómica sobre la esfera
    ortodromic_line =BABYLON.MeshBuilder.CreateLines ( "ortodromic_line", {points: line_data},scene,true); 
    ortodromic_line.material=ol_mat;
    ortodromic_line.isVisible=orto_es_visible;
    
    //Línea orotodrímica proyectada sobre la tierra plana
    ortodromic_line_fe =BABYLON.MeshBuilder.CreateLines ( "ortodromic_line_fe", {points: line_data_fe},scene,true); 
    ortodromic_line_fe.material = ol_mat;
    ortodromic_line_fe.isVisible=orto_es_visible*fe_is_visible;

    //Material de la línea loxodromica
    ll_mat = new BABYLON.StandardMaterial("asph", scene);
    ll_mat.diffuseColor = line_color_loxo;
    ll_mat.specularColor = new BABYLON.Color3(0,0,0);
    ll_mat.emissiveColor = line_color_loxo;
    ll_mat.useLogarithmicDepth=true;

    //Línea loxodrómica sobre la esfera
    loxodromic_line =BABYLON.MeshBuilder.CreateLines ( "loxodromic_line", {points: line_data_lox},scene,true); 
    loxodromic_line.material=ll_mat;
    loxodromic_line.isVisible=loxo_es_visible;

    //Línea loxodrómica proyectada sobre la tierra plana
    loxodromic_line_fe =BABYLON.MeshBuilder.CreateLines ( "loxodromic_line", {points: line_data_lox_fe},scene,true); 
    loxodromic_line_fe.material = ll_mat;
    loxodromic_line_fe.isVisible=loxo_es_visible*fe_line_size;

    //Material de la línea flatodrómica
    fl_mat = new BABYLON.StandardMaterial("asph", scene);
    fl_mat.diffuseColor = line_color_flat;
    fl_mat.specularColor = new BABYLON.Color3(0,0,0);
    fl_mat.emissiveColor = line_color_flat;
    fl_mat.useLogarithmicDepth=true;

    //Línea flatodromica sobre la tierra plana
    flatodromic_line_fe =BABYLON.MeshBuilder.CreateLines ( "flatodromic_line", {points: line_data_flat_fe},scene,true); 
    flatodromic_line_fe.material=fl_mat;
    flatodromic_line_fe.isVisible=flato_es_visible*fe_is_visible;

    //Línea flatodromica sobre la esfera
    flatodromic_line_sp =BABYLON.MeshBuilder.CreateLines ( "flatodromic_line", {points: line_data_flat_sp},scene,true); 
    flatodromic_line_sp.material=fl_mat;
    flatodromic_line_sp.isVisible=flato_es_visible;

    //Material de la línea equiangular
    el_mat = new BABYLON.StandardMaterial("asph", scene);
    el_mat.diffuseColor = line_color_eqac;
    el_mat.specularColor = new BABYLON.Color3(0,0,0);
    el_mat.emissiveColor = line_color_eqac;
    el_mat.useLogarithmicDepth=true;

    //Línea equiangular sobre la tierra plana
    equiangular_line_fe =BABYLON.MeshBuilder.CreateLines ( "equiangular_line", {points: line_data_eqac_fe},scene,true); 
    equiangular_line_fe.material=el_mat;
    equiangular_line_fe.isVisible=eqac_es_visible*fe_is_visible;

    //Línea equiangular sobre la esfera
    equiangular_line_sp =BABYLON.MeshBuilder.CreateLines ( "equiangular_line", {points: line_data_eqac_sp},scene,true); 
    equiangular_line_sp.material=el_mat;
    equiangular_line_sp.isVisible=eqac_es_visible;

    //Material de las líneas hacia La Luna
    ml_mat=new BABYLON.StandardMaterial("ml_mat", scene);
    ml_mat.diffuseColor=line_color_moon;
    ml_mat.ambientColor=new BABYLON.Color3(1,1,1);
    ml_mat.specularColor=new BABYLON.Color3(0,0,0);
    ml_mat.emissiveColor=new BABYLON.Color3(1,1,1);
    ml_mat.useLogarithmicDepth=true;

    //Material de las líneas hacia el Sol
    sl_mat=new BABYLON.StandardMaterial("ml_mat", scene);
    sl_mat.diffuseColor=line_color_sun;
    sl_mat.ambientColor=new BABYLON.Color3(1,1,1);
    sl_mat.specularColor=new BABYLON.Color3(0,0,0);
    sl_mat.emissiveColor=new BABYLON.Color3(1,1,1);
    sl_mat.useLogarithmicDepth=true;

    //Lineas de La Tierra a La Luna
    moon_line_1 =BABYLON.MeshBuilder.CreateLines ( "moon_line_1", {points: moon_line_data_1},scene,true); 
    moon_line_1.material=ml_mat;
    moon_line_1.isVisible=moon_tg_visible;
    moon_line_2 =BABYLON.MeshBuilder.CreateLines ( "moon_line_2", {points: moon_line_data_2},scene,true); 
    moon_line_2.material=ml_mat;
    moon_line_2.isVisible=moon_tg_visible;
    moon_line_c =BABYLON.MeshBuilder.CreateLines ( "moon_line_c", {points: moon_line_data_c},scene,true); 
    moon_line_c.material=ml_mat;
    moon_line_c.isVisible=moon_tg_visible;

    //Lineas de La Tierra del Sol
    sun_line_1 =BABYLON.MeshBuilder.CreateLines ( "sun_line_1", {points: sun_line_data_1},scene,true); 
    sun_line_1.material=sl_mat;
    sun_line_1.isVisible=sun_tg_visible;
    sun_line_2 =BABYLON.MeshBuilder.CreateLines ( "sun_line_2", {points: sun_line_data_2},scene,true); 
    sun_line_2.material=sl_mat;
    sun_line_2.isVisible=sun_tg_visible;
    sun_line_c =BABYLON.MeshBuilder.CreateLines ( "sun_line_c", {points: sun_line_data_c},scene,true); 
    sun_line_c.material=sl_mat;
    sun_line_c.isVisible=sun_tg_visible;

    //Líneas de dirección de la ubicaciones sobre la TP a La Luna
    fe_moon_line_1 =BABYLON.MeshBuilder.CreateLines ( "fe_moon_line_1", {points: fe_moon_line_data_1},scene,true); 
    fe_moon_line_1.material=sl_mat;
    fe_moon_line_1.isVisible=moon_tp_visible*fe_is_visible;
    fe_moon_line_2 =BABYLON.MeshBuilder.CreateLines ( "fe_moon_line_2", {points: fe_moon_line_data_2},scene,true); 
    fe_moon_line_2.material=sl_mat;
    fe_moon_line_2.isVisible=moon_tp_visible*fe_is_visible;

    //Líneas de dirección de la ubicaciones sobre la TP al Sol
    fe_sun_line_1 =BABYLON.MeshBuilder.CreateLines ( "fe_sun_line_1", {points: fe_sun_line_data_1},scene,true); 
    fe_sun_line_1.material=sl_mat;
    fe_sun_line_1.isVisible=sun_tp_visible*fe_is_visible;
    fe_sun_line_2 =BABYLON.MeshBuilder.CreateLines ( "fe_sun_line_2", {points: fe_sun_line_data_2},scene,true); 
    fe_sun_line_2.material=sl_mat;
    fe_sun_line_2.isVisible=sun_tp_visible*fe_is_visible;

    //Línea de iluminación
    ilu_line_sp =BABYLON.MeshBuilder.CreateLines ( "ilumination line", {points: ilu_data_sp},scene,true); 
    ilu_line_sp.material=auxMat2;
    ilu_line_sp.alpha=ilu_alpha;
    ilu_line_sp.isVisible=ilu_is_visible;
    ilu_line_fe =BABYLON.MeshBuilder.CreateLines ( "ilumination line", {points: ilu_data_fe},scene,true); 
    ilu_line_fe.material=auxMat2;
    ilu_line_fe.alpha=ilu_alpha;
    ilu_line_fe.isVisible=ilu_is_visible*fe_is_visible;

    //Flechas para las líneas de dirección-----------------
    var redArrowMat = new BABYLON.StandardMaterial("red arrow", scene);
    redArrowMat.diffuseColor = new BABYLON.Color3(1,0,0);
    redArrowMat.specularColor = new BABYLON.Color3(1,0,0);
    redArrowMat.emissiveColor = new BABYLON.Color3(1,0,0);
    redArrowMat.useLogarithmicDepth=true;
    redArrowMat.alpha=0.9;

    var blueArrowMat = new BABYLON.StandardMaterial("red arrow", scene);
    blueArrowMat.diffuseColor = new BABYLON.Color3(0,0,1);
    blueArrowMat.specularColor = new BABYLON.Color3(0,0,1);
    blueArrowMat.emissiveColor = new BABYLON.Color3(0,0,1);
    blueArrowMat.useLogarithmicDepth=true;
    blueArrowMat.alpha=0.9;

    var sunArrowMat = new BABYLON.StandardMaterial("sun arrow", scene);
    sunArrowMat.diffuseColor = line_color_sun;
    sunArrowMat.ambientColor = new BABYLON.Color3(1,1,1);
    sunArrowMat.emissiveColor = line_color_sun;
    sunArrowMat.useLogarithmicDepth=true;
    sunArrowMat.alpha=0.9;

    var moonArrowMat = new BABYLON.StandardMaterial("moon arrow", scene);
    moonArrowMat.diffuseColor = line_color_moon;
    moonArrowMat.ambientColor = new BABYLON.Color3(0,0,0);
    moonArrowMat.emissiveColor = line_color_moon;
    moonArrowMat.useLogarithmicDepth=true;
    moonArrowMat.alpha=0.9;

    var axisArrowMat = new BABYLON.StandardMaterial("axis arrow", scene);
    axisArrowMat.diffuseColor = new BABYLON.Color3(1,0,1);
    axisArrowMat.ambientColor = new BABYLON.Color3(0,0,0);
    axisArrowMat.emissiveColor = new BABYLON.Color3(1,0,1);
    axisArrowMat.useLogarithmicDepth=true;
    axisArrowMat.alpha=0.9;

    //Flechas de dirección del Sol en la TP
    fe_sun_arrow_1 = BABYLON.MeshBuilder.CreateTube(
        "tube", {
            path: fe_sun_data_arrow_1, 
            radiusFunction: radiusChange = (index, distance) => {
                const radius =  distance / 2;
                return radius;}, 
            sideOrientation: BABYLON.Mesh.DOUBLESIDE
        }, 
    scene);
    fe_sun_arrow_1.material=sunArrowMat;
    fe_sun_arrow_1.isVisible=sun_tp_visible*fe_is_visible;
    
    fe_sun_arrow_2 = BABYLON.MeshBuilder.CreateTube(
        "tube", {
            path: fe_sun_data_arrow_2, 
            radiusFunction: radiusChange = (index, distance) => {
                const radius =  distance / 2;
                return radius;}, 
            sideOrientation: BABYLON.Mesh.DOUBLESIDE
        }, 
    scene);
    fe_sun_arrow_2.material=sunArrowMat;
    fe_sun_arrow_2.isVisible=sun_tp_visible*fe_is_visible;
    //

    //Flechas de dirección de La Luna en la TP
    fe_moon_arrow_1 = BABYLON.MeshBuilder.CreateTube(
        "tube", {
            path: fe_moon_data_arrow_1, 
            radiusFunction: radiusChange = (index, distance) => {
                const radius =  distance / 2;
                return radius;}, 
            sideOrientation: BABYLON.Mesh.DOUBLESIDE
        }, 
    scene);
    fe_moon_arrow_1.material=moonArrowMat;
    fe_moon_arrow_1.isVisible=moon_tp_visible*fe_is_visible;
    
    fe_moon_arrow_2 = BABYLON.MeshBuilder.CreateTube(
        "tube", {
            path: fe_moon_data_arrow_2, 
            radiusFunction: radiusChange = (index, distance) => {
                const radius =  distance / 2;
                return radius;}, 
            sideOrientation: BABYLON.Mesh.DOUBLESIDE
        }, 
    scene);
    fe_moon_arrow_2.material=moonArrowMat;
    fe_moon_arrow_2.isVisible=moon_tp_visible*fe_is_visible;
    //

    //
    rose_arrow_sun=[];
    rose_arrow_moon=[];
    rose_arrow_n=[];
    rose_arrow_s=[];
    for (var k=0;k<4;k++) {

        if (fe_is_visible && k>1) continue;

        rose_arrow_sun[k] = BABYLON.MeshBuilder.CreateTube(
        "tube", {
            path: [rose_arrow_sun_b[k],rose_arrow_sun_e[k]], 
            radiusFunction: radiusChange = (index, distance) => {
                const radius =  distance / 3;
                return radius;}, 
            sideOrientation: BABYLON.Mesh.DOUBLESIDE
        }, 
        scene);
        rose_arrow_sun[k].material=sunArrowMat;
        rose_arrow_sun[k].isVisible=additional_model_info*Math.abs(1-moon_cameras_point_moon);

        rose_arrow_moon[k] = BABYLON.MeshBuilder.CreateTube(
        "tube", {
            path: [rose_arrow_moon_b[k],rose_arrow_moon_e[k]], 
            radiusFunction: radiusChange = (index, distance) => {
                const radius =  distance / 3;
                return radius;}, 
            sideOrientation: BABYLON.Mesh.DOUBLESIDE
        }, 
        scene);
        rose_arrow_moon[k].material=moonArrowMat;
        rose_arrow_moon[k].isVisible=additional_model_info*Math.abs(1-moon_cameras_point_moon);

        rose_arrow_n[k] = BABYLON.MeshBuilder.CreateTube(
        "tube", {
            path: [rose_arrow_n_b[k],rose_arrow_n_e[k]], 
            radiusFunction: radiusChange = (index, distance) => {
                const radius =  distance / 3;
                return radius;}, 
            sideOrientation: BABYLON.Mesh.DOUBLESIDE
        }, 
        scene);
        rose_arrow_n[k].material=axisArrowMat;
        rose_arrow_n[k].isVisible=additional_model_info*Math.abs(1-moon_cameras_point_moon);

        rose_arrow_s[k] = BABYLON.MeshBuilder.CreateTube(
        "tube", {
            path: [rose_arrow_s_b[k],rose_arrow_s_e[k]], 
            radiusFunction: radiusChange = (index, distance) => {
                const radius =  distance / 3;
                return radius;}, 
            sideOrientation: BABYLON.Mesh.DOUBLESIDE
        }, 
        scene);
        rose_arrow_s[k].material=axisArrowMat;
        rose_arrow_s[k].isVisible=additional_model_info*Math.abs(1-moon_cameras_point_moon);

    }
    //

    var shadowEarthMat = new BABYLON.StandardMaterial("Shadow Earth", scene);
    shadowEarthMat.diffuseColor = new BABYLON.Color3(1,0.1,0.1);
    shadowEarthMat.alpha=0.8;
    shadowEarthMat.useLogarithmicDepth = true;

    //Sombra de la Tierra 
    shadowEarth = BABYLON.MeshBuilder.CreateTube(
        "tube", {
            path: umbra_pos, 
            radius: umbra_size,
            cap: 1
        }, 
    scene);
    shadowEarth.material=shadowEarthMat;
    shadowEarth.layerMask= 0x00000110;
    light.excludedMeshes.push(shadowEarth);


    var shadowEarthMat2 = new BABYLON.StandardMaterial("Shadow Earth", scene);
    shadowEarthMat2.diffuseColor = new BABYLON.Color3(1,0.1,0.1);
    shadowEarthMat2.alpha=0.33;
    shadowEarthMat2.useLogarithmicDepth = true;

    //Sombra de la Tierra 
    shadowEarth2 = BABYLON.MeshBuilder.CreateTube(
        "tube", {
            path: umbra_pos, 
            radius: penumbra_size,
            cap: 1
        }, 
    scene);
    shadowEarth2.material=shadowEarthMat2;
    shadowEarth2.layerMask= 0x00000110;
    light.excludedMeshes.push(shadowEarth2);

    //Esfera de corte y línea de corte para La Luna
    moon_cut_sphere = BABYLON.MeshBuilder.CreateSphere("aux ", {diameter:handler_radius*0.5}, scene);
    moon_cut_sphere.material=mooncutMat;
    moon_cut_sphere.position=moon_cut_p;
    moon_cut_sphere.isVisible=moon_tp_visible*moon_tp_cut_visible*fe_is_visible;

    moon_cut_line =BABYLON.MeshBuilder.CreateLines ( "moon_cut_line", {points: moon_cut_line_data},scene,true); 
    moon_cut_line.material=mooncutMat2;
    moon_cut_line.isVisible=moon_tp_visible*moon_tp_cut_visible*fe_is_visible;

    //Esfera de corte y línea de corte para El Sol
    sun_cut_sphere = BABYLON.MeshBuilder.CreateSphere("aux ", {diameter:handler_radius*0.5}, scene);
    sun_cut_sphere.material=suncutMat;
    sun_cut_sphere.position=sun_cut_p;
    sun_cut_sphere.isVisible=sun_tp_visible*sun_tp_cut_visible*fe_is_visible;

    sun_cut_line =BABYLON.MeshBuilder.CreateLines ( "sun_cut_line", {points: sun_cut_line_data},scene,true); 
    sun_cut_line.material=suncutMat2;
    sun_cut_line.isVisible=sun_tp_visible*sun_tp_cut_visible*fe_is_visible;

    //Líneas de observación de usuario sobre la TG
    user_line_1 =BABYLON.MeshBuilder.CreateLines ( "user_line_1", {points: user_data_line_1},scene,true); 
    user_line_1.material=redMat2;
    user_line_1.isVisible=user_tg_lines_visible;

    user_line_2 =BABYLON.MeshBuilder.CreateLines ( "user_line_2", {points: user_data_line_2},scene,true); 
    user_line_2.material=blueMat2;
    user_line_2.isVisible=user_tg_lines_visible;

    //Líneas de observación de usuario sobre la TP
    fe_user_line_1 =BABYLON.MeshBuilder.CreateLines ( "fe_user_line_1", {points: fe_user_data_line_1},scene,true); 
    fe_user_line_1.material=redMat2;
    fe_user_line_1.isVisible=user_tp_lines_visible*fe_is_visible;

    fe_user_line_2 =BABYLON.MeshBuilder.CreateLines ( "fe_user_line_2", {points: fe_user_data_line_2},scene,true); 
    fe_user_line_2.material=blueMat2;
    fe_user_line_2.isVisible=user_tp_lines_visible*fe_is_visible;

    //Trayectorias del Sol cenital
    sun_tr_line =BABYLON.MeshBuilder.CreateLines ( "user_line_1", {points: sun_tr_line_data},scene,true); 
    sun_tr_line.material=suncutMat2;
    sun_tr_line_fe =BABYLON.MeshBuilder.CreateLines ( "user_line_1", {points: sun_tr_line_data_fe},scene,true); 
    sun_tr_line_fe.material=suncutMat2;
    sun_tr_line_fe.isVisible=fe_is_visible;

    //Trayectorias de la luna cenital
    moon_tr_line =BABYLON.MeshBuilder.CreateLines ( "user_line_1", {points: moon_tr_line_data},scene,true); 
    moon_tr_line.material=mooncutMat2;
    moon_tr_line_fe =BABYLON.MeshBuilder.CreateLines ( "user_line_1", {points: moon_tr_line_data_fe},scene,true); 
    moon_tr_line_fe.material=mooncutMat2;
    moon_tr_line_fe.isVisible=fe_is_visible;
        
    //Rose lines
    rose_line =BABYLON.MeshBuilder.CreateLines ( "rose_line", {points: rose_lines_data, colors: rose_lines_color_data},scene,true); 
    rose_line.material=auxMat2;

    //Lineas del horizonte geométrico
    hc_line =BABYLON.MeshBuilder.CreateLines ( "hc_line", {points: hc_lines_data, colors: hc_lines_color_data},scene,true); 
    hc_line.material=auxMat2;
    hc_line.renderingGroupId = 1;

    //Material de las lineas de umbra
    eclu_mat=new BABYLON.StandardMaterial("eclu_mat", scene);
    eclu_mat.diffuseColor=line_color_moon;
    eclu_mat.ambientColor=new BABYLON.Color3(1,0,0);
    eclu_mat.specularColor=new BABYLON.Color3(0,0,0);
    eclu_mat.emissiveColor=new BABYLON.Color3(1,0,0);
    eclu_mat.useLogarithmicDepth=true;

    //Material de las lineas de penumbra
    eclp_mat=new BABYLON.StandardMaterial("eclp_mat", scene);
    eclp_mat.diffuseColor=line_color_moon;
    eclp_mat.ambientColor=new BABYLON.Color3(1,1,0);
    eclp_mat.specularColor=new BABYLON.Color3(0,0,0);
    eclp_mat.emissiveColor=new BABYLON.Color3(1,1,0);
    eclp_mat.useLogarithmicDepth=true;

    //Lineas de eclipse    
    eclipse_line_umbra =BABYLON.MeshBuilder.CreateLines ( "eclipse_line", {points: eclipse_data_umbra},scene,true); 
    eclipse_line_umbra.material=eclu_mat;
    eclipse_line_penumbra =BABYLON.MeshBuilder.CreateLines ( "eclipse_line", {points: eclipse_data_penumbra},scene,true); 
    eclipse_line_penumbra.material=eclu_mat;

    eclipse_line_umbra_fe =BABYLON.MeshBuilder.CreateLines ( "eclipse_line", {points: eclipse_data_umbra_fe},scene,true); 
    eclipse_line_umbra_fe.material=eclp_mat;
    eclipse_line_umbra_fe.isVisible=fe_is_visible;
    eclipse_line_penumbra_fe =BABYLON.MeshBuilder.CreateLines ( "eclipse_line", {points: eclipse_data_penumbra_fe},scene,true); 
    eclipse_line_penumbra_fe.material=eclp_mat;
    eclipse_line_penumbra_fe.isVisible=fe_is_visible;
    
    sumo_line_sp =BABYLON.MeshBuilder.CreateLines ( "sun-moon line sp", {points: sumopos_sp},scene,true); 
    sumo_line_sp.material=auxMat2;
    sumo_line_fe =BABYLON.MeshBuilder.CreateLines ( "sun-moon line fe", {points: sumopos_fe},scene,true); 
    sumo_line_fe.material=auxMat2;
    sumopro_line_sp =BABYLON.MeshBuilder.CreateLines ( "sun-moon line fe", {points: sumopro_sp},scene,true); 
    sumopro_line_sp.material=auxMat2;
    sumopro_line_sp.alpha=0.125;
    sumo_line_sp.isVisible=eclipse_test*fe_is_visible;
    sumo_line_fe.isVisible=eclipse_test*fe_is_visible;
    sumopro_line_sp.isVisible=eclipse_test;

    //Material de las lineas de umbra
    stars_lines_mat=new BABYLON.StandardMaterial("stars_lines_mat", scene);
    stars_lines_mat.diffuseColor=line_color_moon;
    stars_lines_mat.ambientColor=new BABYLON.Color3(1,1,1);
    stars_lines_mat.specularColor=new BABYLON.Color3(1,1,1);
    stars_lines_mat.emissiveColor=new BABYLON.Color3(1,1,1);
    stars_lines_mat.useLogarithmicDepth=true;
    stars_lines_mat.alpha=0.11;
    stars_lines =BABYLON.MeshBuilder.CreateLines ( "stars lines", {points: star_pos, updatable: true},scene); 
    stars_lines.material=stars_lines_mat;
    stars_lines.isVisible=stars_visible;
    
    //--Esfera celeste
    sky_sphere = BABYLON.MeshBuilder.CreateSphere("sky_sphere", {segments:32, diameter:1000000}, scene);

    sky_sphere.isPickable=false;
    sky_sphere.isVisible=stars_visible;				

    var sky_material = new BABYLON.StandardMaterial("sky_sphere_material", scene);
    sky_material.backFaceCulling = false;
    sky_material.disableLighting = true;
    sky_material.diffuseTexture = new BABYLON.Texture("images/sky_map_05_1.jpg", scene);
    sky_material.emissiveColor = new BABYLON.Color3(1, 1, 1);
    sky_material.diffuseTexture.uScale=1;
    sky_material.diffuseTexture.vScale=-1;
    //sky_material.useLogarithmicDepth = true;
    sky_sphere.material = sky_material;

    tilt=23.4393*dtor;
    sky_sphere.rotate(BABYLON.Axis.X, -tilt, BABYLON.Space.WORLD);
    sky_sphere.rotate(BABYLON.Axis.Y, 0.0, BABYLON.Space.WORLD);
    sky_sphere.rotate(BABYLON.Axis.Z, 0.0, BABYLON.Space.WORLD);

    //Corrección de precesión simple
    var precesa=-3.82394E-5 *(JD-2451545.0)*dtor;
    sky_sphere.rotate(BABYLON.Axis.X, 0.0, BABYLON.Space.WORLD);
    sky_sphere.rotate(BABYLON.Axis.Y, precesa, BABYLON.Space.WORLD);
    sky_sphere.rotate(BABYLON.Axis.Z, 0.0, BABYLON.Space.WORLD);

    sky_sphere.rotate(BABYLON.Axis.X, tilt, BABYLON.Space.WORLD);
    sky_sphere.rotate(BABYLON.Axis.Y, 0.0, BABYLON.Space.WORLD);
    sky_sphere.rotate(BABYLON.Axis.Z, 0.0, BABYLON.Space.WORLD);

    sky_sphere.rotate(BABYLON.Axis.X, 0.0, BABYLON.Space.WORLD);
    sky_sphere.rotate(BABYLON.Axis.Y, Math.PI+calc_gmst(), BABYLON.Space.WORLD);
    sky_sphere.rotate(BABYLON.Axis.Z, 0.0, BABYLON.Space.WORLD);
    
    //-------------------
    

    //--------------------------------------------------------
    
    

    //Efecto neón para las líneas
    var glo = new BABYLON.GlowLayer("glow_effect", scene, {
        blurKernelSize: 30
    });
    //glo.addExcludedMesh(EarthSphere);
    //glo.addExcludedMesh(EarthDisc);
    glo.addExcludedMesh(redSphere);
    glo.addExcludedMesh(blueSphere);
    glo.intensity = 2;
    var glow_factor=1.0;
    
    glo.customEmissiveColorSelector = (mesh, subMesh, material, result) => {

        if (mesh == ortodromic_line || mesh == ortodromic_line_fe) {

            result.r = line_color_orto.r*glow_factor;
            result.g = line_color_orto.g*glow_factor;
            result.b = line_color_orto.b*glow_factor;

        } else if (mesh == loxodromic_line || mesh == loxodromic_line_fe) {

            result.r = line_color_loxo.r*glow_factor;
            result.g = line_color_loxo.g*glow_factor;
            result.b = line_color_loxo.b*glow_factor;

        } else if (mesh==flatodromic_line_fe || mesh == flatodromic_line_sp) {

            result.r = line_color_flat.r*glow_factor;
            result.g = line_color_flat.g*glow_factor;
            result.b = line_color_flat.b*glow_factor;

        } else if (mesh==equiangular_line_fe || mesh == equiangular_line_sp) {

            result.r = line_color_eqac.r*glow_factor;
            result.g = line_color_eqac.g*glow_factor;
            result.b = line_color_eqac.b*glow_factor;

        } else if (mesh==sunSphere || mesh==sunFe) {

            result.r = 1*glow_factor;
            result.g = 1*glow_factor;
            result.b = 0*glow_factor;

        } else if (mesh==moonSphere || mesh==moonFe) {

            result.r = 1*glow_factor;
            result.g = 1*glow_factor;
            result.b = 1*glow_factor;
        
        } else if (mesh==eclipse_line_umbra || mesh==eclipse_line_umbra_fe) {

            result.r = 1*glow_factor;
            result.g = 0*glow_factor;
            result.b = 0*glow_factor;
            
        } else if (mesh==eclipse_line_penumbra || mesh==eclipse_line_penumbra_fe) {

            result.r = 1*glow_factor;
            result.g = 1*glow_factor;
            result.b = 0*glow_factor;           

        } else {
            result.r=0;
            result.g=0;
            result.b=0;
        }
    }

    //Efecto neón para las líneas de posición o dirección
    var glo2 = new BABYLON.GlowLayer("glow_effect", scene, {
        blurKernelSize: 15
    });
    glo2.addExcludedMesh(redSphere);
    glo2.addExcludedMesh(blueSphere);
    glo2.intensity = 3;
    var glow_factor=0.5;
    
    glo2.customEmissiveColorSelector = (mesh, subMesh, material, result) => {

        if (mesh == moon_line_1 || mesh==sun_line_1 || 
            mesh == fe_moon_line_1 || mesh==fe_sun_line_1) {

            result.r = 1*glow_factor;
            result.g = 0*glow_factor;
            result.b = 0*glow_factor;

        } else if (mesh == moon_line_2 || mesh == fe_moon_line_2 ) {

            result.r = 0*glow_factor;
            result.g = 0*glow_factor;
            result.b = 1*glow_factor;

        } else if (mesh==sun_line_2 || mesh==fe_sun_line_2) {

            result.r = 0;
            result.g = 0;
            result.b = 0.8;

        } else if (mesh==fe_moon_arrow_1 || mesh==fe_moon_arrow_2) {

            result.r=0.5/3;
            result.g=0.5/3;
            result.b=0.5/3;

        } else if (mesh==fe_sun_arrow_1 || mesh==fe_sun_arrow_2) {

            result.r=1/3;
            result.g=1/3;
            result.b=0/3;

        } else if (mesh == sun_line_c ) {

            result.r = 1*glow_factor;
            result.g = 1*glow_factor;
            result.b = 0*glow_factor;

        } else if (mesh == moon_line_c ) {

            result.r = 1*glow_factor;
            result.g = 1*glow_factor;
            result.b = 1*glow_factor;

        } else if (mesh==user_line_1 || mesh==user_line_2 ||
                   mesh ==fe_user_line_1 || mesh==fe_user_line_2) {
            
            result.r=0.3;
            result.g=0.3;
            result.b=0.3;

        } else {

            result.r=0;
            result.g=0;
            result.b=0;
        }
    }
    
    
    //Punto de inicio y 
    //objeto seleccionado
    var startingPoint;
    var currentMesh;

    FECHA=obtiene_fecha_actual();
    JD=calc_jd(FECHA);

    ssp=new BABYLON.Vector3(0,0,0);
    ssp.copyFrom(sun_sphere_pos);
    ssp.normalize();
    ssp.scaleInPlace(-1);

    light.excludedMeshes.push(EarthSphere);
    light.excludedMeshes.push(MoonSphere);
    light.excludedMeshes.push(SunSphere);
    light2 = new BABYLON.DirectionalLight("DirectionalLight", ssp, scene);
    light2.includedOnlyMeshe=EarthSphere;
    light2.excludedMeshes.push(MoonSphere);
    light2.excludedMeshes.push(shadowEarth);
    light2.excludedMeshes.push(shadowEarth2);
    light2.excludedMeshes.push(SunSphere);

    msp=new BABYLON.Vector3(0,0,0);
    msp.copyFrom(sun_pos);
    msp=msp.subtract(moon_pos);
    msp.normalize();
    msp.scaleInPlace(-1);
    light3 = new BABYLON.DirectionalLight("DirectionalLight", msp, scene);
    light3.includedOnlyMeshe=MoonSphere;
    light3.excludedMeshes.push(EarthSphere);
    light3.excludedMeshes.push(redSphere);
    light3.excludedMeshes.push(blueSphere);
    light3.excludedMeshes.push(shadowEarth);
    light3.excludedMeshes.push(shadowEarth2);
    light3.excludedMeshes.push(SunSphere);
    light3.intensity=4;

    var rt_moon1 = new BABYLON.RenderTargetTexture("render texture moon 1", 256, scene, false, false);
    scene.customRenderTargets.push(rt_moon1);
	rt_moon1.activeCamera = camera_moon_1;
    rt_moon1.renderList = scene.meshes;
        
    var pip_moon1_mat = new BABYLON.StandardMaterial("texturePlane", scene);
    pip_moon1_mat.specularColor=new BABYLON.Color3(0,0,0);
    pip_moon1_mat.diffuseColor=new BABYLON.Color3(0,0,0);
    pip_moon1_mat.emissiveTexture = rt_moon1;
    pip_moon1_mat.useLogarithmicDepth=true;

    var pip_moon1 = BABYLON.Mesh.CreatePlane("plane", 1.3, scene);
    pip_moon1.position = new BABYLON.Vector3(3.065-0.15, 1.165-0.15, 4);
    pip_moon1.parent = camera;
    pip_moon1.material = pip_moon1_mat;
    pip_moon1.isVisible=0;
    pip_moon1.renderingGroupId=2;


    var rt_moon2 = new BABYLON.RenderTargetTexture("render texture moon 2", 256, scene, false, false);
    scene.customRenderTargets.push(rt_moon2);
	rt_moon2.activeCamera = camera_moon_2;
    rt_moon2.renderList = scene.meshes;
    
    var pip_moon2_mat = new BABYLON.StandardMaterial("texturePlane", scene);
    pip_moon2_mat.specularColor=new BABYLON.Color3(0,0,0);
    pip_moon2_mat.diffuseColor=new BABYLON.Color3(0,0,0);
    pip_moon2_mat.emissiveTexture = rt_moon2;
    pip_moon2_mat.useLogarithmicDepth=true;

    var pip_moon2 = BABYLON.Mesh.CreatePlane("plane", 1.3, scene);
    pip_moon2.position = new BABYLON.Vector3(3.065-0.055-0.15, 1.165-1.07-0.45, 3.925);
    pip_moon2.parent = camera;
    pip_moon2.material = pip_moon2_mat;
    pip_moon2.isVisible=0;
    pip_moon2.renderingGroupId=2;
    
    const hl = new BABYLON.HighlightLayer("hl1", scene);
    //hl.outerGlow=false;
    hl.addMesh(pip_moon2, BABYLON.Color3.Blue());
    hl.addMesh(pip_moon1, BABYLON.Color3.Red());

    //GUI--------------------------------------------------------

    var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");
	//var advancedTexture1 = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");
	//var advancedTexture2 = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");
	
    //advancedTexture.layer.layerMask=camera.layerMask;
    //advancedTexture1.layer.layerMask=camera_moon_1.layerMask;
    //advancedTexture2.layer.layerMask=camera_moon_2.layerMask;
    
    var al_left=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
    var al_top=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;

    //Panel inferior
    //Cuadro de datos
    var panelI_rect = new BABYLON.GUI.Rectangle();
    panelI_rect.width = "410px";
    panelI_rect.height = "150px";
    panelI_rect.cornerRadius = 10;
    panelI_rect.color = "black";
    panelI_rect.thickness = 4;
    panelI_rect.background = "black";
    panelI_rect.top="0%";
    panelI_rect.left="0%";
    panelI_rect.horizontalAlignment = al_left;
    panelI_rect.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
    panelI_rect.alpha=0.8;
    panelI_rect.isVisible=1;		
    advancedTexture.addControl(panelI_rect);

    //Tab de opciones y visualizacion de datos
    var panelI_tab1_btn=BABYLON.GUI.Button.CreateSimpleButton("tab1","ROUTES");
    panelI_tab1_btn.width="60px";
    panelI_tab1_btn.height="22px";
    panelI_tab1_btn.fontSize = 14;
    panelI_tab1_btn.thickness=1;
    panelI_tab1_btn.cornerRadius=4;
    panelI_tab1_btn.color="white";
    panelI_tab1_btn.background="black";
    panelI_tab1_btn.top="5px";
    panelI_tab1_btn.left="35px";
    panelI_tab1_btn.horizontalAlignment = al_left;
    panelI_tab1_btn.verticalAlignment  = al_top;
    panelI_tab1_btn.textHorizontalAlignment = al_left;		
    panelI_tab1_btn.fontFamily = 'monospace';
    panelI_tab1_btn.onPointerClickObservable.add (function() {

        data_rect.isVisible=1;
        opts_rect.isVisible=0;
        moon_rect.isVisible=0;
        sun_rect.isVisible=0;
        user_rect.isVisible=0;
        user_rect2.isVisible=0;

        panelI_tab1_btn.background="green";
        panelI_tab2_btn.background="black";
        panelI_tab4_btn.background="black";
        panelI_tab5_btn.background="black";
        panelI_tab3_btn.background="black";
        panelI_tab6_btn.background="black";
        
    });
    panelI_rect.addControl(panelI_tab1_btn);

    //Tab de opciones 
    var panelI_tab2_btn=BABYLON.GUI.Button.CreateSimpleButton("tab2","OPTIONS");
    panelI_tab2_btn.width="70px";
    panelI_tab2_btn.height="22px";
    panelI_tab2_btn.fontSize = 14;
    panelI_tab2_btn.thickness=1;
    panelI_tab2_btn.cornerRadius=4;
    panelI_tab2_btn.color="white";
    panelI_tab2_btn.background="green";
    panelI_tab2_btn.top="5px";
    panelI_tab2_btn.left="98px";
    panelI_tab2_btn.horizontalAlignment = al_left;
    panelI_tab2_btn.verticalAlignment  = al_top;
    panelI_tab2_btn.textHorizontalAlignment = al_left;		
    panelI_tab2_btn.fontFamily = 'monospace';
    panelI_tab2_btn.onPointerClickObservable.add (function() {

        data_rect.isVisible=0;
        opts_rect.isVisible=1;
        moon_rect.isVisible=0;
        sun_rect.isVisible=0;
        user_rect.isVisible=0;
        user_rect2.isVisible=0;

        panelI_tab1_btn.background="black";
        panelI_tab2_btn.background="green";
        panelI_tab4_btn.background="black";
        panelI_tab5_btn.background="black";
        panelI_tab3_btn.background="black";
        panelI_tab6_btn.background="black";
        
    });
    panelI_rect.addControl(panelI_tab2_btn);

    //Tab de opciones y visualización de La Luna
    var panelI_tab4_btn=BABYLON.GUI.Button.CreateSimpleButton("tab1","MOON");
    panelI_tab4_btn.width="45px";
    panelI_tab4_btn.height="22px";
    panelI_tab4_btn.fontSize = 14;
    panelI_tab4_btn.thickness=1;
    panelI_tab4_btn.cornerRadius=4;
    panelI_tab4_btn.color="white";
    panelI_tab4_btn.background="black";
    panelI_tab4_btn.top="5px";
    panelI_tab4_btn.left="170px";
    panelI_tab4_btn.horizontalAlignment = al_left;
    panelI_tab4_btn.verticalAlignment  = al_top;
    panelI_tab4_btn.textHorizontalAlignment = al_left;		
    panelI_tab4_btn.fontFamily = 'monospace';
    panelI_tab4_btn.onPointerClickObservable.add (function() {

        data_rect.isVisible=0;
        opts_rect.isVisible=0;
        moon_rect.isVisible=1;
        sun_rect.isVisible=0;
        user_rect.isVisible=0;
        user_rect2.isVisible=0;

        panelI_tab1_btn.background="black";
        panelI_tab2_btn.background="black";
        panelI_tab4_btn.background="green";
        panelI_tab5_btn.background="black";
        panelI_tab3_btn.background="black";
        panelI_tab6_btn.background="black";
        
    });
    panelI_rect.addControl(panelI_tab4_btn);

    //Tab de opciones y visualización del Sol
    var panelI_tab5_btn=BABYLON.GUI.Button.CreateSimpleButton("tab1","SUN");
    panelI_tab5_btn.width="45px";
    panelI_tab5_btn.height="22px";
    panelI_tab5_btn.fontSize = 14;
    panelI_tab5_btn.thickness=1;
    panelI_tab5_btn.cornerRadius=4;
    panelI_tab5_btn.color="white";
    panelI_tab5_btn.background="black";
    panelI_tab5_btn.top="5px";
    panelI_tab5_btn.left="217px";
    panelI_tab5_btn.horizontalAlignment = al_left;
    panelI_tab5_btn.verticalAlignment  = al_top;
    panelI_tab5_btn.textHorizontalAlignment = al_left;		
    panelI_tab5_btn.fontFamily = 'monospace';
    panelI_tab5_btn.onPointerClickObservable.add (function() {

        data_rect.isVisible=0;
        opts_rect.isVisible=0;
        moon_rect.isVisible=0;
        sun_rect.isVisible=1;
        user_rect.isVisible=0;
        user_rect2.isVisible=0;

        panelI_tab1_btn.background="black";
        panelI_tab2_btn.background="black";
        panelI_tab4_btn.background="black";
        panelI_tab5_btn.background="green";
        panelI_tab3_btn.background="black";
        panelI_tab6_btn.background="black";
        
    });
    panelI_rect.addControl(panelI_tab5_btn);

    //Tab de opciones de usuario
    var panelI_tab3_btn=BABYLON.GUI.Button.CreateSimpleButton("tab1","USER I");
    panelI_tab3_btn.width="60px";
    panelI_tab3_btn.height="22px";
    panelI_tab3_btn.fontSize = 14;
    panelI_tab3_btn.thickness=1;
    panelI_tab3_btn.cornerRadius=4;
    panelI_tab3_btn.color="white";
    panelI_tab3_btn.background="black";
    panelI_tab3_btn.top="5px";
    panelI_tab3_btn.left="264px";
    panelI_tab3_btn.horizontalAlignment = al_left;
    panelI_tab3_btn.verticalAlignment  = al_top;
    panelI_tab3_btn.textHorizontalAlignment = al_left;		
    panelI_tab3_btn.fontFamily = 'monospace';
    panelI_tab3_btn.onPointerClickObservable.add (function() {

        data_rect.isVisible=0;
        opts_rect.isVisible=0;
        moon_rect.isVisible=0;
        sun_rect.isVisible=0;
        user_rect.isVisible=1;
        user_rect2.isVisible=0;

        panelI_tab1_btn.background="black";
        panelI_tab2_btn.background="black";
        panelI_tab4_btn.background="black";
        panelI_tab5_btn.background="black";
        panelI_tab3_btn.background="green";
        panelI_tab6_btn.background="black";
        
    });
    panelI_rect.addControl(panelI_tab3_btn);

    //Tab de opciones de usuario
    var panelI_tab6_btn=BABYLON.GUI.Button.CreateSimpleButton("tab1","USER II");
    panelI_tab6_btn.width="65px";
    panelI_tab6_btn.height="22px";
    panelI_tab6_btn.fontSize = 14;
    panelI_tab6_btn.thickness=1;
    panelI_tab6_btn.cornerRadius=4;
    panelI_tab6_btn.color="white";
    panelI_tab6_btn.background="black";
    panelI_tab6_btn.top="5px";
    panelI_tab6_btn.left="327px";
    panelI_tab6_btn.horizontalAlignment = al_left;
    panelI_tab6_btn.verticalAlignment  = al_top;
    panelI_tab6_btn.textHorizontalAlignment = al_left;		
    panelI_tab6_btn.fontFamily = 'monospace';
    panelI_tab6_btn.onPointerClickObservable.add (function() {

        data_rect.isVisible=0;
        opts_rect.isVisible=0;
        moon_rect.isVisible=0;
        sun_rect.isVisible=0;
        user_rect.isVisible=0;
        user_rect2.isVisible=1;

        panelI_tab1_btn.background="black";
        panelI_tab2_btn.background="black";
        panelI_tab4_btn.background="black";
        panelI_tab5_btn.background="black";
        panelI_tab3_btn.background="black";
        panelI_tab6_btn.background="green";
        
    });
    panelI_rect.addControl(panelI_tab6_btn);

    //Cuadro de datos
    var data_rect = new BABYLON.GUI.Rectangle();
    data_rect.width = "400px";
    data_rect.height = "116px";
    data_rect.cornerRadius = 10;
    data_rect.color = "white";
    data_rect.thickness = 1;
    data_rect.background = "black";
    data_rect.top="0%";
    data_rect.left="0%";
    data_rect.horizontalAlignment = al_left;
    data_rect.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
    data_rect.alpha=0.9;
    data_rect.isVisible=0;		
    panelI_rect.addControl(data_rect);

    //Cuadro de opciones
    var opts_rect = new BABYLON.GUI.Rectangle();
    opts_rect.width = "400px";
    opts_rect.height = "116px";
    opts_rect.cornerRadius = 10;
    opts_rect.color = "white";
    opts_rect.thickness = 1;
    opts_rect.background = "black";
    opts_rect.top="0%";
    opts_rect.left="0%";
    opts_rect.horizontalAlignment = al_left;
    opts_rect.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
    opts_rect.alpha=0.6;
    opts_rect.isVisible=1;		
    panelI_rect.addControl(opts_rect);

    //Cuadro de luna
    var moon_rect = new BABYLON.GUI.Rectangle();
    moon_rect.width = "400px";
    moon_rect.height = "116px";
    moon_rect.cornerRadius = 10;
    moon_rect.color = "white";
    moon_rect.thickness = 1;
    moon_rect.background = "black";
    moon_rect.top="0%";
    moon_rect.left="0%";
    moon_rect.horizontalAlignment = al_left;
    moon_rect.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
    moon_rect.alpha=0.9;
    moon_rect.isVisible=0;		
    panelI_rect.addControl(moon_rect);

    //Cuadro de sol
    var sun_rect = new BABYLON.GUI.Rectangle();
    sun_rect.width = "400px";
    sun_rect.height = "116px";
    sun_rect.cornerRadius = 10;
    sun_rect.color = "white";
    sun_rect.thickness = 1;
    sun_rect.background = "black";
    sun_rect.top="0%";
    sun_rect.left="0%";
    sun_rect.horizontalAlignment = al_left;
    sun_rect.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
    sun_rect.alpha=0.9;
    sun_rect.isVisible=0;		
    panelI_rect.addControl(sun_rect);

    //Cuadro de datos de usuario I
    var user_rect = new BABYLON.GUI.Rectangle();
    user_rect.width = "400px";
    user_rect.height = "116px";
    user_rect.cornerRadius = 10;
    user_rect.color = "white";
    user_rect.thickness = 1;
    user_rect.background = "black";
    user_rect.top="0%";
    user_rect.left="0%";
    user_rect.horizontalAlignment = al_left;
    user_rect.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
    user_rect.alpha=0.9;
    user_rect.isVisible=0;		
    panelI_rect.addControl(user_rect);

    //Cuadro de datos de usuario II
    var user_rect2 = new BABYLON.GUI.Rectangle();
    user_rect2.width = "400px";
    user_rect2.height = "116px";
    user_rect2.cornerRadius = 10;
    user_rect2.color = "white";
    user_rect2.thickness = 1;
    user_rect2.background = "black";
    user_rect2.top="0%";
    user_rect2.left="0%";
    user_rect2.horizontalAlignment = al_left;
    user_rect2.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
    user_rect2.alpha=0.9;
    user_rect2.isVisible=0;		
    panelI_rect.addControl(user_rect2);

    //Texto de datos: distancias
    var data_text_1 = new BABYLON.GUI.TextBlock();
    data_text_1.text="            ~ DISTANCES(km)  (BASELINE "+base_line.toFixed(0)+"km)\n"+
                     "\n"+
                     " ORTHODROMIC  "+ ("00"+(Math.round(distancia_sp)).toString()).slice(-5) + "   "
                                    + ("00"+(Math.round(distancia_fe_suma)).toString()).slice(-5) + "\n"+
                     " LOXODROMIC   "+ ("00"+(Math.round(distancia_sp_lox_suma)).toString()).slice(-5) + "   "
                                    + ("00"+(Math.round(distancia_fe_lox_suma)).toString()).slice(-5) + "\n"+
                     " FLATODROMIC  "+ ("00"+(Math.round(distancia_sp_flat_suma)).toString()).slice(-5) + "   "
                                    + ("00"+(Math.round(distancia_fe_flat_suma)).toString()).slice(-5) + "\n"+
                     " EQUIANGULAR  "+ ("00"+(Math.round(distancia_sp_eqac_suma)).toString()).slice(-5) + "   "
                                    + ("00"+(Math.round(distancia_fe_eqac_suma)).toString()).slice(-5);

    data_text_1.color = "white";
    data_text_1.fontSize = 14;
    data_text_1.top="0%";
    data_text_1.horizontalAlignment = al_left;
    data_text_1.verticalAlignment  = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
    data_text_1.textHorizontalAlignment = al_left;		
    data_text_1.fontFamily = 'monospace';
    data_rect.addControl(data_text_1);

    color_mark_global_left=230+10;

    //Texto de datos: v
    var data_text_v = new BABYLON.GUI.TextBlock();
    data_text_v.text="v"
    data_text_v.color = "white";
    data_text_v.fontSize = 14;
    data_text_v.top="-26px";
    data_text_v.left=color_mark_global_left+2;
    data_text_v.horizontalAlignment = al_left;
    data_text_v.verticalAlignment  = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
    data_text_v.textHorizontalAlignment = al_left;		
    data_text_v.fontFamily = 'monospace';
    data_rect.addControl(data_text_v);

    //Control de visibilidad de la línea ortodrómica
    var color_mark_o = new BABYLON.GUI.Rectangle("");
    color_mark_o.color = line_color_orto.toHexString();
    if (orto_es_visible==1) {
        color_mark_o.background = line_color_orto.toHexString();
    } else {
        color_mark_o.background = "black";
    }
    color_mark_o.height="12px";
    color_mark_o.width="12px";
    color_mark_o.top="41px";
    color_mark_o.left=color_mark_global_left;
    color_mark_o.cornerRadius = 1;
    color_mark_o.thickness = 1;
    color_mark_o.horizontalAlignment = al_left;
    color_mark_o.verticalAlignment = al_top;
    color_mark_o.textHorizontalAlignment=al_left;		
    color_mark_o.fontFamily = 'monospace';
    color_mark_o.onPointerClickObservable.add (function() {

        if (orto_es_visible==1) {

            orto_es_visible=0;
            color_mark_o.background="black";
            ortodromic_line.isVisible=orto_es_visible;
            ortodromic_line_fe.isVisible=orto_es_visible;

        } else {

            orto_es_visible=1;
            color_mark_o.background=line_color_orto.toHexString();
            ortodromic_line.isVisible=orto_es_visible;
            ortodromic_line_fe.isVisible=orto_es_visible;

        }

    });
    data_rect.addControl(color_mark_o);

    //Control de visibilidad de la línea loxodrómica
    var color_mark_l = new BABYLON.GUI.Rectangle("");
    color_mark_l.color = line_color_loxo.toHexString();
    if (loxo_es_visible==1) {
        color_mark_l.background = line_color_loxo.toHexString();
    } else {
        color_mark_l.background = "black";
    }
    color_mark_l.height="12px";
    color_mark_l.width="12px";
    color_mark_l.top="58px";
    color_mark_l.left=color_mark_global_left;
    color_mark_l.cornerRadius = 1;
    color_mark_l.thickness = 1;
    color_mark_l.horizontalAlignment = al_left;
    color_mark_l.verticalAlignment = al_top;
    color_mark_l.textHorizontalAlignment=al_left;		
    color_mark_l.fontFamily = 'monospace';
    color_mark_l.onPointerClickObservable.add (function() {

        if (loxo_es_visible==1) {

            loxo_es_visible=0;
            color_mark_l.background="black";
            loxodromic_line.isVisible=loxo_es_visible;
            loxodromic_line_fe.isVisible=loxo_es_visible;

        } else {

            loxo_es_visible=1;
            color_mark_l.background=line_color_loxo.toHexString();
            loxodromic_line.isVisible=loxo_es_visible;
            loxodromic_line_fe.isVisible=loxo_es_visible;

        }

    });
    data_rect.addControl(color_mark_l);

    //Control de visibilidad de la línea flatodrómica
    var color_mark_f = new BABYLON.GUI.Rectangle("");
    color_mark_f.color = line_color_flat.toHexString();
    if (flato_es_visible==1) {
        color_mark_f.background = line_color_flat.toHexString();
    } else {
        color_mark_f.background="black";
    }
    color_mark_f.height="12px";
    color_mark_f.width="12px";
    color_mark_f.top="75px";
    color_mark_f.left=color_mark_global_left;
    color_mark_f.cornerRadius = 1;
    color_mark_f.thickness = 1;
    color_mark_f.horizontalAlignment = al_left;
    color_mark_f.verticalAlignment = al_top;
    color_mark_f.textHorizontalAlignment=al_left;		
    color_mark_f.fontFamily = 'monospace';
    color_mark_f.onPointerClickObservable.add (function() {

        if (flato_es_visible==1) {

            flato_es_visible=0;
            color_mark_f.background="black";
            flatodromic_line_sp.isVisible=flato_es_visible;
            flatodromic_line_fe.isVisible=flato_es_visible;

        } else {

            flato_es_visible=1;
            color_mark_f.background=line_color_flat.toHexString();
            flatodromic_line_sp.isVisible=flato_es_visible;
            flatodromic_line_fe.isVisible=flato_es_visible;

        }

    });
    data_rect.addControl(color_mark_f);

    //Control de visibilidad de la línea equiangular
    var color_mark_e = new BABYLON.GUI.Rectangle("");
    color_mark_e.color = line_color_eqac.toHexString();
    if (eqac_es_visible==1) {
        color_mark_e.background = line_color_eqac.toHexString();
    } else {
        color_mark_e.background="black";
    }
    color_mark_e.height="12px";
    color_mark_e.width="12px";
    color_mark_e.top="92px";
    color_mark_e.left=color_mark_global_left;
    color_mark_e.cornerRadius = 1;
    color_mark_e.thickness = 1;
    color_mark_e.horizontalAlignment = al_left;
    color_mark_e.verticalAlignment = al_top;
    color_mark_e.textHorizontalAlignment=al_left;		
    color_mark_e.fontFamily = 'monospace';
    color_mark_e.onPointerClickObservable.add (function() {

        if (eqac_es_visible==1) {

            eqac_es_visible=0;
            color_mark_e.background="black";
            equiangular_line_sp.isVisible=eqac_es_visible;
            equiangular_line_fe.isVisible=eqac_es_visible;

        } else {

            eqac_es_visible=1;
            color_mark_e.background=line_color_eqac.toHexString();
            equiangular_line_sp.isVisible=eqac_es_visible;
            equiangular_line_fe.isVisible=eqac_es_visible;

        }

    });
    data_rect.addControl(color_mark_e);

    //Control para mantener la distancia
    //ortodrómica constante
    var kod_mark = new BABYLON.GUI.Rectangle("");
    kod_mark.color = "gray";
    kod_mark.background = "gray";
    kod_mark.height="16px";
    kod_mark.width="160px";
    kod_mark.top="41px";
    kod_mark.left="5px";
    kod_mark.cornerRadius = 1;
    kod_mark.thickness = 1;
    kod_mark.horizontalAlignment = al_left;
    kod_mark.verticalAlignment = al_top;
    kod_mark.textHorizontalAlignment=al_left;		
    kod_mark.fontFamily = 'monospace';
    kod_mark.onPointerClickObservable.add (function() {

       if (keep_orto_dist==1) {
        
           keep_orto_dist=0;
           kod_mark.background="gray";

       } else {

           keep_orto_dist=1;
           kod_mark.background="red";

       }

    });
    data_rect.addControl(kod_mark);

    sp_mark_global_left=108;

    //Texto de datos: Sphere
    var data_text_sp = new BABYLON.GUI.TextBlock();
    data_text_sp.text="Sphere"
    data_text_sp.color = "white";
    data_text_sp.fontSize = 12;
    data_text_sp.top="21px";
    data_text_sp.height="16px";
    data_text_sp.width="60px";
    data_text_sp.left=sp_mark_global_left+4;
    data_text_sp.horizontalAlignment = al_left;
    data_text_sp.verticalAlignment  = al_top;
    data_text_sp.textHorizontalAlignment = al_left;		
    data_text_sp.fontFamily = 'monospace';
    data_rect.addControl(data_text_sp);

    //Control selección de info de las líneas
    //sobre la esfera
    var sp_mark = new BABYLON.GUI.Rectangle("");
    sp_mark.color = "black";
    sp_mark.background = "red";
    sp_mark.height="18px";
    sp_mark.width="57px";
    sp_mark.top="21px";
    sp_mark.left=sp_mark_global_left;
    sp_mark.cornerRadius = 1;
    sp_mark.thickness = 1;
    sp_mark.horizontalAlignment = al_left;
    sp_mark.verticalAlignment = al_top;
    sp_mark.textHorizontalAlignment=al_left;		
    sp_mark.fontFamily = 'monospace';
    sp_mark.onPointerClickObservable.add (function() {

       if (sp_sel==1) {
        
           sp_sel=0;
           fe_sel=1;
           sp_mark.background="gray";
           fe_mark.background="red";

           camera.target=EarthDisk.position;
           camera.radius=6.5*rfe;

       } else {

           sp_sel=1;
           fe_sel=0;
           sp_mark.background="red";
           fe_mark.background="gray"

           camera.target=EarthSphere.position;
           camera.radius=4.0*r;

       }

    });
    data_rect.addControl(sp_mark);

    fe_mark_global_left=182;

    //Texto de datos: Sphere
    var data_text_fe = new BABYLON.GUI.TextBlock();
    data_text_fe.text="Disk"
    data_text_fe.color = "white";
    data_text_fe.fontSize = 12;
    data_text_fe.top="21px";
    data_text_fe.height="16px";
    data_text_fe.width="60px";
    data_text_fe.left=fe_mark_global_left-1;
    data_text_fe.horizontalAlignment = al_left;
    data_text_fe.verticalAlignment  = al_top;
    data_text_fe.textHorizontalAlignment = al_left;		
    data_text_fe.fontFamily = 'monospace';
    data_rect.addControl(data_text_fe);

    //Control selección de info de las líneas
    //sobre el disco
    var fe_mark = new BABYLON.GUI.Rectangle("");
    fe_mark.color = "black";
    fe_mark.background = "gray";
    fe_mark.height="18px";
    fe_mark.width="42px";
    fe_mark.top="21px";
    fe_mark.left=fe_mark_global_left-6;
    fe_mark.cornerRadius = 1;
    fe_mark.thickness = 1;
    fe_mark.horizontalAlignment = al_left;
    fe_mark.verticalAlignment = al_top;
    fe_mark.textHorizontalAlignment=al_left;		
    fe_mark.fontFamily = 'monospace';
    fe_mark.onPointerClickObservable.add (function() {

       if (fe_sel==1) {
        
           fe_sel=0;
           sp_sel=1;
           sp_mark.background="red";
           fe_mark.background="gray";

           camera.target=EarthSphere.position;
           camera.radius=4.0*r;

       } else {

           fe_sel=1;
           sp_sel=0;
           fe_mark.background="red";
           sp_mark.background="gray"

           camera.target=EarthDisk.position;
           camera.radius=6.5*rfe;

       }

    });
    data_rect.addControl(fe_mark);

    //Cuadro de info
    var info_rect = new BABYLON.GUI.Rectangle();
    info_rect.width = "170px";
    info_rect.height = "100px";
    info_rect.cornerRadius = 10;
    info_rect.color = "green";
    info_rect.thickness = 4;
    info_rect.background = "black";
    info_rect.top="-150px";
    info_rect.left="0px";
    info_rect.horizontalAlignment = al_left;
    info_rect.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
    info_rect.alpha=0.6;
    info_rect.isVisible=0;		
    advancedTexture.addControl(info_rect);

    //Texto de info
    var info_text_1 = new BABYLON.GUI.TextBlock();
    info_text_1.text = " ";
    info_text_1.color = "white";
    info_text_1.fontSize = 14;
    info_text_1.top="0%";
    info_text_1.horizontalAlignment = al_left;
    info_text_1.verticalAlignment  = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
    info_text_1.textHorizontalAlignment = al_left;		
    info_text_1.fontFamily = 'monospace';
    info_rect.addControl(info_text_1);

    //Resalado en rojo de la distancia hasta la marca roja
    var red_mark = new BABYLON.GUI.Rectangle("");
    red_mark.color = "red";
    red_mark.background = "red";
    red_mark.height="16px";
    red_mark.width="160px";
    red_mark.top="56px";
    red_mark.left="5px";
    red_mark.cornerRadius = 1;
    red_mark.thickness = 1;
    red_mark.horizontalAlignment = al_left;
    red_mark.verticalAlignment = al_top;
    red_mark.textHorizontalAlignment=al_left;		
    red_mark.alpha=0.5;
    info_rect.addControl(red_mark);

    //Resaltado en azul de la distancia hasta la marca azul
    var blue_mark = new BABYLON.GUI.Rectangle("");
    blue_mark.color = "blue";
    blue_mark.background = "blue";
    blue_mark.height="16px";
    blue_mark.width="160px";
    blue_mark.top="72px";
    blue_mark.left="5px";
    blue_mark.cornerRadius = 1;
    blue_mark.thickness = 1;
    blue_mark.horizontalAlignment = al_left;
    blue_mark.verticalAlignment = al_top;
    blue_mark.textHorizontalAlignment=al_left;		
    blue_mark.alpha=0.5;
    info_rect.addControl(blue_mark);

    info_mark_global_left=262+10;

    //Texto de datos: i
    var data_text_i = new BABYLON.GUI.TextBlock();
    data_text_i.text="i"
    data_text_i.color = "white";
    data_text_i.fontSize = 14;
    data_text_i.top="-26px";
    data_text_i.left=info_mark_global_left+2;
    data_text_i.horizontalAlignment = al_left;
    data_text_i.verticalAlignment  = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
    data_text_i.textHorizontalAlignment = al_left;		
    data_text_i.fontFamily = 'monospace';
    data_rect.addControl(data_text_i);

    //Selector de información sobre la línea ortodrómica
    var info_mark_o = new BABYLON.GUI.Rectangle("");
    info_mark_o.color = line_color_orto.toHexString();
    info_mark_o.background = line_color_orto.toHexString();
    info_mark_o.background = "black";
    info_mark_o.height="12px";
    info_mark_o.width="12px";
    info_mark_o.top="41px";
    info_mark_o.left=info_mark_global_left;
    info_mark_o.cornerRadius = 1;
    info_mark_o.thickness = 1;
    info_mark_o.horizontalAlignment = al_left;
    info_mark_o.verticalAlignment = al_top;
    info_mark_o.textHorizontalAlignment=al_left;		
    info_mark_o.fontFamily = 'monospace';
    info_mark_o.onPointerClickObservable.add (function() {

        if (info_orto==1) {
            
            info_orto=0;
            info_loxo=0;
            info_flat=0;
            info_eqac=0;

            info_mark_o.background = "black";
            info_mark_l.background = "black";
            info_mark_f.background = "black";
            info_mark_e.background = "black";

        } else {

            info_orto=1;
            info_loxo=0;
            info_flat=0;
            info_eqac=0;

            info_mark_o.background = line_color_orto.toHexString();
            info_mark_l.background = "black";
            info_mark_f.background = "black";
            info_mark_e.background = "black";
            
        }

    });
    data_rect.addControl(info_mark_o);

    //Selector de información sobre la línea loxodrómica
    var info_mark_l = new BABYLON.GUI.Rectangle("");
    info_mark_l.color = line_color_loxo.toHexString();
    info_mark_l.background = "black";
    info_mark_l.height="12px";
    info_mark_l.width="12px";
    info_mark_l.top="58px";
    info_mark_l.left=info_mark_global_left;
    info_mark_l.cornerRadius = 1;
    info_mark_l.thickness = 1;
    info_mark_l.horizontalAlignment = al_left;
    info_mark_l.verticalAlignment = al_top;
    info_mark_l.textHorizontalAlignment=al_left;		
    info_mark_l.fontFamily = 'monospace';
    info_mark_l.onPointerClickObservable.add (function() {

        if (info_loxo==1) {
            
            info_orto=0;
            info_loxo=0;
            info_flat=0;
            info_eqac=0;

            info_mark_o.backgorund = "black";
            info_mark_l.background = "black";
            info_mark_f.background = "black";
            info_mark_e.background = "black";

        } else {

            info_orto=0;
            info_loxo=1;
            info_flat=0;
            info_eqac=0;

            info_mark_o.background = "black";
            info_mark_l.background = line_color_loxo.toHexString();
            info_mark_f.background = "black";
            info_mark_e.background = "black";
            
        }

    });
    data_rect.addControl(info_mark_l);

    //Selector de información sobre la línea flatodrómica
    var info_mark_f = new BABYLON.GUI.Rectangle("");
    info_mark_f.color = line_color_flat.toHexString();
    info_mark_f.background = "black";
    info_mark_f.height="12px";
    info_mark_f.width="12px";
    info_mark_f.top="75px";
    info_mark_f.left=info_mark_global_left;
    info_mark_f.cornerRadius = 1;
    info_mark_f.thickness = 1;
    info_mark_f.horizontalAlignment = al_left;
    info_mark_f.verticalAlignment = al_top;
    info_mark_f.textHorizontalAlignment=al_left;		
    info_mark_f.fontFamily = 'monospace';
    info_mark_f.onPointerClickObservable.add (function() {

        if (info_flat==1) {
            
            info_orto=0;
            info_loxo=0;
            info_flat=0;
            info_eqac=0;

            info_mark_o.backgorund = "black";
            info_mark_l.background = "black";
            info_mark_f.background = "black";
            info_mark_e.background = "black";

        } else {

            info_orto=0;
            info_loxo=0;
            info_flat=1;
            info_eqac=0;

            info_mark_o.background = "black";
            info_mark_l.background = "black";
            info_mark_f.background = line_color_flat.toHexString();
            info_mark_e.background = "black";

        }

    });
    data_rect.addControl(info_mark_f);

    //Selector de información sobre la línea equiangular
    var info_mark_e = new BABYLON.GUI.Rectangle("");
    info_mark_e.color = line_color_eqac.toHexString();
    info_mark_e.background = "black";
    info_mark_e.height="12px";
    info_mark_e.width="12px";
    info_mark_e.top="92px";
    info_mark_e.left=info_mark_global_left;
    info_mark_e.cornerRadius = 1;
    info_mark_e.thickness = 1;
    info_mark_e.horizontalAlignment = al_left;
    info_mark_e.verticalAlignment = al_top;
    info_mark_e.textHorizontalAlignment=al_left;		
    info_mark_e.fontFamily = 'monospace';
    info_mark_e.onPointerClickObservable.add (function() {

        if (info_eqac==1) {
            
            info_orto=0;
            info_loxo=0;
            info_flat=0;
            info_eqac=0;

            info_mark_o.backgorund = "black";
            info_mark_l.background = "black";
            info_mark_f.background = "black";
            info_mark_e.background = "black";

        } else {

            info_orto=0;
            info_loxo=0;
            info_flat=0;
            info_eqac=1;

            info_mark_o.background = "black";
            info_mark_l.background = "black";
            info_mark_e.background = line_color_eqac.toHexString();
            info_mark_f.background = "black";

        }

    });
    data_rect.addControl(info_mark_e);
    //----

    var map_text = new BABYLON.GUI.TextBlock();
    map_text.text="MAP\n"+"DEFAULT";
    map_text.color = "white";
    map_text.fontSize = 14;
    map_text.top="40px";
    map_text.left="305px";
    map_text.height="40px";
    map_text.width="80px";
    map_text.horizontalAlignment = al_left;
    map_text.verticalAlignment  = al_top;
    map_text.textHorizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;		
    //map_text.textVerticalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_TOP;		
    map_text.fontFamily = 'monospace';
    data_rect.addControl(map_text);

    //Botón que cambia la fecha y la hora a la actual del sistema
    var map_p_btn=BABYLON.GUI.Button.CreateSimpleButton(">","");
    map_p_btn.textBlock.text=">";
    map_p_btn.width="20px";
    map_p_btn.height="20px";
    map_p_btn.fontSize = 14;
    map_p_btn.thickness=0;
    map_p_btn.color="white";
    map_p_btn.background="green";
    map_p_btn.top="40px";
    map_p_btn.left="370px";
    map_p_btn.horizontalAlignment = al_left;
    map_p_btn.verticalAlignment  = al_top;
    map_p_btn.textHorizontalAlignment = al_left;		
    map_p_btn.fontFamily = 'monospace';
    map_p_btn.onPointerClickObservable.add(function() {

        current_earth_texture++;
        if (current_earth_texture>number_earth_texture) current_earth_texture=number_earth_texture;
       
        if (current_earth_texture==1) {
            map_text.text="MAP\n"+"DEFAULT";
            url_em="images/2560px-Whole_world_-_land_and_oceans.jpg";
        }
        if (current_earth_texture==2) {
            map_text.text="MAP\n"+"AIRLINES";
            url_em="images/airliners_map_02.png";
        }
        if (current_earth_texture==3) {
            map_text.text="MAP\n"+"SHIPPING";
            url_em="images/Shipping_routes_red_black.png";
        }
        if (current_earth_texture==4) {
            map_text.text="MAP\n"+"ECLIPSES";
            url_em="images/earth_ecl_03.jpg";
        }

        EarthMat.diffuseTexture = new BABYLON.Texture(url_em, scene);
        EarthMat.diffuseTexture.uScale=-1;
        EarthMat.diffuseTexture.vScale=-1;

	});	
    data_rect.addControl(map_p_btn);

    //Botón que cambia la fecha y la hora a la actual del sistema
    var map_m_btn=BABYLON.GUI.Button.CreateSimpleButton("<","");
    map_m_btn.textBlock.text="<";
    map_m_btn.width="20px";
    map_m_btn.height="20px";
    map_m_btn.fontSize = 14;
    map_m_btn.thickness=0;
    map_m_btn.color="white";
    map_m_btn.background="green";
    map_m_btn.top="40px";
    map_m_btn.left="300px";
    map_m_btn.horizontalAlignment = al_left;
    map_m_btn.verticalAlignment  = al_top;
    map_m_btn.textHorizontalAlignment = al_left;		
    map_m_btn.fontFamily = 'monospace';
    map_m_btn.onPointerClickObservable.add(function() {

        current_earth_texture--;
        if (current_earth_texture<1) current_earth_texture=1;
       
        if (current_earth_texture==1) {
            map_text.text="MAP\n"+"DEFAULT";
            url_em="images/2560px-Whole_world_-_land_and_oceans.jpg";
        }
        if (current_earth_texture==2) {
            map_text.text="MAP\n"+"AIRLINES";
            url_em="images/airliners_map_02.png";
        }
        if (current_earth_texture==3) {
            map_text.text="MAP\n"+"SHIPPING";
            url_em="images/Shipping_routes_red_black.png";
        }
        if (current_earth_texture==4) {
            map_text.text="MAP\n"+"ECLPSES";
            url_em="images/earth_ecl_03.jpg";
        }

        EarthMat.diffuseTexture = new BABYLON.Texture(url_em, scene);
        EarthMat.diffuseTexture.uScale=-1;
        EarthMat.diffuseTexture.vScale=-1;       

	});	
    data_rect.addControl(map_m_btn);
    //---

    sl_top_pos=10;

    //Texto del cuadro de opciones
    var opt_text = new BABYLON.GUI.TextBlock();
    opt_text.text="\n"+
                  " LINES GLOW                    FE SIZE\n"+
                  " MOUSE SENS.                   FE ANGLE\n\n"+
                  "                CAM FOV\n"+
                  "                FIGURES";
    opt_text.color = "white";
    opt_text.fontSize = 12;
    opt_text.top=sl_top_pos;
    opt_text.height="130px"
    opt_text.left=0;
    opt_text.horizontalAlignment = al_left;
    opt_text.verticalAlignment  = al_top;
    opt_text.textHorizontalAlignment = al_left;		
    opt_text.textVerticalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_TOP;		
    opt_text.fontFamily = 'monospace';
    opts_rect.addControl(opt_text);

    //Control del intensidad del efecto neón
    glow_slider = new BABYLON.GUI.Slider();
    glow_slider.minimum = 0;
    glow_slider.maximum = 10;
    glow_slider.value = 2;
    glow_slider.step=0.001;
    glow_slider.height = "11px";
    glow_slider.width = "90px";
    glow_slider.top=sl_top_pos+4;
    glow_slider.left="96px";
    glow_slider.background = "gray";
    glow_slider.color="gray";
    glow_slider.horizontalAlignment = al_left;
    glow_slider.verticalAlignment = al_top;			
    glow_slider.onValueChangedObservable.add(function(value) {
        glo.intensity = glow_slider.value; 
    });
    opts_rect.addControl(glow_slider);

    //Control del intensidad del efecto neón
    fe_scale_slider = new BABYLON.GUI.Slider();
    fe_scale_slider.minimum = 1;
    fe_scale_slider.maximum = 0.5*Math.PI;
    fe_scale_slider.value = 0.5*Math.PI;
    fe_scale_slider.step=0.01;
    fe_scale_slider.height = "11px";
    fe_scale_slider.width = "90px";
    fe_scale_slider.top=sl_top_pos+4;
    fe_scale_slider.left="290px";
    fe_scale_slider.background = "gray";
    fe_scale_slider.color="gray";
    fe_scale_slider.horizontalAlignment = al_left;
    fe_scale_slider.verticalAlignment = al_top;			
    fe_scale_slider.onValueChangedObservable.add(function(value) {

        sfe=fe_scale_slider.value*1.0;
        rfe=sfe*r;

        EarthDisk.scaling=new BABYLON.Vector3(sfe/sfe0,sfe/sfe0,sfe/sfe0);

        //fe_pos=new BABYLON.Vector3(0,-fe_h,-4*rfe);
        fe_pos=new BABYLON.Vector3(4*rfe*Math.sin(fe_angle),-fe_h,-4*rfe*Math.cos(fe_angle));
        EarthDisk.position= fe_pos.subtract(zero);

        if (fe_sel==1) {
            camera.target=fe_pos;
            //camera.radius=4*r*sfe;
        }

        pos3=rlatlon_to_xyz_fe(rfe,lat1,lon1,h1);
        redSphere_fe.position=pos3.subtract(zero);

        pos4=rlatlon_to_xyz_fe(rfe,lat2,lon2,h2);
        blueSphere_fe.position=pos4.subtract(zero);

        update_all();
        
    });
    opts_rect.addControl(fe_scale_slider);

    //Control del intensidad del efecto neón
    fe_angle_slider = new BABYLON.GUI.Slider();
    fe_angle_slider.minimum = 0;
    fe_angle_slider.maximum = 2*Math.PI;
    fe_angle_slider.value = 0.0
    fe_angle_slider.step=2*Math.PI/360.0;
    fe_angle_slider.height = "11px";
    fe_angle_slider.width = "90px";
    fe_angle_slider.top=sl_top_pos+23;
    fe_angle_slider.left="290px";
    fe_angle_slider.background = "gray";
    fe_angle_slider.color="gray";
    fe_angle_slider.horizontalAlignment = al_left;
    fe_angle_slider.verticalAlignment = al_top;			
    fe_angle_slider.onValueChangedObservable.add(function(value) {

        fe_angle=fe_angle_slider.value*1.0;

        //fe_pos=new BABYLON.Vector3(0,-fe_h,-4*rfe);
        fe_pos=new BABYLON.Vector3(4*rfe*Math.sin(fe_angle),-fe_h,-4*rfe*Math.cos(fe_angle));
        EarthDisk.position= fe_pos.subtract(zero);

        if (fe_sel==1) {
            camera.target=fe_pos;
        }

        pos3=rlatlon_to_xyz_fe(rfe,lat1,lon1,h1);
        redSphere_fe.position=pos3.subtract(zero);

        pos4=rlatlon_to_xyz_fe(rfe,lat2,lon2,h2);
        blueSphere_fe.position=pos4.subtract(zero);

        update_all();
        
    });
    opts_rect.addControl(fe_angle_slider);

    //Control de la sensibilidad del ratón
    //al mover las posiciones
    mouse_slider = new BABYLON.GUI.Slider();
    mouse_slider.minimum = 0.025;
    mouse_slider.maximum = 2;
    mouse_slider.value = mouse_sense;
    mouse_slider.step=(2-0.25)/16;
    mouse_slider.height = "11px";
    mouse_slider.width = "90px";
    mouse_slider.top=sl_top_pos+23;
    mouse_slider.left="96px";
    mouse_slider.background = "gray";
    mouse_slider.color="gray";
    mouse_slider.horizontalAlignment = al_left;
    mouse_slider.verticalAlignment = al_top;			
    mouse_slider.onValueChangedObservable.add(function(value) {
        mouse_sense = mouse_slider.value;
    });
    opts_rect.addControl(mouse_slider);

    //Activa y desactiva las cámaras secundarias
    var vpt_btn=BABYLON.GUI.Button.CreateSimpleButton("Moon cameras","");
    vpt_btn.textBlock.text="POV cameras";
    vpt_btn.width="90px";
    vpt_btn.height="16px";
    vpt_btn.fontSize = 12;
    vpt_btn.thickness=1;
    vpt_btn.color="white";
    vpt_btn.background="red";
    vpt_btn.top=sl_top_pos+45;
    vpt_btn.left="8px";
    vpt_btn.horizontalAlignment = al_left;
    vpt_btn.verticalAlignment  = al_top;
    vpt_btn.textHorizontalAlignment = al_left;		
    vpt_btn.fontFamily = 'monospace';
    vpt_btn.onPointerClickObservable.add(function() {

        if (moon_cameras_option==1) {

            pip_moon1.isVisible=0;
            pip_moon2.isVisible=0;
            //pip_red.isVisible=0;
            //pip_blue.isVisible=0;

            moon_cameras_option=0;
            vpt_btn.background="red";

        } else {

            pip_moon1.isVisible=1;
            pip_moon2.isVisible=1;
            //pip_red.isVisible=1;
            //pip_blue.isVisible=1;

            moon_cameras_option=1;
            vpt_btn.background="green";
        }

	});	
    opts_rect.addControl(vpt_btn);


    //Camaras apuntan a la luna
    var cptm_btn=BABYLON.GUI.Button.CreateSimpleButton("Cam to Moon","");
    cptm_btn.textBlock.text="Cam to Moon";
    cptm_btn.width="90px";
    cptm_btn.height="16px";
    cptm_btn.fontSize = 12;
    cptm_btn.thickness=1;
    cptm_btn.color="white";
    cptm_btn.background="red";
    cptm_btn.top=sl_top_pos+64;
    cptm_btn.left="8px";
    cptm_btn.horizontalAlignment = al_left;
    cptm_btn.verticalAlignment  = al_top;
    cptm_btn.textHorizontalAlignment = al_left;		
    cptm_btn.fontFamily = 'monospace';
    cptm_btn.onPointerClickObservable.add(function() {

        if (moon_cameras_point_moon==1) {moon_cameras_point_moon=0;} else {moon_cameras_point_moon=1;}

        if (moon_cameras_point_moon==1) {

            camera_moon_1.target=moon_pos.subtract(zero);
            camera_moon_2.target=moon_pos.subtract(zero);
            cptm_btn.background="green";

        } else {

            camera_moon_1.target=(user_data_line_1[1]).subtract(zero);
            camera_moon_2.target=(user_data_line_2[1]).subtract(zero);
            cptm_btn.background="red";
        }

	});	
    opts_rect.addControl(cptm_btn);


    //Control del FOV de las cámaras secundarias
    cmfov_slider = new BABYLON.GUI.Slider();
    cmfov_slider.minimum = 1;
    cmfov_slider.maximum = 25;
    cmfov_slider.value = 1;
    cmfov_slider.step=1;
    cmfov_slider.height = "11px";
    cmfov_slider.width = "90px";
    cmfov_slider.top=sl_top_pos+45;
    cmfov_slider.left="175px";
    cmfov_slider.background = "gray";
    cmfov_slider.color="gray";
    cmfov_slider.horizontalAlignment = al_left;
    cmfov_slider.verticalAlignment = al_top;			
    cmfov_slider.onValueChangedObservable.add(function(value) {
        camera_moon_1.fov = cmfov_slider.value*dtor;
        camera_moon_2.fov = cmfov_slider.value*dtor;
    });
    opts_rect.addControl(cmfov_slider);


    //Control del FOV de las cámaras secundarias
    starfig_slider = new BABYLON.GUI.Slider();
    starfig_slider.minimum = 0;
    starfig_slider.maximum = 0.3;
    starfig_slider.value = stars_lines_mat.alpha;
    starfig_slider.step=0.01;
    starfig_slider.height = "11px";
    starfig_slider.width = "90px";
    starfig_slider.top=sl_top_pos+45+20;
    starfig_slider.left="175px";
    starfig_slider.background = "gray";
    starfig_slider.color="gray";
    starfig_slider.horizontalAlignment = al_left;
    starfig_slider.verticalAlignment = al_top;			
    starfig_slider.onValueChangedObservable.add(function(value) {
        stars_lines_mat.alpha=starfig_slider.value;
        stars_lines.material=stars_lines_mat;
    });
    opts_rect.addControl(starfig_slider);


    //Activa y desactiva las cámaras secundarias
    var showsky_btn=BABYLON.GUI.Button.CreateSimpleButton(" Show Sky","");
    showsky_btn.textBlock.text="Show Sky";
    showsky_btn.width="90px";
    showsky_btn.height="16px";
    showsky_btn.fontSize = 12;
    showsky_btn.thickness=1;
    showsky_btn.color="white";
    showsky_btn.background="green";
    showsky_btn.top=sl_top_pos+63+20;
    showsky_btn.left="8px";
    showsky_btn.horizontalAlignment = al_left;
    showsky_btn.verticalAlignment  = al_top;
    showsky_btn.textHorizontalAlignment = al_left;		
    showsky_btn.fontFamily = 'monospace';
    showsky_btn.onPointerClickObservable.add(function() {

        if (stars_visible==1) {

            stars_visible=0;
            showsky_btn.background="red";

        } else {

            stars_visible=1;
            showsky_btn.background="green";
            
        }

        stars_lines.isVisible=stars_visible;
        sky_sphere.isVisible=stars_visible;

	});	
    opts_rect.addControl(showsky_btn);


    //Activa y desactiva las cámaras secundarias
    var fe_is_visible_btn=BABYLON.GUI.Button.CreateSimpleButton("Show FE","");
    fe_is_visible_btn.textBlock.text="Show FE";
    fe_is_visible_btn.width="60px";
    fe_is_visible_btn.height="16px";
    fe_is_visible_btn.fontSize = 12;
    fe_is_visible_btn.thickness=1;
    fe_is_visible_btn.color="white";
    fe_is_visible_btn.background="green";
    fe_is_visible_btn.top=sl_top_pos+63+20;
    fe_is_visible_btn.left=102;
    fe_is_visible_btn.horizontalAlignment = al_left;
    fe_is_visible_btn.verticalAlignment  = al_top;
    fe_is_visible_btn.textHorizontalAlignment = al_left;		
    fe_is_visible_btn.fontFamily = 'monospace';
    if (fe_is_visible==1) {
        fe_is_visible_btn.background="green";
        } else {
        fe_is_visible_btn.background="red";
    }
    fe_is_visible_btn.onPointerClickObservable.add(function() {

        if (fe_is_visible==1) {

            fe_is_visible=0;
            fe_is_visible_btn.background="red";

        } else {

            fe_is_visible=1;
            fe_is_visible_btn.background="green";
            
        }

        update_all();

	});	
    opts_rect.addControl(fe_is_visible_btn);


	 //Activa y desactiva la conrrección de horizonte con la altura
    var hc_btn=BABYLON.GUI.Button.CreateSimpleButton("Horizon Correction","");
    hc_btn.textBlock.text="Alt. Correction";
    hc_btn.width="115px";
    hc_btn.height="16px";
    hc_btn.fontSize = 12;
    hc_btn.thickness=1;
    hc_btn.color="white";
    hc_btn.background="red";
    hc_btn.top=sl_top_pos+45;
    hc_btn.left="275px";
    hc_btn.horizontalAlignment = al_left;
    hc_btn.verticalAlignment  = al_top;
    hc_btn.textHorizontalAlignment = al_left;		
    hc_btn.fontFamily = 'monospace';
    hc_btn.onPointerClickObservable.add(function() {

		  if (horizon_correction==1) {

		  		horizon_correction=0;
				hc_btn.background="red";

		  } else {

			   hc_btn.background="green";
				horizon_correction=1;

		  }

	 });	
    opts_rect.addControl(hc_btn);

    //Activa y desactiva la información adicional
    //sobre los modelos
    var pinfo2_btn=BABYLON.GUI.Button.CreateSimpleButton("+ Info v2.0","");
    pinfo2_btn.textBlock.text="+ Info v2.0";
    pinfo2_btn.width="115px";
    pinfo2_btn.height="16px";
    pinfo2_btn.fontSize = 12;
    pinfo2_btn.thickness=1;
    pinfo2_btn.color="white";
    pinfo2_btn.background="red";
    pinfo2_btn.top=sl_top_pos+63;
    pinfo2_btn.left="275px";
    pinfo2_btn.horizontalAlignment = al_left;
    pinfo2_btn.verticalAlignment  = al_top;
    pinfo2_btn.textHorizontalAlignment = al_left;		
    pinfo2_btn.fontFamily = 'monospace';
    pinfo2_btn.onPointerClickObservable.add(function() {

        if (additional_model_info==1) {

            pinfo2_btn.background="red";
            additional_model_info=0;
        } else {

            pinfo2_btn.background="green";
            additional_model_info=1;
        }

        update_all();

	});	
    opts_rect.addControl(pinfo2_btn);


    //Detalles del reto de Tetraedrum 4
    var tetra01_btn=BABYLON.GUI.Button.CreateSimpleButton("Reto Tetra","");
    tetra01_btn.textBlock.text="Reto Tetra";
    tetra01_btn.width="115px";
    tetra01_btn.height="16px";
    tetra01_btn.fontSize = 12;
    tetra01_btn.thickness=1;
    tetra01_btn.color="white";
    tetra01_btn.background="red";
    tetra01_btn.top=sl_top_pos+63+18;
    tetra01_btn.left="275px";
    tetra01_btn.horizontalAlignment = al_left;
    tetra01_btn.verticalAlignment  = al_top;
    tetra01_btn.textHorizontalAlignment = al_left;		
    tetra01_btn.fontFamily = 'monospace';
    tetra01_btn.onPointerClickObservable.add(function() {

        if (ilu_is_visible==1) {
            tetra01_btn.background="red";
            ilu_is_visible=0;
        } else {
            tetra01_btn.background="green";
            ilu_is_visible=1;
        }

        update_all();
	});	
    opts_rect.addControl(tetra01_btn);


    //Cuadro de fecha
    var date_rect = new BABYLON.GUI.Rectangle();
    date_rect.width = "380px";
    date_rect.height = "155px";
    date_rect.cornerRadius = 10;
    date_rect.color = "white";
    date_rect.thickness = 0;
    date_rect.background = "black";
    date_rect.top="2px";
    date_rect.left="2";
    date_rect.horizontalAlignment = al_left;
    date_rect.verticalAlignment = al_top;
    date_rect.alpha=0.6;
    date_rect.isVisible=1;		
    advancedTexture.addControl(date_rect);

    //Cuadro de fecha
    var open_date_rect = new BABYLON.GUI.Rectangle();
    open_date_rect.width = "150px";
    open_date_rect.height = "50px";
    open_date_rect.cornerRadius = 10;
    open_date_rect.color = "white";
    open_date_rect.thickness = 0;
    open_date_rect.background = "black";
    open_date_rect.top="2px";
    open_date_rect.left="2";
    open_date_rect.horizontalAlignment = al_left;
    open_date_rect.verticalAlignment = al_top;
    open_date_rect.alpha=1;
    open_date_rect.isVisible=0;		
    advancedTexture.addControl(open_date_rect);

    //Línea de separación entre el control de tiempo
    //y el de localización en el cuadro date_rect
    var sep01 = new BABYLON.GUI.Line();
	sep01.x1 = 0;
	sep01.y1 = 62;
	sep01.x2 = 380;
	sep01.y2 = 62;
    sep01.color="white";
    date_rect.addControl(sep01);

    var sep02 = new BABYLON.GUI.Line();
	sep02.x1 = 302;
	sep02.y1 = 0;
	sep02.x2 = 302;
	sep02.y2 = 62;
    sep02.color="gray";
    date_rect.addControl(sep02);

    //Offset GMT para la posición roja
    var gmt_offset_red_text = BABYLON.GUI.Button.CreateSimpleButton("GMT OFFSET RED","");
    gmt_offset_red_text.height="22px"
    gmt_offset_red_text.width="75px"

    var gor=FECHA[3]+GMT_OFFSET_RED;
    var pds=0;var spds="+";
    if (gor>24) { gor-=24; pds=1;spds="+";}
    if (gor<0) {gor+=24;pds=1;spds="-"}; 
    if (gor==24) gor=0;
    gmt_offset_red_text.textBlock.text=gor.toString().padStart(2,"0")+":"+
                                       (FECHA[4]).toString().padStart(2,"0")+
                                       "("+spds+pds.toString()+")";

    gmt_offset_red_text.color = "white";
    gmt_offset_red_text.background="red";
    gmt_offset_red_text.fontSize = 15;
    gmt_offset_red_text.top=5;
    gmt_offset_red_text.left=305;
    gmt_offset_red_text.thickness = 0;
    gmt_offset_red_text.horizontalAlignment = al_left;
    gmt_offset_red_text.verticalAlignment  = al_top;
    gmt_offset_red_text.textHorizontalAlignment = al_left;		
    gmt_offset_red_text.textVerticalAlignment = al_top;		
    gmt_offset_red_text.fontFamily = 'monospace';
    gmt_offset_red_text.onWheelObservable.add(function(evt) {

        if (evt.y<0) {GMT_OFFSET_RED++;} else {GMT_OFFSET_RED--;}
        if (GMT_OFFSET_RED>12) GMT_OFFSET_RED=12;
        if (GMT_OFFSET_RED<-12) GMT_OFFSET_RED=-12;

        gmts_offset();

    });	
    date_rect.addControl(gmt_offset_red_text);


    //Offset GMT para la posición azul
    var gmt_offset_blue_text = BABYLON.GUI.Button.CreateSimpleButton("GMT OFFSET BLUE","");
    gmt_offset_blue_text.height="22px"
    gmt_offset_blue_text.width="75px"

    var gob=FECHA[3]+GMT_OFFSET_BLUE;
    var pds=0;var spds="+";
    if (gob>24) { gob-=24; pds=1;spds="+";}
    if (gob<0) {gob+=24;pds=1;spds="-"}; 
    if (gob==24) gob=0;
    gmt_offset_blue_text.textBlock.text=gob.toString().padStart(2,"0")+":"+
                                       (FECHA[4]).toString().padStart(2,"0")+
                                       "("+spds+pds.toString()+")";

    gmt_offset_blue_text.color = "white";
    gmt_offset_blue_text.background="blue";
    gmt_offset_blue_text.fontSize = 15;
    gmt_offset_blue_text.top=35;
    gmt_offset_blue_text.left=305;
    gmt_offset_blue_text.thickness = 0;
    gmt_offset_blue_text.horizontalAlignment = al_left;
    gmt_offset_blue_text.verticalAlignment  = al_top;
    gmt_offset_blue_text.textHorizontalAlignment = al_left;		
    gmt_offset_blue_text.textVerticalAlignment = al_top;		
    gmt_offset_blue_text.fontFamily = 'monospace';
    gmt_offset_blue_text.onWheelObservable.add(function(evt) {

        if (evt.y<0) {GMT_OFFSET_BLUE++;} else {GMT_OFFSET_BLUE--;}
        if (GMT_OFFSET_BLUE>12) GMT_OFFSET_BLUE=12;
        if (GMT_OFFSET_BLUE<-12) GMT_OFFSET_BLUE=-12;

        gmts_offset();

    });	
    date_rect.addControl(gmt_offset_blue_text);
    

    function gmts_offset() {

        var gor=FECHA[3]+GMT_OFFSET_RED;
        var pds=0;var spds="+";
        if (gor>24) { gor-=24; pds=1;spds="+";}
        if (gor<0) {gor+=24;pds=1;spds="-"}; 
        if (gor==24) gor=0;
        gmt_offset_red_text.textBlock.text=gor.toString().padStart(2,"0")+":"+
                                        (FECHA[4]).toString().padStart(2,"0")+
                                        "("+spds+pds.toString()+")";

        var gob=FECHA[3]+GMT_OFFSET_BLUE;
        var pds=0;var spds="+";
        if (gob>24) { gob-=24; pds=1;spds="+";}
        if (gob<0) {gob+=24;pds=1;spds="-"}; 
        if (gob==24) gob=0;
        gmt_offset_blue_text.textBlock.text=gob.toString().padStart(2,"0")+":"+
                                        (FECHA[4]).toString().padStart(2,"0")+
                                        "("+spds+pds.toString()+")";
    }


    //Cuadro de localización
    var loca_rect = new BABYLON.GUI.Rectangle();
    loca_rect.width = "380px";
    loca_rect.height = "90px";
    loca_rect.cornerRadius = 10;
    loca_rect.color = "white";
    loca_rect.thickness = 0;
    loca_rect.background = "black";
    loca_rect.top="62px";
    loca_rect.left="0px";
    loca_rect.horizontalAlignment = al_left;
    loca_rect.verticalAlignment = al_top;
    loca_rect.alpha=1;
    loca_rect.isVisible=1;		
    date_rect.addControl(loca_rect);

    //Control de ocultación del cuadro de tiempo
    var close_date_text = new BABYLON.GUI.TextBlock();
    close_date_text.height="25px"
    close_date_text.width="40px"
    close_date_text.text="<-";
    close_date_text.color = "red";
    close_date_text.fontSize = 18;
    close_date_text.top=33;
    close_date_text.left=5;
    close_date_text.horizontalAlignment = al_left;
    close_date_text.verticalAlignment  = al_top;
    close_date_text.textHorizontalAlignment = al_left;		
    close_date_text.textVerticalAlignment = al_top;		
    close_date_text.fontFamily = 'monospace';
    close_date_text.onPointerClickObservable.add(function() {
        date_rect.isVisible=0;
        open_date_rect.isVisible=1;
    });
    date_rect.addControl(close_date_text);

    //Control que muestra del cuadro de tiempo
    var open_date_text = new BABYLON.GUI.TextBlock();
    open_date_text.height="35px"
    open_date_text.width="140px"
    open_date_text.text="TIME / POSITION\nCONTROL  ->";
    open_date_text.color = "green";
    open_date_text.fontSize = 14;
    open_date_text.top="5px";
    open_date_text.left="5px";
    open_date_text.horizontalAlignment = al_left;
    open_date_text.verticalAlignment  = al_top;
    open_date_text.textHorizontalAlignment = al_left;		
    open_date_text.textVerticalAlignment = al_top;		
    open_date_text.fontFamily = 'monospace';
    open_date_text.onPointerClickObservable.add(function() {
        date_rect.isVisible=1;
        open_date_rect.isVisible=0;
    });
    open_date_rect.addControl(open_date_text);

    var date_top_pos=10;

    //Texto del cuadro de tiempo
    var date_text = new BABYLON.GUI.TextBlock();
    date_text.height="25px"
    date_text.width="40px"
    date_text.text="(UTC)";
    date_text.color = "white";
    date_text.fontSize = 14;
    date_text.top=date_top_pos+1;
    date_text.left=5;
    date_text.horizontalAlignment = al_left;
    date_text.verticalAlignment  = al_top;
    date_text.textHorizontalAlignment = al_left;		
    date_text.textVerticalAlignment = al_top;		
    date_text.fontFamily = 'monospace';
    date_rect.addControl(date_text);

    //Botón que cambia la fecha y la hora a la actual del sistema
    var now_btn=BABYLON.GUI.Button.CreateSimpleButton("NOW","");
    now_btn.textBlock.text="NOW!";
    now_btn.width="36px";
    now_btn.height="18px";
    now_btn.fontSize = 14;
    now_btn.thickness=0;
    now_btn.color="white";
    now_btn.background="green";
    now_btn.top=date_top_pos+30;
    now_btn.left="50px";
    now_btn.horizontalAlignment = al_left;
    now_btn.verticalAlignment  = al_top;
    now_btn.textHorizontalAlignment = al_left;		
    now_btn.fontFamily = 'monospace';
    now_btn.onPointerClickObservable.add(function() {

        FECHA=obtiene_fecha_actual();
        JD=calc_jd(FECHA);

        day_btn.textBlock.text=FECHA[0].toString().padStart(2,"0");
        month_btn.textBlock.text=FECHA[1].toString().padStart(2,"0");
        year_btn.textBlock.text=FECHA[2].toString();
        hour_btn.textBlock.text=FECHA[3].toString().padStart(2,"0")+":";
        minu_btn.textBlock.text=FECHA[4].toString().padStart(2,"0")+":";
        segu_btn.textBlock.text=FECHA[5].toString().padStart(2,"0");

        gmts_offset();

        update_all();

	});	
    date_rect.addControl(now_btn);

    //Cambio del paso temporal
    var time_step_btn=BABYLON.GUI.Button.CreateSimpleButton("NOW","");
    time_step_btn.textBlock.text="x"+ TIME_STEP.toString();
    time_step_btn.width="40px";
    time_step_btn.height="18px";
    time_step_btn.fontSize = 14;
    time_step_btn.thickness=0;
    time_step_btn.color="white";
    time_step_btn.background="black";
    time_step_btn.top=date_top_pos+32;
    time_step_btn.left="260px";
    time_step_btn.horizontalAlignment = al_left;
    time_step_btn.verticalAlignment  = al_top;
    time_step_btn.textHorizontalAlignment = al_left;		
    time_step_btn.fontFamily = 'monospace';
    time_step_btn.onWheelObservable.add(function(evt) {

        if (evt.y<0) {
            TIME_STEP+=1 
        } else {
            TIME_STEP-=1;
        }

        if (TIME_STEP<=1) TIME_STEP=1;
        if (TIME_STEP>10) TIME_STEP=10;

        time_step_btn.textBlock.text="x"+ TIME_STEP.toString();
        
	});	
    date_rect.addControl(time_step_btn);

    //--intervalo

    step_day_val=0;
    step_hour_val=0;
    step_min_val=0;
    step_seg_val=0;

    //Control de intervalo dias
    var step_day_btn=BABYLON.GUI.Button.CreateSimpleButton("step day","");
    step_day_btn.textBlock.text=step_day_val.toString().padStart(2,"0");
    step_day_btn.width="30px";
    step_day_btn.height="18px";
    step_day_btn.fontSize = 16;
    step_day_btn.thickness=0;
    step_day_btn.color="white"
    step_day_btn.background="black"
    step_day_btn.top=date_top_pos+30;
    step_day_btn.left="155px";
    step_day_btn.horizontalAlignment = al_left;
    step_day_btn.verticalAlignment  = al_top;
    step_day_btn.textHorizontalAlignment = al_left;		
    step_day_btn.fontFamily = 'monospace';
    step_day_btn.onWheelObservable.add(function(evt) {

        if (evt.y<0) {step_day_val++;} else {step_day_val--;}
        if (step_day_val>99) step_day_val=99;
        if (step_day_val<0) step_day_val=0;
        step_day_btn.textBlock.text=step_day_val.toString().padStart(2,"0");

	});	
    date_rect.addControl(step_day_btn);

    //Control de intervalo dias
    var step_hour_btn=BABYLON.GUI.Button.CreateSimpleButton("hour","");
    step_hour_btn.textBlock.text=step_hour_val.toString().padStart(2,"0")+":";
    step_hour_btn.width="30px";
    step_hour_btn.height="18px";
    step_hour_btn.fontSize = 16;
    step_hour_btn.thickness=0;
    step_hour_btn.color="white"
    step_hour_btn.background="black"
    step_hour_btn.top=date_top_pos+30;
    step_hour_btn.left="183px";
    step_hour_btn.horizontalAlignment = al_left;
    step_hour_btn.verticalAlignment  = al_top;
    step_hour_btn.textHorizontalAlignment = al_left;		
    step_hour_btn.fontFamily = 'monospace';
    step_hour_btn.onWheelObservable.add(function(evt) {

        if (evt.y<0) {step_hour_val++;} else {step_hour_val--;}
        if (step_hour_val<0) step_hour_val+=24;
        if (step_hour_val>23) step_hour_val-=24;
        step_hour_btn.textBlock.text=step_hour_val.toString().padStart(2,"0")+':';

	});	
    date_rect.addControl(step_hour_btn);

    //Control de intervalo dias
    var step_min_btn=BABYLON.GUI.Button.CreateSimpleButton("step min","");
    step_min_btn.textBlock.text=step_hour_val.toString().padStart(2,"0")+":";
    step_min_btn.width="30px";
    step_min_btn.height="18px";
    step_min_btn.fontSize = 16;
    step_min_btn.thickness=0;
    step_min_btn.color="white"
    step_min_btn.background="black"
    step_min_btn.top=date_top_pos+30;
    step_min_btn.left="210px";
    step_min_btn.horizontalAlignment = al_left;
    step_min_btn.verticalAlignment  = al_top;
    step_min_btn.textHorizontalAlignment = al_left;		
    step_min_btn.fontFamily = 'monospace';
    step_min_btn.onWheelObservable.add(function(evt) {

        if (evt.y<0) {step_min_val++;} else {step_min_val--;}
        if (step_min_val<0) step_min_val+=60;
        if (step_min_val>59) step_min_val-=60;
        step_min_btn.textBlock.text=step_min_val.toString().padStart(2,"0")+':';

	});	
    date_rect.addControl(step_min_btn);

    //Control de intervalo dias
    var step_seg_btn=BABYLON.GUI.Button.CreateSimpleButton("step min","");
    step_seg_btn.textBlock.text=step_hour_val.toString().padStart(2,"0");
    step_seg_btn.width="20px";
    step_seg_btn.height="18px";
    step_seg_btn.fontSize = 16;
    step_seg_btn.thickness=0;
    step_seg_btn.color="white"
    step_seg_btn.background="black"
    step_seg_btn.top=date_top_pos+30;
    step_seg_btn.left="237px";
    step_seg_btn.horizontalAlignment = al_left;
    step_seg_btn.verticalAlignment  = al_top;
    step_seg_btn.textHorizontalAlignment = al_left;		
    step_seg_btn.fontFamily = 'monospace';
    step_seg_btn.onWheelObservable.add(function(evt) {

        if (evt.y<0) {step_seg_val++;} else {step_seg_val--;}
        if (step_seg_val<0) step_seg_val+=60;
        if (step_seg_val>59) step_seg_val-=60;
        step_seg_btn.textBlock.text=step_seg_val.toString().padStart(2,"0");

	});	
    date_rect.addControl(step_seg_btn);

    //Control de intervalo 
    var step_int_btn=BABYLON.GUI.Button.CreateSimpleButton("INTERVAL","");
    step_int_btn.textBlock.text='o';
    step_int_btn.width="22px";
    step_int_btn.height="18px";
    step_int_btn.fontSize = 16;
    step_int_btn.thickness=0;
    step_int_btn.color="white"
    step_int_btn.background="green"
    step_int_btn.top=date_top_pos+30;
    step_int_btn.left="110px";
    step_int_btn.horizontalAlignment = al_left;
    step_int_btn.verticalAlignment  = al_top;
    step_int_btn.textHorizontalAlignment = al_left;		
    step_int_btn.fontFamily = 'monospace';
    step_int_btn.onWheelObservable.add(function(evt) {

        var stt=step_day_val+step_hour_val/24.0+step_min_val/1440.0+step_seg_val/86400.0;
        stt*=TIME_STEP;

        if (evt.y<0) {JD+=stt;} else {JD-=stt;}
        FECHA=calc_fecha(JD);

        day_btn.textBlock.text=FECHA[0].toString().padStart(2,"0");
        month_btn.textBlock.text=FECHA[1].toString().padStart(2,"0");
        year_btn.textBlock.text=FECHA[2].toString();
        hour_btn.textBlock.text=FECHA[3].toString().padStart(2,"0")+":";
        minu_btn.textBlock.text=FECHA[4].toString().padStart(2,"0")+":";
        segu_btn.textBlock.text=FECHA[5].toString().padStart(2,"0");

        update_all();

	});	
    date_rect.addControl(step_int_btn);

    //Animación hacia adelante
    var animaf_btn=BABYLON.GUI.Button.CreateSimpleButton("ANIMATION+","");
    animaf_btn.textBlock.text='>';
    animaf_btn.width="16px";
    animaf_btn.height="18px";
    animaf_btn.fontSize = 16;
    animaf_btn.thickness=0;
    animaf_btn.color="white"
    animaf_btn.background="red"
    animaf_btn.top=date_top_pos+30;
    animaf_btn.left="133px";
    animaf_btn.horizontalAlignment = al_left;
    animaf_btn.verticalAlignment  = al_top;
    animaf_btn.textHorizontalAlignment = al_left;		
    animaf_btn.fontFamily = 'monospace';
    animaf_btn.onPointerClickObservable.add(function(evt) {

        if (animation_control==0) {
            animation_control=1;
            animaf_btn.background="green";
        } else {
            animation_control=0;
            animaf_btn.background="red";
            animar_btn.background="red";
        }

	});	
    date_rect.addControl(animaf_btn);

    //Animación hacia atrás
    var animar_btn=BABYLON.GUI.Button.CreateSimpleButton("ANIMATION+","");
    animar_btn.textBlock.text='<';
    animar_btn.width="16px";
    animar_btn.height="18px";
    animar_btn.fontSize = 16;
    animar_btn.thickness=0;
    animar_btn.color="white"
    animar_btn.background="red"
    animar_btn.top=date_top_pos+30;
    animar_btn.left="93px";
    animar_btn.horizontalAlignment = al_left;
    animar_btn.verticalAlignment  = al_top;
    animar_btn.textHorizontalAlignment = al_left;		
    animar_btn.fontFamily = 'monospace';
    animar_btn.onPointerClickObservable.add(function(evt) {

        if (animation_control==0) {
            animation_control=-1;
            animar_btn.background="green";
        } else {
            animation_control=0;
            animar_btn.background="red";
            animaf_btn.background="red";
        }

	});	
    date_rect.addControl(animar_btn);
    //----------------

    //Control de fecha (dia)
    var day_btn=BABYLON.GUI.Button.CreateSimpleButton("day","");
    day_btn.textBlock.text=FECHA[0].toString().padStart(2,"0");
    day_btn.width="30px";
    day_btn.height="25px";
    day_btn.fontSize = 28;
    day_btn.thickness=0;
    day_btn.color="white"
    day_btn.top=date_top_pos;
    day_btn.left="51px";
    day_btn.horizontalAlignment = al_left;
    day_btn.verticalAlignment  = al_top;
    day_btn.textHorizontalAlignment = al_left;		
    day_btn.fontFamily = 'monospace';
    day_btn.onWheelObservable.add(function(evt) {

        if (evt.y<0) {FECHA[0]=FECHA[0]+1.0*TIME_STEP;} else {FECHA[0]=FECHA[0]-1.0*TIME_STEP;}

        var segundo=FECHA[5];
        var minuto=FECHA[4];
        JD=calc_jd(FECHA);
        FECHA=calc_fecha(JD);
        FECHA[5]=segundo;
        FECHA[4]=minuto;
        
        day_btn.textBlock.text=FECHA[0].toString().padStart(2,"0");
        month_btn.textBlock.text=FECHA[1].toString().padStart(2,"0");
        year_btn.textBlock.text=FECHA[2].toString();
        hour_btn.textBlock.text=FECHA[3].toString().padStart(2,"0")+":";
        minu_btn.textBlock.text=FECHA[4].toString().padStart(2,"0")+":";
        segu_btn.textBlock.text=FECHA[5].toString().padStart(2,"0");

        gmts_offset();
        update_all();

	});	
    date_rect.addControl(day_btn);

    //Control de fecha (mes)
    var month_btn = BABYLON.GUI.Button.CreateSimpleButton("month","");
    month_btn.textBlock.text=FECHA[1].toString().padStart(2,"0");
    month_btn.width="30px";
    month_btn.height="25px";
    month_btn.fontSize = 28;
    month_btn.color="white"
    month_btn.top=date_top_pos;
    month_btn.left="88px";
    month_btn.thickness=0;
    month_btn.horizontalAlignment = al_left;
    month_btn.verticalAlignment  = al_top;
    month_btn.textHorizontalAlignment = al_left;		
    month_btn.fontFamily = 'monospace';
    month_btn.onWheelObservable.add(function(evt) {

        var fecha2=FECHA.slice();

        if (evt.y<0) {FECHA[1]=FECHA[1]+1*TIME_STEP;} else {FECHA[1]=FECHA[1]-1*TIME_STEP;}

        var minuto=FECHA[4];
        var segundo=FECHA[5];

        JD=calc_jd(FECHA);
        FECHA=calc_fecha(JD);

        FECHA[0]=fecha2[0]*1.0;

        JD=calc_jd(FECHA);
        FECHA=calc_fecha(JD);

        FECHA[4]=minuto;
        FECHA[5]=segundo;

        day_btn.textBlock.text=FECHA[0].toString().padStart(2,"0");
        month_btn.textBlock.text=FECHA[1].toString().padStart(2,"0");
        year_btn.textBlock.text=FECHA[2].toString();
        hour_btn.textBlock.text=FECHA[3].toString().padStart(2,"0")+":";
        minu_btn.textBlock.text=FECHA[4].toString().padStart(2,"0")+":";
        segu_btn.textBlock.text=FECHA[5].toString().padStart(2,"0");

        gmts_offset();
        update_all();        

	});	
    date_rect.addControl(month_btn);

    ////Control de fecha (año)
    var year_btn = BABYLON.GUI.Button.CreateSimpleButton("year","");
    year_btn.textBlock.text=FECHA[2].toString().padStart(2,"0");
    year_btn.width="60px";
    year_btn.height="25px";
    year_btn.fontSize = 28;
    year_btn.thickness=0;
    year_btn.color="white"
    year_btn.top=date_top_pos;
    year_btn.left="125px";
    year_btn.horizontalAlignment = al_left;
    year_btn.verticalAlignment  = al_top;
    year_btn.textHorizontalAlignment = al_left;		
    year_btn.fontFamily = 'monospace';
    year_btn.onWheelObservable.add(function(evt) {

        if (evt.y<0) {FECHA[2]=FECHA[2]+1*TIME_STEP;} else {FECHA[2]=FECHA[2]-1*TIME_STEP;}

        if (FECHA[2]>=2100) FECHA[2]=2100;
        if (FECHA[2]<=1900) FECHA[2]=1900;

        var minuto=FECHA[4];
        var segundo=FECHA[5];
        JD=calc_jd(FECHA);
        FECHA=calc_fecha(JD);
        FECHA[4]=minuto;
        FECHA[5]=segundo;

        day_btn.textBlock.text=FECHA[0].toString().padStart(2,"0");
        month_btn.textBlock.text=FECHA[1].toString().padStart(2,"0");
        year_btn.textBlock.text=FECHA[2].toString();
        hour_btn.textBlock.text=FECHA[3].toString().padStart(2,"0")+":";
        minu_btn.textBlock.text=FECHA[4].toString().padStart(2,"0")+":";
        segu_btn.textBlock.text=FECHA[5].toString().padStart(2,"0");

        gmts_offset();
        update_all();

	});	
    date_rect.addControl(year_btn);

    var time_top_pos=date_top_pos-1;

    //Control de fecha (hora)
    var hour_btn = BABYLON.GUI.Button.CreateSimpleButton("hour","");
    hour_btn.textBlock.text=FECHA[3].toString().padStart(2,"0")+":";
    hour_btn.width="35px";
    hour_btn.height="25px";
    hour_btn.fontSize = 22;
    hour_btn.thickness=0;
    hour_btn.color="white"
    hour_btn.top=time_top_pos;
    hour_btn.left="194px";
    hour_btn.horizontalAlignment = al_left;
    hour_btn.verticalAlignment  = al_top;
    hour_btn.textHorizontalAlignment = al_left;		
    hour_btn.fontFamily = 'monospace';
    hour_btn.onWheelObservable.add(function(evt) {

        if (evt.y<0) {FECHA[3]=FECHA[3]+1*TIME_STEP;} else {FECHA[3]=FECHA[3]-1*TIME_STEP;}

        var segundo=FECHA[5]*1.0;
        JD=calc_jd(FECHA);
        FECHA=calc_fecha(JD);
        FECHA[5]=segundo*1.0;

        day_btn.textBlock.text=FECHA[0].toString().padStart(2,"0");
        month_btn.textBlock.text=FECHA[1].toString().padStart(2,"0");
        year_btn.textBlock.text=FECHA[2].toString();
        hour_btn.textBlock.text=FECHA[3].toString().padStart(2,"0")+":";
        minu_btn.textBlock.text=FECHA[4].toString().padStart(2,"0")+":";
        segu_btn.textBlock.text=FECHA[5].toString().padStart(2,"0");

        gmts_offset();
        update_all();

	});	
    date_rect.addControl(hour_btn);

    //Control de fecha (minuto)
    var minu_btn = BABYLON.GUI.Button.CreateSimpleButton("minute","");
    minu_btn.textBlock.text=FECHA[4].toString().padStart(2,"0")+":";
    minu_btn.width="30px";
    minu_btn.height="25px";
    minu_btn.fontSize = 22;
    minu_btn.thickness=0;
    minu_btn.color="white"
    minu_btn.top=time_top_pos;
    minu_btn.left="230px";
    minu_btn.horizontalAlignment = al_left;
    minu_btn.verticalAlignment  = al_top;
    minu_btn.textHorizontalAlignment = al_left;		
    minu_btn.fontFamily = 'monospace';
    minu_btn.onWheelObservable.add(function(evt) {

        if (evt.y<0) {FECHA[4]=FECHA[4]+1.000001*TIME_STEP;} else {FECHA[4]=FECHA[4]-1.00000*TIME_STEP;}

        var segundo=FECHA[5]*1.0;
        JD=calc_jd(FECHA);
        FECHA=calc_fecha(JD);
        FECHA[5]=segundo*1.0;

        day_btn.textBlock.text=FECHA[0].toString().padStart(2,"0");
        month_btn.textBlock.text=FECHA[1].toString().padStart(2,"0");
        year_btn.textBlock.text=FECHA[2].toString();
        hour_btn.textBlock.text=FECHA[3].toString().padStart(2,"0")+":";
        minu_btn.textBlock.text=FECHA[4].toString().padStart(2,"0")+":";
        segu_btn.textBlock.text=FECHA[5].toString().padStart(2,"0");

        gmts_offset();
        update_all();

	});	
    date_rect.addControl(minu_btn);

    //Control de fecha (segundo)
    var segu_btn = BABYLON.GUI.Button.CreateSimpleButton("minute","");
    segu_btn.textBlock.text=FECHA[5].toString().padStart(2,"0");
    segu_btn.width="30px";
    segu_btn.height="25px";
    segu_btn.fontSize = 22;
    segu_btn.thickness=0;
    segu_btn.color="white"
    segu_btn.top=time_top_pos;
    segu_btn.left="260px";
    segu_btn.horizontalAlignment = al_left;
    segu_btn.verticalAlignment  = al_top;
    segu_btn.textHorizontalAlignment = al_left;		
    segu_btn.fontFamily = 'monospace';
    segu_btn.onWheelObservable.add(function(evt) {

        if (evt.y<0) {
            JD=JD+1.000001*TIME_STEP/86400.0;
        } else {
            JD=JD-1.000001*TIME_STEP/86400.0;
        }

        FECHA=calc_fecha(JD);

        day_btn.textBlock.text=FECHA[0].toString().padStart(2,"0");
        month_btn.textBlock.text=FECHA[1].toString().padStart(2,"0");
        year_btn.textBlock.text=FECHA[2].toString();
        hour_btn.textBlock.text=FECHA[3].toString().padStart(2,"0")+":";
        minu_btn.textBlock.text=FECHA[4].toString().padStart(2,"0")+":";
        segu_btn.textBlock.text=FECHA[5].toString().padStart(2,"0");

        gmts_offset();
        update_all();

	});	
    date_rect.addControl(segu_btn);
    //------Contenido del tab de opciones---------

    //--------------------------------------------

     //Texto del cuadro de ubicación (ajuste fino)
    var loca_text = new BABYLON.GUI.TextBlock();
    loca_text.text="   LATITUDE    LONGITUDE     HEIGHT    BEARING";
    loca_text.color = "white";
    loca_text.fontSize = 14;
    loca_text.top="5px";
    loca_text.height="30px"
    loca_text.left=0;
    loca_text.horizontalAlignment = al_left;
    loca_text.verticalAlignment  = al_top;
    loca_text.textHorizontalAlignment = al_left;		
    loca_text.textVerticalAlignment = al_top;		
    loca_text.fontFamily = 'monospace';
    loca_rect.addControl(loca_text);

    //--------------ROJA------------------------

    var red_loc_top="30px";
	var loc_left=20;

    var alat1=Math.abs(lat1);
    var slat1="+";
    if (lat1<0) slat1="-";
    var tlat1=slat1+(alat1/dtor).toFixed(2).padStart(5,'0');

    //Ajuste fino de la latitud de la esfera roja (parte entera)
    var lat1_pe_btn=BABYLON.GUI.Button.CreateSimpleButton("lat1 int","");
    lat1_pe_btn.textBlock.text=tlat1.substring(0,4);
    lat1_pe_btn.width="40px";
    lat1_pe_btn.height="20px";
    lat1_pe_btn.fontSize = 20;
    lat1_pe_btn.thickness=0;
    lat1_pe_btn.color="white"
    lat1_pe_btn.background="red";
    lat1_pe_btn.top=red_loc_top;
    lat1_pe_btn.left=loc_left;
    lat1_pe_btn.horizontalAlignment = al_left;
    lat1_pe_btn.verticalAlignment  = al_top;
    lat1_pe_btn.textHorizontalAlignment = al_left;		
    lat1_pe_btn.fontFamily = 'monospace';
    lat1_pe_btn.onWheelObservable.add(function(evt) {

        var val;
        if (evt.y<0) {val=1;} else {val=-1}

        lat1=lat1+val*dtor;
        if (lat1>max_lat*Math.PI/2.0) lat1=max_lat*Math.PI/2.0;
        if (lat1<-max_lat*Math.PI/2.0) lat1=-max_lat*Math.PI/2.0;

        var alat1=Math.abs(lat1);
        var slat1="+";
        if (lat1<0) slat1="-";
        var tlat1=slat1+(alat1/dtor).toFixed(2).padStart(5,'0');
        lat1_pe_btn.textBlock.text=tlat1.substring(0,4);
        lat1_pd_btn.textBlock.text=tlat1.substring(4,6)+"º";

        pos1=rlatlon_to_xyz(r,lat1,lon1,h1);
        redSphere.position=pos1;
		pos3=rlatlon_to_xyz_fe(rfe,lat1,lon1,h1);
		redSphere_fe.position=pos3;
        update_all();
        
	});
    lat1_pe_btn.onPointerClickObservable.add( open_map_for_red=() => {

        marker_type=1;

        //Esconde el canvas de render 3d y
        //hace visible el botón de volver
        canvas.setAttribute("hidden","hidden");
        done_button.removeAttribute("hidden");

        //Elimina los marcadores existentes en el mapa
        map.removeLayer(markers);

        //Genera una nueva capa de marcadores
        markers = new ol.layer.Vector({source: new ol.source.Vector()});
        map.addLayer(markers);

        //Coordenadas del marcador
        map_latlon=[];
        map_latlon[0]=lon1/dtor;
        map_latlon[1]=lat1/dtor;

        //Creación de marcador en la ubicación roja
        var marker = new ol.Feature(new ol.geom.Point(ol.proj.fromLonLat(map_latlon)));

        //Fuente del símbolo del marcador rojo
        if (marker_type==1) {
            marker_icon_source='http://maps.google.com/mapfiles/kml/paddle/red-circle.png';
        }
        if (marker_type==2) {
            marker_icon_source='http://maps.google.com/mapfiles/kml/paddle/blue-circle.png';
        }

        //Estilo de marcador
        marker.setStyle(
            new ol.style.Style({
                image: new ol.style.Icon({
                src: marker_icon_source,
                anchor: [0.5, 1],
                scale: 0.5
                })
            })
        );

        //Añade el marcador a la capa de marcadores
        markers.getSource().addFeature(marker);

    });
    loca_rect.addControl(lat1_pe_btn);

    //Ajuste fino de la latitud de la esfera roja (parte decimal)
    var lat1_pd_btn=BABYLON.GUI.Button.CreateSimpleButton("lat1 dec","");
    lat1_pd_btn.textBlock.text=tlat1.substring(4,6)+"º";
    lat1_pd_btn.width="35px";
    lat1_pd_btn.height="20px";
    lat1_pd_btn.fontSize = 20;
    lat1_pd_btn.thickness=0;
    lat1_pd_btn.color="white";
    lat1_pd_btn.background="red";
    lat1_pd_btn.top=red_loc_top;
    lat1_pd_btn.left=loc_left+40;
    lat1_pd_btn.horizontalAlignment = al_left;
    lat1_pd_btn.verticalAlignment  = al_top;
    lat1_pd_btn.textHorizontalAlignment = al_left;		
    lat1_pd_btn.fontFamily = 'monospace';
    lat1_pd_btn.onPointerClickObservable.add( function() { open_map_for_red(); });
    lat1_pd_btn.onWheelObservable.add(function(evt) {

        var val;
        if (evt.y<0) {val=1;} else {val=-1}

        lat1+=0.01*val*dtor;

        if (lat1>max_lat*Math.PI/2.0) lat1=max_lat*Math.PI/2.0;
        if (lat1<-max_lat*Math.PI/2.0) lat1=-max_lat*Math.PI/2.0;

        var alat1=Math.abs(lat1);
        var slat1="+";
        if (lat1<0) slat1="-";
        var tlat1=slat1+(alat1/dtor).toFixed(2).padStart(5,'0');
        lat1_pe_btn.textBlock.text=tlat1.substring(0,4);
        lat1_pd_btn.textBlock.text=tlat1.substring(4,6)+"º";

        pos1=rlatlon_to_xyz(r,lat1,lon1,h1);
        redSphere.position=pos1;
		pos3=rlatlon_to_xyz_fe(rfe,lat1,lon1,h1);
		redSphere_fe.position=pos3;
        update_all();
 
	});	
    loca_rect.addControl(lat1_pd_btn);


    var alon1=Math.abs(lon1);
    var slon1="+";
    if (lon1<0) slon1="-";
    var tlon1=slon1+(alon1/dtor).toFixed(2).padStart(6,'0');

    //Ajuste fino de la longitud de la esfera roja (parte entera)
    var lon1_pe_btn=BABYLON.GUI.Button.CreateSimpleButton("lon1 int","");
    lon1_pe_btn.textBlock.text=tlon1.substring(0,5);
    lon1_pe_btn.width="50px";
    lon1_pe_btn.height="20px";
    lon1_pe_btn.fontSize = 20;
    lon1_pe_btn.thickness=0;
    lon1_pe_btn.color="white"
    lon1_pe_btn.background="red";
    lon1_pe_btn.top=red_loc_top;
    lon1_pe_btn.left=loc_left+80+17;
    lon1_pe_btn.horizontalAlignment = al_left;
    lon1_pe_btn.verticalAlignment  = al_top;
    lon1_pe_btn.textHorizontalAlignment = al_left;		
    lon1_pe_btn.fontFamily = 'monospace';
    lon1_pe_btn.onPointerClickObservable.add( function() { open_map_for_red(); });
    lon1_pe_btn.onWheelObservable.add(function(evt) {

        var val;
        if (evt.y<0) {val=1;} else {val=-1}

        lon1=lon1+val*dtor;
        if (lon1>Math.PI) lon1=Math.PI;
        if (lon1<-Math.PI) lon1=-Math.PI;

        var alon1=Math.abs(lon1);
        var slon1="+";
        if (lon1<0) slon1="-";
        var tlon1=slon1+(alon1/dtor).toFixed(2).padStart(6,'0');
        lon1_pe_btn.textBlock.text=tlon1.substring(0,5);
        lon1_pd_btn.textBlock.text=tlon1.substring(5,7)+"º";

        pos1=rlatlon_to_xyz(r,lat1,lon1,h1);
        redSphere.position=pos1;
		pos3=rlatlon_to_xyz_fe(rfe,lat1,lon1,h1);
		redSphere_fe.position=pos3;
        update_all();
        
	});	
    loca_rect.addControl(lon1_pe_btn);

    //Ajuste fino de la longitud de la esfera roja (parte decimal)
    var lon1_pd_btn=BABYLON.GUI.Button.CreateSimpleButton("lon1 dec","");
    lon1_pd_btn.textBlock.text=tlon1.substring(5,7)+"º";
    lon1_pd_btn.width="35px";
    lon1_pd_btn.height="20px";
    lon1_pd_btn.fontSize = 20;
    lon1_pd_btn.thickness=0;
    lon1_pd_btn.color="white";
    lon1_pd_btn.background="red";
    lon1_pd_btn.top=red_loc_top;
    lon1_pd_btn.left=loc_left+130+17;
    lon1_pd_btn.horizontalAlignment = al_left;
    lon1_pd_btn.verticalAlignment  = al_top;
    lon1_pd_btn.textHorizontalAlignment = al_left;		
    lon1_pd_btn.fontFamily = 'monospace';
    lon1_pd_btn.onPointerClickObservable.add( function() { open_map_for_red(); });
    lon1_pd_btn.onWheelObservable.add(function(evt) {

        var val;
        if (evt.y<0) {val=1;} else {val=-1}

        lon1=lon1+0.01*val*dtor;
        if (lon1>Math.PI) lon1=Math.PI;
        if (lon1<-Math.PI) lon1=-Math.PI;

        var alon1=Math.abs(lon1);
        var slon1="+";
        if (lon1<0) slon1="-";
        var tlon1=slon1+(alon1/dtor).toFixed(2).padStart(6,'0');
        lon1_pe_btn.textBlock.text=tlon1.substring(0,5);
        lon1_pd_btn.textBlock.text=tlon1.substring(5,7)+"º";

        pos1=rlatlon_to_xyz(r,lat1,lon1,h1);
        redSphere.position=pos1;
		pos3=rlatlon_to_xyz_fe(rfe,lat1,lon1,h1);
		redSphere_fe.position=pos3;
        update_all();
 
	});	
    loca_rect.addControl(lon1_pd_btn);

    //Rumbo ortodrómico sobre la posición de la esfera roja
    var bear1_btn=BABYLON.GUI.Button.CreateSimpleButton("bear1","");
    bear1_btn.textBlock.text=(moon_bear1.toFixed(2)).padStart(6,"0")+"º";
    bear1_btn.width="60px";
    bear1_btn.height="20px";
    bear1_btn.fontSize = 14;
    bear1_btn.thickness=0;
    bear1_btn.color="white";
    bear1_btn.background="red";
    bear1_btn.top=red_loc_top;
    bear1_btn.left=loc_left+170+80+40;
    bear1_btn.horizontalAlignment = al_left;
    bear1_btn.verticalAlignment  = al_top;
    bear1_btn.textHorizontalAlignment = al_left;		
    bear1_btn.fontFamily = 'monospace';
    //Muestra el mapa de selección de la ubicación roja
    //bear1_btn.onPointerClickObservable.add( function() { open_map_for_red(); });
    loca_rect.addControl(bear1_btn);

	 //Altura de la esfera roja (kilómetros)
    var height1k_btn=BABYLON.GUI.Button.CreateSimpleButton("h1k","");
    height1k_btn.textBlock.text=((Math.floor(h1/1000)).toFixed(0)).padStart(3,"0");
    height1k_btn.width="35px";
    height1k_btn.height="20px";
    height1k_btn.fontSize = 18;
    height1k_btn.thickness=0;
    height1k_btn.color="white";
    height1k_btn.background="red";
    height1k_btn.top=red_loc_top;
    height1k_btn.left=loc_left+170+30;
    height1k_btn.horizontalAlignment = al_left;
    height1k_btn.verticalAlignment  = al_top;
    height1k_btn.textHorizontalAlignment = al_left;		
    height1k_btn.fontFamily = 'monospace';
    height1k_btn.onWheelObservable.add(function(evt) {

        var val;
        if (evt.y<0) {val=1;} else {val=-1}

        if (val>0) h1=h1+1000;
        if (val<0) h1=h1-1000;

        if (h1<0) h1=0;
        if (h1>999999) h1=999999;

        h1_alt_co=Math.PI/2.0-Math.asin(earth_radius/(earth_radius+h1/1000));
        
        if (horizon_correction==0) h1_alt_co=0;

        user_alt_1_co=user_alt_1+h1_alt_co/dtor;

        height1k_btn.textBlock.text=((h1/1000).toFixed(0)).padStart(3,"0");
        height1m_btn.textBlock.text=(( h1-Math.floor(h1/1000)*1000  ).toFixed(0)).padStart(3,"0")+"m";

        pos1=rlatlon_to_xyz(r,lat1,lon1,h1);
        redSphere.position=pos1;
		pos3=rlatlon_to_xyz_fe(rfe,lat1,lon1,h1);
		redSphere_fe.position=pos3;
        update_all();
 
	});	
    loca_rect.addControl(height1k_btn);

	 //Altura de la esfera roja (metros)
    var height1m_btn=BABYLON.GUI.Button.CreateSimpleButton("h1m","");
    height1m_btn.textBlock.text=(( h1-Math.floor(h1/1000)*1000  ).toFixed(0)).padStart(3,"0")+"m";
    height1m_btn.width="40px";
    height1m_btn.height="20px";
    height1m_btn.fontSize = 18;
    height1m_btn.thickness=0;
    height1m_btn.color="white";
    height1m_btn.background="red";
    height1m_btn.top=red_loc_top;
    height1m_btn.left=loc_left+170+35+30;
    height1m_btn.horizontalAlignment = al_left;
    height1m_btn.verticalAlignment  = al_top;
    height1m_btn.textHorizontalAlignment = al_left;		
    height1m_btn.fontFamily = 'monospace';
    height1m_btn.onWheelObservable.add(function(evt) {

        var val;
        if (evt.y<0) {val=1;} else {val=-1}

        if (val>0) h1=h1+10;
        if (val<0) h1=h1-10;

        if (h1<0) h1=0;
        if (h1>999999) h1=999999;

        h1_alt_co=Math.PI/2.0-Math.asin(earth_radius/(earth_radius+h1/1000));

        if (horizon_correction==0) h1_alt_co=0;

        user_alt_1_co=user_alt_1+h1_alt_co/dtor;

        height1k_btn.textBlock.text=((Math.floor(h1/1000)).toFixed(0)).padStart(3,"0");
        height1m_btn.textBlock.text=(( h1-Math.floor(h1/1000)*1000  ).toFixed(0)).padStart(3,"0")+"m";

        pos1=rlatlon_to_xyz(r,lat1,lon1,h1);
        redSphere.position=pos1;
		pos3=rlatlon_to_xyz_fe(rfe,lat1,lon1,h1);
		redSphere_fe.position=pos3;
        update_all();
 
	});	
    loca_rect.addControl(height1m_btn);

    //---------------------------------------------------------

    //--------------AZUL------------------------

    var blue_loc_top="55px";
    
    var alat2=Math.abs(lat2);
    var slat2="+";
    if (lat2<0) slat2="-";
    var tlat2=slat2+(alat2/dtor).toFixed(2).padStart(5,'0');

    //Ajuste fino de la latitud de la esfera roja (parte entera)
    var lat2_pe_btn=BABYLON.GUI.Button.CreateSimpleButton("lat2 int","");
    lat2_pe_btn.textBlock.text=tlat2.substring(0,4);
    lat2_pe_btn.width="40px";
    lat2_pe_btn.height="20px";
    lat2_pe_btn.fontSize = 20;
    lat2_pe_btn.thickness=0;
    lat2_pe_btn.color="white"
    lat2_pe_btn.background="blue";
    lat2_pe_btn.top=blue_loc_top;
    lat2_pe_btn.left=loc_left;
    lat2_pe_btn.horizontalAlignment = al_left;
    lat2_pe_btn.verticalAlignment  = al_top;
    lat2_pe_btn.textHorizontalAlignment = al_left;		
    lat2_pe_btn.fontFamily = 'monospace';
    lat2_pe_btn.onWheelObservable.add(function(evt) {

        var val;
        if (evt.y<0) {val=1;} else {val=-1}

        lat2=lat2+val*dtor;
        if (lat2>max_lat*Math.PI/2.0) lat2=max_lat*Math.PI/2.0;
        if (lat2<-max_lat*Math.PI/2.0) lat2=-max_lat*Math.PI/2.0;

        var alat2=Math.abs(lat2);
        var slat2="+";
        if (lat2<0) slat2="-";
        var tlat2=slat2+(alat2/dtor).toFixed(2).padStart(5,'0');
        lat2_pe_btn.textBlock.text=tlat2.substring(0,4);
        lat2_pd_btn.textBlock.text=tlat2.substring(4,6)+"º";

        pos2=rlatlon_to_xyz(r,lat2,lon2,h2);
        blueSphere.position=pos2;
        pos4=rlatlon_to_xyz_fe(rfe,lat2,lon2,h2);
		blueSphere_fe.position=pos4;
        update_all();
        
	});
    lat2_pe_btn.onPointerClickObservable.add( open_map_for_blue=() => {

        marker_type=2;
        //Oculta el canvas de render 3d y
        //hace visible el botón de retorno
        canvas.setAttribute("hidden","hidden");
        done_button.removeAttribute("hidden");

        //Elimina la capa existente de marcadores
        map.removeLayer(markers);

        //Crea una nueva capa de marcadores y la añade al mapa
        markers = new ol.layer.Vector({source: new ol.source.Vector()});
        map.addLayer(markers);

        //Coordenadas de la ubicación azul
        map_latlon=[];
        map_latlon[0]=lon2/dtor;
        map_latlon[1]=lat2/dtor;

        //Crea un marcador en la ubicación azul
        var marker = new ol.Feature(new ol.geom.Point(ol.proj.fromLonLat(map_latlon)));

        //Fuente del símbolo del marcador de la ubicación azul
        if (marker_type==1) {
            marker_icon_source='http://maps.google.com/mapfiles/kml/paddle/red-circle.png';
        }
        if (marker_type==2) {
            marker_icon_source='http://maps.google.com/mapfiles/kml/paddle/blu-circle.png';
        }

        //Estilo del del marcador de la ubicación azul
        marker.setStyle(
            new ol.style.Style({
                image: new ol.style.Icon({
                src: marker_icon_source,
                anchor: [0.5, 1],
                scale: 0.5
                })
            })
        );

        //Añade el marcador azul a la capa de marcadores del mapa
        markers.getSource().addFeature(marker);

    });	
    loca_rect.addControl(lat2_pe_btn);

    //Ajuste fino de la latitud de la esfera azul (parte decimal)
    var lat2_pd_btn=BABYLON.GUI.Button.CreateSimpleButton("lat2 dec","");
    lat2_pd_btn.textBlock.text=tlat2.substring(4,6)+"º";
    lat2_pd_btn.width="35px";
    lat2_pd_btn.height="20px";
    lat2_pd_btn.fontSize = 20;
    lat2_pd_btn.thickness=0;
    lat2_pd_btn.color="white";
    lat2_pd_btn.background="blue";
    lat2_pd_btn.top=blue_loc_top;
    lat2_pd_btn.left=loc_left+40;
    lat2_pd_btn.horizontalAlignment = al_left;
    lat2_pd_btn.verticalAlignment  = al_top;
    lat2_pd_btn.textHorizontalAlignment = al_left;		
    lat2_pd_btn.fontFamily = 'monospace';
    lat2_pd_btn.onPointerClickObservable.add( function() {open_map_for_blue()});
    lat2_pd_btn.onWheelObservable.add(function(evt) {

        var val;
        if (evt.y<0) {val=1;} else {val=-1}

        lat2+=0.01*val*dtor;
        if (lat2>max_lat*Math.PI/2.0) lat2=max_lat*Math.PI/2.0;
        if (lat2<-max_lat*Math.PI/2.0) lat2=-max_lat*Math.PI/2.0;

        var alat2=Math.abs(lat2);
        var slat2="+";
        if (lat2<0) slat2="-";
        var tlat2=slat2+(alat2/dtor).toFixed(2).padStart(5,'0');
        lat2_pe_btn.textBlock.text=tlat2.substring(0,4);
        lat2_pd_btn.textBlock.text=tlat2.substring(4,6)+"º";

        pos2=rlatlon_to_xyz(r,lat2,lon2,h2);
        blueSphere.position=pos2;
		pos4=rlatlon_to_xyz_fe(rfe,lat2,lon2,h2);
		blueSphere_fe.position=pos4;
        update_all();
 
	});	
    loca_rect.addControl(lat2_pd_btn);


    var alon2=Math.abs(lon2);
    var slon2="+";
    if (lon2<0) slon2="-";
    var tlon2=slon2+(alon2/dtor).toFixed(2).padStart(6,'0');

    //Ajuste fino de la longitud de la esfera azul (parte entera)
    var lon2_pe_btn=BABYLON.GUI.Button.CreateSimpleButton("lon2 int","");
    lon2_pe_btn.textBlock.text=tlon2.substring(0,5);
    lon2_pe_btn.width="50px";
    lon2_pe_btn.height="20px";
    lon2_pe_btn.fontSize = 20;
    lon2_pe_btn.thickness=0;
    lon2_pe_btn.color="white"
    lon2_pe_btn.background="blue";
    lon2_pe_btn.top=blue_loc_top;
    lon2_pe_btn.left=loc_left+80+17;
    lon2_pe_btn.horizontalAlignment = al_left;
    lon2_pe_btn.verticalAlignment  = al_top;
    lon2_pe_btn.textHorizontalAlignment = al_left;		
    lon2_pe_btn.fontFamily = 'monospace';
    lon2_pe_btn.onPointerClickObservable.add( function() {open_map_for_blue()});
    lon2_pe_btn.onWheelObservable.add(function(evt) {

        var val;
        if (evt.y<0) {val=1;} else {val=-1}

        lon2=lon2+val*dtor;
        if (lon2>Math.PI) lon2=Math.PI;
        if (lon2<-Math.PI) lon2=-Math.PI;

        var alon2=Math.abs(lon2);
        var slon2="+";
        if (lon2<0) slon2="-";
        var tlon2=slon2+(alon2/dtor).toFixed(2).padStart(6,'0');
        lon2_pe_btn.textBlock.text=tlon2.substring(0,5);
        lon2_pd_btn.textBlock.text=tlon2.substring(5,7)+"º";

        pos2=rlatlon_to_xyz(r,lat2,lon2,h2);
        blueSphere.position=pos2;
        pos4=rlatlon_to_xyz_fe(rfe,lat2,lon2,h2);
		blueSphere_fe.position=pos4;
        update_all();
        
	});	
    loca_rect.addControl(lon2_pe_btn);

    //Ajuste fino de la longitud de la esfera azul (parte decimal)
    var lon2_pd_btn=BABYLON.GUI.Button.CreateSimpleButton("lon2 dec","");
    lon2_pd_btn.textBlock.text=tlon2.substring(5,7)+"º";
    lon2_pd_btn.width="35px";
    lon2_pd_btn.height="20px";
    lon2_pd_btn.fontSize = 20;
    lon2_pd_btn.thickness=0;
    lon2_pd_btn.color="white";
    lon2_pd_btn.background="blue";
    lon2_pd_btn.top=blue_loc_top;
    lon2_pd_btn.left=loc_left+130+17;
    lon2_pd_btn.horizontalAlignment = al_left;
    lon2_pd_btn.verticalAlignment  = al_top;
    lon2_pd_btn.textHorizontalAlignment = al_left;		
    lon2_pd_btn.fontFamily = 'monospace';
    lon2_pd_btn.onPointerClickObservable.add( function() {open_map_for_blue()});
    lon2_pd_btn.onWheelObservable.add(function(evt) {

        var val;
        if (evt.y<0) {val=1;} else {val=-1}

        lon2=lon2+0.01*val*dtor;
        if (lon2>Math.PI) lon2=Math.PI;
        if (lon2<-Math.PI) lon2=-Math.PI;

        var alon2=Math.abs(lon2);
        var slon2="+";
        if (lon2<0) slon2="-";
        var tlon2=slon2+(alon2/dtor).toFixed(2).padStart(6,'0');
        lon2_pe_btn.textBlock.text=tlon2.substring(0,5);
        lon2_pd_btn.textBlock.text=tlon2.substring(5,7)+"º";

        pos2=rlatlon_to_xyz(r,lat2,lon2,h2);
        blueSphere.position=pos2;
		pos4=rlatlon_to_xyz_fe(rfe,lat2,lon2,h2);
		blueSphere_fe.position=pos4;
        update_all();
 
	});	
    loca_rect.addControl(lon2_pd_btn);

    //Rumbo ortodrómico sobre la posición de la esfera azul
    var bear2_btn=BABYLON.GUI.Button.CreateSimpleButton("bear2","");
    bear2_btn.textBlock.text=(moon_bear2.toFixed(2)).padStart(6,"0")+"º";
    bear2_btn.width="60px";
    bear2_btn.height="20px";
    bear2_btn.fontSize = 14;
    bear2_btn.thickness=0;
    bear2_btn.color="white";
    bear2_btn.background="blue";
    bear2_btn.top=blue_loc_top;
    bear2_btn.left=loc_left+170+80+40;
    bear2_btn.horizontalAlignment = al_left;
    bear2_btn.verticalAlignment  = al_top;
    bear2_btn.textHorizontalAlignment = al_left;		
    bear2_btn.fontFamily = 'monospace';
    //Muestra el mapa de selección de la ubicación azul
    //bear2_btn.onPointerClickObservable.add( function() {open_map_for_blue()});
    loca_rect.addControl(bear2_btn);

	 //Altura de la esfera roja (kilómetros)
    var height2k_btn=BABYLON.GUI.Button.CreateSimpleButton("h2k","");
    height2k_btn.textBlock.text=((Math.floor(h2/1000)).toFixed(0)).padStart(3,"0");
    height2k_btn.width="35px";
    height2k_btn.height="20px";
    height2k_btn.fontSize = 18;
    height2k_btn.thickness=0;
    height2k_btn.color="white";
    height2k_btn.background="blue";
    height2k_btn.top=blue_loc_top;
    height2k_btn.left=loc_left+170+30;
    height2k_btn.horizontalAlignment = al_left;
    height2k_btn.verticalAlignment  = al_top;
    height2k_btn.textHorizontalAlignment = al_left;		
    height2k_btn.fontFamily = 'monospace';
    height2k_btn.onWheelObservable.add(function(evt) {

        var val;
        if (evt.y<0) {val=1;} else {val=-1}

        if (val>0) h2=h2+1000;
        if (val<0) h2=h2-1000;

        if (h2<0) h2=0;
        if (h2>999999) h2=999999;

        h2_alt_co=Math.PI/2.0-Math.asin(earth_radius/(earth_radius+h2/1000));

        if (horizon_correction==0) h2_alt_co=0;

        user_alt_2_co=user_alt_2+h2_alt_co/dtor;

        height2k_btn.textBlock.text=((h2/1000).toFixed(0)).padStart(3,"0");
        height2m_btn.textBlock.text=(( h2-Math.floor(h2/1000)*1000  ).toFixed(0)).padStart(3,"0")+"m";

        pos2=rlatlon_to_xyz(r,lat2,lon2,h2);
        blueSphere.position=pos2;
		pos4=rlatlon_to_xyz_fe(rfe,lat2,lon2,h2);
		blueSphere_fe.position=pos4;
        update_all();
 
	});	
    loca_rect.addControl(height2k_btn);

	 //Altura de la esfera roja (metros)
    var height2m_btn=BABYLON.GUI.Button.CreateSimpleButton("h2m","");
    height2m_btn.textBlock.text=(( h2-Math.floor(h2/1000)*1000  ).toFixed(0)).padStart(3,"0")+"m";
    height2m_btn.width="40px";
    height2m_btn.height="20px";
    height2m_btn.fontSize = 18;
    height2m_btn.thickness=0;
    height2m_btn.color="white";
    height2m_btn.background="blue";
    height2m_btn.top=blue_loc_top;
    height2m_btn.left=loc_left+170+35+30;
    height2m_btn.horizontalAlignment = al_left;
    height2m_btn.verticalAlignment  = al_top;
    height2m_btn.textHorizontalAlignment = al_left;		
    height2m_btn.fontFamily = 'monospace';
    height2m_btn.onWheelObservable.add(function(evt) {

        var val;
        if (evt.y<0) {val=1;} else {val=-1}

        if (val>0) h2=h2+10;
        if (val<0) h2=h2-10;

        if (h2<0) h1=0;
        if (h2>999999) h2=999999;

        h2_alt_co=Math.PI/2.0-Math.asin(earth_radius/(earth_radius+h2/1000));

        if (horizon_correction==0) h2_alt_co=0;

        user_alt_2_co=user_alt_2+h2_alt_co/dtor;

        height2k_btn.textBlock.text=((Math.floor(h2/1000)).toFixed(0)).padStart(3,"0");
        height2m_btn.textBlock.text=(( h2-Math.floor(h2/1000)*1000  ).toFixed(0)).padStart(3,"0")+"m";

        pos2=rlatlon_to_xyz(r,lat2,lon2,h2);
        blueSphere.position=pos2;
		pos4=rlatlon_to_xyz_fe(rfe,lat2,lon2,h2);
		blueSphere_fe.position=pos4;
        update_all();
 
	});	
    loca_rect.addControl(height2m_btn);

    //---------------------------------------------------------

    //---------Datos de observación de usuario--------------------

    


    //USER RECT II markers

    usrmk_max=5;
    usrmk_ub_btn=[];
    usrmk_get_red_btn=[];
    usrmk_set_red_btn=[];
    usrmk_get_blue_btn=[];
    usrmk_set_blue_btn=[];
    usrmk_color=[];

    usrmk_lat=[];
    usrmk_lon=[];

    usrmk_pos=[];
    usrmk_mat=[];
    usrmk_sph=[];

    usmrc=100
    usrmk_color[0]= new BABYLON.Color3(255/255.0,usmrc/255.0,usmrc/255.0);
    usrmk_color[1]= new BABYLON.Color3(255/255.0,255/255.0,usmrc/255.0);
    usrmk_color[2]= new BABYLON.Color3(usmrc/255.0,255/255.0,usmrc/255.0);
    usrmk_color[3]= new BABYLON.Color3(usmrc/255.0,255/255.0,255/255.0);
    usrmk_color[4]= new BABYLON.Color3(usmrc/255.0,usmrc/255.0,255/255.0);

    //Texto de información en el tab de usuario
    var usrmk_text = new BABYLON.GUI.TextBlock();
    usrmk_text.text="  Mark    Lat     Lon";
    usrmk_text.color = "white";
    usrmk_text.fontSize = 14;
    usrmk_text.top="2px";
    usrmk_text.left="8px";
    usrmk_text.height="20px"
    usrmk_text.width="180px"
    usrmk_text.horizontalAlignment = al_left;
    usrmk_text.verticalAlignment  = al_top;
    usrmk_text.textHorizontalAlignment = al_left;		
    usrmk_text.textVerticalAlignment = al_top;		
    usrmk_text.fontFamily = 'monospace';
    user_rect2.addControl(usrmk_text);

    for (var evc=0;evc<usrmk_max;evc++) {

        usrmk_lat[evc]=NaN;
        usrmk_lon[evc]=NaN;
        usrmk_pos[evc]=nan.subtract(zero);

        //Marcador de posicion del Sol sobre La Tierra
        usrmk_mat[evc] = new BABYLON.StandardMaterial("usrmk_mat", scene);
        usrmk_mat[evc].diffuseColor = usrmk_color[evc];
        usrmk_mat[evc].specularColor = new BABYLON.Color3(0.0, 0.0, 0.0);
        usrmk_mat[evc].ambientColor = usrmk_color[evc];
        usrmk_mat[evc].emissiveColor = usrmk_color[evc];
        usrmk_mat[evc].alpha=0.5;
        usrmk_mat[evc].useLogarithmicDepth = true;
        
        usrmk_sph[evc] = BABYLON.MeshBuilder.CreateSphere("usrmk_sph", {diameter:0.25}, scene);
        usrmk_sph[evc].material = usrmk_mat[evc];
        usrmk_sph[evc].position=usrmk_pos[evc].subtract(zero);
        glo.addExcludedMesh(usrmk_sph[evc]);
        glo2.addExcludedMesh(usrmk_sph[evc]);
        light2.excludedMeshes.push(usrmk_sph[evc]);
        light3.excludedMeshes.push(usrmk_sph[evc]);
        light.excludedMeshes.push(usrmk_sph[evc]);

        usrmk_ub_btn[evc]=BABYLON.GUI.Button.CreateSimpleButton(evc.toString()," ");
        usrmk_ub_btn[evc].textBlock.text=" "+evc.toString()+"     NONE    NONE";
        usrmk_ub_btn[evc].width="190px";
        usrmk_ub_btn[evc].height="14px";
        usrmk_ub_btn[evc].fontSize = 14;
        usrmk_ub_btn[evc].thickness=0;
        usrmk_ub_btn[evc].color="black"
        usrmk_ub_btn[evc].background=usrmk_color[evc].toHexString();
        usrmk_ub_btn[evc].top=20+18*evc;
        usrmk_ub_btn[evc].left=20;
        usrmk_ub_btn[evc].horizontalAlignment = al_left;
        usrmk_ub_btn[evc].verticalAlignment  = al_top;
        usrmk_ub_btn[evc].textHorizontalAlignment = al_left;		
        usrmk_ub_btn[evc].fontFamily = 'monospace';
        usrmk_ub_btn[evc].onPointerClickObservable.add( function(ev,state) {

            var mkind=Number(state.currentTarget.name);
            usrmk_ub_btn[mkind].textBlock.text=" "+mkind.toString()+"     NONE    NONE";
            
            usrmk_lat[mkind]=NaN;
            usrmk_lon[mkind]=NaN;

            usrmk_pos[mkind]=nan.subtract(zero);
            usrmk_sph[mkind].position=usrmk_pos[mkind].subtract(zero);
            //update_all();
            
        });	
        user_rect2.addControl(usrmk_ub_btn[evc]);

        usrmk_get_red_btn[evc]=BABYLON.GUI.Button.CreateSimpleButton(evc.toString()," ");
        usrmk_get_red_btn[evc].textBlock.text="GET";
        usrmk_get_red_btn[evc].width="35px";
        usrmk_get_red_btn[evc].height="14px";
        usrmk_get_red_btn[evc].fontSize = 14;
        usrmk_get_red_btn[evc].thickness=0;
        usrmk_get_red_btn[evc].color="white"
        usrmk_get_red_btn[evc].background="red";
        usrmk_get_red_btn[evc].top=20+18*evc;
        usrmk_get_red_btn[evc].left=217;
        usrmk_get_red_btn[evc].horizontalAlignment = al_left;
        usrmk_get_red_btn[evc].verticalAlignment  = al_top;
        usrmk_get_red_btn[evc].textHorizontalAlignment = al_left;		
        usrmk_get_red_btn[evc].fontFamily = 'monospace';
        usrmk_get_red_btn[evc].onPointerClickObservable.add( function(ev,state) {

            var mkind=Number(state.currentTarget.name);
            //console.log(mkind);
            
            usrmk_lat[mkind]=lat1/dtor;
            usrmk_lon[mkind]=lon1/dtor;

            var lats,lons;
            if (usrmk_lat[mkind]>=0) {lats="+";} else {lats="-";}
            if (usrmk_lon[mkind]>=0) {lons="+";} else {lons="-";}

            usrmk_ub_btn[mkind].textBlock.text="  "+mkind.toString()+"  "+
                                             lats+Math.abs(usrmk_lat[mkind]).toFixed(2).padStart(5,'0')+"º  "+lons+Math.abs(usrmk_lon[mkind]).toFixed(2).padStart(5,'0')+"º";
                                             
            usrmk_pos[mkind]=rlatlon_to_xyz(r,lat1,lon1,0);
            usrmk_sph[mkind].position=usrmk_pos[mkind].subtract(zero);
            
        });	
        user_rect2.addControl(usrmk_get_red_btn[evc]);

        usrmk_get_blue_btn[evc]=BABYLON.GUI.Button.CreateSimpleButton(evc.toString()," ");
        usrmk_get_blue_btn[evc].textBlock.text="GET";
        usrmk_get_blue_btn[evc].width="35px";
        usrmk_get_blue_btn[evc].height="14px";
        usrmk_get_blue_btn[evc].fontSize = 14;
        usrmk_get_blue_btn[evc].thickness=0;
        usrmk_get_blue_btn[evc].color="white"
        usrmk_get_blue_btn[evc].background="blue";
        usrmk_get_blue_btn[evc].top=20+18*evc;
        usrmk_get_blue_btn[evc].left=260;
        usrmk_get_blue_btn[evc].horizontalAlignment = al_left;
        usrmk_get_blue_btn[evc].verticalAlignment  = al_top;
        usrmk_get_blue_btn[evc].textHorizontalAlignment = al_left;		
        usrmk_get_blue_btn[evc].fontFamily = 'monospace';
        usrmk_get_blue_btn[evc].onPointerClickObservable.add( function(ev,state) {

            var mkind=Number(state.currentTarget.name);
            
            usrmk_lat[mkind]=lat2/dtor;
            usrmk_lon[mkind]=lon2/dtor;

            var lats,lons;
            if (usrmk_lat[mkind]>=0) {lats="+";} else {lats="-";}
            if (usrmk_lon[mkind]>=0) {lons="+";} else {lons="-";}

            usrmk_ub_btn[mkind].textBlock.text="  "+mkind.toString()+"  "+
                                             lats+Math.abs(usrmk_lat[mkind]).toFixed(2).padStart(5,'0')+"º  "+lons+Math.abs(usrmk_lon[mkind]).toFixed(2).padStart(5,'0')+"º";
                                             
            usrmk_pos[mkind]=rlatlon_to_xyz(r,lat2,lon2,0);
            usrmk_sph[mkind].position=usrmk_pos[mkind].subtract(zero);

            //update_all();
            
        });	
        user_rect2.addControl(usrmk_get_blue_btn[evc]);

        usrmk_set_red_btn[evc]=BABYLON.GUI.Button.CreateSimpleButton(evc.toString()," ");
        usrmk_set_red_btn[evc].textBlock.text="SET";
        usrmk_set_red_btn[evc].width="35px";
        usrmk_set_red_btn[evc].height="14px";
        usrmk_set_red_btn[evc].fontSize = 14;
        usrmk_set_red_btn[evc].thickness=0;
        usrmk_set_red_btn[evc].color="white"
        usrmk_set_red_btn[evc].background="red";
        usrmk_set_red_btn[evc].top=20+18*evc;
        usrmk_set_red_btn[evc].left=302;
        usrmk_set_red_btn[evc].horizontalAlignment = al_left;
        usrmk_set_red_btn[evc].verticalAlignment  = al_top;
        usrmk_set_red_btn[evc].textHorizontalAlignment = al_left;		
        usrmk_set_red_btn[evc].fontFamily = 'monospace';
        usrmk_set_red_btn[evc].onPointerClickObservable.add( function(ev,state) {

            var mkind=Number(state.currentTarget.name);

            lat1=usrmk_lat[mkind]*dtor;
            lon1=usrmk_lon[mkind]*dtor;

            pos3=rlatlon_to_xyz_fe(rfe,lat1,lon1,h1);
            pos1=rlatlon_to_xyz(r,lat1,lon1,h1);

            redSphere_fe.position=pos3.subtract(zero);
            redSphere.position=pos1.subtract(zero);

            calculate_lines();
            update_all();
            
        });	
        user_rect2.addControl(usrmk_set_red_btn[evc]);


        usrmk_set_blue_btn[evc]=BABYLON.GUI.Button.CreateSimpleButton(evc.toString()," ");
        usrmk_set_blue_btn[evc].textBlock.text="SET";
        usrmk_set_blue_btn[evc].width="35px";
        usrmk_set_blue_btn[evc].height="14px";
        usrmk_set_blue_btn[evc].fontSize = 14;
        usrmk_set_blue_btn[evc].thickness=0;
        usrmk_set_blue_btn[evc].color="white"
        usrmk_set_blue_btn[evc].background="blue";
        usrmk_set_blue_btn[evc].top=20+18*evc;
        usrmk_set_blue_btn[evc].left=345;
        usrmk_set_blue_btn[evc].horizontalAlignment = al_left;
        usrmk_set_blue_btn[evc].verticalAlignment  = al_top;
        usrmk_set_blue_btn[evc].textHorizontalAlignment = al_left;		
        usrmk_set_blue_btn[evc].fontFamily = 'monospace';
        usrmk_set_blue_btn[evc].onPointerClickObservable.add( function(ev,state) {

            var mkind=Number(state.currentTarget.name);

            lat2=usrmk_lat[mkind]*dtor;
            lon2=usrmk_lon[mkind]*dtor;

            pos4=rlatlon_to_xyz_fe(rfe,lat2,lon2,h2);
            pos2=rlatlon_to_xyz(r,lat2,lon2,h2);

            blueSphere_fe.position=pos4.subtract(zero);
            blueSphere.position=pos2.subtract(zero);

            calculate_lines();
            update_all();
            
        });	
        user_rect2.addControl(usrmk_set_blue_btn[evc]);
    }

    

    //


    //Rojo
    var red_user_top=25+25+10;
    var red_user_left=125;

    user_alt_1_co=user_alt_1+h1_alt_co/dtor;

    var auser_alt_1_co=Math.abs(user_alt_1_co);
    var suser_alt_1_co="+";
    if (user_alt_1_co<0) suser_alt_1_co="-";
    var tuser_alt_1_co=suser_alt_1_co+(auser_alt_1_co).toFixed(4).padStart(7,'0');

    //Altura observación por usuario (parte entera)
    var usr_alt1_pe_btn=BABYLON.GUI.Button.CreateSimpleButton("user alt1 int","");
    usr_alt1_pe_btn.textBlock.text=tuser_alt_1_co.substring(0,4);
    usr_alt1_pe_btn.width="30px";
    usr_alt1_pe_btn.height="18px";
    usr_alt1_pe_btn.fontSize = 16;
    usr_alt1_pe_btn.thickness=0;
    usr_alt1_pe_btn.color="white"
    usr_alt1_pe_btn.background="red";
    usr_alt1_pe_btn.top=red_user_top;
    usr_alt1_pe_btn.left=red_user_left;
    usr_alt1_pe_btn.horizontalAlignment = al_left;
    usr_alt1_pe_btn.verticalAlignment  = al_top;
    usr_alt1_pe_btn.textHorizontalAlignment = al_left;		
    usr_alt1_pe_btn.fontFamily = 'monospace';
    usr_alt1_pe_btn.onWheelObservable.add(function(evt) {

        var val;
        if (evt.y<0) {val=1;} else {val=-1}

        user_alt_1+=val;
        if (user_alt_1>90) user_alt_1=90;
        if (user_alt_1<0) user_alt_1=0;

        update_user_data();
        
        update_all();
        
	});	
    user_rect.addControl(usr_alt1_pe_btn);

    //Altura de observación por usuario (parte decimal)
    var usr_alt1_pd_btn=BABYLON.GUI.Button.CreateSimpleButton("user alt1 dec","");
    usr_alt1_pd_btn.textBlock.text=tuser_alt_1_co.substring(4,6);
    usr_alt1_pd_btn.width="20px";
    usr_alt1_pd_btn.height="18px";
    usr_alt1_pd_btn.fontSize = 16;
    usr_alt1_pd_btn.thickness=0;
    usr_alt1_pd_btn.color="white";
    usr_alt1_pd_btn.background="red";
    usr_alt1_pd_btn.top=red_user_top;
    usr_alt1_pd_btn.left=red_user_left+30;
    usr_alt1_pd_btn.horizontalAlignment = al_left;
    usr_alt1_pd_btn.verticalAlignment  = al_top;
    usr_alt1_pd_btn.textHorizontalAlignment = al_left;		
    usr_alt1_pd_btn.fontFamily = 'monospace';
    usr_alt1_pd_btn.onWheelObservable.add(function(evt) {

        var val;
        if (evt.y<0) {val=1;} else {val=-1}

        user_alt_1+=0.0100000*val;
        if (user_alt_1>90) user_alt_1=90;
        if (user_alt_1<0) user_alt_1=0;

        update_user_data();

        update_all();

	});	
    user_rect.addControl(usr_alt1_pd_btn);

    //Altura de observación por usuario (parte decimal)
    var usr_alt1_pd2_btn=BABYLON.GUI.Button.CreateSimpleButton("user alt1 dec","");
    usr_alt1_pd2_btn.textBlock.text=tuser_alt_1_co.substring(6,8)+"º";
    usr_alt1_pd2_btn.width="25px";
    usr_alt1_pd2_btn.height="18px";
    usr_alt1_pd2_btn.fontSize = 16;
    usr_alt1_pd2_btn.thickness=0;
    usr_alt1_pd2_btn.color="white";
    usr_alt1_pd2_btn.background="red";
    usr_alt1_pd2_btn.top=red_user_top;
    usr_alt1_pd2_btn.left=red_user_left+50;
    usr_alt1_pd2_btn.horizontalAlignment = al_left;
    usr_alt1_pd2_btn.verticalAlignment  = al_top;
    usr_alt1_pd2_btn.textHorizontalAlignment = al_left;		
    usr_alt1_pd2_btn.fontFamily = 'monospace';
    usr_alt1_pd2_btn.onWheelObservable.add(function(evt) {

        var val;
        if (evt.y<0) {val=1;} else {val=-1}

        user_alt_1+=0.000100000*val;
        if (user_alt_1>90) user_alt_1=90;
        if (user_alt_1<0) user_alt_1=0;

        update_user_data();

        update_all();
 
	});	
    user_rect.addControl(usr_alt1_pd2_btn);

    var tuser_az_1=(user_az_1).toFixed(4).padStart(8,'0');

    //Azimut observación por usuario (parte entera)
    var usr_az1_pe_btn=BABYLON.GUI.Button.CreateSimpleButton("user az1 int","");
    usr_az1_pe_btn.textBlock.text=tuser_az_1.substring(0,4);
    usr_az1_pe_btn.width="35px";
    usr_az1_pe_btn.height="18px";
    usr_az1_pe_btn.fontSize = 16;
    usr_az1_pe_btn.thickness=0;
    usr_az1_pe_btn.color="white"
    usr_az1_pe_btn.background="red";
    usr_az1_pe_btn.top=red_user_top;
    usr_az1_pe_btn.left=red_user_left+90;
    usr_az1_pe_btn.horizontalAlignment = al_left;
    usr_az1_pe_btn.verticalAlignment  = al_top;
    usr_az1_pe_btn.textHorizontalAlignment = al_left;		
    usr_az1_pe_btn.fontFamily = 'monospace';
    usr_az1_pe_btn.onWheelObservable.add(function(evt) {

        var val;
        if (evt.y<0) {val=1;} else {val=-1}

        user_az_1+=val;
        if (user_az_1>=360) user_az_1-=360;
        if (user_az_1<0) user_az_1+=360;

        update_user_data();

        update_all();
        
	});	
    user_rect.addControl(usr_az1_pe_btn);

    //Azimut de observación por usuario (parte decimal)
    var usr_az1_pd_btn=BABYLON.GUI.Button.CreateSimpleButton("user az1 dec","");
    usr_az1_pd_btn.textBlock.text=tuser_az_1.substring(4,6);
    usr_az1_pd_btn.width="20px";
    usr_az1_pd_btn.height="18px";
    usr_az1_pd_btn.fontSize = 16;
    usr_az1_pd_btn.thickness=0;
    usr_az1_pd_btn.color="white";
    usr_az1_pd_btn.background="red";
    usr_az1_pd_btn.top=red_user_top;
    usr_az1_pd_btn.left=red_user_left+35+90;
    usr_az1_pd_btn.horizontalAlignment = al_left;
    usr_az1_pd_btn.verticalAlignment  = al_top;
    usr_az1_pd_btn.textHorizontalAlignment = al_left;		
    usr_az1_pd_btn.fontFamily = 'monospace';
    usr_az1_pd_btn.onWheelObservable.add(function(evt) {

        var val;
        if (evt.y<0) {val=1;} else {val=-1}

        user_az_1+=0.01000000*val;
        if (user_az_1>=360) user_az_1-=360;
        if (user_az_1<0) user_az_1+=360;

        update_user_data();

        update_all();
 
	});	
    user_rect.addControl(usr_az1_pd_btn);

    //Azimut de observación por usuario (parte decimal)
    var usr_az1_pd2_btn=BABYLON.GUI.Button.CreateSimpleButton("user az1 dec","");
    usr_az1_pd2_btn.textBlock.text=tuser_az_1.substring(6,8)+"º";
    usr_az1_pd2_btn.width="25px";
    usr_az1_pd2_btn.height="18px";
    usr_az1_pd2_btn.fontSize = 16;
    usr_az1_pd2_btn.thickness=0;
    usr_az1_pd2_btn.color="white";
    usr_az1_pd2_btn.background="red";
    usr_az1_pd2_btn.top=red_user_top;
    usr_az1_pd2_btn.left=red_user_left+35+110;
    usr_az1_pd2_btn.horizontalAlignment = al_left;
    usr_az1_pd2_btn.verticalAlignment  = al_top;
    usr_az1_pd2_btn.textHorizontalAlignment = al_left;		
    usr_az1_pd2_btn.fontFamily = 'monospace';
    usr_az1_pd2_btn.onWheelObservable.add(function(evt) {

        var val;
        if (evt.y<0) {val=1;} else {val=-1}

        user_az_1+=0.0001000000*val;
        if (user_az_1>=360) user_az_1-=360;
        if (user_az_1<0) user_az_1+=360;
        
        update_user_data();

        update_all();
 
	});	
    user_rect.addControl(usr_az1_pd2_btn);

    //
    //Azul

    var blue_user_top=red_user_top+25;
    var blue_user_left=red_user_left;

    user_alt_2_co=user_alt_2+h2_alt_co/dtor;
    var auser_alt_2_co=Math.abs(user_alt_2_co);
    var suser_alt_2_co="+";
    if (user_alt_2_co<0) suser_alt_2_co="-";
    var tuser_alt_2_co=suser_alt_2_co+(auser_alt_2_co).toFixed(4).padStart(7,'0');

    //Altura observación por usuario (parte entera)
    var usr_alt2_pe_btn=BABYLON.GUI.Button.CreateSimpleButton("user alt2 int","");
    usr_alt2_pe_btn.textBlock.text=tuser_alt_2_co.substring(0,4);
    usr_alt2_pe_btn.width="30px";
    usr_alt2_pe_btn.height="18px";
    usr_alt2_pe_btn.fontSize = 16;
    usr_alt2_pe_btn.thickness=0;
    usr_alt2_pe_btn.color="white"
    usr_alt2_pe_btn.background="blue";
    usr_alt2_pe_btn.top=blue_user_top;
    usr_alt2_pe_btn.left=blue_user_left;
    usr_alt2_pe_btn.horizontalAlignment = al_left;
    usr_alt2_pe_btn.verticalAlignment  = al_top;
    usr_alt2_pe_btn.textHorizontalAlignment = al_left;		
    usr_alt2_pe_btn.fontFamily = 'monospace';
    usr_alt2_pe_btn.onWheelObservable.add(function(evt) {

        var val;
        if (evt.y<0) {val=1;} else {val=-1}

        user_alt_2+=val;
        if (user_alt_2>90) user_alt_2=90;
        if (user_alt_2<0) user_alt_2=0;

        update_user_data();

        update_all();
        
	});	
    user_rect.addControl(usr_alt2_pe_btn);

    //Altura de observación por usuario (parte decimal)
    var usr_alt2_pd_btn=BABYLON.GUI.Button.CreateSimpleButton("user alt2 dec","");
    usr_alt2_pd_btn.textBlock.text=tuser_alt_2_co.substring(4,6);
    usr_alt2_pd_btn.width="20px";
    usr_alt2_pd_btn.height="18px";
    usr_alt2_pd_btn.fontSize = 16;
    usr_alt2_pd_btn.thickness=0;
    usr_alt2_pd_btn.color="white";
    usr_alt2_pd_btn.background="blue";
    usr_alt2_pd_btn.top=blue_user_top;
    usr_alt2_pd_btn.left=blue_user_left+30;
    usr_alt2_pd_btn.horizontalAlignment = al_left;
    usr_alt2_pd_btn.verticalAlignment  = al_top;
    usr_alt2_pd_btn.textHorizontalAlignment = al_left;		
    usr_alt2_pd_btn.fontFamily = 'monospace';
    usr_alt2_pd_btn.onWheelObservable.add(function(evt) {

        var val;
        if (evt.y<0) {val=1;} else {val=-1}

        user_alt_2+=0.0100000*val;
        if (user_alt_2>90) user_alt_2=90;
        if (user_alt_2<0) user_alt_2=0;

        update_user_data();

        update_all();
 
	});	
    user_rect.addControl(usr_alt2_pd_btn);

    //Altura de observación por usuario (parte decimal)
    var usr_alt2_pd2_btn=BABYLON.GUI.Button.CreateSimpleButton("user alt2 dec","");
    usr_alt2_pd2_btn.textBlock.text=tuser_alt_2_co.substring(6,8)+"º";

    usr_alt2_pd2_btn.width="25px";
    usr_alt2_pd2_btn.height="18px";
    usr_alt2_pd2_btn.fontSize = 16;
    usr_alt2_pd2_btn.thickness=0;
    usr_alt2_pd2_btn.color="white";
    usr_alt2_pd2_btn.background="blue";
    usr_alt2_pd2_btn.top=blue_user_top;
    usr_alt2_pd2_btn.left=blue_user_left+30+20;
    usr_alt2_pd2_btn.horizontalAlignment = al_left;
    usr_alt2_pd2_btn.verticalAlignment  = al_top;
    usr_alt2_pd2_btn.textHorizontalAlignment = al_left;		
    usr_alt2_pd2_btn.fontFamily = 'monospace';
    usr_alt2_pd2_btn.onWheelObservable.add(function(evt) {

        var val;
        if (evt.y<0) {val=1;} else {val=-1}

        user_alt_2+=0.000100000*val;
        if (user_alt_2>90) user_alt_2=90;
        if (user_alt_2<0) user_alt_2=0;

        update_user_data();

        update_all();
 
	});	
    user_rect.addControl(usr_alt2_pd2_btn);


    var tuser_az_2=(user_az_2).toFixed(4).padStart(8,'0');

    //Azimut observación por usuario (parte entera)
    var usr_az2_pe_btn=BABYLON.GUI.Button.CreateSimpleButton("user az2 int","");
    usr_az2_pe_btn.textBlock.text=tuser_az_2.substring(0,4);
    usr_az2_pe_btn.width="35px";
    usr_az2_pe_btn.height="18px";
    usr_az2_pe_btn.fontSize = 16;
    usr_az2_pe_btn.thickness=0;
    usr_az2_pe_btn.color="white"
    usr_az2_pe_btn.background="blue";
    usr_az2_pe_btn.top=blue_user_top;
    usr_az2_pe_btn.left=blue_user_left+90;
    usr_az2_pe_btn.horizontalAlignment = al_left;
    usr_az2_pe_btn.verticalAlignment  = al_top;
    usr_az2_pe_btn.textHorizontalAlignment = al_left;		
    usr_az2_pe_btn.fontFamily = 'monospace';
    usr_az2_pe_btn.onWheelObservable.add(function(evt) {

        var val;
        if (evt.y<0) {val=1;} else {val=-1}

        user_az_2+=val;
        if (user_az_2>=360) user_az_2-=360;
        if (user_az_2<0) user_az_2+=360;

        update_user_data();

        update_all();
        
	});	
    user_rect.addControl(usr_az2_pe_btn);

    //Azimut de observación por usuario (parte decimal)
    var usr_az2_pd_btn=BABYLON.GUI.Button.CreateSimpleButton("user az2 dec","");
    usr_az2_pd_btn.textBlock.text=tuser_az_2.substring(4,6);
    usr_az2_pd_btn.width="20px";
    usr_az2_pd_btn.height="18px";
    usr_az2_pd_btn.fontSize = 16;
    usr_az2_pd_btn.thickness=0;
    usr_az2_pd_btn.color="white";
    usr_az2_pd_btn.background="blue";
    usr_az2_pd_btn.top=blue_user_top;
    usr_az2_pd_btn.left=blue_user_left+35+90;
    usr_az2_pd_btn.horizontalAlignment = al_left;
    usr_az2_pd_btn.verticalAlignment  = al_top;
    usr_az2_pd_btn.textHorizontalAlignment = al_left;		
    usr_az2_pd_btn.fontFamily = 'monospace';
    usr_az2_pd_btn.onWheelObservable.add(function(evt) {

        var val;
        if (evt.y<0) {val=1;} else {val=-1}

        user_az_2+=0.01000000*val;
        if (user_az_2>=360) user_az_2-=360;
        if (user_az_2<0) user_az_2+=360;

        update_user_data();

        update_all();
 
	});	
    user_rect.addControl(usr_az2_pd_btn);

    //Azimut de observación por usuario (parte decimal)
    var usr_az2_pd2_btn=BABYLON.GUI.Button.CreateSimpleButton("user az2 dec","");
    usr_az2_pd2_btn.textBlock.text=tuser_az_2.substring(6,8)+"º";
    usr_az2_pd2_btn.width="25px";
    usr_az2_pd2_btn.height="18px";
    usr_az2_pd2_btn.fontSize = 16;
    usr_az2_pd2_btn.thickness=0;
    usr_az2_pd2_btn.color="white";
    usr_az2_pd2_btn.background="blue";
    usr_az2_pd2_btn.top=blue_user_top;
    usr_az2_pd2_btn.left=blue_user_left+35+110;
    usr_az2_pd2_btn.horizontalAlignment = al_left;
    usr_az2_pd2_btn.verticalAlignment  = al_top;
    usr_az2_pd2_btn.textHorizontalAlignment = al_left;		
    usr_az2_pd2_btn.fontFamily = 'monospace';
    usr_az2_pd2_btn.onWheelObservable.add(function(evt) {

        var val;
        if (evt.y<0) {val=1;} else {val=-1}

        user_az_2+=0.0001000000*val;
        if (user_az_2>=360) user_az_2-=360;
        if (user_az_2<0) user_az_2+=360;

        update_user_data();

        update_all();
 
	});	
    user_rect.addControl(usr_az2_pd2_btn);

    //
    function update_user_data() {

        user_alt_1_co=user_alt_1+h1_alt_co/dtor;
        var auser_alt_1_co=Math.abs(user_alt_1_co);
        var suser_alt_1_co="+";
        if (user_alt_1_co<0) suser_alt_1_co="-";
        var tuser_alt_1_co=suser_alt_1_co+(auser_alt_1_co).toFixed(4).padStart(7,'0');

        usr_alt1_pe_btn.textBlock.text=tuser_alt_1_co.substring(0,4);
        usr_alt1_pd_btn.textBlock.text=tuser_alt_1_co.substring(4,6);
        usr_alt1_pd2_btn.textBlock.text=tuser_alt_1_co.substring(6,8)+"º";


        var tuser_az_1=(user_az_1).toFixed(4).padStart(8,'0');
        usr_az1_pe_btn.textBlock.text=tuser_az_1.substring(0,4);
        usr_az1_pd_btn.textBlock.text=tuser_az_1.substring(4,6);
        usr_az1_pd2_btn.textBlock.text=tuser_az_1.substring(6,8)+"º";


        user_alt_2_co=user_alt_2+h2_alt_co/dtor;
        var auser_alt_2_co=Math.abs(user_alt_2_co);
        var suser_alt_2_co="+";
        if (user_alt_2_co<0) suser_alt_2_co="-";
        var tuser_alt_2_co=suser_alt_2_co+(auser_alt_2_co).toFixed(4).padStart(7,'0');

        usr_alt2_pe_btn.textBlock.text=tuser_alt_2_co.substring(0,4);
        usr_alt2_pd_btn.textBlock.text=tuser_alt_2_co.substring(4,6);
        usr_alt2_pd2_btn.textBlock.text=tuser_alt_2_co.substring(6,8)+"º";


        var tuser_az_2=(user_az_2).toFixed(4).padStart(8,'0');
        usr_az2_pe_btn.textBlock.text=tuser_az_2.substring(0,4);
        usr_az2_pd_btn.textBlock.text=tuser_az_2.substring(4,6);
        usr_az2_pd2_btn.textBlock.text=tuser_az_2.substring(6,8)+"º";

    }
    //


    //Copia los datos de La Luna en los datos de usuario
    var cmd_btn=BABYLON.GUI.Button.CreateSimpleButton("user az2 dec","");
    cmd_btn.textBlock.text="CP MOON";
    cmd_btn.width="60px";
    cmd_btn.height="16px";
    cmd_btn.fontSize = 12;
    cmd_btn.thickness=1;
    cmd_btn.cornerRadius=4;
    cmd_btn.color="white";
    cmd_btn.background="green";
    cmd_btn.top=10;
    cmd_btn.left=275;
    cmd_btn.horizontalAlignment = al_left;
    cmd_btn.verticalAlignment  = al_top;
    cmd_btn.textHorizontalAlignment = al_left;		
    cmd_btn.fontFamily = 'monospace';
    cmd_btn.onPointerClickObservable.add(function(evt) {

        user_az_1=moon_az1*1.0/dtor;
        user_alt_1=moon_alt1*1.0/dtor;
        user_az_2=moon_az2*1.0/dtor;
        user_alt_2=moon_alt2*1.0/dtor;

        update_user_data();

        update_all();
	});	
    user_rect.addControl(cmd_btn);

    //Copia los datos del Sol en los datos de usuario
    var csd_btn=BABYLON.GUI.Button.CreateSimpleButton("user az2 dec","");
    csd_btn.textBlock.text="CP SUN";
    csd_btn.width="55px";
    csd_btn.height="16px";
    csd_btn.fontSize = 12;
    csd_btn.thickness=1;
    csd_btn.cornerRadius=4;
    csd_btn.color="white";
    csd_btn.background="green";
    csd_btn.top=10;
    csd_btn.left=340;
    csd_btn.horizontalAlignment = al_left;
    csd_btn.verticalAlignment  = al_top;
    csd_btn.textHorizontalAlignment = al_left;		
    csd_btn.fontFamily = 'monospace';
    csd_btn.onPointerClickObservable.add(function(evt) {

        user_az_1=sun_az1*1.0/dtor;
        user_alt_1=sun_alt1*1.0/dtor;
        user_az_2=sun_az2*1.0/dtor;
        user_alt_2=sun_alt2*1.0/dtor;

        update_user_data();

        update_all();
        
	});	
    user_rect.addControl(csd_btn);


    ///Activa o descativa la vista de posición fija o estrella
    var lstar_btn=BABYLON.GUI.Button.CreateSimpleButton("user az2 dec","");
    lstar_btn.textBlock.text="RA/DEC";
    lstar_btn.width="55px";
    lstar_btn.height="16px";
    lstar_btn.fontSize = 12;
    lstar_btn.thickness=1;
    lstar_btn.cornerRadius=4;
    lstar_btn.color="white";
    lstar_btn.background="red";
    lstar_btn.top=35;
    lstar_btn.left=340;
    lstar_btn.horizontalAlignment = al_left;
    lstar_btn.verticalAlignment  = al_top;
    lstar_btn.textHorizontalAlignment = al_left;		
    lstar_btn.fontFamily = 'monospace';

    lstar_btn.onPointerClickObservable.add(function() {

        if (usuario_mira_estrella==1) {

            usuario_mira_estrella=0;
            lstar_btn.background="red";

        } else {

            usuario_mira_estrella=1;
            lstar_btn.background="green";
        }

        update_all();

	});	
    user_rect.addControl(lstar_btn);

    
    var tuser_ra=(user_ra).toFixed(2).padStart(5,'0');

    //Ascencsión recta (parte entera)
    var usr_ra_pe_btn=BABYLON.GUI.Button.CreateSimpleButton("user ra int","");
    usr_ra_pe_btn.textBlock.text=tuser_ra.substring(0,3);
    usr_ra_pe_btn.width="30px";
    usr_ra_pe_btn.height="18px";
    usr_ra_pe_btn.fontSize = 16;
    usr_ra_pe_btn.thickness=0;
    usr_ra_pe_btn.color="black"
    usr_ra_pe_btn.background="white";
    usr_ra_pe_btn.top=red_user_top;
    usr_ra_pe_btn.left=red_user_left+220;
    usr_ra_pe_btn.horizontalAlignment = al_left;
    usr_ra_pe_btn.verticalAlignment  = al_top;
    usr_ra_pe_btn.textHorizontalAlignment = al_left;		
    usr_ra_pe_btn.fontFamily = 'monospace';
    usr_ra_pe_btn.onWheelObservable.add(function(evt) {

        var val;
        if (evt.y<0) {val=1;} else {val=-1}

        user_ra+=val;
        if (user_ra>24) user_ra+=-24;
        if (user_ra<0) user_ra+=+24;
        
        var tuser_ra=(user_ra).toFixed(2).padStart(5,'0');
        usr_ra_pe_btn.textBlock.text=tuser_ra.substring(0,3);
        usr_ra_pd_btn.textBlock.text=tuser_ra.substring(3,5);
        
        update_all();
        
	});	
    user_rect.addControl(usr_ra_pe_btn);

    //Ascensción recta (parte decimal)
    var usr_ra_pd_btn=BABYLON.GUI.Button.CreateSimpleButton("user ra fract","");
    usr_ra_pd_btn.textBlock.text=usr_ra_pd_btn.textBlock.text=tuser_ra.substring(3,5);
    usr_ra_pd_btn.width="20px";
    usr_ra_pd_btn.height="18px";
    usr_ra_pd_btn.fontSize = 16;
    usr_ra_pd_btn.thickness=0;
    usr_ra_pd_btn.color="black";
    usr_ra_pd_btn.background="white";
    usr_ra_pd_btn.top=red_user_top;
    usr_ra_pd_btn.left=red_user_left+30+220;
    usr_ra_pd_btn.horizontalAlignment = al_left;
    usr_ra_pd_btn.verticalAlignment  = al_top;
    usr_ra_pd_btn.textHorizontalAlignment = al_left;		
    usr_ra_pd_btn.fontFamily = 'monospace';
    usr_ra_pd_btn.onWheelObservable.add(function(evt) {

        var val;
        if (evt.y<0) {val=1;} else {val=-1}

        user_ra+=0.0100000*val;
        if (user_ra>24) user_ra+=-24;
        if (user_ra<0) user_ra+=+24;
        
        var tuser_ra=(user_ra).toFixed(2).padStart(5,'0');
        usr_ra_pe_btn.textBlock.text=tuser_ra.substring(0,3);
        usr_ra_pd_btn.textBlock.text=tuser_ra.substring(3,5);

        update_all();

	});	
    user_rect.addControl(usr_ra_pd_btn);

    var auser_dec=Math.abs(user_dec);
    var suser_dec="+";
    if (user_dec<0) suser_dec="-";
    var tuser_dec=suser_dec+(auser_dec).toFixed(2).padStart(5,'0');

    //Declinacion recta (parte entera)
    var usr_dec_pe_btn=BABYLON.GUI.Button.CreateSimpleButton("user dec int","");
    usr_dec_pe_btn.textBlock.text=tuser_dec.substring(0,4);
    usr_dec_pe_btn.width="30px";
    usr_dec_pe_btn.height="18px";
    usr_dec_pe_btn.fontSize = 16;
    usr_dec_pe_btn.thickness=0;
    usr_dec_pe_btn.color="black"
    usr_dec_pe_btn.background="white";
    usr_dec_pe_btn.top=red_user_top+30;
    usr_dec_pe_btn.left=red_user_left+220;
    usr_dec_pe_btn.horizontalAlignment = al_left;
    usr_dec_pe_btn.verticalAlignment  = al_top;
    usr_dec_pe_btn.textHorizontalAlignment = al_left;		
    usr_dec_pe_btn.fontFamily = 'monospace';
    usr_dec_pe_btn.onWheelObservable.add(function(evt) {

        var val;
        if (evt.y<0) {val=1;} else {val=-1}

        user_dec+=val;
        if (user_dec>90) user_dec=90;
        if (user_dec<-90) user_dec=-90;

        var auser_dec=Math.abs(user_dec);
        var suser_dec="+";
        if (user_dec<0) suser_dec="-";
        var tuser_dec=suser_dec+(auser_dec).toFixed(2).padStart(5,'0');
        usr_dec_pe_btn.textBlock.text=tuser_dec.substring(0,4);
        usr_dec_pd_btn.textBlock.text=tuser_dec.substring(4,6);

        update_all();
        
	});	
    user_rect.addControl(usr_dec_pe_btn);

    //Ascensción recta (parte decimal)
    var usr_dec_pd_btn=BABYLON.GUI.Button.CreateSimpleButton("user dec fract","");
    usr_dec_pd_btn.textBlock.text=tuser_dec.substring(4,6);
    usr_dec_pd_btn.width="20px";
    usr_dec_pd_btn.height="18px";
    usr_dec_pd_btn.fontSize = 16;
    usr_dec_pd_btn.thickness=0;
    usr_dec_pd_btn.color="black";
    usr_dec_pd_btn.background="white";
    usr_dec_pd_btn.top=red_user_top+30;
    usr_dec_pd_btn.left=red_user_left+30+220;
    usr_dec_pd_btn.horizontalAlignment = al_left;
    usr_dec_pd_btn.verticalAlignment  = al_top;
    usr_dec_pd_btn.textHorizontalAlignment = al_left;		
    usr_dec_pd_btn.fontFamily = 'monospace';
    usr_dec_pd_btn.onWheelObservable.add(function(evt) {

        var val;
        if (evt.y<0) {val=1;} else {val=-1}

        user_dec+=0.01*val;

        if (user_dec>90) user_dec=90;
        if (user_dec<-90) user_dec=-90;

        var auser_dec=Math.abs(user_dec);
        var suser_dec="+";
        if (user_dec<0) suser_dec="-";
        var tuser_dec=suser_dec+(auser_dec).toFixed(2).padStart(5,'0');
        usr_dec_pe_btn.textBlock.text=tuser_dec.substring(0,4);
        usr_dec_pd_btn.textBlock.text=tuser_dec.substring(4,6);

        update_all();

	});	
    user_rect.addControl(usr_dec_pd_btn);


    //
    //Texto del cuadro de ubicación (ajuste fino)
    var sp_usr_text = new BABYLON.GUI.TextBlock();
    sp_usr_text.text="--ON SPHERE--\n"+
                    "D  "+ sp_user_cut_d.toFixed(0)+" km\n"+
                    "DL "+sp_user_cut_dl.toFixed(0)+" km\n"+
                    "D1 "+sp_user_cut_d1.toFixed(0)+" km\n"+
                    "D2 "+sp_user_cut_d2.toFixed(0)+" km";

    sp_usr_text.color = "white";
    sp_usr_text.fontSize = 14;
    sp_usr_text.top="20px";
    sp_usr_text.left="15px";
    sp_usr_text.height="100px"
    sp_usr_text.width="100px"
    sp_usr_text.horizontalAlignment = al_left;
    sp_usr_text.verticalAlignment  = al_top;
    sp_usr_text.textHorizontalAlignment = al_left;		
    sp_usr_text.textVerticalAlignment = al_top;		
    sp_usr_text.fontFamily = 'monospace';
    sp_usr_text.isVisible=1;
    sp_usr_text.onPointerClickObservable.add( function() {

        if (sp_usr_text.isVisible==1) {
            sp_usr_text.isVisible=0;
            fe_usr_text.isVisible=1;
        }

    });
    user_rect.addControl(sp_usr_text);

    //Texto del cuadro de ubicación (ajuste fino)
    var fe_usr_text = new BABYLON.GUI.TextBlock();
    fe_usr_text.text=" --ON DISK--\n"+
                    "H  "+ fe_user_cut_d.toFixed(0)+" km\n"+
                    "DL "+fe_user_cut_dl.toFixed(0)+" km\n"+
                    "D1 "+fe_user_cut_d1.toFixed(0)+" km\n"+
                    "D2 "+fe_user_cut_d2.toFixed(0)+" km";

    fe_usr_text.color = "white";
    fe_usr_text.fontSize = 14;
    fe_usr_text.top="20px";
    fe_usr_text.left="15px";
    fe_usr_text.height="100px"
    fe_usr_text.width="100px"
    fe_usr_text.horizontalAlignment = al_left;
    fe_usr_text.verticalAlignment  = al_top;
    fe_usr_text.textHorizontalAlignment = al_left;		
    fe_usr_text.textVerticalAlignment = al_top;		
    fe_usr_text.fontFamily = 'monospace';
    fe_usr_text.isVisible=0;
    fe_usr_text.onPointerClickObservable.add( function() {

        if (fe_usr_text.isVisible==1) {
            fe_usr_text.isVisible=0;
            sp_usr_text.isVisible=1;
        }

    });
    user_rect.addControl(fe_usr_text);

    //Texto de información en el tab de usuario
    var usr_text = new BABYLON.GUI.TextBlock();
    usr_text.text="Height      Azimuth";
    usr_text.color = "white";
    usr_text.fontSize = 14;
    usr_text.top="40px";
    usr_text.left="130px";
    usr_text.height="20px"
    usr_text.width="150px"
    usr_text.horizontalAlignment = al_left;
    usr_text.verticalAlignment  = al_top;
    usr_text.textHorizontalAlignment = al_left;		
    usr_text.textVerticalAlignment = al_top;		
    usr_text.fontFamily = 'monospace';
    user_rect.addControl(usr_text);

    //Texto de información en el tab de usuario 2
    var usr_text_2 = new BABYLON.GUI.TextBlock();
    usr_text_2.text="RA \n\nDEC";
    usr_text_2.color = "white";
    usr_text_2.fontSize = 13;
    usr_text_2.top="60px";
    usr_text_2.left="315px";
    usr_text_2.height="80px"
    usr_text_2.width="30px"
    usr_text_2.horizontalAlignment = al_left;
    usr_text_2.verticalAlignment  = al_top;
    usr_text_2.textHorizontalAlignment = al_left;		
    usr_text_2.textVerticalAlignment = al_top;		
    usr_text_2.fontFamily = 'monospace';
    user_rect.addControl(usr_text_2);

    //Visibilidad de las líneas de observación de usuario sobre la TG
    var user_line_tg_btn=BABYLON.GUI.Button.CreateSimpleButton("user sph","ON SPHERE");
    user_line_tg_btn.width="65px";
    user_line_tg_btn.height="17px";
    user_line_tg_btn.fontSize = 11;
    user_line_tg_btn.thickness=1;
    user_line_tg_btn.cornerRadius=4;
    user_line_tg_btn.color="white"
    user_line_tg_btn.background="red";
    user_line_tg_btn.top="10px";
    user_line_tg_btn.left="130px";
    user_line_tg_btn.horizontalAlignment = al_left;
    user_line_tg_btn.verticalAlignment  = al_top;
    user_line_tg_btn.textHorizontalAlignment = al_left;		
    user_line_tg_btn.fontFamily = 'monospace';
    if (user_tg_lines_visible==1) user_line_tg_btn.background="green";
    user_line_tg_btn.onPointerClickObservable.add(function() {
        
        if (user_tg_lines_visible==1) {
            user_tg_lines_visible=0;
            user_line_tg_btn.background="red";
        } else {
            user_tg_lines_visible=1;
            user_line_tg_btn.background="green";
        }
        
        update_all();
        
	});	
    user_rect.addControl(user_line_tg_btn);

    //Visibilidad de las líneas de observación de usuario sobre la TG
    var user_line_tp_btn=BABYLON.GUI.Button.CreateSimpleButton("user sph","ON DISK");
    user_line_tp_btn.width="65px";
    user_line_tp_btn.height="17px";
    user_line_tp_btn.fontSize = 11;
    user_line_tp_btn.thickness=1;
    user_line_tp_btn.cornerRadius=4;
    user_line_tp_btn.color="white"
    user_line_tp_btn.background="red";
    user_line_tp_btn.top="10px";
    user_line_tp_btn.left="200px";
    user_line_tp_btn.horizontalAlignment = al_left;
    user_line_tp_btn.verticalAlignment  = al_top;
    user_line_tp_btn.textHorizontalAlignment = al_left;		
    user_line_tp_btn.fontFamily = 'monospace';
    if (user_tp_lines_visible==1) {
        user_line_tp_btn.background="green";
    } else {
        user_line_tp_btn_background="red";
    }
    user_line_tp_btn.onPointerClickObservable.add(function() {
        
        if (user_tp_lines_visible==1) {
            user_tp_lines_visible=0;
            user_line_tp_btn.background="red";
        } else {
            user_tp_lines_visible=1;
            user_line_tp_btn.background="green";
        }
        
        update_all();
        
	});	
    user_rect.addControl(user_line_tp_btn);
    //-------------------------------------------------------------

    //---------Datos de posición de La Luna----------------------

     //Texto del cuadro de ubicación (ajuste fino)
    var moon_title_text = new BABYLON.GUI.TextBlock();
    moon_title_text.text="                Height   Azimuth   Ph      El\n\n\n"+
                         "                   Geocentric\n"+
                         "   DISTANCE   FE Height   Paralax";
    moon_title_text.color = "white";
    moon_title_text.fontSize = 14;
    moon_title_text.top="2px";
    moon_title_text.height="230px"
    moon_title_text.left="0px";
    moon_title_text.horizontalAlignment = al_left;
    moon_title_text.verticalAlignment  = al_top;
    moon_title_text.textHorizontalAlignment = al_left;		
    moon_title_text.textVerticalAlignment = al_top;		
    moon_title_text.fontFamily = 'monospace';
    moon_rect.addControl(moon_title_text);

    //Visibilidad de las línas hacia La Luna sobre la esfera
    var moon_line_tg_btn=BABYLON.GUI.Button.CreateSimpleButton("lines moon dsk","ON SPHERE");
    moon_line_tg_btn.width="80px";
    moon_line_tg_btn.height="17px";
    moon_line_tg_btn.fontSize = 13;
    moon_line_tg_btn.thickness=1;
    moon_line_tg_btn.cornerRadius=4;
    moon_line_tg_btn.color="white"
    moon_line_tg_btn.background="red";
    moon_line_tg_btn.top="5px";
    moon_line_tg_btn.left="20px";
    moon_line_tg_btn.horizontalAlignment = al_left;
    moon_line_tg_btn.verticalAlignment  = al_top;
    moon_line_tg_btn.textHorizontalAlignment = al_left;		
    moon_line_tg_btn.fontFamily = 'monospace';
    if (moon_tg_visible==1) {
        moon_line_tg_btn.background="green";
    } else {
        moon_line_tg_btn.background="red";
    }
    moon_line_tg_btn.onPointerClickObservable.add(function() {

        if (moon_tg_visible==1) {
            moon_tg_visible=0;
            moon_line_tg_btn.background="red";
        } else {
            moon_tg_visible=1;
            moon_line_tg_btn.background="green";
        }
        update_all();
        
	});	
    moon_rect.addControl(moon_line_tg_btn);

    //Visibilidad de las línas hacia La Luna sobre el disco
    var moon_line_tp_btn=BABYLON.GUI.Button.CreateSimpleButton("lines moon dsk","ON DISK");
    moon_line_tp_btn.width="80px";
    moon_line_tp_btn.height="17px";
    moon_line_tp_btn.fontSize = 13;
    moon_line_tp_btn.thickness=1;
    moon_line_tp_btn.cornerRadius=4;
    moon_line_tp_btn.color="white"
    moon_line_tp_btn.background="green";
    moon_line_tp_btn.top="25px";
    moon_line_tp_btn.left="20px";
    moon_line_tp_btn.horizontalAlignment = al_left;
    moon_line_tp_btn.verticalAlignment  = al_top;
    moon_line_tp_btn.textHorizontalAlignment = al_left;		
    moon_line_tp_btn.fontFamily = 'monospace';
    if (moon_tp_visible==1) {
        moon_line_tp_btn.background="green";
    } else {
        moon_line_tp_btn.background="red";
    }
    moon_line_tp_btn.onPointerClickObservable.add(function() {

        if (moon_tp_visible==1) {
            moon_tp_visible=0;
            moon_cut_tp_btn.isEnabled=0;
            moon_line_tp_btn.background="red";
        } else {
            moon_tp_visible=1;
            moon_cut_tp_btn.isEnabled=1;
            moon_line_tp_btn.background="green";
        }
        update_all();
        
	});	
    moon_rect.addControl(moon_line_tp_btn);

    //Visibilidad del punto de intermedio intermedio
    //de las direcciones a La Luna sobre la TP
    var moon_cut_tp_btn=BABYLON.GUI.Button.CreateSimpleButton("cut moon dsk","MID POINT");
    moon_cut_tp_btn.width="80px";
    moon_cut_tp_btn.height="17px";
    moon_cut_tp_btn.fontSize = 13;
    moon_cut_tp_btn.thickness=1;
    moon_cut_tp_btn.cornerRadius=4;
    moon_cut_tp_btn.color="white"
    moon_cut_tp_btn.background="black";
    if (moon_tp_cut_visible==1) {
        moon_cut_tp_btn.background="green";
    } else {
        moon_cut_tp_btn.background="red";
    }
    moon_cut_tp_btn.top="45px";
    moon_cut_tp_btn.left="20px";
    moon_cut_tp_btn.horizontalAlignment = al_left;
    moon_cut_tp_btn.verticalAlignment  = al_top;
    moon_cut_tp_btn.textHorizontalAlignment = al_left;		
    moon_cut_tp_btn.fontFamily = 'monospace';
    moon_cut_tp_btn.isEnabled=0;
    if (moon_tp_visible==1) {
        moon_cut_tp_btn.isEnabled=1;
    } else {
        moon_cut_tp_btn.isEnabled=0;
    }
    moon_cut_tp_btn.onPointerClickObservable.add(function() {

        if (moon_tp_cut_visible==1) {
            moon_tp_cut_visible=0;
            moon_cut_tp_btn.background="red";
        } else {
            moon_tp_cut_visible=1;
            moon_cut_tp_btn.background="green";
        }
        update_all();

	});	
    moon_rect.addControl(moon_cut_tp_btn);

    //Altura de La Luna desde la ubicación de la marca roja
    var moonaltaz1_btn=BABYLON.GUI.Button.CreateSimpleButton("moon altaz 1","");

    var smoon_alt1="+";
    if (moon_alt1_co<0) smoon_alt1="-";

    moonaltaz1_btn.textBlock.text=smoon_alt1+(Math.abs(moon_alt1_co/dtor)).toFixed(2).padStart(5,"0")+"º"+
                                    "  " + (Math.abs(moon_az1/dtor)).toFixed(2).padStart(6,"0")+"º"+
                                    " "+mf1.toFixed(2).padStart(5,"0")+"%"+" "+
                                    " "+melo1.toFixed(2).padStart(6,"0")+"º";
    moonaltaz1_btn.width="260px";
    moonaltaz1_btn.height="14px";
    moonaltaz1_btn.fontSize = 14;
    moonaltaz1_btn.thickness=0;
    moonaltaz1_btn.color="white";
    moonaltaz1_btn.background="red";
    moonaltaz1_btn.top="20px";
    moonaltaz1_btn.left="128px";
    moonaltaz1_btn.horizontalAlignment = al_left;
    moonaltaz1_btn.verticalAlignment  = al_top;
    moonaltaz1_btn.textHorizontalAlignment = al_left;		
    moonaltaz1_btn.fontFamily = 'monospace';
    moonaltaz1_btn.onPointerClickObservable.add(function() {

        lat1=moon_latc*1.0;
        lon1=moon_lonc*1.0;
        pos3=rlatlon_to_xyz_fe(rfe,moon_latc,moon_lonc,h1);
        pos1=rlatlon_to_xyz(r,moon_latc,moon_lonc,h1);

        redSphere_fe.position=pos3.subtract(zero);
        redSphere.position=pos1.subtract(zero);

        update_all();

    });
    moon_rect.addControl(moonaltaz1_btn);

    //Altura de La Luna desde la ubicación de la marca azul
    var moonaltaz2_btn=BABYLON.GUI.Button.CreateSimpleButton("moon altaz 2","");
    
    var smoon_alt2="+";
    if (moon_alt2_co<0) smoon_alt2="-";
    
    moonaltaz2_btn.textBlock.text=smoon_alt2+(Math.abs(moon_alt2_co/dtor)).toFixed(2).padStart(5,"0")+"º"+
                                    "  " + (Math.abs(moon_az2/dtor)).toFixed(2).padStart(6,"0")+"º"+
                                    " "+mf2.toFixed(2).padStart(5,"0")+"%"+" "+
                                    " "+melo2.toFixed(2).padStart(6,"0")+"º";
    moonaltaz2_btn.width="260px";
    moonaltaz2_btn.height="14px";
    moonaltaz2_btn.fontSize = 14;
    moonaltaz2_btn.thickness=0;
    moonaltaz2_btn.color="white";
    moonaltaz2_btn.background="blue";
    moonaltaz2_btn.top="36px";
    moonaltaz2_btn.left="128px";
    moonaltaz2_btn.horizontalAlignment = al_left;
    moonaltaz2_btn.verticalAlignment  = al_top;
    moonaltaz2_btn.textHorizontalAlignment = al_left;		
    moonaltaz2_btn.fontFamily = 'monospace';
    moonaltaz2_btn.onPointerClickObservable.add(function() {

        lat2=moon_latc*1.0;
        lon2=moon_lonc*1.0;
        pos4=rlatlon_to_xyz_fe(rfe,moon_latc,moon_lonc,h2);
        pos2=rlatlon_to_xyz(r,moon_latc,moon_lonc,h2);

        blueSphere_fe.position=pos4.subtract(zero);
        blueSphere.position=pos2.subtract(zero);

        update_all();

    });
    moon_rect.addControl(moonaltaz2_btn);

    //Paralaje de La Luna
    var mfeh_text="-----"
    if (isNaN(moon_cut_d)==0) mfeh_text=(moon_cut_d).toFixed(0);
    var moonpar_btn=BABYLON.GUI.Button.CreateSimpleButton("moon altaz 2","");

    moonpar_btn.textBlock.text=(moon_earth_distance).toFixed(0)+"km      "+
                            mfeh_text+"km    "+
                            (moon_paralax).toFixed(4).padStart(5,"0")+"º"; 
    moonpar_btn.width="268px";
    moonpar_btn.height="20px";
    moonpar_btn.fontSize = 14;
    moonpar_btn.thickness=0;
    moonpar_btn.cornerRadius=4;
    moonpar_btn.color="white";
    moonpar_btn.background="gray";
    moonpar_btn.top="90px";
    moonpar_btn.left="10px";
    moonpar_btn.horizontalAlignment = al_left;
    moonpar_btn.verticalAlignment  = al_top;
    moonpar_btn.textHorizontalAlignment = al_left;		
    moonpar_btn.fontFamily = 'monospace';
    //moonpar_btn.isHighlighted=0;
    moon_rect.addControl(moonpar_btn);

    var s_mlac="+";
    if (moon_latc<0) s_mlac="-";
    var s_mloc="+";
    if (moon_lonc<0) s_mloc="-";
    
    //Texto del cuadro de ubicación (ajuste fino)
    var latlonmoon_text = new BABYLON.GUI.TextBlock();
    latlonmoon_text.text=" "+mfc.toFixed(2).padStart(5,"0")+"%"+" "+
                         " "+meloc.toFixed(2).padStart(6,"0")+"º"+"\n"+
                         "    Lat=  "+s_mlac+Math.abs((moon_latc/dtor)).toFixed(2).padStart(5,"0")+"\n"+
                         "    Lon= "+s_mloc+Math.abs((moon_lonc/dtor)).toFixed(2).padStart(6,"0");
    latlonmoon_text.color = "white";
    latlonmoon_text.fontSize = 14;
    latlonmoon_text.top="56px";
    latlonmoon_text.left="258px";
    latlonmoon_text.height="60px"
    latlonmoon_text.horizontalAlignment = al_left;
    latlonmoon_text.verticalAlignment  = al_top;
    latlonmoon_text.textHorizontalAlignment = al_left;		
    latlonmoon_text.textVerticalAlignment = al_top;		
    latlonmoon_text.fontFamily = 'monospace';
    moon_rect.addControl(latlonmoon_text);

    //Visibilidad de las línas hacia el Sol sobre la esfera
    var moon_tr_btn=BABYLON.GUI.Button.CreateSimpleButton("lines sun sph","TR");
    moon_tr_btn.width="20px";
    moon_tr_btn.height="17px";
    moon_tr_btn.fontSize = 12;
    moon_tr_btn.thickness=1;
    moon_tr_btn.cornerRadius=4;
    moon_tr_btn.color="white"
    if (moon_tr_a==1) {
        moon_tr_btn.background="blue";
    } else {
        moon_tr_btn.background="red";
    }
    moon_tr_btn.top="5px";
    moon_tr_btn.left="104px";
    moon_tr_btn.horizontalAlignment = al_left;
    moon_tr_btn.verticalAlignment  = al_top;
    moon_tr_btn.textHorizontalAlignment = al_left;		
    moon_tr_btn.fontFamily = 'monospace';
    moon_tr_btn.onPointerClickObservable.add(function() {

        if (moon_tr_a==1) {

            moon_tr_a=0;
            moon_tr_btn.background="red";

            moon_tr_line_data=[ nan,nan];
            moon_tr_line_data_fe=[ nan,nan];

            moon_tr_np=1;

            moon_tr_line.dispose();
            moon_tr_line =BABYLON.MeshBuilder.CreateLines ( "user_line_1", {points: moon_tr_line_data},scene,true); 
            moon_tr_line.material=mooncutMat2;
            moon_tr_line_fe.dispose();
            moon_tr_line_fe =BABYLON.MeshBuilder.CreateLines ( "user_line_1", {points: moon_tr_line_data_fe},scene,true); 
            moon_tr_line_fe.material=mooncutMat2;

        }   else {

            moon_tr_a=1;
            moon_tr_btn.background="blue";
        } 
        
	});	
    moon_rect.addControl(moon_tr_btn);
    //------------------------------------------------------------

    //---------Datos de posición del Sol----------------------

     //Texto del cuadro de datos del Sol
    var sun_title_text = new BABYLON.GUI.TextBlock();
    sun_title_text.text="                Height     Azimuth\n\n\n\n"+
                         "   DISTANCE   FE Height   Paralax";
    sun_title_text.color = "white";
    sun_title_text.fontSize = 14;
    sun_title_text.top="2px";
    sun_title_text.height="230px"
    sun_title_text.left="0px";
    sun_title_text.horizontalAlignment = al_left;
    sun_title_text.verticalAlignment  = al_top;
    sun_title_text.textHorizontalAlignment = al_left;		
    sun_title_text.textVerticalAlignment = al_top;		
    sun_title_text.fontFamily = 'monospace';
    sun_rect.addControl(sun_title_text);

    //Visibilidad de las línas hacia el Sol sobre la esfera
    var sun_line_tg_btn=BABYLON.GUI.Button.CreateSimpleButton("lines sun sph","ON SPHERE");
    sun_line_tg_btn.width="80px";
    sun_line_tg_btn.height="17px";
    sun_line_tg_btn.fontSize = 13;
    sun_line_tg_btn.thickness=1;
    sun_line_tg_btn.cornerRadius=4;
    sun_line_tg_btn.color="white"
    sun_line_tg_btn.background="red";
    sun_line_tg_btn.top="5px";
    sun_line_tg_btn.left="20px";
    sun_line_tg_btn.horizontalAlignment = al_left;
    sun_line_tg_btn.verticalAlignment  = al_top;
    sun_line_tg_btn.textHorizontalAlignment = al_left;		
    sun_line_tg_btn.fontFamily = 'monospace';
    if (sun_tg_visible==1) {
        sun_line_tg_btn.background="green";
    } else {
        sun_line_tg_btn.background="red";
    }
    sun_line_tg_btn.onPointerClickObservable.add(function() {

        if (sun_tg_visible==1) {
            sun_tg_visible=0;
            sun_line_tg_btn.background="red";
        } else {
            sun_tg_visible=1;
            sun_line_tg_btn.background="green";
        }
        update_all();
        
	});	
    sun_rect.addControl(sun_line_tg_btn);

    //Visibilidad de las línas hacia el Sol sobre la esfera
    var sun_tr_btn=BABYLON.GUI.Button.CreateSimpleButton("lines sun sph","TR");
    sun_tr_btn.width="20px";
    sun_tr_btn.height="17px";
    sun_tr_btn.fontSize = 13;
    sun_tr_btn.thickness=1;
    sun_tr_btn.cornerRadius=4;
    sun_tr_btn.color="white"
    if (sun_tr_a==1) {
        sun_tr_btn.background="blue";
    } else {
        sun_tr_btn.background="red";
    }
    sun_tr_btn.top="5px";
    sun_tr_btn.left="104px";
    sun_tr_btn.horizontalAlignment = al_left;
    sun_tr_btn.verticalAlignment  = al_top;
    sun_tr_btn.textHorizontalAlignment = al_left;		
    sun_tr_btn.fontFamily = 'monospace';
    sun_tr_btn.onPointerClickObservable.add(function() {

        if (sun_tr_a==1) {

            sun_tr_a=0;
            sun_tr_btn.background="red";

            sun_tr_line_data=[nan,nan];
            sun_tr_line_data_fe=[nan,nan];

            sun_tr_np=1;

            sun_tr_line.dispose();
            sun_tr_line =BABYLON.MeshBuilder.CreateLines ( "user_line_1", {points: sun_tr_line_data},scene,true); 
            sun_tr_line.material=suncutMat2;
            sun_tr_line_fe.dispose();
            sun_tr_line_fe =BABYLON.MeshBuilder.CreateLines ( "user_line_1", {points: sun_tr_line_data_fe},scene,true); 
            sun_tr_line_fe.material=suncutMat2;

        }   else {

            sun_tr_a=1;
            sun_tr_btn.background="blue";
        } 
        
	});	
    sun_rect.addControl(sun_tr_btn);

    //Visibilidad de las línas hacia el Sol sobre el disco
    var sun_line_tp_btn=BABYLON.GUI.Button.CreateSimpleButton("lines sun sph","ON DISK");
    sun_line_tp_btn.width="80px";
    sun_line_tp_btn.height="17px";
    sun_line_tp_btn.fontSize = 13;
    sun_line_tp_btn.thickness=1;
    sun_line_tp_btn.cornerRadius=4;
    sun_line_tp_btn.color="white"
    sun_line_tp_btn.background="red";
    sun_line_tp_btn.top="25px";
    sun_line_tp_btn.left="20px";
    sun_line_tp_btn.horizontalAlignment = al_left;
    sun_line_tp_btn.verticalAlignment  = al_top;
    sun_line_tp_btn.textHorizontalAlignment = al_left;		
    sun_line_tp_btn.fontFamily = 'monospace';
    if (sun_tp_visible==1) {
        sun_line_tp_btn.background="green";
    } else {
        sun_line_tp_btn.background="red";
    }
    sun_line_tp_btn.onPointerClickObservable.add(function() {

        if (sun_tp_visible==1) {
            sun_tp_visible=0;
            sun_line_tp_btn.background="red";
            sun_cut_tp_btn.isEnabled=0;
        } else {
            sun_tp_visible=1;
            sun_line_tp_btn.background="green";
            sun_cut_tp_btn.isEnabled=1;
        }
        update_all();
        
	});	
    sun_rect.addControl(sun_line_tp_btn);

    //Visibilidad del punto de intermedio intermedio
    //de las direcciones a Sol sobre la TP
    var sun_cut_tp_btn=BABYLON.GUI.Button.CreateSimpleButton("cut sun dsk","MID POINT");
    sun_cut_tp_btn.width="80px";
    sun_cut_tp_btn.height="17px";
    sun_cut_tp_btn.fontSize = 13;
    sun_cut_tp_btn.thickness=1;
    sun_cut_tp_btn.cornerRadius=4;
    sun_cut_tp_btn.color="white"
    sun_cut_tp_btn.background="black";
    if (sun_tp_cut_visible==1) {
        sun_cut_tp_btn.background="green";
    } else {
        sun_cut_tp_btn.background="red";
    }
    sun_cut_tp_btn.top="45px";
    sun_cut_tp_btn.left="20px";
    sun_cut_tp_btn.horizontalAlignment = al_left;
    sun_cut_tp_btn.verticalAlignment  = al_top;
    sun_cut_tp_btn.textHorizontalAlignment = al_left;		
    sun_cut_tp_btn.fontFamily = 'monospace';
    sun_cut_tp_btn.isEnabled=0;
    if (sun_tp_visible==1) {
        sun_cut_tp_btn.isEnabled=1;
    } else {
        sun_cut_tp_btn.isEnabled=0;
    }
    sun_cut_tp_btn.onPointerClickObservable.add(function() {

        if (sun_tp_cut_visible==1) {
            sun_tp_cut_visible=0;
            sun_cut_tp_btn.background="red";
        } else {
            sun_tp_cut_visible=1;
            sun_cut_tp_btn.background="green";
        }
        update_all();

	});	
    sun_rect.addControl(sun_cut_tp_btn);

    //Altura del Sol desde la ubicación de la marca roja
    var sunaltaz1_btn=BABYLON.GUI.Button.CreateSimpleButton("sun altaz 1","");

    var ssun_alt1="+";
    if (sun_alt1_co<0) ssun_alt1="-";

    sunaltaz1_btn.textBlock.text=ssun_alt1+(Math.abs(sun_alt1_co/dtor)).toFixed(2).padStart(5,"0")+"º"+
                                    "   " + (Math.abs(sun_az1/dtor)).toFixed(2).padStart(6,"0")+"º";
    sunaltaz1_btn.width="150px";
    sunaltaz1_btn.height="20px";
    sunaltaz1_btn.fontSize = 16;
    sunaltaz1_btn.thickness=0;
    sunaltaz1_btn.color="white";
    sunaltaz1_btn.background="red";
    sunaltaz1_btn.top="23px";
    sunaltaz1_btn.left="128px";
    sunaltaz1_btn.horizontalAlignment = al_left;
    sunaltaz1_btn.verticalAlignment  = al_top;
    sunaltaz1_btn.textHorizontalAlignment = al_left;		
    sunaltaz1_btn.fontFamily = 'monospace';
    sunaltaz1_btn.onPointerClickObservable.add(function() {

        lat1=sun_latc*1.0;
        lon1=sun_lonc*1.0;
        pos3=rlatlon_to_xyz_fe(rfe,sun_latc,sun_lonc,h1);
        pos1=rlatlon_to_xyz(r,sun_latc,sun_lonc,h1);

        redSphere_fe.position=pos3.subtract(zero);
        redSphere.position=pos1.subtract(zero);

        calculate_lines();
        update_all();

    });
    sun_rect.addControl(sunaltaz1_btn);
    
    //Altura de La Luna desde la ubicación de la marca azul
    var sunaltaz2_btn=BABYLON.GUI.Button.CreateSimpleButton("sun altaz 2","");
    
    var ssun_alt2="+";
    if (sun_alt2_co<0) ssun_alt2="-";
    
    sunaltaz2_btn.textBlock.text=ssun_alt2+(Math.abs(sun_alt2_co/dtor)).toFixed(2).padStart(5,"0")+"º"+
                                    "   " + (Math.abs(sun_az2/dtor)).toFixed(2).padStart(6,"0")+"º";
    sunaltaz2_btn.width="150px";
    sunaltaz2_btn.height="20px";
    sunaltaz2_btn.fontSize = 16;
    sunaltaz2_btn.thickness=0;
    sunaltaz2_btn.color="white";
    sunaltaz2_btn.background="blue";
    sunaltaz2_btn.top="43px";
    sunaltaz2_btn.left="128px";
    sunaltaz2_btn.horizontalAlignment = al_left;
    sunaltaz2_btn.verticalAlignment  = al_top;
    sunaltaz2_btn.textHorizontalAlignment = al_left;		
    sunaltaz2_btn.fontFamily = 'monospace';
    sunaltaz2_btn.onPointerClickObservable.add(function() {

        lat2=sun_latc*1.0;
        lon2=sun_lonc*1.0;
        pos4=rlatlon_to_xyz_fe(rfe,sun_latc,sun_lonc,h2);
        pos2=rlatlon_to_xyz(r,sun_latc,sun_lonc,h2);

        blueSphere_fe.position=pos4.subtract(zero);
        blueSphere.position=pos2.subtract(zero);

        calculate_lines();
        update_all();

    });
    sun_rect.addControl(sunaltaz2_btn);

    //Datos del Sol: Disstancia, altura sobre la TP, paralaje
    var sfeh_text="----"
    if (isNaN(sun_cut_d)==0) sfeh_text=(sun_cut_d).toFixed(0);
    var sunpar_btn=BABYLON.GUI.Button.CreateSimpleButton("sun paralax","");

    sunpar_btn.textBlock.text=(sun_earth_distance/1e6).toFixed(3)+"Mkm   "+
                            sfeh_text+"km    "+
                            (sun_paralax*3600).toFixed(2).padStart(5,"0")+"\""; 
    sunpar_btn.width="268px";
    sunpar_btn.height="20px";
    sunpar_btn.fontSize = 14;
    sunpar_btn.thickness=0;
    sunpar_btn.cornerRadius=4;
    sunpar_btn.color="white";
    sunpar_btn.background="gray";
    sunpar_btn.top="90px";
    sunpar_btn.left="10px";
    sunpar_btn.horizontalAlignment = al_left;
    sunpar_btn.verticalAlignment  = al_top;
    sunpar_btn.textHorizontalAlignment = al_left;		
    sunpar_btn.fontFamily = 'monospace';
    sun_rect.addControl(sunpar_btn);

    var s_slac="+";
    if (sun_latc<0) s_slac="-";
    var s_sloc="+";
    if (sun_lonc<0) s_slon="-";

    //Texto del cuadro de ubicación (ajuste fino)
    var latlonsun_text = new BABYLON.GUI.TextBlock();
    latlonsun_text.text="\n"+
                        "    Lat=  "+s_slac+Math.abs((sun_latc/dtor)).toFixed(2).padStart(5,"0")+"º\n"+
                        "    Lon= "+s_sloc+Math.abs((sun_lonc/dtor)).toFixed(2).padStart(6,"0")+"º";
    latlonsun_text.color = "white";
    latlonsun_text.fontSize = 14;
    latlonsun_text.top="56px";
    latlonsun_text.left="258px";
    latlonsun_text.height="60px"
    latlonsun_text.horizontalAlignment = al_left;
    latlonsun_text.verticalAlignment  = al_top;
    latlonsun_text.textHorizontalAlignment = al_left;		
    latlonsun_text.textVerticalAlignment = al_top;		
    latlonsun_text.fontFamily = 'monospace';
    sun_rect.addControl(latlonsun_text);

    //------------------------------------------------------------

    //Cuadro de datos minimizado
    var closed_data_rect = new BABYLON.GUI.Rectangle();
    closed_data_rect.width = "140px";
    closed_data_rect.height = "50px";
    closed_data_rect.cornerRadius = 10;
    closed_data_rect.color = "black";
    closed_data_rect.thickness = 4;
    closed_data_rect.background = "black";
    closed_data_rect.top="0px";
    closed_data_rect.left="0px";
    closed_data_rect.horizontalAlignment = al_left;
    closed_data_rect.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
    closed_data_rect.alpha=1;
    closed_data_rect.isVisible=0;		
    advancedTexture.addControl(closed_data_rect);

    //Texto de datos: <-
    //Flecha roja que cierra el cuadro de datos
    var data_text_c = new BABYLON.GUI.TextBlock();
    data_text_c.text="<-"
    data_text_c.color = "red";
    data_text_c.fontSize = 16;
    data_text_c.top="-120px";
    data_text_c.left="10px";
    data_text_c.width="20px";
    data_text_c.height="20px";
    data_text_c.horizontalAlignment = al_left;
    data_text_c.verticalAlignment  = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
    data_text_c.textHorizontalAlignment = al_left;		
    data_text_c.fontFamily = 'monospace';
    data_text_c.onPointerClickObservable.add (function() {
        panelI_rect.isVisible=0;
        closed_data_rect.isVisible=1;
    });
    panelI_rect.addControl(data_text_c);

    //Texto de datos: ->
    //Flecha verde que abre el cuadro de datos
    var data_text_o = new BABYLON.GUI.TextBlock();
    data_text_o.text="DATA / OPTIONS\n ->"
    data_text_o.color = "green";
    data_text_o.fontSize = 14;
    data_text_o.top="0px";
    data_text_o.left="10px";
    data_text_o.width="120px";
    data_text_o.height="35px";
    data_text_o.horizontalAlignment = al_left;
    data_text_o.verticalAlignment  = al_top;
    data_text_o.textHorizontalAlignment = al_left;		
    data_text_o.fontFamily = 'monospace';
    data_text_o.onPointerClickObservable.add (function() {
        panelI_rect.isVisible=1;
        closed_data_rect.isVisible=0;
    });
    closed_data_rect.addControl(data_text_o);
    //END GUI----------------------------------------------------

    /*
    scene.onBeforeRenderObservable.add(() => {
        //engine.disableScissor();
    });
    */

    /*
    scene.onBeforeCameraRenderObservable.add(camera => {
        if (camera === camera) {
            engine.enableScissor(0, 0, canvas.width * 0.5, canvas.height);
            engine.clear(BABYLON.Color3.Red(), true, false, false);
        } else {
            engine.enableScissor(canvas.width * 0.5, 0, canvas.width , canvas.height);
            engine.clear(BABYLON.Color3.Green(), true, false, false);
        }
    });
    */

    /*
    scene.onBeforeCameraRenderObservable.add(_camera => {

        if (moon_cameras_option==1) {
            
            if (_camera == camera_moon_1) {
                engine.enableScissor(0, 0, canvas.width, canvas.height);
                engine.clear(BABYLON.Color3.Red(), true, true, true);
            } 

        } else {

            engine.disableScissor();
        } 

        
    });
    */

    //Animación
    scene.registerBeforeRender(function () {

        if (moon_cameras_option==1) {
            rt_moon1.render();
            rt_moon2.render();
        }

        if (animation_control==0) return;

        var stt=step_day_val+step_hour_val/24.0+step_min_val/1440.0+step_seg_val/86400.0;
        stt*=TIME_STEP*animation_control;

        JD+=stt;
        FECHA=calc_fecha(JD);

        day_btn.textBlock.text=FECHA[0].toString().padStart(2,"0");
        month_btn.textBlock.text=FECHA[1].toString().padStart(2,"0");
        year_btn.textBlock.text=FECHA[2].toString();
        hour_btn.textBlock.text=FECHA[3].toString().padStart(2,"0")+":";
        minu_btn.textBlock.text=FECHA[4].toString().padStart(2,"0")+":";
        segu_btn.textBlock.text=FECHA[5].toString().padStart(2,"0");

        gmts_offset();
        update_all();
        
    });


    //Posición del cursor en la patalla
    var getScreenPosition = function () {
        
        return [scene.pointerX,scene.pointerY]

    }

    //Comportamiento al pulsar el botón del ratón
    var pointerDown = function (mesh) {

        currentMesh = mesh;

        startingPoint = getScreenPosition();

        //Se desconecta la cámara
        //si el mesh seleccionado es 
        //la esfera roja o azul

        if (startingPoint ) { 
            setTimeout(function () {
                camera.detachControl(canvas);
            }, 0);
        }

    }

    //Comportamiento al soltar el botón del ratón
    var pointerUp = function () {

        //Se vuelve a conectar la cámara
        if (startingPoint) {
            
            startingPoint = null;
            camera.attachControl(canvas, true);
            //console.log(scene.activeCamera.id)
            return;
        }

    }

    //Comportamiento al mover 
    //el ratón con el botón pulsado
    var pointerMove = function () {

        //Desactiva la información sobre las líneas
        //que no son visibles
        var general_info=1;
        if (info_orto==1 && orto_es_visible==0) general_info=0;
        if (info_loxo==1 && loxo_es_visible==0) general_info=0;
        if (info_flat==1 && flato_es_visible==0) general_info=0;

        //Si la opción de información sobre alguna de las
        // líneas está activada...
        if ((info_orto!=0 || info_loxo!=0 || info_flat!=0 || info_eqac!=0) && general_info==1) {

            //Copia los datos de la línea seleccionada
            //a variables locales y cambia el color
            //de la esfera auxiliar y del cuadro de información

            if (info_orto==1) {

                auxMat.emissiveColor=line_color_orto;
                auxMat.diffuseColor=line_color_orto;
                info_rect.color=line_color_orto.toHexString();

                if (sp_sel==1) {
                    var line_data_sel=line_data;
                    var dist_line=dist_orto;
                    var max_dist=distancia_sp_suma;
                } else {
                    var line_data_sel=line_data_fe;
                    var dist_line=dist_orto_fe;
                    var max_dist=distancia_fe_suma;
                }
            }
            if (info_loxo==1) {

                auxMat.emissiveColor=line_color_loxo;
                auxMat.diffuseColor=line_color_loxo;
                info_rect.color=line_color_loxo.toHexString();

                if (sp_sel==1) {
                    var line_data_sel=line_data_lox;
                    var dist_line=dist_loxo;
                    var max_dist=distancia_sp_lox_suma;
                } else {
                    var line_data_sel=line_data_lox_fe;
                    var dist_line=dist_loxo_fe;
                    var max_dist=distancia_fe_lox_suma;
                }
            }
            if (info_flat==1) {

                auxMat.emissiveColor=line_color_flat;
                auxMat.diffuseColor=line_color_flat;
                info_rect.color=line_color_flat.toHexString();

                if (sp_sel==1) {
                    var line_data_sel=line_data_flat_sp;
                    var dist_line=dist_flat;
                    var max_dist=distancia_sp_flat_suma;    
                } else {
                    var line_data_sel=line_data_flat_fe;
                    var dist_line=dist_flat_fe;
                    var max_dist=distancia_fe_flat_suma;
                }
            }
            if (info_eqac==1) {

                auxMat.emissiveColor=line_color_eqac;
                auxMat.diffuseColor=line_color_eqac;
                info_rect.color=line_color_eqac.toHexString();

                if (sp_sel==1) {
                    var line_data_sel=line_data_eqac_sp;
                    var dist_line=dist_eqac;
                    var max_dist=distancia_sp_eqac_suma;    
                } else {
                    var line_data_sel=line_data_eqac_fe;
                    var dist_line=dist_eqac_fe;
                    var max_dist=distancia_fe_eqac_suma;
                }
            }

            //Variables para la transformación 3D-2D
            var tm=scene.getTransformMatrix();
            var idm=BABYLON.Matrix.Identity();
            var vptog=camera.viewport.toGlobal(
                engine.getRenderWidth(),
                engine.getRenderHeight());
            var scx=scene.pointerX;
            var scy=scene.pointerY;

            //Transforma cada punto 3D de la línea
            //seleccionada a las coordenadas de pantalla
            //y busca el punto más cercano a la posición
            //del puntero dentro de un rango de 15px
            var scnt=-1;
            for (var i=0;i<ndiv+1;i++) {

                var sco=BABYLON.Vector3.Project(
                    line_data_sel[i],
                    idm,
                    tm,
                    vptog);

                sdx=scx-sco.x;
                sdy=scy-sco.y;
                sdist=Math.sqrt(sdx*sdx+sdy*sdy);

                if (sdist<15) {
                    scnt=i;
                    break;
                }

            }

            if (sp_sel==1) {
                //Comprueba si el punto seleccinado de la
                //línea es visible y no está oculto por la esfera
                if (scnt!=-1) {                
                    var cpn=(camera.position).subtract(zero);
                    cpn.normalize();
                    var ppn=(line_data_sel[i]).subtract(zero);
                    ppn.normalize();
                    var cp_dire=BABYLON.Vector3.Dot(cpn,ppn);
                } else {
                    var cp_dire=-1;
                }
            } else {
                cp_dire=1;
            }
            
            //Cálculos de ubicación, rumbo y distancia
            //del punto más proximo al puntero de la
            //línea seleccionada
            if (scnt!=-1 && cp_dire>-0.01) {

                if (sp_sel==1) {

                    var p5=line_data_sel[scnt];
                    auxSphere.position=p5;
                    info_rect.isVisible=1;

                    var lat5=Math.asin(p5.y/rdeltar);
                    var lon5=Math.atan2(p5.z,p5.x);

                    if (scnt==0) {
                        var p6=line_data_sel[1];
                    } else if (scnt==ndiv) {
                        var p6=line_data_sel[ndiv-1];
                    } else {
                        var p6=line_data_sel[i-1];
                    }

                    var lat6=Math.asin(p6.y/rdeltar);
                    var lon6=Math.atan2(p6.z,p6.x);

                    var dl65=lon6-lon5;
                    if (dl65>0.5) dl65+=-2*Math.PI;
                    if (dl65<-0.5) dl65+=2*Math.PI;

                    var p6angle=Math.atan2(dl65,(agdf(lat6)-agdf(lat5)))/dtor;
                    if (p6angle<0) p6angle=p6angle+360;
                    var ip6angle=p6angle-180;
                    if (ip6angle<0) ip6angle=ip6angle+360;
                    
                    var ilat5=Math.round(lat5/dtor*10)/10;
                    var ilon5=Math.round(lon5/dtor*10)/10;
                    var dst=Math.round(dist_line[scnt]);
                    var idst=Math.round(-dist_line[scnt]+max_dist);

                } else {

                    var p5=line_data_sel[scnt];
                    auxSphere.position=p5;
                    info_rect.isVisible=1;

                    var dc5=BABYLON.Vector3.Distance(fe_pos,new BABYLON.Vector3(p5.x,0,p5.z));
                    var lat5=Math.PI*(0.5-dc5/(2*rfe));
                    dx5=p5.x-fe_pos.x;
                    dz5=p5.z-fe_pos.z;
                    lon5=Math.atan2(dz5,dx5);

                    if (scnt==0) {
                        var p6=line_data_sel[1];
                    } else if (scnt==ndiv) {
                        var p6=line_data_sel[ndiv-1];
                    } else {
                        var p6=line_data_sel[i-1];
                    }
                    
                    var p51=new BABYLON.Vector3(p5.x,0,p5.z);
                    var un=fe_pos.subtract(p51);
                    un.normalize();

                    var ue=new BABYLON.Vector3(-un.z,0,un.x);

                    var p5p6=p6.subtract(p5);
                    p5p6.normalize();

                    var compn=BABYLON.Vector3.Dot(p5p6,un);
                    var compe=BABYLON.Vector3.Dot(p5p6,ue);

                    var p6angle=Math.atan2(compe,compn)/dtor;

                    if (p6angle<0) p6angle=p6angle+360;
                    var ip6angle=p6angle-180;
                    if (ip6angle<0) ip6angle=ip6angle+360;

                    var ilat5=Math.round(lat5/dtor*10)/10;
                    var ilon5=Math.round(lon5/dtor*10)/10;
                    var dst=Math.round(dist_line[scnt]);
                    var idst=Math.round(-dist_line[scnt]+max_dist);

                }

                var slat="";
                if (ilat5>=0) slat="+";
                var slon="";
                if (ilon5>=0) slon="+";

                //Presentación de la información sobre
                //ubicación, rumbo y distancias
                //solo si el puntero del ratón está
                //cerca de la línea
                info_text_1.text = " Lat: "+ slat +ilat5.toString()+"º\n"+
                                   " Lon: "+ slon +ilon5.toString()+"º\n"+
                " Rumb: "+ 
                (Math.round(p6angle*10)/10).toString()+"º/"+
                (Math.round(ip6angle*10)/10).toString()+"º\n"+
                " to red:  "+dst.toString()+"km \n"+
                " to blue: "+idst.toString()+"km";

                red_mark.height="16px";
                red_mark.top="56px";
                red_mark.left="5px";

                blue_mark.height="16px";
                blue_mark.top="72px";
                blue_mark.left="5px";

            } else {

                //Si el puntero del ratón
                //no está cerca de la línea
                //no se muestra el cuadro de información
                //ni la esfera auxiliar
                auxSphere.position=zero;
                info_rect.isVisible=0;

            }

        }
       
        //No hace nada si no se ha pulsado el
        //botón del ratón
        if (!startingPoint) {
            return;
        }

        //No hace nada si la posición  
        //no está definida o es = a null
        var current = getScreenPosition();
        if (!current) {
            return;
        }
        
        //Diferencia de posición
        var diffx=current[0]-startingPoint[0];
        var diffy=current[1]-startingPoint[1];

        //Copia de las posiciones actuales
        var delta=0.01*mouse_sense;
        var latc1=lat1+0.0;
        var latc2=lat2-0;
        var lonc1=lon1-0;var lonc2=lon2-0;
        var pos3c=pos3.clone();
        var pos4c=pos4.clone();

        //Movimiento de las esferas roja
        //y azul manteniedo constante
        //la distancia ortodrómica
        //(rotaciones usando SO3)
        if (keep_orto_dist==1) {

            var angev=(diffx)*0.02*mouse_sense;

            //La esfera roja puede moverse libremente
            //arrastrando a la esfera azul para mantener
            //la distancia ortodrómica constante.
            if (currentMesh==redSphere || currentMesh==redSphere_fe) {

                if (Math.abs(diffy)>Math.abs(diffx)) {

                    var ev=(line_data[0]).subtract(zero);
                    ev.normalize();

                    var ev2=new BABYLON.Vector3(0,1,0);

                    var ev3=BABYLON.Vector3.Cross(ev,ev2);
                    ev3.normalize();

                    var wx=ev3.x;
                    var wy=ev3.z;
                    var wz=ev3.y;

                    var angev=(diffy)*0.02*mouse_sense;

                } else {

                    var wx=0;
                    var wy=0;
                    var wz=1;

                    var angev=(diffx)*0.02*mouse_sense;

                }

                var c=Math.cos(angev);
                var s=Math.sin(angev);
                var ic=1-c;

                mr00=c+ic*wx*wx;
                mr01=ic*wx*wy-s*wz;
                mr02=ic*wx*wz+s*wy;

                mr10=ic*wy*wx+s*wz;
                mr11=c+ic*wy*wy;
                mr12=ic*wy*wz-s*wx;

                mr20=ic*wz*wx-s*wy;
                mr21=ic*wz*wy+s*wx;
                mr22=c+ic*wz*wz;
                
                var ax=line_data[0].x;
                var ay=line_data[0].z;
                var az=line_data[0].y;

                var rx=mr00*ax+mr01*ay+mr02*az;
                var rz=mr10*ax+mr11*ay+mr12*az;
                var ry=mr20*ax+mr21*ay+mr22*az;

                var lat11=Math.asin(ry/rdeltar);
                var lon11=Math.atan2(rz,rx);
                if (Math.abs(lon1-lon11)>-1.5 && Math.abs(lat11)<0.99*Math.PI/2) {

                    lat1=Math.asin(ry/rdeltar);
                    lon1=Math.atan2(rz,rx);

                    //Actualización de la posición 
                    //de la esfera roja
                    pos1=rlatlon_to_xyz(r,lat1,lon1,h1);
                    redSphere.position=pos1;
                    pos3=rlatlon_to_xyz_fe(rfe,lat1,lon1,h1);
                    redSphere_fe.position=pos3.subtract(zero);

                    var ax2=line_data[ndiv].x;
                    var ay2=line_data[ndiv].z;
                    var az2=line_data[ndiv].y;

                    var rx2=mr00*ax2+mr01*ay2+mr02*az2;
                    var rz2=mr10*ax2+mr11*ay2+mr12*az2;
                    var ry2=mr20*ax2+mr21*ay2+mr22*az2;

                    lat2=Math.asin(ry2/rdeltar);
                    lon2=Math.atan2(rz2,rx2);

                    //Actualización de la posición 
                    //de la esfera roja
                    pos2=rlatlon_to_xyz(r,lat2,lon2,h2);
                    blueSphere.position=pos2;
                    pos4=rlatlon_to_xyz_fe(rfe,lat2,lon2,h2);
                    blueSphere_fe.position=pos4.subtract(zero);

                }

                change_pos=1;

            }

            //La esfera azul solo puede rotar, tomando
            //como eje el vector entre la esfera roja y el centro
            //mantiendo la distancia ortodrómica constante
            if (currentMesh==blueSphere || currentMesh==blueSphere_fe) {

                var ev=(line_data[0]).subtract(zero);
                ev.normalize();

                var wx=ev.x;
                var wy=ev.z;
                var wz=ev.y;

                var c=Math.cos(angev);
                var s=Math.sin(angev);
                var ic=1-c;

                mr00=c+ic*wx*wx;
                mr01=ic*wx*wy-s*wz;
                mr02=ic*wx*wz+s*wy;

                mr10=ic*wy*wx+s*wz;
                mr11=c+ic*wy*wy;
                mr12=ic*wy*wz-s*wx;

                mr20=ic*wz*wx-s*wy;
                mr21=ic*wz*wy+s*wx;
                mr22=c+ic*wz*wz;
                
                var ax=line_data[ndiv].x;
                var ay=line_data[ndiv].z;
                var az=line_data[ndiv].y;

                var rx=mr00*ax+mr01*ay+mr02*az;
                var rz=mr10*ax+mr11*ay+mr12*az;
                var ry=mr20*ax+mr21*ay+mr22*az;

                lat2=Math.asin(ry/rdeltar);
                lon2=Math.atan2(rz,rx);

                //Actualización de la posición de la esfera roja
                pos2=rlatlon_to_xyz(r,lat2,lon2,h2);
                blueSphere.position=pos2;
                pos4=rlatlon_to_xyz_fe(rfe,lat2,lon2,h2);
                blueSphere_fe.position=pos4.subtract(zero);

                change_pos=1;

            }

        }

        //Si se ha seleccionado la esfera roja
        //sobre la tierra plana
        if (currentMesh==redSphere_fe && keep_orto_dist==0) {

            //Modificación de las direcciones de movimiento
            //sobre el plano en fución de la orientación de la
            //cámara
            var rcp=camera.position.subtract(fe_pos);
            var rcpa=Math.atan2(rcp.z,rcp.x);

            pos3.x+=10*delta*(diffy*Math.cos(rcpa)-diffx*Math.sin(rcpa));
            pos3.z+=10*delta*(diffy*Math.sin(rcpa)+diffx*Math.cos(rcpa));
            
            var dc_aux=BABYLON.Vector3.Distance(fe_pos,new BABYLON.Vector3(pos3.x,0,pos3.z));
            lat1=Math.PI*(0.5-dc_aux/(2*rfe));
            lon1=Math.atan2(pos3.z-fe_pos.z,pos3.x-fe_pos.x);
            
            if (dc_aux>2*rfe) {
                pos3=pos3c;
                lat1=lat1c;
                lon1=lon1c;
            }

            //Cálculo de la distancia angular
            //entre las esferas roja y azul
            var v=Math.sin(lat1)*Math.sin(lat2) + Math.cos(lat1)*Math.cos(lat2)*Math.cos(lon1-lon2);
            var ang=Math.acos(v)*180/Math.PI;

            //No se permite que la distancia
            //angular sea inferior a 5º
            if (ang<5) {
                lat1=latc1;
                lon1=lonc1;
                pos3=pos3c;
                return;
            }

            pos1=rlatlon_to_xyz(r,lat1,lon1,h1);
            redSphere.position=pos1;

            redSphere_fe.position=pos3;

            change_pos=1;
        }

        //Si se ha seleccionado la esfera azul
        //sobre la tierra plana
        if (currentMesh==blueSphere_fe && keep_orto_dist==0) {
            
            //Modificación de las direcciones de movimiento
            //sobre el plano en fución de la orientación de la
            //cámara
            var rcp=camera.position.subtract(fe_pos);
            var rcpa=Math.atan2(rcp.z,rcp.x);

            pos4.x+=10*delta*(diffy*Math.cos(rcpa)-diffx*Math.sin(rcpa));
            pos4.z+=10*delta*(diffy*Math.sin(rcpa)+diffx*Math.cos(rcpa));
            
            var dc_aux=BABYLON.Vector3.Distance(fe_pos,new BABYLON.Vector3(pos4.x,0,pos4.z));
            lat2=Math.PI*(0.5-dc_aux/(2*rfe));
            lon2=Math.atan2(pos4.z-fe_pos.z,pos4.x-fe_pos.x);
            
            if (dc_aux>2*rfe) {
                pos4=pos4c;
                lat2=lat2c;
                lon2=lon2c;
            }

            //Cálculo de la distancia angular
            var v=Math.sin(lat1)*Math.sin(lat2) + Math.cos(lat1)*Math.cos(lat2)*Math.cos(lon1-lon2);
            var ang=Math.acos(v)*180/Math.PI;

            //No se permite que la distancia
            //angular sea inferior a 5º
            if (ang<5) {
                lat2=latc2;
                lon2=lonc2;
                pos4=pos4c;
                return;
            }

            pos2=rlatlon_to_xyz(r,lat2,lon2,h2);

            blueSphere.position=pos2;
            blueSphere_fe.position=pos4;

            change_pos=1;
        }
        
        //Si se ha seleccionado la esfera roja
        //sobre la esfera...
        if (currentMesh==redSphere && keep_orto_dist==0) {

            //Cálculo de la nueva posción
            lat1=lat1-delta*diffy;
            lon1=lon1+delta*diffx;

            //Se limita el ángulo máximo de latitud
            if (lat1>max_lat*0.5*Math.PI) lat1=max_lat*0.5*Math.PI;
            if (lat1<-max_lat*0.5*Math.PI) lat1=-max_lat*0.5*Math.PI;

            //Cálculo de la distancia angular
            //entre las esferas roja y azul
            var v=Math.sin(lat1)*Math.sin(lat2) + Math.cos(lat1)*Math.cos(lat2)*Math.cos(lon1-lon2);
            var ang=Math.acos(v)*180/Math.PI;

            //No se permite que la distancia
            //angular sea inferior a 5º
            if (ang<5) {
                lat1=latc1;
                lon1=lonc1;
                return;
            }

            //Actualización de la posición de la esfera roja
            pos1=rlatlon_to_xyz(r,lat1,lon1,h1);

            redSphere.position=pos1;

            pos3=rlatlon_to_xyz_fe(rfe,lat1,lon1,h1);

            redSphere_fe.position=pos3;

            change_pos=1;
        }

        //Si se ha seleccionado la esfera azul...
        if (currentMesh==blueSphere && keep_orto_dist==0) {

            //Cálculo de la nueva posición
            lat2=lat2-delta*diffy;
            lon2=lon2+delta*diffx;

            //Se limita el ángulo máximo de latitud
            if (lat2>max_lat*0.5*Math.PI) lat2=max_lat*0.5*Math.PI;
            if (lat2<-max_lat*0.5*Math.PI) lat2=-max_lat*0.5*Math.PI;

            //Cálculo de la distancia angular
            var v=Math.sin(lat1)*Math.sin(lat2) + Math.cos(lat1)*Math.cos(lat2)*Math.cos(lon1-lon2);
            var ang=Math.acos(v)*180/Math.PI;

            //No se permite que la distancia
            //angular sea inferior a 5º
            if (ang<5) {
                lat2=latc2;
                lon2=lonc2;
                return;
            }

            //Actualización de la posición de la esfera azul
            pos2=rlatlon_to_xyz(r,lat2,lon2,h2);

            blueSphere.position=pos2;

            pos4=rlatlon_to_xyz_fe(rfe,lat2,lon2,h2);

            blueSphere_fe.position=pos4;

            change_pos=1;
        }
        
        //Se guarda el punto de incio como actual
        startingPoint = current;

        //Actualización de posinción de las
        //esferas roja y azul
        pos1=redSphere.position;
        pos2=blueSphere.position;
        pos3=redSphere_fe.position;
        pos4=blueSphere_fe.position;

        //Actualización de las posiciones, 
        //líneas y tamaños
        update_all();
    }

    //Modelo seleccionado
    //1 La Tierra
    //2 tierra plana
    var model_selected=1;
    if (sp_sel==1) {model_selected=1;} else {model_selected=2;}

    //Comportamiento general al pulsar botones
    //o mover el ratón
    scene.onPointerObservable.add((pointerInfo) => {

        switch (pointerInfo.type) {

            //Al pulsar el botón del ratón...
			case BABYLON.PointerEventTypes.POINTERDOWN:

                //sobre la esfera de La Tierra...
                if(pointerInfo.pickInfo.hit && pointerInfo.pickInfo.pickedMesh == EarthSphere) {
                    
                    //La centra
                    camera.target=EarthSphere.position;
                    //Actualzia el zoom al cambiar de modelo
                    if (model_selected==2) camera.radius=4.0*r;
                    //Actualiza el modelo seleccionado
                    model_selected=1;
                    sp_mark.background="red";
                    fe_mark.background="black";
                    sp_sel=1;
                    fe_sel=0;
                    
                }

                //sobre el disco de la tierra plana...
                if(pointerInfo.pickInfo.hit && pointerInfo.pickInfo.pickedMesh == EarthDisk) {
                    
                    //la centra
                    camera.target=EarthDisk.position;
                    //Actualiza el zoom al cambiar de modelo
                    if (model_selected==1) camera.radius=6.5*rfe;
                    //Actualiza el modelo seleccionado
                    model_selected=2;
                    sp_mark.background="black";
                    fe_mark.background="red";
                    fe_sel=1;
                    sp_sel=0;
                        
                }

                //Si se pulsa sobre cualquier elemento que no 
                //sea la esfera de La Tierra
                
				if(pointerInfo.pickInfo.hit && pointerInfo.pickInfo.pickedMesh != EarthSphere && pointerInfo.pickInfo.pickedMesh != EarthDisk ) {
                
                    pointerDown(pointerInfo.pickInfo.pickedMesh)
                }
                
				break;

            //Al soltar el botón del ratón...
			case BABYLON.PointerEventTypes.POINTERUP:
                    pointerUp();
                    
				break;

            //Al mover el ratón con el botón pulsado...
			case BABYLON.PointerEventTypes.POINTERMOVE:          
                    pointerMove();

				break;

            //Leve disminución de los tamaños de las
            //esferas roja y azul al aumentar el zoom
            //al máximo sobre la esfera de La Tierra
            //(experimental)
            case BABYLON.PointerEventTypes.POINTERWHEEL:
                if (camera.radius<2.75*r && pointerInfo.event.wheelDelta>0) {
                    redSphere.scaling=new BABYLON.Vector3(0.5,0.5,0.5);
                    blueSphere.scaling=new BABYLON.Vector3(0.5,0.5,0.5);
                } else {
                    redSphere.scaling=new BABYLON.Vector3(1,1,1);
                    blueSphere.scaling=new BABYLON.Vector3(1,1,1);
                }
                break;    
        }

        //update_all();

    });

    //Botón de salida del mapa de selección de ubicación
    done_button.addEventListener("click", function() {

        //Hace visible el canvas 3d,
        //oculta el botón de retorno y
        //Actualiza el canvas
        canvas.removeAttribute("hidden");
        done_button.setAttribute("hidden", "hidden");
        engine.resize();

        //Ubicación de la esfera roja
        if (marker_type==1) {
            //Cambia las coordenadas de la ubicación roja
            // en función de la selección del mapa
            lon1=map_latlon[0]*dtor;
            lat1=map_latlon[1]*dtor;

            //cambia las posiciones de la esfera roja de ubicación
            //sobre la esfera y sobre el plano
            pos1=rlatlon_to_xyz(r,lat1,lon1,h1);
            redSphere.position=pos1.subtract(zero);
            pos3=rlatlon_to_xyz_fe(rfe,lat1,lon1,h1);
            redSphere_fe.position=pos3.subtract(zero);
        }

        //Ubicación de la esfera azul
        if (marker_type==2) {
            //Cambia las coordenadas de la ubicación azul
            //En función de la selección del mapa
            lon2=map_latlon[0]*dtor;
            lat2=map_latlon[1]*dtor;

            //Cambia las posiciones de la esfera azul de ubicación
            //sobre la esfera y sobre el plano
            pos2=rlatlon_to_xyz(r,lat2,lon2,h2);
            blueSphere.position=pos2.subtract(zero);
            pos4=rlatlon_to_xyz_fe(rfe,lat2,lon2,h2);
            blueSphere_fe.position=pos4.subtract(zero);
        }

        //Actualiza todos los cálculos
        update_all();

    });

    var update_all=function() {

        //Cálculo de las líneas
        //en función de las posiciones
        calculate_lines();
        
        //Actuliza las posiciones de las esferas
        //roja y azul sobre la tierra plana
        //redSphere_fe.position=line_data_fe[0];
        //blueSphere_fe.position=line_data_fe[ndiv];

        pos3=redSphere_fe.position;
        pos4=blueSphere_fe.position;

        moonFe.position=moon_fe_pos;
        sunFe.position=sun_fe_pos;

        ssp=new BABYLON.Vector3(0,0,0);
        ssp.copyFrom(sun_sphere_pos);
        ssp.normalize();
        ssp.scaleInPlace(-1);
        light2.direction=ssp;

        msp=new BABYLON.Vector3(0,0,0);
        msp.copyFrom(sun_pos);
        msp=msp.subtract(moon_pos);
        msp.normalize();
        msp.scaleInPlace(-1);
        light3.direction=msp;

        //Control de distancias absurdas sobre la tierra plana
        if (distancia_fe_suma!=0) {
            var dofe_opt=("00"+(Math.round(distancia_fe_suma)).toString()).slice(-5);
        } else {
            var dofe_opt="  N/A";
        }

        if (distancia_fe_lox_suma!=0) {
            var dlfe_opt=("00"+(Math.round(distancia_fe_lox_suma)).toString()).slice(-5);
        } else {
            var dlfe_opt="  N/A";
        }
        
        //Actualización de distancias en GUI
         data_text_1.text="            ~ DISTANCES(km)  (BASELINE "+base_line.toFixed(0)+"km)\n"+
                     "\n"+
                     " ORTHODROMIC  "+ ("00"+(Math.round(distancia_sp)).toString()).slice(-5) + "   "
                                    + dofe_opt + "\n"+
                     " LOXODROMIC   "+ ("00"+(Math.round(distancia_sp_lox_suma)).toString()).slice(-5) + "   "
                                    + dlfe_opt + "\n"+
                     " FLATODROMIC  "+ ("00"+(Math.round(distancia_sp_flat_suma)).toString()).slice(-5) + "   "
                                    + ("00"+(Math.round(distancia_fe_flat_suma)).toString()).slice(-5) + "\n"+
                     " EQUIANGULAR  "+ ("00"+(Math.round(distancia_sp_eqac_suma)).toString()).slice(-5) + "   "
                                    + ("00"+(Math.round(distancia_fe_eqac_suma)).toString()).slice(-5);
               
        //Destrucción de la ortodrómica sobre la esfera
        ortodromic_line.dispose();
        //Creación de la ortodrómica sobre la esfera
        ortodromic_line =BABYLON.MeshBuilder.CreateLines ( "ortodromic_line", {points: line_data},scene,true); 
        ortodromic_line.material=ol_mat;
        ortodromic_line.isVisible=orto_es_visible;

        //Destrucción de la ortodrómica proyectada 
        //sobre la tierra plana
        ortodromic_line_fe.dispose();
        //Creación de la ortodrómica proyectada 
        //sobre la tierra plana
        ortodromic_line_fe =BABYLON.MeshBuilder.CreateLines ( "ortodromic_line_fe", {points: line_data_fe},scene,true); 
        ortodromic_line_fe.material=ol_mat;
        ortodromic_line_fe.isVisible=orto_es_visible;

        //Destrucción de la línea loxodrómica sobre la esfera
        loxodromic_line.dispose();
        //Creación de línea loxodrómica sobre la esfera
        loxodromic_line =BABYLON.MeshBuilder.CreateLines ( "loxodromic_line", {points: line_data_lox},scene,true); 
        loxodromic_line.material = ll_mat;
        loxodromic_line.isVisible=loxo_es_visible;

        //Destrucción de la línea loxodrómica
        //proyectada sobre la tierra plana
        loxodromic_line_fe.dispose();
        //Creación de la línea loxodrómica proyectada sobre la tierra plana
        loxodromic_line_fe =BABYLON.MeshBuilder.CreateLines ( "loxodromic_line", {points: line_data_lox_fe},scene,true); 
        loxodromic_line_fe.material = ll_mat;
        loxodromic_line_fe.isVisible=loxo_es_visible;

        //Destrucción de la línea flatodrómica
        //Sobre la tierra plana
        flatodromic_line_fe.dispose();
        //Creación de la línea flatodromica sobre la tierra plana
        flatodromic_line_fe =BABYLON.MeshBuilder.CreateLines ( "flatodromic_line", {points: line_data_flat_fe},scene,true); 
        flatodromic_line_fe.material = fl_mat;
        flatodromic_line_fe.isVisible=flato_es_visible;

        //Destrucción de la línea flatodrómica
        //sobre la esfera
        flatodromic_line_sp.dispose();
        //Creación de la línea flatodromica sobre la esfera
        flatodromic_line_sp =BABYLON.MeshBuilder.CreateLines ( "flatodromic_line", {points: line_data_flat_sp},scene,true); 
        flatodromic_line_sp.material=fl_mat;
        flatodromic_line_sp.isVisible=flato_es_visible;

        //Destrucción de la línea equiangular
        //Sobre la tierra plana
        equiangular_line_fe.dispose();
        //Creación de la línea equiangular sobre la tierra plana
        equiangular_line_fe =BABYLON.MeshBuilder.CreateLines ( "equiangular_line", {points: line_data_eqac_fe},scene,true); 
        equiangular_line_fe.material=el_mat;
        equiangular_line_fe.isVisible=eqac_es_visible;

        //Destrucción de la línea equiangular
        //Sobre la esfera
        equiangular_line_sp.dispose();
        //Creación de la línea equiangular sobre la esfera
        equiangular_line_sp =BABYLON.MeshBuilder.CreateLines ( "equiangular_line", {points: line_data_eqac_sp},scene,true); 
        equiangular_line_sp.material=el_mat;
        equiangular_line_sp.isVisible=eqac_es_visible;

        /////////////

        moon_line_1.dispose();
        moon_line_1 =BABYLON.MeshBuilder.CreateLines ( "moon_line_1", {points: moon_line_data_1},scene,true); 
        moon_line_1.material=ml_mat;
        moon_line_1.isVisible=moon_tg_visible;

        moon_line_2.dispose();
        moon_line_2 =BABYLON.MeshBuilder.CreateLines ( "moon_line_2", {points: moon_line_data_2},scene,true); 
        moon_line_2.material=ml_mat;
        moon_line_2.isVisible=moon_tg_visible;

        moon_line_c.dispose();
        moon_line_c =BABYLON.MeshBuilder.CreateLines ( "moon_line_c", {points: moon_line_data_c},scene,true); 
        moon_line_c.material=ml_mat;
        moon_line_c.isVisible=moon_tg_visible;

        sun_line_1.dispose();
        sun_line_1 =BABYLON.MeshBuilder.CreateLines ( "sun_line_1", {points: sun_line_data_1},scene,true); 
        sun_line_1.material=sl_mat;
        sun_line_1.isVisible=sun_tg_visible;

        sun_line_2.dispose();
        sun_line_2 =BABYLON.MeshBuilder.CreateLines ( "sun_line_2", {points: sun_line_data_2},scene,true); 
        sun_line_2.material=sl_mat;
        sun_line_2.isVisible=sun_tg_visible;

        sun_line_c.dispose();
        sun_line_c =BABYLON.MeshBuilder.CreateLines ( "sun_line_c", {points: sun_line_data_c},scene,true); 
        sun_line_c.material=sl_mat;
        sun_line_c.isVisible=sun_tg_visible;

        fe_moon_line_1.dispose();
        fe_moon_line_1 =BABYLON.MeshBuilder.CreateLines ( "fe_moon_line_1", {points: fe_moon_line_data_1},scene,true); 
        fe_moon_line_1.material=sl_mat;
        fe_moon_line_1.isVisible=moon_tp_visible;

        fe_moon_line_2.dispose();
        fe_moon_line_2 =BABYLON.MeshBuilder.CreateLines ( "fe_moon_line_2", {points: fe_moon_line_data_2},scene,true); 
        fe_moon_line_2.material=sl_mat;
        fe_moon_line_2.isVisible=moon_tp_visible;

        fe_sun_line_1.dispose();
        fe_sun_line_1 =BABYLON.MeshBuilder.CreateLines ( "fe_sun_line_1", {points: fe_sun_line_data_1},scene,true); 
        fe_sun_line_1.material=sl_mat;
        fe_sun_line_1.isVisible=sun_tp_visible;

        fe_sun_line_2.dispose();
        fe_sun_line_2 =BABYLON.MeshBuilder.CreateLines ( "fe_sun_line_2", {points: fe_sun_line_data_2},scene,true); 
        fe_sun_line_2.material=sl_mat;
        fe_sun_line_2.isVisible=sun_tp_visible;

        /////////

        //Flechs de dirección del Sol en la TP
        fe_sun_arrow_1.dispose();
        fe_sun_arrow_1 = BABYLON.MeshBuilder.CreateTube(
        "tube", {
            path: fe_sun_data_arrow_1, 
            radiusFunction: radiusChange = (index, distance) => {
                const radius =  distance / 2;
                return radius;}, 
            sideOrientation: BABYLON.Mesh.DOUBLESIDE
        }, 
        scene);
        fe_sun_arrow_1.material=sunArrowMat;
        fe_sun_arrow_1.isVisible=sun_tp_visible;
    
        fe_sun_arrow_2.dispose();
        fe_sun_arrow_2 = BABYLON.MeshBuilder.CreateTube(
            "tube", {
                path: fe_sun_data_arrow_2, 
                radiusFunction: radiusChange = (index, distance) => {
                    const radius =  distance / 2;
                    return radius;}, 
                sideOrientation: BABYLON.Mesh.DOUBLESIDE
            }, 
        scene);
        fe_sun_arrow_2.material=sunArrowMat;
        fe_sun_arrow_2.isVisible=sun_tp_visible;
        //

        //Flechas de dirección de la Luna en la TP
        fe_moon_arrow_1.dispose();
        fe_moon_arrow_1 = BABYLON.MeshBuilder.CreateTube(
        "tube", {
            path: fe_moon_data_arrow_1, 
            radiusFunction: radiusChange = (index, distance) => {
                const radius =  distance / 2;
                return radius;}, 
            sideOrientation: BABYLON.Mesh.DOUBLESIDE
        }, 
        scene);
        fe_moon_arrow_1.material=moonArrowMat;
        fe_moon_arrow_1.isVisible=moon_tp_visible;
    
        fe_moon_arrow_2.dispose();
        fe_moon_arrow_2 = BABYLON.MeshBuilder.CreateTube(
            "tube", {
                path: fe_moon_data_arrow_2, 
                radiusFunction: radiusChange = (index, distance) => {
                    const radius =  distance / 2;
                    return radius;}, 
                sideOrientation: BABYLON.Mesh.DOUBLESIDE
            }, 
        scene);
        fe_moon_arrow_2.material=moonArrowMat;
        fe_moon_arrow_2.isVisible=moon_tp_visible;
        //

        //Actualización de las puntas de flecha del plano
        //de información local para el Sol, La Luna y el eje Norte-Sur
        for (var k=0;k<4;k++) {

            rose_arrow_sun[k].dispose();
            rose_arrow_moon[k].dispose();
            rose_arrow_n[k].dispose();
            rose_arrow_s[k].dispose();

            if (fe_is_visible==0 && k>1) continue;
            
            rose_arrow_sun[k] = BABYLON.MeshBuilder.CreateTube(
            "tube", {
                path: [rose_arrow_sun_b[k],rose_arrow_sun_e[k]], 
                radiusFunction: radiusChange = (index, distance) => {
                    const radius =  distance / 3;
                    return radius;}, 
                sideOrientation: BABYLON.Mesh.DOUBLESIDE
            }, 
            scene);
            rose_arrow_sun[k].material=sunArrowMat;
            rose_arrow_sun[k].isVisible=additional_model_info*Math.abs(1-moon_cameras_point_moon);

            
            rose_arrow_moon[k] = BABYLON.MeshBuilder.CreateTube(
            "tube", {
                path: [rose_arrow_moon_b[k],rose_arrow_moon_e[k]], 
                radiusFunction: radiusChange = (index, distance) => {
                    const radius =  distance / 3;
                    return radius;}, 
                sideOrientation: BABYLON.Mesh.DOUBLESIDE
            }, 
            scene);
            rose_arrow_moon[k].material=moonArrowMat;
            rose_arrow_moon[k].isVisible=additional_model_info*Math.abs(1-moon_cameras_point_moon);

            
            rose_arrow_n[k] = BABYLON.MeshBuilder.CreateTube(
            "tube", {
                path: [rose_arrow_n_b[k],rose_arrow_n_e[k]], 
                radiusFunction: radiusChange = (index, distance) => {
                    const radius =  distance / 3;
                    return radius;}, 
                sideOrientation: BABYLON.Mesh.DOUBLESIDE
            }, 
            scene);
            rose_arrow_n[k].material=axisArrowMat;
            rose_arrow_n[k].isVisible=additional_model_info*Math.abs(1-moon_cameras_point_moon);

            
            rose_arrow_s[k] = BABYLON.MeshBuilder.CreateTube(
            "tube", {
                path: [rose_arrow_s_b[k],rose_arrow_s_e[k]], 
                radiusFunction: radiusChange = (index, distance) => {
                    const radius =  distance / 3;
                    return radius;}, 
                sideOrientation: BABYLON.Mesh.DOUBLESIDE
            }, 
            scene);
            rose_arrow_s[k].material=axisArrowMat;
            rose_arrow_s[k].isVisible=additional_model_info*Math.abs(1-moon_cameras_point_moon);

        }

        //Sombra de la Tierra 
        shadowEarth.dispose();
        shadowEarth = BABYLON.MeshBuilder.CreateTube(
            "tube", {
                path: umbra_pos, 
                radius: umbra_size,
                cap: 1
            }, 
        scene);
        //fe_sun_arrow_1.material=redArrowMat;
        shadowEarth.material=shadowEarthMat;
        shadowEarth.layerMask= 0x00000110;
        light.excludedMeshes.push(shadowEarth);
        light2.excludedMeshes.push(shadowEarth);
        light3.excludedMeshes.push(shadowEarth);

        //Sombra de la Tierra 
        shadowEarth2.dispose();
        shadowEarth2 = BABYLON.MeshBuilder.CreateTube(
            "tube", {
                path: umbra_pos, 
                radius: penumbra_size,
                cap: 1
            }, 
        scene);
        //fe_sun_arrow_1.material=redArrowMat;
        shadowEarth2.material=shadowEarthMat2;
        shadowEarth2.layerMask= 0x00000110;
        light.excludedMeshes.push(shadowEarth2);
        light2.excludedMeshes.push(shadowEarth2);
        light3.excludedMeshes.push(shadowEarth2);

        //Si las posiciones de las esferas han cambiado
        //y está seleccionada alguna de las casillas
        //de información
        if (change_pos==1 && info_orto+info_loxo+info_flat+info_eqac>0) {

            //Hace visible el cuadro de
            //información y cambia el color
            //del contorno a gris
            info_rect.isVisible=1;
            info_rect.color="gray";

            var slat1="";
            if (lat1>=0) slat1="+";
            var slat2="";
            if (lat2>=0) slat2="+";

            var slon1="";
            if (lon1>=0) slon1="+";
            var slon2="";
            if (lon2>=0) slon2="+";

            //Cambia el resaltado 
            //del cuadro de información
            red_mark.height="32px";
            red_mark.top="5px";
            red_mark.left="5px";

            blue_mark.height="32px";
            blue_mark.top="40px";
            blue_mark.left="5px";

            //Presenta información de
            //latitud, longitud y
            //ángulo
            info_text_1.text= ""+
                              " Red Lat:  "+ slat1 +(Math.round(lat1/dtor*10)/10) +"º\n"+
                              " Red Lon:  "+ slon1 +(Math.round(lon1/dtor*10)/10) +"º\n"+
                              " Blue Lat: "+ slat2 +(Math.round(lat2/dtor*10)/10) +"º\n"+
                              " Blue Lon: "+ slon2 +(Math.round(lon2/dtor*10)/10) +"º\n"+
                              " S. ANGLE: "+ (Math.round(orthodromic_angle*10)/10)+"º";
            
            change_pos=0;

        } else {

           info_rect.isVisible=0;

        }

        //
        var alat1=Math.abs(lat1);
        var slat1="+";
        if (lat1<0) slat1="-";
        var tlat1=slat1+(alat1/dtor).toFixed(2).padStart(5,'0');
        lat1_pe_btn.textBlock.text=tlat1.substring(0,4);
        lat1_pd_btn.textBlock.text=tlat1.substring(4,6)+"º";


        var alon1=lon1*1.0;
        if (alon1<-Math.PI) alon1=alon1+2*Math.PI;
        if (alon1>Math.PI) alon1=alon1-2*Math.PI;
        alon1=Math.abs(alon1);
        var slon1="+";
        if (lon1<0) slon1="-";
        var tlon1=slon1+(alon1/dtor).toFixed(2).padStart(6,'0');
        lon1_pe_btn.textBlock.text=tlon1.substring(0,5);
        lon1_pd_btn.textBlock.text=tlon1.substring(5,7)+"º";


        var alat2=Math.abs(lat2);
        var slat2="+";
        if (lat2<0) slat2="-";
        var tlat2=slat2+(alat2/dtor).toFixed(2).padStart(5,'0');
        lat2_pe_btn.textBlock.text=tlat2.substring(0,4);
        lat2_pd_btn.textBlock.text=tlat2.substring(4,6)+"º";

        
        var alon2=lon2*1.0;
        if (alon2<-Math.PI) alon2=alon2+2*Math.PI;
        if (alon2>Math.PI) alon2=alon2-2*Math.PI;
        alon2=Math.abs(alon2);
        var slon2="+";
        if (lon2<0) slon2="-";
        var tlon2=slon2+(alon2/dtor).toFixed(2).padStart(6,'0');
        lon2_pe_btn.textBlock.text=tlon2.substring(0,5);
        lon2_pd_btn.textBlock.text=tlon2.substring(5,7)+"º";
        //
        

        bear1_btn.textBlock.text=(moon_bear1.toFixed(2)).padStart(6,"0")+"º";        
        bear2_btn.textBlock.text=(moon_bear2.toFixed(2)).padStart(6,"0")+"º";


        var smoon_alt1="+";
        if (moon_alt1_co<0) smoon_alt1="-";
        var smoon_alt2="+";
        if (moon_alt2_co<0) smoon_alt2="-";
        
        moonaltaz1_btn.textBlock.text=smoon_alt1+(Math.abs(moon_alt1_co/dtor)).toFixed(2).padStart(5,"0")+"º"+
                                    "  " + (Math.abs(moon_az1/dtor)).toFixed(2).padStart(6,"0")+"º"+
                                    " "+mf1.toFixed(2).padStart(5,"0")+"%"+" "+
                                    " "+melo1.toFixed(2).padStart(6,"0")+"º";                                    
        moonaltaz2_btn.textBlock.text=smoon_alt2+(Math.abs(moon_alt2_co/dtor)).toFixed(2).padStart(5,"0")+"º"+
                                    "  " + (Math.abs(moon_az2/dtor)).toFixed(2).padStart(6,"0")+"º"+
                                    " "+mf2.toFixed(2).padStart(5,"0")+"%"+" "+
                                    " "+melo2.toFixed(2).padStart(6,"0")+"º";
        
        var mfeh_text="-----"
        if (isNaN(moon_cut_d)==0) mfeh_text=(moon_cut_d).toFixed(0);
        moonpar_btn.textBlock.text=(moon_earth_distance).toFixed(0)+"km      "+
                                mfeh_text+"km    "+
                                (moon_paralax).toFixed(4).padStart(5,"0")+"º"; 

        var ssun_alt1="+";
        if (sun_alt1_co<0) ssun_alt1="-";
        var ssun_alt2="+";
        if (sun_alt2_co<0) ssun_alt2="-";
        
        sunaltaz1_btn.textBlock.text=ssun_alt1+(Math.abs(sun_alt1_co/dtor)).toFixed(2).padStart(5,"0")+"º"+
                                    "   " + (Math.abs(sun_az1/dtor)).toFixed(2).padStart(6,"0")+"º";
        sunaltaz2_btn.textBlock.text=ssun_alt2+(Math.abs(sun_alt2_co/dtor)).toFixed(2).padStart(5,"0")+"º"+
                                    "   " + (Math.abs(sun_az2/dtor)).toFixed(2).padStart(6,"0")+"º";
        var sfeh_text="----"
        if (isNaN(sun_cut_d)==0) sfeh_text=(sun_cut_d).toFixed(0);
        sunpar_btn.textBlock.text=(sun_earth_distance/1e6).toFixed(3)+"Mkm   "+
                                sfeh_text+"km    "+
                                (sun_paralax*3600).toFixed(2).padStart(5,"0")+"\""; 

        var s_mlac="+";
        if (moon_latc<0) s_mlac="-";
        var s_mloc="+";
        if (moon_lonc<0) s_mloc="-";
         latlonmoon_text.text=" "+mfc.toFixed(2).padStart(5,"0")+"%"+" "+
                         " "+meloc.toFixed(2).padStart(6,"0")+"º"+"\n"+
                         "    Lat=  "+s_mlac+Math.abs((moon_latc/dtor)).toFixed(2).padStart(5,"0")+"\n"+
                         "    Lon= "+s_mloc+Math.abs((moon_lonc/dtor)).toFixed(2).padStart(6,"0");
        
        var s_slac="+";
        if (sun_latc<0) s_slac="-";
        var s_sloc="+";
        if (sun_lonc<0) s_slon="-";
        latlonsun_text.text="\n"+
                            "    Lat=  "+s_slac+Math.abs((sun_latc/dtor)).toFixed(2).padStart(5,"0")+"º\n"+
                            "    Lon= "+s_sloc+Math.abs((sun_lonc/dtor)).toFixed(2).padStart(6,"0")+"º";
        
        
        //
        if (usuario_mira_estrella==1) {

            update_user_data();
        }
        //

        //Actualización de la línea y punto de corte
        //de las direcciones hacia La Luna en la TP
        moon_cut_line.dispose();
        moon_cut_line =BABYLON.MeshBuilder.CreateLines ( "moon_cut_line", {points: moon_cut_line_data},scene,true); 
        moon_cut_line.material=mooncutMat2;
        moon_cut_line.isVisible=moon_tp_visible*moon_tp_cut_visible*fe_is_visible;

        moon_cut_sphere.position=moon_cut_p.subtract(zero);
        moon_cut_sphere.material=mooncutMat;
        moon_cut_sphere.isVisible=moon_tp_visible*moon_tp_cut_visible*fe_is_visible;
    
        //Actualización de la línea y punto de corte
        //de las direcciones hacia el Sol en la TP
        sun_cut_line.dispose();
        sun_cut_line =BABYLON.MeshBuilder.CreateLines ( "sun_cut_line", {points: sun_cut_line_data},scene,true); 
        sun_cut_line.material=suncutMat2;
        sun_cut_line.isVisible=sun_tp_visible*sun_tp_cut_visible*fe_is_visible;

        sun_cut_sphere.position=sun_cut_p.subtract(zero);
        sun_cut_sphere.material=suncutMat;
        sun_cut_sphere.isVisible=sun_tp_visible*sun_tp_cut_visible*fe_is_visible;

        //Actualización de las líneas de observación de usuario
        user_line_1.dispose();
        user_line_1 =BABYLON.MeshBuilder.CreateLines ( "user_line_1", {points: user_data_line_1},scene,true); 
        user_line_1.material=redMat2;
        user_line_1.isVisible=user_tg_lines_visible;

        user_line_2.dispose();
        user_line_2 =BABYLON.MeshBuilder.CreateLines ( "user_line_2", {points: user_data_line_2},scene,true); 
        user_line_2.material=blueMat2;
        user_line_2.isVisible=user_tg_lines_visible;

        //Líneas de observación de usuario sobre la TP
        fe_user_line_1.dispose();
        fe_user_line_1 =BABYLON.MeshBuilder.CreateLines ( "fe_user_line_1", {points: fe_user_data_line_1},scene,true); 
        fe_user_line_1.material=redMat2;
        fe_user_line_1.isVisible=user_tp_lines_visible;

        fe_user_line_2.dispose();
        fe_user_line_2 =BABYLON.MeshBuilder.CreateLines ( "fe_user_line_2", {points: fe_user_data_line_2},scene,true); 
        fe_user_line_2.material=blueMat2;
        fe_user_line_2.isVisible=user_tp_lines_visible;

        //Rose lines
        rose_line.dispose();
        rose_line =BABYLON.MeshBuilder.CreateLines ( "rose_line", {points: rose_lines_data, colors: rose_lines_color_data},scene,true); 
        rose_line.material=auxMat2;
        
        //Líneas del horizonte geometrico
        hc_line.dispose();
        hc_line =BABYLON.MeshBuilder.CreateLines ( "hc_line", {points: hc_lines_data, colors: hc_lines_color_data},scene,true); 
        hc_line.material=auxMat2;
        hc_line.renderingGroupId = 1;

        //Líneas de eclipse
        eclipse_line_umbra.dispose();
        eclipse_line_umbra =BABYLON.MeshBuilder.CreateLines ( "eclipse_line", {points: eclipse_data_umbra},scene,true); 
        eclipse_line_umbra.material=eclu_mat;

        eclipse_line_penumbra.dispose();
        eclipse_line_penumbra =BABYLON.MeshBuilder.CreateLines ( "eclipse_line", {points: eclipse_data_penumbra},scene,true); 
        eclipse_line_penumbra.material=eclp_mat;

        eclipse_line_umbra_fe.dispose();
        eclipse_line_umbra_fe =BABYLON.MeshBuilder.CreateLines ( "eclipse_line", {points: eclipse_data_umbra_fe},scene,true); 
        eclipse_line_umbra_fe.material=eclu_mat;

        eclipse_line_penumbra_fe.dispose();
        eclipse_line_penumbra_fe =BABYLON.MeshBuilder.CreateLines ( "eclipse_line", {points: eclipse_data_penumbra_fe},scene,true); 
        eclipse_line_penumbra_fe.material=eclp_mat;

        //Comprobaciones relacionadas con el eclipse
        sumo_line_sp.dispose();
        sumo_line_sp =BABYLON.MeshBuilder.CreateLines ( "sun-moon line sp", {points: sumopos_sp},scene,true); 
        sumo_line_sp.material=auxMat2;
        
        sumo_line_fe.dispose();
        sumo_line_fe =BABYLON.MeshBuilder.CreateLines ( "sun-moon line fe", {points: sumopos_fe},scene,true); 
        sumo_line_fe.material=auxMat2;

        sumopro_line_sp.dispose();
        sumopro_line_sp =BABYLON.MeshBuilder.CreateLines ( "sun-moon line fe", {points: sumopro_sp},scene,true); 
        sumopro_line_sp.material=auxMat2;
        sumopro_line_sp.alpha=0.125;

        sumo_line_sp.isVisible=eclipse_test;
        sumo_line_fe.isVisible=eclipse_test;
        sumopro_line_sp.isVisible=eclipse_test;

        //Línea de iluminación
        ilu_line_sp.dispose();
        ilu_line_sp =BABYLON.MeshBuilder.CreateLines ( "ilumination line", {points: ilu_data_sp},scene,true); 
        ilu_line_sp.material=auxMat2;
        ilu_line_sp.alpha=ilu_alpha;
        ilu_line_sp.isVisible=ilu_is_visible;
        ilu_line_fe.dispose();
        ilu_line_fe =BABYLON.MeshBuilder.CreateLines ( "ilumination line", {points: ilu_data_fe},scene,true); 
        ilu_line_fe.material=auxMat2;
        ilu_line_fe.alpha=ilu_alpha;
        ilu_line_fe.isVisible=ilu_is_visible;

        //Actualización de los datos de usuario
        sp_usr_text.text="--ON SPHERE--\n"+
                    "D  "+ sp_user_cut_d.toFixed(0)+" km\n"+
                    "DL "+sp_user_cut_dl.toFixed(0)+" km\n"+
                    "D1 "+sp_user_cut_d1.toFixed(0)+" km\n"+
                    "D2 "+sp_user_cut_d2.toFixed(0)+" km";


        fe_usr_text.text="--ON DISK--\n"+
                    "H  "+ fe_user_cut_d.toFixed(0)+" km\n"+
                    "DL "+fe_user_cut_dl.toFixed(0)+" km\n"+
                    "D1 "+fe_user_cut_d1.toFixed(0)+" km\n"+
                    "D2 "+fe_user_cut_d2.toFixed(0)+" km";

        if (sun_tr_a==1) {

            sun_tr_np++;
            ssp2=new BABYLON.Vector3(0,0,0);
            ssp2.copyFrom(sun_sphere_pos);
            ssp2.normalize();
            ssp2.scaleInPlace(0.1);
            ssp2.addInPlace(sun_sphere_pos);
            sun_tr_line_data[sun_tr_np-1]=ssp2;
            sun_tr_line_data_fe[sun_tr_np-1]=sun_fe_pos;

            if (sun_tr_np>365) {
                sun_tr_line_data.splice(0,1);
                sun_tr_line_data_fe.splice(0,1);
                sun_tr_np--;
            }
            
            sun_tr_line.dispose();
            sun_tr_line =BABYLON.MeshBuilder.CreateLines ( "user_line_1", {points: sun_tr_line_data},scene,true); 
            sun_tr_line.material=suncutMat2;
            sun_tr_line_fe.dispose();
            sun_tr_line_fe =BABYLON.MeshBuilder.CreateLines ( "user_line_1", {points: sun_tr_line_data_fe},scene,true); 
            sun_tr_line_fe.material=suncutMat2;

        }

        if (moon_tr_a==1) {

            moon_tr_np++;
            ssp2m=new BABYLON.Vector3(0,0,0);
            ssp2m.copyFrom(moon_sphere_pos);
            ssp2m.normalize();
            ssp2m.scaleInPlace(0.1);
            ssp2m.addInPlace(moon_sphere_pos);
            moon_tr_line_data[moon_tr_np-1]=ssp2m;
            moon_tr_line_data_fe[moon_tr_np-1]=moon_fe_pos;

            if (moon_tr_np>100) {
                moon_tr_line_data.splice(0,1);
                moon_tr_line_data_fe.splice(0,1);
                moon_tr_np--;
            }
            
            moon_tr_line.dispose();
            moon_tr_line =BABYLON.MeshBuilder.CreateLines ( "user_line_1", {points: moon_tr_line_data},scene,true); 
            moon_tr_line.material=mooncutMat2;
            moon_tr_line_fe.dispose();
            moon_tr_line_fe =BABYLON.MeshBuilder.CreateLines ( "user_line_1", {points: moon_tr_line_data_fe},scene,true); 
            moon_tr_line_fe.material=mooncutMat2;

        }

        camera_moon_1.position=pos1_cam;
        camera_moon_2.position=pos2_cam;
        camera_moon_1.upVector=pos1_upv;
        camera_moon_2.upVector=pos2_upv;

        if (moon_cameras_point_moon==1) {
            camera_moon_1.target=moon_pos.subtract(zero);
            camera_moon_2.target=moon_pos.subtract(zero);
        } else {
            camera_moon_1.target=(user_data_line_1[1]).subtract(zero);
            camera_moon_2.target=(user_data_line_2[1]).subtract(zero);
        }

        MoonSphere.position=moon_pos;
        SunSphere.position=sun_pos;

        MoonSphere.rotation=new BABYLON.Vector3(0, 0, 0);

        //Diurnal motion
        MoonSphere.rotate(BABYLON.Axis.Y, moon_w, BABYLON.Space.WORLD);
        MoonSphere.rotate(BABYLON.Axis.X, 0.0, BABYLON.Space.WORLD);
        MoonSphere.rotate(BABYLON.Axis.Z, 0.0, BABYLON.Space.WORLD);
        //Axial Tilt
        MoonSphere.rotate(BABYLON.Axis.X, moon_ori1, BABYLON.Space.WORLD);
        MoonSphere.rotate(BABYLON.Axis.Y, moon_ori2, BABYLON.Space.WORLD);
        MoonSphere.rotate(BABYLON.Axis.Z, 0.0, BABYLON.Space.WORLD);

        ilu_text=new BABYLON.RawTexture.CreateRGBTexture(ilu_texture_data, ilu_ts, ilu_ts, scene);
        FlatEarthMat.ambientTexture=ilu_text;

        stars_lines =BABYLON.MeshBuilder.CreateLines ( "stars lines", {points: star_pos, instance: stars_lines},scene); 
    
        tilt=23.4393*dtor;
        sky_sphere.rotation=new BABYLON.Vector3(0, 0, 0);
        sky_sphere.rotate(BABYLON.Axis.X, -tilt, BABYLON.Space.WORLD);
        sky_sphere.rotate(BABYLON.Axis.Y, 0.0, BABYLON.Space.WORLD);
        sky_sphere.rotate(BABYLON.Axis.Z, 0.0, BABYLON.Space.WORLD);

        //Corrección de precesión simple
        var precesa=-3.82394E-5 *(JD-2451545.0)*dtor;
        sky_sphere.rotate(BABYLON.Axis.X, 0.0, BABYLON.Space.WORLD);
        sky_sphere.rotate(BABYLON.Axis.Y, precesa, BABYLON.Space.WORLD);
        sky_sphere.rotate(BABYLON.Axis.Z, 0.0, BABYLON.Space.WORLD);

        sky_sphere.rotate(BABYLON.Axis.X, tilt, BABYLON.Space.WORLD);
        sky_sphere.rotate(BABYLON.Axis.Y, 0.0, BABYLON.Space.WORLD);
        sky_sphere.rotate(BABYLON.Axis.Z, 0.0, BABYLON.Space.WORLD);

        sky_sphere.rotate(BABYLON.Axis.X, 0.0, BABYLON.Space.WORLD);
        sky_sphere.rotate(BABYLON.Axis.Y, Math.PI+calc_gmst(), BABYLON.Space.WORLD);
        sky_sphere.rotate(BABYLON.Axis.Z, 0.0, BABYLON.Space.WORLD);


        //--Muestra o esconde la tierra plana y sus elementos
        EarthDisk.isVisible=fe_is_visible;

        moonFe.isVisible=fe_is_visible;
        sunFe.isVisible=fe_is_visible;

        redSphere_fe.isVisible=fe_is_visible;
        blueSphere_fe.isVisible=fe_is_visible;

        ortodromic_line_fe.isVisible=orto_es_visible*fe_is_visible;
        loxodromic_line_fe.isVisible=loxo_es_visible*fe_is_visible;
        flatodromic_line_fe.isVisible=flato_es_visible*fe_is_visible;
        equiangular_line_fe.isVisible=eqac_es_visible*fe_is_visible;

        fe_moon_line_1.isVisible=moon_tp_visible*fe_is_visible;
        fe_moon_line_2.isVisible=moon_tp_visible*fe_is_visible;
        fe_sun_line_1.isVisible=sun_tp_visible*fe_is_visible;
        fe_sun_line_2.isVisible=sun_tp_visible*fe_is_visible;

        ilu_line_fe.isVisible=ilu_is_visible*fe_is_visible;

        fe_sun_arrow_1.isVisible=sun_tp_visible*fe_is_visible;
        fe_sun_arrow_2.isVisible=sun_tp_visible*fe_is_visible;
        fe_moon_arrow_1.isVisible=moon_tp_visible*fe_is_visible;
        fe_moon_arrow_2.isVisible=moon_tp_visible*fe_is_visible;

        fe_user_line_1.isVisible=user_tp_lines_visible*fe_is_visible;
        fe_user_line_2.isVisible=user_tp_lines_visible*fe_is_visible;

        sun_tr_line_fe.isVisible=fe_is_visible;
        moon_tr_line_fe.isVisible=fe_is_visible;

        eclipse_line_umbra_fe.isVisible=fe_is_visible;
        eclipse_line_penumbra_fe.isVisible=fe_is_visible;

        moon_cut_sphere.isVisible=moon_tp_visible*moon_tp_cut_visible*fe_is_visible;
        moon_cut_line.isVisible=moon_tp_visible*moon_tp_cut_visible*fe_is_visible;
        sun_cut_sphere.isVisible=sun_tp_visible*sun_tp_cut_visible*fe_is_visible;
        sun_cut_line.isVisible=sun_tp_visible*sun_tp_cut_visible*fe_is_visible;

        //--

    }
   
    return scene;
};

window.initFunction = async function() {
                    
    var asyncEngineCreation = async function() {
        try {
            return createDefaultEngine();
        } catch(e) {
            console.log("the available createEngine function failed. Creating the default engine instead");
            return createDefaultEngine();
        }
    }

    window.engine = await asyncEngineCreation();
    if (!engine) throw 'engine should not be null.';
    startRenderLoop(engine, canvas);
    window.scene = createScene();};
    initFunction().then(() => {sceneToRender = scene                    
});

// Resize
window.addEventListener("resize", function () {
    engine.resize();
});


    </script>
</body>
</html>
